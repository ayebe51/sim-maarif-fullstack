/* eslint-disable @typescript-eslint/no-unsafe-assignment, @typescript-eslint/no-unsafe-member-access, @typescript-eslint/no-unsafe-call, @typescript-eslint/no-explicit-any */
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import * as XLSX from 'xlsx';
import * as fs from 'fs';
import * as path from 'path';

import { School } from './entities/school.entity';
import { Teacher } from './entities/teacher.entity';
import { Student } from './entities/student.entity';
import { validatePhoneNumber, validateNIK } from '../common/validation.utils';

@Injectable()
export class MasterDataService {
  constructor(
    @InjectRepository(School)
    private schoolRepo: Repository<School>,
    @InjectRepository(Teacher)
    private teacherRepo: Repository<Teacher>,
    @InjectRepository(Student)
    private studentRepo: Repository<Student>,
  ) {}

  // ... (existing methods - not showing for brevity, they remain the same)

  // DUPLICATE DETECTION & VALIDATION
  /**
   * Find duplicate teachers based on NUPTK, NIK, or name+satminkal
   */
  async findDuplicateTeachers(
    nuptk?: string,
    nik?: string,
    nama?: string,
    satminkal?: string,
    excludeId?: string,
  ) {
    const duplicates = [];

    // Check by NUPTK (if provided)
    if (nuptk) {
      const byNuptk = await this.teacherRepo.find({ where: { nuptk } });
      const filtered = excludeId
        ? byNuptk.filter((t) => t.id !== excludeId)
        : byNuptk;

      if (filtered.length > 0) {
        duplicates.push({
          type: 'NUPTK',
          value: nuptk,
          count: filtered.length,
          records: filtered.map((t) => ({
            id: t.id,
            nama: t.nama,
            nuptk: t.nuptk,
            satminkal: t.satminkal,
          })),
        });
      }
    }

    // Check by NIK (if provided)
    if (nik) {
      const byNik = await this.teacherRepo.find({ where: { nik } });
      const filtered = excludeId
        ? byNik.filter((t) => t.id !== excludeId)
        : byNik;

      if (filtered.length > 0) {
        duplicates.push({
          type: 'NIK',
          value: nik,
          count: filtered.length,
          records: filtered.map((t) => ({
            id: t.id,
            nama: t.nama,
            nik: t.nik,
            satminkal: t.satminkal,
          })),
        });
      }
    }

    // Check by Name + Satminkal (if both provided)
    if (nama && satminkal) {
      const byName = await this.teacherRepo.find({
        where: { nama, satminkal },
      });
      const filtered = excludeId
        ? byName.filter((t) => t.id !== excludeId)
        : byName;

      if (filtered.length > 0) {
        duplicates.push({
          type: 'Name+School',
          value: `${nama} - ${satminkal}`,
          count: filtered.length,
          records: filtered.map((t) => ({
            id: t.id,
            nama: t.nama,
            nuptk: t.nuptk,
            satminkal: t.satminkal,
          })),
        });
      }
    }

    return duplicates;
  }

  /**
   * Find duplicate schools based on NSM or NPSN
   */
  async findDuplicateSchools(
    nsm?: string,
    npsn?: string,
    excludeId?: string,
  ) {
    const duplicates = [];

    // Check by NSM (if provided)
    if (nsm) {
      const byNsm = await this.schoolRepo.find({ where: { nsm } });
      const filtered = excludeId
        ? byNsm.filter((s) => s.id !== excludeId)
        : byNsm;

      if (filtered.length > 0) {
        duplicates.push({
          type: 'NSM',
          value: nsm,
          count: filtered.length,
          records: filtered.map((s) => ({
            id: s.id,
            nama: s.nama,
            nsm: s.nsm,
            kecamatan: s.kecamatan,
          })),
        });
      }
    }

    // Check by NPSN (if provided)
    if (npsn) {
      const byNpsn = await this.schoolRepo.find({ where: { npsn } });
      const filtered = excludeId
        ? byNpsn.filter((s) => s.id !== excludeId)
        : byNpsn;

      if (filtered.length > 0) {
        duplicates.push({
          type: 'NPSN',
          value: npsn,
          count: filtered.length,
          records: filtered.map((s) => ({
            id: s.id,
            nama: s.nama,
            npsn: s.npsn,
            kecamatan: s.kecamatan,
          })),
        });
      }
    }

    return duplicates;
  }

  /**
   * Validate teacher data before save
   */
  async validateTeacherData(data: Partial<Teacher>, excludeId?: string) {
    const errors = [];
    const warnings = [];

    // Validate phone number
    if (data.phoneNumber) {
      const phoneResult = validatePhoneNumber(data.phoneNumber);
      if (!phoneResult.isValid) {
        errors.push({ field: 'phoneNumber', message: phoneResult.error });
      }
    }

    // Validate NIK (warning only)
    if (data.nik) {
      const nikResult = validateNIK(data.nik);
      if (nikResult.warning) {
        warnings.push({
          field: 'nik',
          message: nikResult.warning,
          province: nikResult.province,
        });
      }
    }

    // Check for duplicates (block)
    const duplicates = await this.findDuplicateTeachers(
      data.nuptk,
      data.nik,
      data.nama,
      data.satminkal,
      excludeId,
    );

    if (duplicates.length > 0) {
      errors.push({
        field: 'duplicate',
        message: 'Data guru sudah ada',
        duplicates: duplicates,
      });
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings,
    };
  }

  /**
   * Validate school data before save
   */
  async validateSchoolData(data: Partial<School>, excludeId?: string) {
    const errors = [];
    const warnings = [];

    // Validate phone number
    if (data.noHpKepala) {
      const phoneResult = validatePhoneNumber(data.noHpKepala);
      if (!phoneResult.isValid) {
        errors.push({ field: 'noHpKepala', message: phoneResult.error });
      }
    }

    // Check for duplicates (block)
    const duplicates = await this.findDuplicateSchools(
      data.nsm,
      data.npsn,
      excludeId,
    );

    if (duplicates.length > 0) {
      errors.push({
        field: 'duplicate',
        message: 'Data madrasah sudah ada',
        duplicates: duplicates,
      });
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings,
    };
  }
}
