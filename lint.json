[{"filePath":"D:\\SIMMACI\\check-data.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\_generated\\api.d.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2251,2254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2251,2254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2522,2525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2522,2525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"The `{}` (\"empty object\") type allows any non-nullish value, including literals like `0` and `\"\"`.\n- If that's what you want, disable this lint rule with an inline comment or configure the 'allowObjectTypes' rule option.\n- If you want a type meaning \"any object\", you probably want `object` instead.\n- If you want a type meaning \"any value\", you probably want `unknown` instead.","line":89,"column":34,"nodeType":"TSTypeLiteral","messageId":"noEmptyObject","endLine":89,"endColumn":36,"suggestions":[{"messageId":"replaceEmptyObjectType","data":{"replacement":"object"},"fix":{"range":[2576,2578],"text":"object"},"desc":"Replace `{}` with `object`."},{"messageId":"replaceEmptyObjectType","data":{"replacement":"unknown"},"fix":{"range":[2576,2578],"text":"unknown"},"desc":"Replace `{}` with `unknown`."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\_generated\\api.js","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported).","line":1,"column":1,"severity":1,"nodeType":null,"fix":{"range":[0,20],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/* eslint-disable */\n/**\n * Generated `api` utility.\n *\n * THIS CODE IS AUTOMATICALLY GENERATED.\n *\n * To regenerate, run `npx convex dev`.\n * @module\n */\n\nimport { anyApi, componentsGeneric } from \"convex/server\";\n\n/**\n * A utility for referencing Convex functions in your app's API.\n *\n * Usage:\n * ```js\n * const myFunctionReference = api.myModule.myFunction;\n * ```\n */\nexport const api = anyApi;\nexport const internal = anyApi;\nexport const components = componentsGeneric();\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\_generated\\dataModel.d.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported).","line":1,"column":1,"severity":1,"nodeType":null,"fix":{"range":[0,20],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/* eslint-disable */\n/**\n * Generated data model types.\n *\n * THIS CODE IS AUTOMATICALLY GENERATED.\n *\n * To regenerate, run `npx convex dev`.\n * @module\n */\n\nimport type {\n  DataModelFromSchemaDefinition,\n  DocumentByName,\n  TableNamesInDataModel,\n  SystemTableNames,\n} from \"convex/server\";\nimport type { GenericId } from \"convex/values\";\nimport schema from \"../schema.js\";\n\n/**\n * The names of all of your Convex tables.\n */\nexport type TableNames = TableNamesInDataModel<DataModel>;\n\n/**\n * The type of a document stored in Convex.\n *\n * @typeParam TableName - A string literal type of the table name (like \"users\").\n */\nexport type Doc<TableName extends TableNames> = DocumentByName<\n  DataModel,\n  TableName\n>;\n\n/**\n * An identifier for a document in Convex.\n *\n * Convex documents are uniquely identified by their `Id`, which is accessible\n * on the `_id` field. To learn more, see [Document IDs](https://docs.convex.dev/using/document-ids).\n *\n * Documents can be loaded using `db.get(tableName, id)` in query and mutation functions.\n *\n * IDs are just strings at runtime, but this type can be used to distinguish them from other\n * strings when type checking.\n *\n * @typeParam TableName - A string literal type of the table name (like \"users\").\n */\nexport type Id<TableName extends TableNames | SystemTableNames> =\n  GenericId<TableName>;\n\n/**\n * A type describing your Convex data model.\n *\n * This type includes information about what tables you have, the type of\n * documents stored in those tables, and the indexes defined on them.\n *\n * This type is used to parameterize methods like `queryGeneric` and\n * `mutationGeneric` to make them type-safe.\n */\nexport type DataModel = DataModelFromSchemaDefinition<typeof schema>;\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\_generated\\server.d.ts","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported).","line":1,"column":1,"severity":1,"nodeType":null,"fix":{"range":[0,20],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/* eslint-disable */\n/**\n * Generated utilities for implementing server-side Convex query and mutation functions.\n *\n * THIS CODE IS AUTOMATICALLY GENERATED.\n *\n * To regenerate, run `npx convex dev`.\n * @module\n */\n\nimport {\n  ActionBuilder,\n  HttpActionBuilder,\n  MutationBuilder,\n  QueryBuilder,\n  GenericActionCtx,\n  GenericMutationCtx,\n  GenericQueryCtx,\n  GenericDatabaseReader,\n  GenericDatabaseWriter,\n} from \"convex/server\";\nimport type { DataModel } from \"./dataModel.js\";\n\n/**\n * Define a query in this Convex app's public API.\n *\n * This function will be allowed to read your Convex database and will be accessible from the client.\n *\n * @param func - The query function. It receives a {@link QueryCtx} as its first argument.\n * @returns The wrapped query. Include this as an `export` to name it and make it accessible.\n */\nexport declare const query: QueryBuilder<DataModel, \"public\">;\n\n/**\n * Define a query that is only accessible from other Convex functions (but not from the client).\n *\n * This function will be allowed to read from your Convex database. It will not be accessible from the client.\n *\n * @param func - The query function. It receives a {@link QueryCtx} as its first argument.\n * @returns The wrapped query. Include this as an `export` to name it and make it accessible.\n */\nexport declare const internalQuery: QueryBuilder<DataModel, \"internal\">;\n\n/**\n * Define a mutation in this Convex app's public API.\n *\n * This function will be allowed to modify your Convex database and will be accessible from the client.\n *\n * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.\n * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.\n */\nexport declare const mutation: MutationBuilder<DataModel, \"public\">;\n\n/**\n * Define a mutation that is only accessible from other Convex functions (but not from the client).\n *\n * This function will be allowed to modify your Convex database. It will not be accessible from the client.\n *\n * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.\n * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.\n */\nexport declare const internalMutation: MutationBuilder<DataModel, \"internal\">;\n\n/**\n * Define an action in this Convex app's public API.\n *\n * An action is a function which can execute any JavaScript code, including non-deterministic\n * code and code with side-effects, like calling third-party services.\n * They can be run in Convex's JavaScript environment or in Node.js using the \"use node\" directive.\n * They can interact with the database indirectly by calling queries and mutations using the {@link ActionCtx}.\n *\n * @param func - The action. It receives an {@link ActionCtx} as its first argument.\n * @returns The wrapped action. Include this as an `export` to name it and make it accessible.\n */\nexport declare const action: ActionBuilder<DataModel, \"public\">;\n\n/**\n * Define an action that is only accessible from other Convex functions (but not from the client).\n *\n * @param func - The function. It receives an {@link ActionCtx} as its first argument.\n * @returns The wrapped function. Include this as an `export` to name it and make it accessible.\n */\nexport declare const internalAction: ActionBuilder<DataModel, \"internal\">;\n\n/**\n * Define an HTTP action.\n *\n * The wrapped function will be used to respond to HTTP requests received\n * by a Convex deployment if the requests matches the path and method where\n * this action is routed. Be sure to route your httpAction in `convex/http.js`.\n *\n * @param func - The function. It receives an {@link ActionCtx} as its first argument\n * and a Fetch API `Request` object as its second.\n * @returns The wrapped function. Import this function from `convex/http.js` and route it to hook it up.\n */\nexport declare const httpAction: HttpActionBuilder;\n\n/**\n * A set of services for use within Convex query functions.\n *\n * The query context is passed as the first argument to any Convex query\n * function run on the server.\n *\n * This differs from the {@link MutationCtx} because all of the services are\n * read-only.\n */\nexport type QueryCtx = GenericQueryCtx<DataModel>;\n\n/**\n * A set of services for use within Convex mutation functions.\n *\n * The mutation context is passed as the first argument to any Convex mutation\n * function run on the server.\n */\nexport type MutationCtx = GenericMutationCtx<DataModel>;\n\n/**\n * A set of services for use within Convex action functions.\n *\n * The action context is passed as the first argument to any Convex action\n * function run on the server.\n */\nexport type ActionCtx = GenericActionCtx<DataModel>;\n\n/**\n * An interface to read from the database within Convex query functions.\n *\n * The two entry points are {@link DatabaseReader.get}, which fetches a single\n * document by its {@link Id}, or {@link DatabaseReader.query}, which starts\n * building a query.\n */\nexport type DatabaseReader = GenericDatabaseReader<DataModel>;\n\n/**\n * An interface to read from and write to the database within Convex mutation\n * functions.\n *\n * Convex guarantees that all writes within a single mutation are\n * executed atomically, so you never have to worry about partial writes leaving\n * your data in an inconsistent state. See [the Convex Guide](https://docs.convex.dev/understanding/convex-fundamentals/functions#atomicity-and-optimistic-concurrency-control)\n * for the guarantees Convex provides your functions.\n */\nexport type DatabaseWriter = GenericDatabaseWriter<DataModel>;\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\_generated\\server.js","messages":[{"ruleId":null,"message":"Unused eslint-disable directive (no problems were reported).","line":1,"column":1,"severity":1,"nodeType":null,"fix":{"range":[0,20],"text":" "}}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"/* eslint-disable */\n/**\n * Generated utilities for implementing server-side Convex query and mutation functions.\n *\n * THIS CODE IS AUTOMATICALLY GENERATED.\n *\n * To regenerate, run `npx convex dev`.\n * @module\n */\n\nimport {\n  actionGeneric,\n  httpActionGeneric,\n  queryGeneric,\n  mutationGeneric,\n  internalActionGeneric,\n  internalMutationGeneric,\n  internalQueryGeneric,\n} from \"convex/server\";\n\n/**\n * Define a query in this Convex app's public API.\n *\n * This function will be allowed to read your Convex database and will be accessible from the client.\n *\n * @param func - The query function. It receives a {@link QueryCtx} as its first argument.\n * @returns The wrapped query. Include this as an `export` to name it and make it accessible.\n */\nexport const query = queryGeneric;\n\n/**\n * Define a query that is only accessible from other Convex functions (but not from the client).\n *\n * This function will be allowed to read from your Convex database. It will not be accessible from the client.\n *\n * @param func - The query function. It receives a {@link QueryCtx} as its first argument.\n * @returns The wrapped query. Include this as an `export` to name it and make it accessible.\n */\nexport const internalQuery = internalQueryGeneric;\n\n/**\n * Define a mutation in this Convex app's public API.\n *\n * This function will be allowed to modify your Convex database and will be accessible from the client.\n *\n * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.\n * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.\n */\nexport const mutation = mutationGeneric;\n\n/**\n * Define a mutation that is only accessible from other Convex functions (but not from the client).\n *\n * This function will be allowed to modify your Convex database. It will not be accessible from the client.\n *\n * @param func - The mutation function. It receives a {@link MutationCtx} as its first argument.\n * @returns The wrapped mutation. Include this as an `export` to name it and make it accessible.\n */\nexport const internalMutation = internalMutationGeneric;\n\n/**\n * Define an action in this Convex app's public API.\n *\n * An action is a function which can execute any JavaScript code, including non-deterministic\n * code and code with side-effects, like calling third-party services.\n * They can be run in Convex's JavaScript environment or in Node.js using the \"use node\" directive.\n * They can interact with the database indirectly by calling queries and mutations using the {@link ActionCtx}.\n *\n * @param func - The action. It receives an {@link ActionCtx} as its first argument.\n * @returns The wrapped action. Include this as an `export` to name it and make it accessible.\n */\nexport const action = actionGeneric;\n\n/**\n * Define an action that is only accessible from other Convex functions (but not from the client).\n *\n * @param func - The function. It receives an {@link ActionCtx} as its first argument.\n * @returns The wrapped function. Include this as an `export` to name it and make it accessible.\n */\nexport const internalAction = internalActionGeneric;\n\n/**\n * Define an HTTP action.\n *\n * The wrapped function will be used to respond to HTTP requests received\n * by a Convex deployment if the requests matches the path and method where\n * this action is routed. Be sure to route your httpAction in `convex/http.js`.\n *\n * @param func - The function. It receives an {@link ActionCtx} as its first argument\n * and a Fetch API `Request` object as its second.\n * @returns The wrapped function. Import this function from `convex/http.js` and route it to hook it up.\n */\nexport const httpAction = httpActionGeneric;\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\analytics.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'v' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":11}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { query } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\n// Helper to normalize strings for aggregation\r\nconst normalize = (str?: string) => (str || \"Tidak Diketahui\").trim();\r\n\r\nexport const getDashboardStats = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    // 1. Fetch ALL teachers (Consider pagination/indexing for scale later, but fine for <10k records)\r\n    const teachers = await ctx.db.query(\"teachers\").collect();\r\n    \r\n    // Aggregation Containers\r\n    const statusCounts: Record<string, number> = {};\r\n    const certCounts: Record<string, number> = { \"Sudah Sertifikasi\": 0, \"Belum Sertifikasi\": 0 };\r\n    const unitCounts: Record<string, number> = {};\r\n    const kecamatanCounts: Record<string, number> = {};\r\n\r\n    // 2. Iterate and Aggregate\r\n    for (const t of teachers) {\r\n      // A. Status Kepegawaian (GTY, GTT, PNS, PPPK, etc)\r\n      const status = normalize(t.status);\r\n      statusCounts[status] = (statusCounts[status] || 0) + 1;\r\n\r\n      // B. Certification Status\r\n      if (t.isCertified) {\r\n        certCounts[\"Sudah Sertifikasi\"]++;\r\n      } else {\r\n        certCounts[\"Belum Sertifikasi\"]++;\r\n      }\r\n\r\n      // C. Unit Kerja (School)\r\n      const unit = normalize(t.unitKerja);\r\n      unitCounts[unit] = (unitCounts[unit] || 0) + 1;\r\n\r\n      // D. Kecamatan\r\n      const kec = normalize(t.kecamatan);\r\n      kecamatanCounts[kec] = (kecamatanCounts[kec] || 0) + 1;\r\n    }\r\n\r\n    // 3. Format for Recharts (Array of Objects)\r\n    \r\n    // Status Data\r\n    const statusData = Object.entries(statusCounts)\r\n      .map(([name, value]) => ({ name, value }))\r\n      .sort((a, b) => b.value - a.value); // Sort Descending\r\n\r\n    // Certification Data\r\n    const certData = Object.entries(certCounts)\r\n      .map(([name, value]) => ({ name, value }));\r\n\r\n    // Unit Data (Top 5)\r\n    const unitData = Object.entries(unitCounts)\r\n      .map(([name, jumlah]) => ({ name, jumlah }))\r\n      .sort((a, b) => b.jumlah - a.jumlah)\r\n      .slice(0, 5);\r\n\r\n    // Kecamatan Data\r\n    const kecamatanData = Object.entries(kecamatanCounts)\r\n      .map(([name, jumlah]) => ({ name, jumlah }))\r\n      .sort((a, b) => b.jumlah - a.jumlah);\r\n\r\n    return {\r\n      totalTeachers: teachers.length,\r\n      status: statusData,\r\n      certification: certData,\r\n      units: unitData,\r\n      kecamatan: kecamatanData\r\n    };\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\approvalHistory.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Id' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":12}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v } from \"convex/values\"\r\nimport { mutation, query } from \"./_generated/server\"\r\nimport { Id } from \"./_generated/dataModel\"\r\n\r\n// ========================================\r\n// APPROVAL HISTORY MUTATIONS\r\n// ========================================\r\n\r\n// Log approval action (generic for any document type)\r\nexport const logApprovalAction = mutation({\r\n  args: {\r\n    documentId: v.string(),\r\n    documentType: v.string(),\r\n    action: v.string(),\r\n    fromStatus: v.optional(v.string()),\r\n    toStatus: v.optional(v.string()),\r\n    performedBy: v.id(\"users\"),\r\n    comment: v.optional(v.string()),\r\n    rejectionReason: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const historyId = await ctx.db.insert(\"approvalHistory\", {\r\n      documentId: args.documentId,\r\n      documentType: args.documentType,\r\n      action: args.action,\r\n      fromStatus: args.fromStatus,\r\n      toStatus: args.toStatus,\r\n      performedBy: args.performedBy,\r\n      performedAt: Date.now(),\r\n      comment: args.comment,\r\n      metadata: args.rejectionReason ? {\r\n        rejectionReason: args.rejectionReason,\r\n      } : undefined,\r\n    })\r\n\r\n    return { success: true, historyId }\r\n  },\r\n})\r\n\r\n// Add comment to document\r\nexport const addComment = mutation({\r\n  args: {\r\n    documentId: v.string(),\r\n    documentType: v.string(),\r\n    performedBy: v.id(\"users\"),\r\n    comment: v.string(),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.insert(\"approvalHistory\", {\r\n      documentId: args.documentId,\r\n      documentType: args.documentType,\r\n      action: \"comment\",\r\n      performedBy: args.performedBy,\r\n      performedAt: Date.now(),\r\n      comment: args.comment,\r\n    })\r\n\r\n    return { success: true }\r\n  },\r\n})\r\n\r\n// ========================================\r\n// APPROVAL HISTORY QUERIES\r\n// ========================================\r\n\r\n// Get approval history for a document\r\nexport const getApprovalHistory = query({\r\n  args: {\r\n    documentId: v.string(),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const history = await ctx.db\r\n      .query(\"approvalHistory\")\r\n      .withIndex(\"by_document\", (q) => q.eq(\"documentId\", args.documentId))\r\n      .collect()\r\n\r\n    // Enrich with user data\r\n    const enriched = await Promise.all(\r\n      history.map(async (h) => {\r\n        const user = await ctx.db.get(h.performedBy)\r\n        return {\r\n          ...h,\r\n          performedByName: user?.name || \"Unknown\",\r\n          performedByEmail: user?.email || \"\",\r\n          performedByRole: user?.role || \"\",\r\n        }\r\n      })\r\n    )\r\n\r\n    // Sort by date (newest first)\r\n    enriched.sort((a, b) => b.performedAt - a.performedAt)\r\n\r\n    return enriched\r\n  },\r\n})\r\n\r\n// Get recent approval actions (for activity feed)\r\nexport const getRecentApprovalActions = query({\r\n  args: {\r\n    limit: v.optional(v.number()),\r\n    documentType: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const limit = args.limit || 20\r\n\r\n    let history = await ctx.db\r\n      .query(\"approvalHistory\")\r\n      .withIndex(\"by_date\")\r\n      .order(\"desc\")\r\n      .take(limit * 2) // Take more to filter\r\n\r\n    // Filter by document type if specified\r\n    if (args.documentType) {\r\n      history = history.filter((h) => h.documentType === args.documentType)\r\n    }\r\n\r\n    // Enrich with user data\r\n    const enriched = await Promise.all(\r\n      history.slice(0, limit).map(async (h) => {\r\n        const user = await ctx.db.get(h.performedBy)\r\n        return {\r\n          ...h,\r\n          performedByName: user?.name || \"Unknown\",\r\n          performedByRole: user?.role || \"\",\r\n        }\r\n      })\r\n    )\r\n\r\n    return enriched\r\n  },\r\n})\r\n\r\n// Get approval statistics\r\nexport const getApprovalStats = query({\r\n  args: {\r\n    documentType: v.optional(v.string()),\r\n    days: v.optional(v.number()), // Last N days\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const days = args.days || 30\r\n    const cutoffDate = Date.now() - days * 24 * 60 * 60 * 1000\r\n\r\n    let history = await ctx.db\r\n      .query(\"approvalHistory\")\r\n      .withIndex(\"by_date\")\r\n      .filter((q) => q.gte(q.field(\"performedAt\"), cutoffDate))\r\n      .collect()\r\n\r\n    // Filter by document type if specified\r\n    if (args.documentType) {\r\n      history = history.filter((h) => h.documentType === args.documentType)\r\n    }\r\n\r\n    const stats = {\r\n      total: history.length,\r\n      approvals: history.filter((h) => h.action === \"approve\").length,\r\n      rejections: history.filter((h) => h.action === \"reject\").length,\r\n      comments: history.filter((h) => h.action === \"comment\").length,\r\n      byAction: {} as Record<string, number>,\r\n      byUser: {} as Record<string, number>,\r\n    }\r\n\r\n    // Aggregate by action\r\n    history.forEach((h) => {\r\n      stats.byAction[h.action] = (stats.byAction[h.action] || 0) + 1\r\n    })\r\n\r\n    // Aggregate by user\r\n    for (const h of history) {\r\n      const user = await ctx.db.get(h.performedBy)\r\n      const userName = user?.name || \"Unknown\"\r\n      stats.byUser[userName] = (stats.byUser[userName] || 0) + 1\r\n    }\r\n\r\n    return stats\r\n  },\r\n})\r\n\r\n// Get approval history for a user (what they approved/rejected)\r\nexport const getUserApprovalHistory = query({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    limit: v.optional(v.number()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const limit = args.limit || 50\r\n\r\n    const history = await ctx.db\r\n      .query(\"approvalHistory\")\r\n      .withIndex(\"by_user\", (q) => q.eq(\"performedBy\", args.userId))\r\n      .order(\"desc\")\r\n      .take(limit)\r\n\r\n    return history\r\n  },\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\archive.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\auth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":165,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4314,4317],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4314,4317],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"prefer-const","severity":2,"message":"'query' is never reassigned. Use 'const' instead.","line":184,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":184,"endColumn":14,"fix":{"range":[5095,5143],"text":"const query = ctx.db.query(\"users\").order(\"desc\");"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":245,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":245,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7364,7367],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7364,7367],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import { mutation, query } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\n// Simple password hashing (in production, use proper bcrypt or Convex Auth)\r\nfunction hashPassword(password: string): string {\r\n  // Simple hash for demo - in production use proper encryption\r\n  return btoa(password); // Base64 encoding using web API\r\n}\r\n\r\nfunction verifyPassword(password: string, hash: string): boolean {\r\n  return hashPassword(password) === hash;\r\n}\r\n\r\n// Register new user\r\nexport const register = mutation({\r\n  args: {\r\n    email: v.string(),\r\n    name: v.string(),\r\n    password: v.string(),\r\n    role: v.optional(v.string()),\r\n    unit: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // Check if user exists\r\n    const existing = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", args.email))\r\n      .first();\r\n    \r\n    if (existing) {\r\n      throw new Error(\"Email already registered\");\r\n    }\r\n    \r\n    // Create user\r\n    const userId = await ctx.db.insert(\"users\", {\r\n      email: args.email,\r\n      name: args.name,\r\n      passwordHash: hashPassword(args.password),\r\n      role: args.role || \"operator\",\r\n      unit: args.unit,\r\n      isActive: true,\r\n      createdAt: Date.now(),\r\n      updatedAt: Date.now(),\r\n    });\r\n    \r\n    return { userId, email: args.email, name: args.name };\r\n  },\r\n});\r\n\r\n// Login user\r\nexport const login = mutation({\r\n  args: {\r\n    email: v.string(),\r\n    password: v.string(),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // Find user by email\r\n    const user = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", args.email))\r\n      .first();\r\n    \r\n    if (!user) {\r\n      throw new Error(\"Invalid credentials\");\r\n    }\r\n    \r\n    // Verify password\r\n    if (!verifyPassword(args.password, user.passwordHash)) {\r\n      throw new Error(\"Invalid credentials\");\r\n    }\r\n    \r\n    // Check if active\r\n    if (!user.isActive) {\r\n      throw new Error(\"Account is inactive\");\r\n    }\r\n    \r\n    // Return user data (without password hash)\r\n    return {\r\n      user: {\r\n        _id: user._id,  // Changed from 'id' to '_id' for consistency\r\n        email: user.email,\r\n        name: user.name,\r\n        role: user.role,\r\n        unitKerja: user.unit, // Map to frontend format\r\n      },\r\n      token: user._id, // Using user ID as token for simplicity\r\n    };\r\n  },\r\n});\r\n\r\n// Get current user\r\nexport const getCurrentUser = query({\r\n  args: { userId: v.id(\"users\") },\r\n  handler: async (ctx, args) => {\r\n    const user = await ctx.db.get(args.userId);\r\n    \r\n    if (!user) {\r\n      return null;\r\n    }\r\n    \r\n    return {\r\n      id: user._id,\r\n      email: user.email,\r\n      name: user.name,\r\n      role: user.role,\r\n      unitKerja: user.unit, // Map to frontend format\r\n      isActive: user.isActive,\r\n    };\r\n  },\r\n});\r\n\r\n// Create default admin user (run once)\r\nexport const createDefaultAdmin = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    // Check if admin exists\r\n    const existing = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", \"admin@maarif.nu\"))\r\n      .first();\r\n    \r\n    if (existing) {\r\n      return { message: \"Admin already exists\", userId: existing._id };\r\n    }\r\n    \r\n    // Create admin\r\n    const userId = await ctx.db.insert(\"users\", {\r\n      email: \"admin@maarif.nu\",\r\n      name: \"Admin Maarif\",\r\n      passwordHash: hashPassword(\"admin123\"),\r\n      role: \"super_admin\",\r\n      unit: undefined,\r\n      isActive: true,\r\n      createdAt: Date.now(),\r\n      updatedAt: Date.now(),\r\n    });\r\n    \r\n    return { \r\n      message: \"Default admin created\", \r\n      userId,\r\n      credentials: {\r\n        email: \"admin@maarif.nu\",\r\n        password: \"admin123\"\r\n      }\r\n    };\r\n  },\r\n});\r\n\r\n// List all users (admin only check should be done in frontend/middleware)\r\nexport const listUsers = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    try {\r\n      const users = await ctx.db.query(\"users\").collect();\r\n      \r\n      return users.map(u => ({\r\n        id: u._id,\r\n        email: u.email,\r\n        name: u.name,\r\n        role: u.role,\r\n        unitKerja: u.unit, // Map to frontend format\r\n        isActive: u.isActive,\r\n        createdAt: u.createdAt,\r\n      }));\r\n    } catch (e: any) {\r\n      console.error(\"Error in listUsers:\", e);\r\n      // Construct a safe error message\r\n      const errorMessage = e.message || \"Unknown error\";\r\n      console.error(`Detailed error stats: ${JSON.stringify(e)}`);\r\n      throw new Error(`Failed to list users: ${errorMessage}`);\r\n    }\r\n  },\r\n});\r\n\r\n// Paginated User List for Management Page\r\nexport const listUsersPage = query({\r\n  args: {\r\n    paginationOpts: v.any(), // Using v.any() to pass pagination options safely or v.object({...}) \r\n    // Convex pagination options structure is specific, usually better to pass standard args and build opts inside?\r\n    // Actually standard pattern is passing paginationOpts (cursor, numItems).\r\n    search: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let query = ctx.db.query(\"users\").order(\"desc\");\r\n\r\n    // Note: Search with filter is manual in Convex if not using search index.\r\n    // For pagination + search, we usually use search index.\r\n    // But `users` table doesn't have search index on name/email defined in this file (schema hidden).\r\n    // If I use filter, I can't use `order(\"desc\")` efficiently without index?\r\n    // `order` requires index.\r\n    // Let's stick to simple pagination first.\r\n    // If search is present, we might need to filter manually?\r\n    // If I filter manually, I can't use .paginate().\r\n    // So for now, I'll paginate ALL users, and handle search via `withSearchIndex` if available, or just filter on client?\r\n    // User wants pagination to reduce scroll.\r\n    // Let's just implement simple pagination. Search can be done on client IF we fetch all?\r\n    // No, if paginated, fetching all defeats point.\r\n    // I'll check if `users` has search index. `dashboard.ts` used `withIndex(\"by_email\")`.\r\n    // I'll assume simple pagination on ALL users for now. Search will only work on LOADED page or I must use search query.\r\n    \r\n    // Using default pagination\r\n    const results = await query.paginate(args.paginationOpts);\r\n\r\n    return {\r\n      ...results,\r\n      page: results.page.map(u => ({\r\n        id: u._id,\r\n        email: u.email,\r\n        name: u.name,\r\n        role: u.role,\r\n        unitKerja: u.unit,\r\n        isActive: u.isActive,\r\n        createdAt: u.createdAt,\r\n      }))\r\n    };\r\n  }\r\n});\r\n\r\n// Update user's assigned school (unitKerja)\r\nexport const updateUserSchool = mutation({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    schoolName: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // Update user's unit field\r\n    await ctx.db.patch(args.userId, {\r\n      unit: args.schoolName || undefined,\r\n      updatedAt: Date.now(),\r\n    });\r\n\r\n    return { success: true };\r\n  },\r\n});\r\n// Update user details (admin function)\r\nexport const updateUser = mutation({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    role: v.optional(v.string()),\r\n    unit: v.optional(v.string()),\r\n    isActive: v.optional(v.boolean()),\r\n    password: v.optional(v.string()), // Optional password reset\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const updates: any = {\r\n      updatedAt: Date.now(),\r\n    };\r\n\r\n    if (args.role !== undefined) updates.role = args.role;\r\n    if (args.unit !== undefined) updates.unit = args.unit;\r\n    if (args.isActive !== undefined) updates.isActive = args.isActive;\r\n    \r\n    // Only hash password if provided\r\n    if (args.password) {\r\n      updates.passwordHash = hashPassword(args.password);\r\n    }\r\n\r\n    await ctx.db.patch(args.userId, updates);\r\n    return { success: true };\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\cleanup.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\dashboard.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\debugging.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'v' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":11}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { query } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\nexport const listAllTeachers = query({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    return await ctx.db.query(\"teachers\").collect();\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\headmaster.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\headmasters.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\importData.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[721,724],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[721,724],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[990,993],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[990,993],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3269,3272],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3269,3272],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport { mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\n// Helper to normalize Status\r\nfunction normalizeStatus(val: string): string {\r\n  if (!val) return \"GTT\";\r\n  const s = String(val).toLowerCase().trim();\r\n  if (s.includes(\"gty\") || s.includes(\"tetap yayasan\")) return \"GTY\";\r\n  if (s.includes(\"pns\") || s.includes(\"asn\")) return \"PNS\";\r\n  if (s.includes(\"pppk\") || s.includes(\"p3k\")) return \"PPPK\";\r\n  if (s.includes(\"tendik\") || s.includes(\"tenaga pendidik\")) return \"Tendik\";\r\n  if (s.includes(\"honorer\") || s.includes(\"gtt\") || s.includes(\"tidak tetap\")) return \"GTT\";\r\n  return val; // Fallback to original\r\n}\r\n\r\n// Helper to normalize Certification\r\nfunction normalizeCert(val: any): boolean {\r\n  if (!val) return false;\r\n  const s = String(val).toLowerCase().trim();\r\n  return s === \"true\" || s === \"ya\" || s === \"sudah\" || s.includes(\"sertifi\") || s === \"lulus\" || s === \"v\";\r\n}\r\n\r\n// Helper to normalize PDPKPNU\r\nfunction normalizePdpkpnu(val: any): string {\r\n  if (!val) return \"Belum\";\r\n  const s = String(val).toLowerCase().trim();\r\n  if (s === \"sudah\" || s === \"ya\" || s === \"lulus\" || s.includes(\"sertifi\") || s === \"v\") return \"Sudah\";\r\n  return \"Belum\";\r\n}\r\n\r\nexport const run = mutation({\r\n  args: {\r\n    teachers: v.array(v.any()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    let success = 0;\r\n    let updated = 0;\r\n    const errors: string[] = [];\r\n\r\n    // Prioritize new field names, fallback to old\r\n    for (const t of args.teachers) {\r\n      try {\r\n        const nuptk = String(t.nuptk || t.NUPTK || \"\").trim();\r\n        const nama = String(t.nama || t.NAMA || t.Name || \"\").trim();\r\n\r\n        if (!nuptk || !nama) continue;\r\n\r\n        // Extract raw values for normalization\r\n        const rawStatus = t.status || t.STATUS || t.Status || \"\";\r\n        const rawCert = t.isCertified || t.sertifikasi || t.SERTIFIKASI || t['Status Sertifikasi'];\r\n        const rawPdpkpnu = t.pdpkpnu || t.PDPKPNU || t['Status PDPKPNU'];\r\n\r\n        const cleanData = {\r\n          nuptk,\r\n          nama,\r\n          unitKerja: t.unitKerja || t.satminkal || t.SATMINKAL || t['Unit Kerja'] || t.sekolah || \"\",\r\n          status: normalizeStatus(rawStatus),\r\n          tmt: t.tmt || t.TMT || \"\",\r\n          pendidikanTerakhir: t.pendidikanTerakhir || t.pendidikan || t.PENDIDIKAN || \"\",\r\n          mapel: t.mapel || t.MAPEL || t.jabatan || \"\",\r\n          nip: t.nip || t.NIP || undefined,\r\n          tempatLahir: t.tempatLahir || t.birthPlace || undefined,\r\n          tanggalLahir: t.tanggalLahir || t.birthDate || undefined,\r\n          jenisKelamin: t.jenisKelamin || t.jk || undefined,\r\n          pdpkpnu: normalizePdpkpnu(rawPdpkpnu),\r\n          isCertified: normalizeCert(rawCert),\r\n          updatedAt: now,\r\n        };\r\n\r\n        const existing = await ctx.db\r\n          .query(\"teachers\")\r\n          .withIndex(\"by_nuptk\", q => q.eq(\"nuptk\", nuptk))\r\n          .first();\r\n\r\n        if (existing) {\r\n          await ctx.db.patch(existing._id, cleanData);\r\n          updated++;\r\n        } else {\r\n          await ctx.db.insert(\"teachers\", {\r\n            ...cleanData,\r\n            isActive: true,\r\n            createdAt: now,\r\n          });\r\n          success++;\r\n        }\r\n      } catch (err: any) {\r\n        errors.push(`${t.nama}: ${err.message}`);\r\n      }\r\n    }\r\n\r\n    return { \r\n      count: success + updated, \r\n      new: success, \r\n      updated: updated, \r\n      errors, \r\n      version: \"4.1 (Smart Normalize)\" \r\n    };\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\listUsers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\logs.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\maintenance.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'v' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":11}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\nfunction hashPassword(password: string): string {\r\n  return btoa(password);\r\n}\r\n\r\nexport const restoreLostAccounts = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const usersToRestore = [\r\n      { email: \"alayyubi612@gmail.com\", name: \"Super Admin\", role: \"super_admin\" },\r\n      { email: \"maarifnuclp@gmail.com\", name: \"Admin Yayasan\", role: \"admin_yayasan\" }\r\n    ];\r\n\r\n    const results = [];\r\n\r\n    for (const u of usersToRestore) {\r\n      const existing = await ctx.db\r\n        .query(\"users\")\r\n        .withIndex(\"by_email\", (q) => q.eq(\"email\", u.email))\r\n        .first();\r\n\r\n      if (!existing) {\r\n        await ctx.db.insert(\"users\", {\r\n          email: u.email,\r\n          name: u.name,\r\n          passwordHash: hashPassword(\"123456\"),\r\n          role: u.role,\r\n          isActive: true, // Default to inactive until verified? No, auto-active for admins.\r\n          createdAt: Date.now(),\r\n          updatedAt: Date.now(),\r\n        });\r\n        results.push(`Created ${u.email} as ${u.role}`);\r\n      } else {\r\n        // Force update role just in case\r\n        await ctx.db.patch(existing._id, {\r\n            role: u.role,\r\n            isActive: true\r\n        });\r\n        results.push(`Updated ${u.email} as ${u.role}`);\r\n      }\r\n    }\r\n\r\n    return results;\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\notifications.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Doc' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":13},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Id' is defined but never used.","line":3,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":17}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v } from \"convex/values\"\r\nimport { mutation, query } from \"./_generated/server\"\r\nimport { Doc, Id } from \"./_generated/dataModel\"\r\n\r\n// Create notification mutation\r\nexport const createNotification = mutation({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    type: v.string(),\r\n    title: v.string(),\r\n    message: v.string(),\r\n    metadata: v.optional(v.object({\r\n      skId: v.optional(v.id(\"skDocuments\")),\r\n      batchCount: v.optional(v.number()),\r\n      rejectionReason: v.optional(v.string()),\r\n    })),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const notificationId = await ctx.db.insert(\"notifications\", {\r\n      userId: args.userId,\r\n      type: args.type,\r\n      title: args.title,\r\n      message: args.message,\r\n      metadata: args.metadata,\r\n      isRead: false,\r\n      createdAt: Date.now(),\r\n    })\r\n    \r\n    return notificationId\r\n  },\r\n})\r\n\r\n// Mark notification as read\r\nexport const markAsRead = mutation({\r\n  args: {\r\n    notificationId: v.id(\"notifications\"),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.patch(args.notificationId, {\r\n      isRead: true,\r\n    })\r\n  },\r\n})\r\n\r\n// Mark all notifications as read for a user\r\nexport const markAllAsRead = mutation({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const unreadNotifications = await ctx.db\r\n      .query(\"notifications\")\r\n      .withIndex(\"by_user_unread\", (q) =>\r\n        q.eq(\"userId\", args.userId).eq(\"isRead\", false)\r\n      )\r\n      .collect()\r\n\r\n    for (const notif of unreadNotifications) {\r\n      await ctx.db.patch(notif._id, { isRead: true })\r\n    }\r\n    \r\n    return { count: unreadNotifications.length }\r\n  },\r\n})\r\n\r\n// Delete notification\r\nexport const deleteNotification = mutation({\r\n  args: {\r\n    notificationId: v.id(\"notifications\"),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.delete(args.notificationId)\r\n  },\r\n})\r\n\r\n// Get unread count\r\nexport const getUnreadCount = query({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const unreadNotifications = await ctx.db\r\n      .query(\"notifications\")\r\n      .withIndex(\"by_user_unread\", (q) =>\r\n        q.eq(\"userId\", args.userId).eq(\"isRead\", false)\r\n      )\r\n      .collect()\r\n\r\n    return unreadNotifications.length\r\n  },\r\n})\r\n\r\n// Get recent notifications (last 50)\r\nexport const getRecentNotifications = query({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    limit: v.optional(v.number()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const limit = args.limit || 50\r\n    \r\n    const notifications = await ctx.db\r\n      .query(\"notifications\")\r\n      .withIndex(\"by_user\", (q) => q.eq(\"userId\", args.userId))\r\n      .order(\"desc\")\r\n      .take(limit)\r\n\r\n    return notifications\r\n  },\r\n})\r\n\r\n// Get notification history (paginated with cursor)\r\nexport const getNotificationHistory = query({\r\n  args: {\r\n    userId: v.id(\"users\"),\r\n    cursor: v.optional(v.string()),\r\n    limit: v.optional(v.number()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const limit = args.limit || 20\r\n    \r\n    const query = ctx.db\r\n      .query(\"notifications\")\r\n      .withIndex(\"by_user\", (q) => q.eq(\"userId\", args.userId))\r\n      .order(\"desc\")\r\n    \r\n    // TODO: Implement cursor-based pagination if needed\r\n    const notifications = await query.take(limit)\r\n    \r\n    return {\r\n      notifications,\r\n      cursor: notifications.length > 0 \r\n        ? notifications[notifications.length - 1]._id\r\n        : null,\r\n    }\r\n  },\r\n})\r\n\r\n// Internal mutation for cleanup (to be used with cron)\r\nexport const cleanupOldNotifications = mutation({\r\n  handler: async (ctx) => {\r\n    const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000)\r\n    \r\n    const oldNotifications = await ctx.db\r\n      .query(\"notifications\")\r\n      .withIndex(\"by_created\", (q) => q.lt(\"createdAt\", thirtyDaysAgo))\r\n      .filter((q) => q.eq(q.field(\"isRead\"), true))\r\n      .collect()\r\n\r\n    for (const notif of oldNotifications) {\r\n      await ctx.db.delete(notif._id)\r\n    }\r\n    \r\n    return { deleted: oldNotifications.length }\r\n  },\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\reports.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4031,4034],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4031,4034],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { v } from \"convex/values\"\r\nimport { query } from \"./_generated/server\"\r\n\r\n// Main SK report generation with filters\r\nexport const generateSkReport = query({\r\n  args: {\r\n    startDate: v.optional(v.number()),\r\n    endDate: v.optional(v.number()),\r\n    schoolId: v.optional(v.id(\"schools\")),\r\n    status: v.optional(v.string()),\r\n    teacherId: v.optional(v.id(\"teachers\")),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    try {\r\n        // Fetch all SK documents\r\n        const allSks = await ctx.db.query(\"skDocuments\").collect() || [];\r\n        \r\n        // Apply filters\r\n        let filtered = Array.isArray(allSks) ? allSks : [];\r\n        \r\n        // Date range filter\r\n        if (args.startDate || args.endDate) {\r\n          filtered = filtered.filter(sk => {\r\n            const createdAt = sk.createdAt || 0\r\n            if (args.startDate && createdAt < args.startDate) return false\r\n            if (args.endDate && createdAt > args.endDate) return false\r\n            return true\r\n          })\r\n        }\r\n        \r\n        // Status filter\r\n        if (args.status) {\r\n          filtered = filtered.filter(sk => sk.status === args.status)\r\n        }\r\n        \r\n        // School filter\r\n        if (args.schoolId) {\r\n          const school = await ctx.db.get(args.schoolId);\r\n          if (school) {\r\n            const targetSchoolName = school.nama;\r\n            filtered = filtered.filter(sk => sk.unitKerja === targetSchoolName);\r\n          }\r\n        }\r\n        \r\n        // Teacher filter\r\n        if (args.teacherId) {\r\n          filtered = filtered.filter(sk => sk.teacherId === args.teacherId)\r\n        }\r\n        \r\n        // Enrich with related data (schools, teachers)\r\n        const enriched = await Promise.all(\r\n          filtered.map(async (sk) => {\r\n            try {\r\n                // unitKerja is likely a string name, not an ID. Try to treat as ID only if it looks like one, \r\n                // but for now, since schema says string, likely just name.\r\n                \r\n                const schoolName = sk.unitKerja || 'N/A';\r\n                \r\n                let teacher = null;\r\n                if (sk.teacherId) {\r\n                    try {\r\n                        teacher = await ctx.db.get(sk.teacherId);\r\n                    } catch {\r\n                        // Ignore invalid ID error\r\n                    }\r\n                }\r\n                \r\n                return {\r\n                  ...sk,\r\n                  schoolName: schoolName,\r\n                  teacherName: teacher?.nama || 'N/A',\r\n                  teacherNIP: teacher?.nip || '-',\r\n                }\r\n            } catch (error) {\r\n                console.error(`Error processing SK ${sk._id}:`, error);\r\n                return {\r\n                    ...sk,\r\n                    schoolName: 'Error',\r\n                    teacherName: 'Error',\r\n                    teacherNIP: '-',\r\n                }\r\n            }\r\n          })\r\n        )\r\n        \r\n        // Calculate summary statistics\r\n        const summary = {\r\n          total: enriched.length,\r\n          pending: enriched.filter(sk => sk.status === 'pending').length,\r\n          approved: enriched.filter(sk => sk.status === 'approved').length,\r\n          rejected: enriched.filter(sk => sk.status === 'rejected').length,\r\n          draft: enriched.filter(sk => sk.status === 'draft').length,\r\n        }\r\n        \r\n        // Group by SK type\r\n        const byType = {\r\n          gty: enriched.filter(sk => (sk.jenisSk || \"\").toLowerCase().includes('tetap yayasan')).length,\r\n          gtt: enriched.filter(sk => (sk.jenisSk || \"\").toLowerCase().includes('tidak tetap')).length,\r\n          kamad: enriched.filter(sk => (sk.jenisSk || \"\").toLowerCase().includes('kepala')).length,\r\n          tendik: enriched.filter(sk => (sk.jenisSk || \"\").toLowerCase().includes('tenaga')).length,\r\n        }\r\n        \r\n        return {\r\n          data: enriched,\r\n          summary,\r\n          byType,\r\n          filters: args,\r\n        }\r\n    } catch (criticalError: any) {\r\n        console.error(\"CRITICAL REPORT ERROR:\", criticalError);\r\n        // Return fail-safe empty structure to prevent whitescreen\r\n        return {\r\n            data: [],\r\n            summary: { total: 0, pending: 0, approved: 0, rejected: 0, draft: 0 },\r\n            byType: { gty: 0, gtt: 0, kamad: 0, tendik: 0 },\r\n            filters: args,\r\n            error: criticalError instanceof Error ? criticalError.message : String(criticalError)\r\n        };\r\n    }\r\n  }\r\n})\r\n\r\n// Get SK history for a specific teacher\r\nexport const getTeacherSkHistory = query({\r\n  args: { teacherId: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    const sks = await ctx.db\r\n      .query(\"skDocuments\")\r\n      .filter(q => q.eq(q.field(\"teacherId\"), args.teacherId))\r\n      .collect()\r\n    \r\n    // Enrich with school data\r\n    const enriched = await Promise.all(\r\n      sks.map(async (sk) => {\r\n        try {\r\n            // unitKerja is the school name string\r\n            const schoolName = sk.unitKerja || 'N/A';\r\n            \r\n            return {\r\n              ...sk,\r\n              schoolName,\r\n            }\r\n        } catch (error) {\r\n             console.error(`Error processing SK history ${sk._id}:`, error);\r\n             return {\r\n                 ...sk,\r\n                 schoolName: 'Error'\r\n             }\r\n        }\r\n      })\r\n    )\r\n    \r\n    // Sort by creation date (newest first)\r\n    return enriched.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))\r\n  }\r\n})\r\n\r\n// Get summary statistics for a specific school\r\nexport const getSchoolSummary = query({\r\n  args: { schoolId: v.id(\"schools\") },\r\n  handler: async (ctx, args) => {\r\n    const sks = await ctx.db\r\n      .query(\"skDocuments\")\r\n      .filter(q => q.eq(q.field(\"unitKerja\"), args.schoolId))\r\n      .collect()\r\n    \r\n    return {\r\n      total: sks.length,\r\n      byStatus: {\r\n        draft: sks.filter(sk => sk.status === 'draft').length,\r\n        pending: sks.filter(sk => sk.status === 'pending').length,\r\n        approved: sks.filter(sk => sk.status === 'approved').length,\r\n        rejected: sks.filter(sk => sk.status === 'rejected').length,\r\n      },\r\n      byType: {\r\n        pengangkatan: sks.filter(sk => sk.jenisSk === 'pengangkatan').length,\r\n        mutasi: sks.filter(sk => sk.jenisSk === 'mutasi').length,\r\n        promosi: sks.filter(sk => sk.jenisSk === 'promosi').length,\r\n        pemberhentian: sks.filter(sk => sk.jenisSk === 'pemberhentian').length,\r\n      },\r\n      recent: sks\r\n        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))\r\n        .slice(0, 5)\r\n    }\r\n  }\r\n})\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\schema.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\schools.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":425,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":425,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12110,12113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12110,12113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { query, mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\nimport { paginationOptsValidator } from \"convex/server\";\r\n\r\n// Get paginated schools with optional filters\r\nexport const paginatedList = query({\r\n  args: {\r\n    paginationOpts: paginationOptsValidator,\r\n    searchTerm: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const { paginationOpts, searchTerm, kecamatan } = args;\r\n\r\n    if (searchTerm) {\r\n      // Use search index\r\n      return await ctx.db\r\n        .query(\"schools\")\r\n        .withSearchIndex(\"search_schools\", (q) => {\r\n          let query = q.search(\"nama\", searchTerm);\r\n          if (kecamatan && kecamatan !== \"all\") {\r\n            query = query.eq(\"kecamatan\", kecamatan);\r\n          }\r\n          return query;\r\n        })\r\n        .paginate(paginationOpts);\r\n    } else {\r\n      // Regular query with optional filter\r\n      if (kecamatan && kecamatan !== \"all\") {\r\n        return await ctx.db\r\n          .query(\"schools\")\r\n          .withIndex(\"by_kecamatan\", (q) => q.eq(\"kecamatan\", kecamatan))\r\n          .paginate(paginationOpts);\r\n      } else {\r\n        // Default sort by natural order (creation time)\r\n        return await ctx.db\r\n          .query(\"schools\")\r\n          .order(\"desc\")\r\n          .paginate(paginationOpts);\r\n      }\r\n    }\r\n  },\r\n});\r\n\r\n// Get all schools with optional filters\r\nexport const list = query({\r\n  args: {\r\n    kecamatan: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let schools = await ctx.db.query(\"schools\").collect();\r\n    \r\n    // RBAC: Check if user is an Operator\r\n    const identity = await ctx.auth.getUserIdentity();\r\n    \r\n    if (identity && identity.email) {\r\n       const email = identity.email;\r\n       const user = await ctx.db\r\n         .query(\"users\")\r\n         .withIndex(\"by_email\", (q) => q.eq(\"email\", email))\r\n         .first();\r\n\r\n       if (user && user.role === \"operator\" && user.unit) {\r\n           // Strict filter for operators: only return their own school\r\n           const userUnit = user.unit;\r\n           schools = schools.filter(s => s.nama === userUnit);\r\n       }\r\n    }\r\n\r\n    // Apply filters\r\n    if (args.kecamatan && args.kecamatan !== \"all\") {\r\n      schools = schools.filter(s => s.kecamatan === args.kecamatan);\r\n    }\r\n    \r\n    return schools;\r\n  },\r\n});\r\n\r\n// Get single school by ID\r\nexport const get = query({\r\n  args: { id: v.id(\"schools\") },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db.get(args.id);\r\n  },\r\n});\r\n\r\n// Get school by NSM\r\nexport const getByNsm = query({\r\n  args: { nsm: v.string() },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db\r\n      .query(\"schools\")\r\n      .withIndex(\"by_nsm\", (q) => q.eq(\"nsm\", args.nsm))\r\n      .first();\r\n  },\r\n});\r\n\r\n// Get current operator's school\r\nexport const getMyself = query({\r\n  args: { email: v.string() }, // Accept email explicitly\r\n  handler: async (ctx, args) => {\r\n    const user = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", args.email))\r\n      .first();\r\n\r\n    if (!user || !user.unit) return null;\r\n\r\n    // 1. Try exact match\r\n    let school = await ctx.db\r\n      .query(\"schools\")\r\n      .filter(q => q.eq(q.field(\"nama\"), user.unit))\r\n      .first();\r\n    \r\n    const unitName = user.unit || \"\";\r\n\r\n    // 2. Fallback: Try matching NSM if unit looks like NSM (digits)\r\n    if (!school && /^\\d+$/.test(unitName)) {\r\n         school = await ctx.db\r\n            .query(\"schools\")\r\n            .withIndex(\"by_nsm\", q => q.eq(\"nsm\", unitName))\r\n            .first();\r\n    }\r\n\r\n    // 3. Fallback: Try case-insensitive search (expensive but necessary for manual inputs)\r\n    // Note: This matches the search_schools index logic\r\n    if (!school && unitName) {\r\n        school = await ctx.db\r\n            .query(\"schools\")\r\n            .withSearchIndex(\"search_schools\", q => q.search(\"nama\", unitName))\r\n            .first();\r\n    }\r\n      \r\n    return school;\r\n  },\r\n});\r\n\r\n// Create new school\r\nexport const create = mutation({\r\n  args: {\r\n    nsm: v.string(),\r\n    nama: v.string(),\r\n    npsn: v.optional(v.string()),\r\n    alamat: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    telepon: v.optional(v.string()),\r\n    email: v.optional(v.string()),\r\n    kepalaMadrasah: v.optional(v.string()),\r\n    akreditasi: v.optional(v.string()),\r\n    statusJamiyyah: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    \r\n    // Check if NSM already exists\r\n    const existing = await ctx.db\r\n      .query(\"schools\")\r\n      .withIndex(\"by_nsm\", (q) => q.eq(\"nsm\", args.nsm))\r\n      .first();\r\n    \r\n    if (existing) {\r\n      throw new Error(\"NSM sudah terdaftar\");\r\n    }\r\n    \r\n    return await ctx.db.insert(\"schools\", {\r\n      ...args,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    });\r\n  },\r\n});\r\n\r\n// Update school\r\nexport const update = mutation({\r\n  args: {\r\n    id: v.id(\"schools\"),\r\n    nsm: v.optional(v.string()),\r\n    nama: v.optional(v.string()),\r\n    npsn: v.optional(v.string()),\r\n    alamat: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    telepon: v.optional(v.string()),\r\n    kepalaMadrasah: v.optional(v.string()),\r\n    akreditasi: v.optional(v.string()),\r\n    statusJamiyyah: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const { id, ...updates } = args;\r\n    \r\n    await ctx.db.patch(id, {\r\n      ...updates,\r\n      updatedAt: Date.now(),\r\n    });\r\n    \r\n    return id;\r\n  },\r\n});\r\n\r\n// Delete school (hard delete - to prevent duplicates)\r\nexport const remove = mutation({\r\n  args: { id: v.id(\"schools\") },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.delete(args.id);\r\n  },\r\n});\r\n\r\n// Bulk delete all schools\r\nexport const bulkDelete = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const allSchools = await ctx.db.query(\"schools\").collect();\r\n    for (const school of allSchools) {\r\n      await ctx.db.delete(school._id);\r\n    }\r\n    return { count: allSchools.length };\r\n  },\r\n});\r\n\r\n// Simple helper (consistent with auth.ts)\r\nfunction hashPassword(password: string): string {\r\n  return btoa(password);\r\n}\r\n\r\n// Create School Account (Operator)\r\nexport const createSchoolAccount = mutation({\r\n  args: { \r\n    schoolId: v.id(\"schools\"),\r\n    customEmail: v.optional(v.string()), \r\n    customPassword: v.optional(v.string())\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const school = await ctx.db.get(args.schoolId);\r\n    if (!school) throw new Error(\"School not found\");\r\n\r\n    const email = args.customEmail || `${school.nsm}@maarif.nu`;\r\n    const password = args.customPassword || \"123456\";\r\n\r\n    // Check existing user\r\n    const existing = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", email))\r\n      .first();\r\n\r\n    if (existing) {\r\n       // If exists, just update the unit/role linkage to be sure\r\n       await ctx.db.patch(existing._id, {\r\n           role: \"operator\",\r\n           unit: school.nama,\r\n           isActive: true\r\n       });\r\n       return { message: \"Account updated\", email, password: \"(Unchanged)\" };\r\n    }\r\n\r\n    // Create new user\r\n    await ctx.db.insert(\"users\", {\r\n        email,\r\n        name: `Admin ${school.nama}`,\r\n        passwordHash: hashPassword(password),\r\n        role: \"operator\",\r\n        unit: school.nama,\r\n        isActive: true,\r\n        createdAt: Date.now(),\r\n        updatedAt: Date.now(),\r\n    });\r\n\r\n    return { message: \"Account created\", email, password };\r\n  },\r\n});\r\n\r\n// Bulk create schools (for import)\r\nexport const bulkCreate = mutation({\r\n  args: {\r\n    schools: v.array(v.object({\r\n      nsm: v.string(),\r\n      nama: v.string(),\r\n      npsn: v.optional(v.string()),\r\n      alamat: v.optional(v.string()),\r\n      kecamatan: v.optional(v.string()),\r\n      telepon: v.optional(v.string()),\r\n      email: v.optional(v.string()),\r\n      kepalaMadrasah: v.optional(v.string()),\r\n      akreditasi: v.optional(v.string()),\r\n      statusJamiyyah: v.optional(v.string()),\r\n    })),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    const results = [];\r\n    \r\n    for (const school of args.schools) {\r\n      // Check duplicates\r\n      const existing = await ctx.db\r\n        .query(\"schools\")\r\n        .withIndex(\"by_nsm\", (q) => q.eq(\"nsm\", school.nsm))\r\n        .first();\r\n      \r\n      if (!existing) {\r\n        const id = await ctx.db.insert(\"schools\", {\r\n          ...school,\r\n          createdAt: now,\r\n          updatedAt: now,\r\n        });\r\n        results.push(id);\r\n      }\r\n    }\r\n    \r\n    return { count: results.length, ids: results };\r\n  },\r\n});\r\n\r\n// Bulk create school accounts (for initial distribution)\r\nexport const bulkCreateSchoolAccounts = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const schools = await ctx.db.query(\"schools\").collect();\r\n    const results = [];\r\n\r\n    for (const school of schools) {\r\n      if (!school.nsm) continue;\r\n\r\n      const email = `${school.nsm}@maarif.nu`;\r\n      const password = \"123456\"; // Default\r\n      \r\n      let status = \"Existing\";\r\n      \r\n      // Check if user exists\r\n      const existing = await ctx.db\r\n        .query(\"users\")\r\n        .withIndex(\"by_email\", (q) => q.eq(\"email\", email))\r\n        .first();\r\n\r\n      if (!existing) {\r\n        // Create\r\n        await ctx.db.insert(\"users\", {\r\n          email,\r\n          name: `Admin ${school.nama}`,\r\n          passwordHash: hashPassword(password),\r\n          role: \"operator\",\r\n          unit: school.nama,\r\n          isActive: true,\r\n          createdAt: Date.now(),\r\n          updatedAt: Date.now(),\r\n        });\r\n        status = \"Created\";\r\n      } else {\r\n           // Update linkage\r\n           await ctx.db.patch(existing._id, {\r\n               role: \"operator\",\r\n               unit: school.nama,\r\n           });\r\n           status = \"Updated\";\r\n      }\r\n\r\n      results.push({\r\n        nsm: school.nsm,\r\n        nama: school.nama,\r\n        email,\r\n        password: \"123456\",\r\n        status\r\n      });\r\n    }\r\n\r\n    return results;\r\n  }\r\n});\r\n\r\n// Update school profile (Self-service for Operators)\r\nexport const updateSelf = mutation({\r\n  args: {\r\n    email: v.string(), // Added for custom auth\r\n    alamat: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    telepon: v.optional(v.string()),\r\n    // email: v.optional(v.string()), // Conflict with arg? No, school email field vs user email arg.\r\n    // actually args.email is the identifying email.\r\n    // But we also allow updating the school's email field.\r\n    schoolEmail: v.optional(v.string()), // Renamed from email to avoid conflict\r\n    kepalaMadrasah: v.optional(v.string()),\r\n    akreditasi: v.optional(v.string()),\r\n    npsn: v.optional(v.string()),\r\n    statusJamiyyah: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // const identity = await ctx.auth.getUserIdentity(); // Disabled\r\n    const email = args.email;\r\n\r\n    const user = await ctx.db\r\n      .query(\"users\")\r\n      .withIndex(\"by_email\", (q) => q.eq(\"email\", email))\r\n      .first();\r\n\r\n    if (!user || user.role !== \"operator\" || !user.unit) {\r\n      throw new Error(\"Unauthorized: Only operators can update their school profile.\");\r\n    }\r\n\r\n    // Find the school by name (user.unit)\r\n    // 1. Exact match\r\n    let school = await ctx.db\r\n      .query(\"schools\")\r\n      .filter(q => q.eq(q.field(\"nama\"), user.unit))\r\n      .first();\r\n\r\n    const unitName = user.unit || \"\";\r\n\r\n    // 2. Fallback: NSM\r\n    if (!school && /^\\d+$/.test(unitName)) {\r\n         school = await ctx.db\r\n            .query(\"schools\")\r\n            .withIndex(\"by_nsm\", q => q.eq(\"nsm\", unitName))\r\n            .first();\r\n    }\r\n\r\n    // 3. Fallback: Search\r\n    if (!school && unitName) {\r\n        school = await ctx.db\r\n            .query(\"schools\")\r\n            .withSearchIndex(\"search_schools\", q => q.search(\"nama\", unitName))\r\n            .first();\r\n    }\r\n\r\n    if (!school) {\r\n       throw new Error(`School not found: ${user.unit}`);\r\n    }\r\n\r\n    const updates: any = {\r\n        updatedAt: Date.now()\r\n    };\r\n    \r\n    if (args.alamat !== undefined) updates.alamat = args.alamat;\r\n    if (args.kecamatan !== undefined) updates.kecamatan = args.kecamatan;\r\n    if (args.telepon !== undefined) updates.telepon = args.telepon;\r\n    if (args.schoolEmail !== undefined) updates.email = args.schoolEmail;\r\n    if (args.kepalaMadrasah !== undefined) updates.kepalaMadrasah = args.kepalaMadrasah;\r\n    if (args.akreditasi !== undefined) updates.akreditasi = args.akreditasi;\r\n    if (args.npsn !== undefined) updates.npsn = args.npsn;\r\n    if (args.statusJamiyyah !== undefined) updates.statusJamiyyah = args.statusJamiyyah;\r\n\r\n    await ctx.db.patch(school._id, updates);\r\n\r\n    return school._id;\r\n  },\r\n});\r\n\r\n// Get school count\r\nexport const count = query({\r\n  handler: async (ctx) => {\r\n    const schools = await ctx.db.query(\"schools\").collect();\r\n    return schools.length;\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\sk.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":108,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":108,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3162,3165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3162,3165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":164,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4933,4936],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4933,4936],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":176,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":176,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5484,5487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5484,5487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":238,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7162,7165],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7162,7165],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":285,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":285,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8395,8398],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8395,8398],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { query, mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\n// Get all SK documents with optional filters\r\nexport const list = query({\r\n  args: {\r\n    jenisSk: v.optional(v.string()),\r\n    status: v.optional(v.string()),\r\n    unitKerja: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let docs = await ctx.db.query(\"skDocuments\").collect();\r\n    \r\n    // Filter out archived SK (so Reset Data works)\r\n    docs = docs.filter(sk => sk.status !== \"archived\");\r\n    \r\n    // Apply filters\r\n    if (args.jenisSk && args.jenisSk !== \"all\") {\r\n      docs = docs.filter(sk => sk.jenisSk === args.jenisSk);\r\n    }\r\n    \r\n    if (args.status && args.status !== \"all\") {\r\n      docs = docs.filter(sk => sk.status === args.status);\r\n    }\r\n    \r\n    if (args.unitKerja) {\r\n      docs = docs.filter(sk => sk.unitKerja === args.unitKerja);\r\n    }\r\n    \r\n    return docs;\r\n  },\r\n});\r\n\r\n// Get single SK by ID\r\nexport const get = query({\r\n  args: { id: v.id(\"skDocuments\") },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db.get(args.id);\r\n  },\r\n});\r\n\r\n// Get SK by nomor\r\nexport const getByNomor = query({\r\n  args: { nomorSk: v.string() },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db\r\n      .query(\"skDocuments\")\r\n      .withIndex(\"by_nomor\", (q) => q.eq(\"nomorSk\", args.nomorSk))\r\n      .first();\r\n  },\r\n});\r\n\r\n// Get SK by teacher ID\r\nexport const getByTeacher = query({\r\n  args: { teacherId: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db\r\n      .query(\"skDocuments\")\r\n      .withIndex(\"by_teacher\", (q) => q.eq(\"teacherId\", args.teacherId))\r\n      .collect();\r\n  },\r\n});\r\n\r\n// Create new SK\r\nexport const create = mutation({\r\n  args: {\r\n    nomorSk: v.string(),\r\n    jenisSk: v.string(),\r\n    teacherId: v.optional(v.id(\"teachers\")),\r\n    nama: v.string(),\r\n    jabatan: v.optional(v.string()),\r\n    unitKerja: v.optional(v.string()),\r\n    tanggalPenetapan: v.string(),\r\n    status: v.optional(v.string()),\r\n    fileUrl: v.optional(v.string()),\r\n    qrCode: v.optional(v.string()),\r\n    createdBy: v.optional(v.string()), //  CHANGED to optional string (fix for bulk upload)\r\n  },\r\n  handler: async (ctx, args) => {\r\n    try {\r\n      const now = Date.now();\r\n      \r\n      // Check if nomor SK already exists\r\n      const existing = await ctx.db\r\n        .query(\"skDocuments\")\r\n        .withIndex(\"by_nomor\", (q) => q.eq(\"nomorSk\", args.nomorSk))\r\n        .first();\r\n      \r\n      if (existing) {\r\n        console.log(`Duplicate Nomor SK: ${args.nomorSk}, Updating existing record...`);\r\n        // UPSERT LOGIC: Update existing instead of throwing\r\n        await ctx.db.patch(existing._id, {\r\n            ...args,\r\n            updatedAt: now,\r\n            // Keep original createdAt and createdBy if not provided?\r\n            // Overwriting is safer for \"regeneration\" context\r\n        });\r\n        return existing._id;\r\n      }\r\n      \r\n      const newId = await ctx.db.insert(\"skDocuments\", {\r\n        ...args,\r\n        status: args.status || \"draft\",\r\n        createdAt: now,\r\n        updatedAt: now,\r\n      });\r\n      return newId;\r\n    } catch (e: any) {\r\n      console.error(\"SK Create Error Details:\", {\r\n        args,\r\n        error: e.message,\r\n        stack: e.stack\r\n      });\r\n      throw e; // Re-throw to be caught by client\r\n    }\r\n  },\r\n});\r\n\r\n// Bulk create SK (for batch generation)\r\nexport const bulkCreate = mutation({\r\n  args: {\r\n    documents: v.array(v.object({\r\n      nomorSk: v.string(),\r\n      jenisSk: v.string(),\r\n      teacherId: v.optional(v.id(\"teachers\")),\r\n      nama: v.string(),\r\n      jabatan: v.optional(v.string()),\r\n      unitKerja: v.optional(v.string()),\r\n      tanggalPenetapan: v.string(),\r\n      status: v.optional(v.string()),\r\n      fileUrl: v.optional(v.string()),\r\n      qrCode: v.optional(v.string()),\r\n    })),\r\n    createdBy: v.string(), // Changed from v.id(\"users\") to v.string() to match schema and single create\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    const results = [];\r\n    const errors = [];\r\n    \r\n    console.log(`Starting bulkCreate for ${args.documents.length} documents by ${args.createdBy}`);\r\n    \r\n    try {\r\n      for (const doc of args.documents) {\r\n        try {\r\n          // Check duplicates\r\n          const existing = await ctx.db\r\n            .query(\"skDocuments\")\r\n            .withIndex(\"by_nomor\", (q) => q.eq(\"nomorSk\", doc.nomorSk))\r\n            .first();\r\n          \r\n          if (!existing) {\r\n            const id = await ctx.db.insert(\"skDocuments\", {\r\n              ...doc,\r\n              status: doc.status || \"active\",\r\n              createdBy: args.createdBy,\r\n              createdAt: now,\r\n              updatedAt: now,\r\n            });\r\n            results.push(id);\r\n          } else {\r\n            console.log(`Skipping duplicate SK: ${doc.nomorSk}`);\r\n          }\r\n        } catch (innerError: any) {\r\n          console.error(`Error processing SK ${doc.nomorSk}:`, innerError);\r\n          errors.push({ nomor: doc.nomorSk, error: innerError.message });\r\n        }\r\n      }\r\n      \r\n      console.log(`Bulk Create finished. Created: ${results.length}, Errors: ${errors.length}`);\r\n      \r\n      // If we have mixed results, we return success count, but maybe we should warn?\r\n      // For now, return standard format.\r\n      return { count: results.length, ids: results, errors: errors.length > 0 ? errors : undefined };\r\n      \r\n    } catch (e: any) {\r\n      console.error(\"Critical Error in bulkCreate:\", e);\r\n      throw new Error(`Bulk Create Failed: ${e.message}`);\r\n    }\r\n  },\r\n});\r\n\r\n// Update SK\r\nexport const update = mutation({\r\n  args: {\r\n    id: v.id(\"skDocuments\"),\r\n    nomorSk: v.optional(v.string()),\r\n    jenisSk: v.optional(v.string()),\r\n    teacherId: v.optional(v.id(\"teachers\")),\r\n    nama: v.optional(v.string()),\r\n    jabatan: v.optional(v.string()),\r\n    unitKerja: v.optional(v.string()),\r\n    tanggalPenetapan: v.optional(v.string()),\r\n    status: v.optional(v.string()),\r\n    fileUrl: v.optional(v.string()),\r\n    qrCode: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const { id, ...updates } = args;\r\n    \r\n    await ctx.db.patch(id, {\r\n      ...updates,\r\n      updatedAt: Date.now(),\r\n    });\r\n    \r\n    return id;\r\n  },\r\n});\r\n\r\n// Archive SK (soft delete)\r\nexport const archive = mutation({\r\n  args: { id: v.id(\"skDocuments\") },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.patch(args.id, {\r\n      status: \"archived\",\r\n      updatedAt: Date.now(),\r\n    });\r\n  },\r\n});\r\n\r\n// Hard delete all SK documents (for true cleanup)\r\nexport const cleanupAll = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    console.log(\"Starting cleanupAll...\");\r\n    try {\r\n      const allDocs = await ctx.db.query(\"skDocuments\").collect();\r\n      console.log(`Found ${allDocs.length} documents to delete.`);\r\n      \r\n      let deleted = 0;\r\n      for (const doc of allDocs) {\r\n        await ctx.db.delete(doc._id);\r\n        deleted++;\r\n      }\r\n      console.log(`Successfully deleted ${deleted} documents.`);\r\n      \r\n      return { count: allDocs.length };\r\n    } catch (e: any) {\r\n      console.error(\"Error in cleanupAll:\", e);\r\n      throw new Error(`Delete failed: ${e.message}`);\r\n    }\r\n  },\r\n});\r\n\r\nexport const testHello = query({\r\n  args: {},\r\n  handler: async () => {\r\n    return \"Hello from SK module\";\r\n  }\r\n});\r\n\r\n// Archive all SK documents (for reset functionality)\r\nexport const archiveAll = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const allDocs = await ctx.db.query(\"skDocuments\").collect();\r\n    const now = Date.now();\r\n    \r\n    for (const doc of allDocs) {\r\n      await ctx.db.patch(doc._id, {\r\n        status: \"archived\",\r\n        updatedAt: now,\r\n      });\r\n    }\r\n    \r\n    return { count: allDocs.length };\r\n  },\r\n});\r\n\r\n// Batch update SK status (for batch approval/rejection)\r\nexport const batchUpdateStatus = mutation({\r\n  args: {\r\n    ids: v.array(v.id(\"skDocuments\")),\r\n    status: v.string(), // \"approved\" or \"rejected\"\r\n    rejectionReason: v.optional(v.string()),\r\n    currentUserId: v.optional(v.id(\"users\")), // For notifications\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const updatedCount = args.ids.length;\r\n    \r\n    for (const id of args.ids) {\r\n      const sk = await ctx.db.get(id);\r\n      if (!sk) continue;\r\n      \r\n      const updateData: any = {\r\n        status: args.status,\r\n        updatedAt: Date.now(),\r\n      };\r\n      \r\n      // Add rejection reason if provided\r\n      if (args.status === \"rejected\" && args.rejectionReason) {\r\n        updateData.rejectionReason = args.rejectionReason;\r\n      }\r\n      \r\n      await ctx.db.patch(id, updateData);\r\n      \r\n      //  Notification: Notify SK creator\r\n      if (sk.createdBy && args.status !== \"draft\") {\r\n        try {\r\n          const users = await ctx.db.query(\"users\").collect();\r\n          const targetUser = users.find(u => u.email === sk.createdBy || u._id === sk.createdBy);\r\n          \r\n          if (targetUser) {\r\n            const type = args.status === \"approved\" ? \"sk_approved\" : \"sk_rejected\";\r\n            const title = args.status === \"approved\" ? \"SK Disetujui\" : \"SK Ditolak\";\r\n            let message = `SK No. ${sk.nomorSk} untuk ${sk.nama} telah ${args.status === \"approved\" ? \"disetujui\" : \"ditolak\"}`;\r\n            \r\n            if (args.status === \"rejected\" && args.rejectionReason) {\r\n              message += `: ${args.rejectionReason}`;\r\n            }\r\n            \r\n            await ctx.db.insert(\"notifications\", {\r\n              userId: targetUser._id,\r\n              type,\r\n              title,\r\n              message,\r\n              isRead: false,\r\n              metadata: { skId: id, rejectionReason: args.rejectionReason },\r\n              createdAt: Date.now(),\r\n            });\r\n          }\r\n        } catch (error) {\r\n          console.error(\"Notification error:\", error);\r\n        }\r\n      }\r\n    }\r\n    \r\n    //  Notification: Batch summary to current user\r\n    if (args.currentUserId && updatedCount > 0) {\r\n      try {\r\n        await ctx.db.insert(\"notifications\", {\r\n          userId: args.currentUserId,\r\n          type: \"batch_complete\",\r\n          title: \"Batch Operation Selesai\",\r\n          message: `${updatedCount} SK berhasil di-${args.status === \"approved\" ? \"setujui\" : \"tolak\"}`,\r\n          isRead: false,\r\n          metadata: { batchCount: updatedCount },\r\n          createdAt: Date.now(),\r\n        });\r\n      } catch (error) {\r\n        console.error(\"Batch notification error:\", error);\r\n      }\r\n    }\r\n    \r\n    return { count: updatedCount };\r\n  },\r\n});\r\n\r\n// Get SK count by status\r\nexport const countByStatus = query({\r\n  args: {\r\n    status: v.optional(v.string()),\r\n    jenisSk: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let docs = await ctx.db.query(\"skDocuments\").collect();\r\n    \r\n    if (args.status) {\r\n      docs = docs.filter(sk => sk.status === args.status);\r\n    }\r\n    \r\n    if (args.jenisSk) {\r\n      docs = docs.filter(sk => sk.jenisSk === args.jenisSk);\r\n    }\r\n    \r\n    return docs.length;\r\n  },\r\n});\r\n\r\n// Delete teacher (used by SK Generator queue cleanup)\r\nexport const deleteTeacher = mutation({\r\n  args: { id: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    const exists = await ctx.db.get(args.id);\r\n    if (exists) {\r\n        await ctx.db.delete(args.id);\r\n    }\r\n  },\r\n});\r\n\r\nexport const deleteAllTeachers = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const teachers = await ctx.db.query(\"teachers\").collect();\r\n    for (const t of teachers) {\r\n      await ctx.db.delete(t._id);\r\n    }\r\n  },\r\n});\r\n\r\n// Get teachers (The Queue for SK Generation)\r\nexport const getTeachersWithSk = query({\r\n  args: {\r\n    isVerified: v.optional(v.boolean()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // fetches ALL teachers currently in the \"teachers\" table (the queue)\r\n    const teachers = await ctx.db.query(\"teachers\").order(\"desc\").collect();\r\n    \r\n    // 1. Filter out teachers who already have SK generated (Soft Cleanup)\r\n    let filteredTeachers = teachers.filter(t => (t.isSkGenerated !== true));\r\n\r\n    // 2. Filter based on verification status if provided\r\n    if (args.isVerified !== undefined) {\r\n        filteredTeachers = filteredTeachers.filter(t => {\r\n            // Treat undefined/null as false (Unverified)\r\n            const isVerified = t.isVerified === true; \r\n            return isVerified === args.isVerified;\r\n        });\r\n    }\r\n    \r\n    return filteredTeachers;\r\n  },\r\n});\r\n\r\n// Mark teacher as having SK generated (Available for historical record but hidden from generator)\r\nexport const markTeacherAsGenerated = mutation({\r\n  args: { id: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    const teacher = await ctx.db.get(args.id);\r\n    await ctx.db.patch(args.id, { isSkGenerated: true });\r\n\r\n    // Log the activity\r\n    if (teacher) {\r\n        await ctx.db.insert(\"activity_logs\", {\r\n            user: \"System\",\r\n            role: \"system\",\r\n            action: \"Generate SK\",\r\n            details: `SK Generated for ${teacher.nama}`,\r\n            timestamp: Date.now(),\r\n        });\r\n    }\r\n  },\r\n});\r\n\r\n// Verify Teacher (Move from Dashboard to Generator)\r\nexport const verifyTeacher = mutation({\r\n  args: { id: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.patch(args.id, { isVerified: true });\r\n  },\r\n});\r\n\r\n// Reject teacher (from Queue) with feedback\r\nexport const rejectTeacher = mutation({\r\n  args: { \r\n    id: v.id(\"teachers\"), \r\n    reason: v.string(),\r\n    rejectedBy: v.optional(v.id(\"users\"))\r\n  },\r\n  handler: async (ctx, args) => {\r\n    // 1. Get teacher data\r\n    const teacher = await ctx.db.get(args.id);\r\n    if (!teacher) throw new Error(\"Teacher not found\");\r\n\r\n    // 2. Mark as NOT verified (ensure false)\r\n    await ctx.db.patch(args.id, { \r\n        isVerified: false,\r\n        // We might want to add a status field on teacher later like 'verificationStatus': 'rejected'\r\n        // For now, rely on notifications or Activity Log\r\n    });\r\n\r\n    // 3. Send Notification to Operator/Creator if possible?\r\n    // Since Teacher table doesn't track \"createdBy\" user ID (yet), we might need to rely on \"Unit Kerja\" match or later add createdBy.\r\n    // For now, maybe just Log it. Or if we have email.\r\n    \r\n    // 4. Log Activity\r\n    await ctx.db.insert(\"activity_logs\", {\r\n        user: args.rejectedBy ? \"Admin\" : \"System\",\r\n        role: \"admin\",\r\n        action: \"Reject Verification\",\r\n        details: `Rejection for ${teacher.nama}: ${args.reason}`,\r\n        timestamp: Date.now(),\r\n    });\r\n\r\n    // 5. Store \"Rejection Reason\" on Teacher?\r\n    // Maybe we need a `metadata` or `verificationNote` field on Teacher?\r\n    // Let's assume we don't modify schema too much.\r\n  },\r\n});\r\n\r\nexport const bulkVerifyTeachers = mutation({\r\n  args: { ids: v.array(v.id(\"teachers\")) },\r\n  handler: async (ctx, args) => {\r\n    for (const id of args.ids) {\r\n        await ctx.db.patch(id, { isVerified: true });\r\n    }\r\n  },\r\n});\r\n\r\nexport const deleteAllSk = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const sks = await ctx.db.query(\"skDocuments\").collect();\r\n    for (const sk of sks) {\r\n      await ctx.db.delete(sk._id);\r\n    }\r\n    return { count: sks.length };\r\n  },\r\n});\r\n\r\n\r\nexport const debugListAllTeachers = query({\r\n    args: {},\r\n    handler: async (ctx) => {\r\n        return await ctx.db.query(\"teachers\").collect();\r\n    }\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\students.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\teachers.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":376,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":376,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12563,12566],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12563,12566],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":215,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":215,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6509,6512],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6509,6512],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { query, mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\n// Get all teachers with optional filters\r\nexport const list = query({\r\n  args: {\r\n    unitKerja: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    isCertified: v.optional(v.string()),\r\n    userEmail: v.optional(v.string()), // For RBAC\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let teachers = await ctx.db\r\n      .query(\"teachers\")\r\n      .withIndex(\"by_active\", (q) => q.eq(\"isActive\", true))\r\n      .collect();\r\n    \r\n    // RBAC: Check identity\r\n    const identity = await ctx.auth.getUserIdentity();\r\n    const email = identity?.email || args.userEmail;\r\n\r\n    if (!email) {\r\n        // Fallback: If no email provided, check if strict mode is needed.\r\n        // For development/migration, we might allow, but for security we should RESTRICT.\r\n        // Let's return empty array if no auth info to prevent leak.\r\n        // return []; \r\n        // OR Throw Error?\r\n        // throw new Error(\"Unauthorized: Identity required\");\r\n        // To be safe for now without breaking everything immediately if I miss a file:\r\n        // Use \"Open\" but log? No, \"Secure by Default\".\r\n        // I will return EMPTY if not identified.\r\n        return [];\r\n    }\r\n\r\n    if (email) {\r\n       const user = await ctx.db\r\n         .query(\"users\")\r\n         .withIndex(\"by_email\", (q) => q.eq(\"email\", email))\r\n         .first();\r\n\r\n       if (user) {\r\n           if (user.role === \"operator\" && user.unit) {\r\n               // Strict filter for operators\r\n               teachers = teachers.filter(t => t.unitKerja === user.unit);\r\n           }\r\n           // Admins see all\r\n       } else {\r\n           // User not found in DB? Treat as unauthenticated.\r\n           return [];\r\n       }\r\n    }\r\n\r\n    // Apply filters\r\n    if (args.unitKerja && args.unitKerja !== \"all\") {\r\n      // Case-insensitive match for unitKerja\r\n      const searchUnit = args.unitKerja.toLowerCase().trim();\r\n      teachers = teachers.filter(t => \r\n        t.unitKerja?.toLowerCase().trim() === searchUnit\r\n      );\r\n    }\r\n    \r\n    if (args.kecamatan && args.kecamatan !== \"all\") {\r\n      teachers = teachers.filter(t => t.kecamatan === args.kecamatan);\r\n    }\r\n    \r\n    if (args.isCertified && args.isCertified !== \"all\") {\r\n      const certified = args.isCertified === \"true\";\r\n      teachers = teachers.filter(t => t.isCertified === certified);\r\n    }\r\n    \r\n    return teachers;\r\n  },\r\n});\r\n\r\n// Get single teacher by ID\r\nexport const get = query({\r\n  args: { id: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db.get(args.id);\r\n  },\r\n});\r\n\r\n// Get teacher by NUPTK\r\nexport const getByNuptk = query({\r\n  args: { nuptk: v.string() },\r\n  handler: async (ctx, args) => {\r\n    return await ctx.db\r\n      .query(\"teachers\")\r\n      .withIndex(\"by_nuptk\", (q) => q.eq(\"nuptk\", args.nuptk))\r\n      .first();\r\n  },\r\n});\r\n\r\n// Create new teacher\r\nexport const create = mutation({\r\n  args: {\r\n    nuptk: v.string(),\r\n    nama: v.string(),\r\n    nip: v.optional(v.string()),\r\n    jenisKelamin: v.optional(v.string()),\r\n    tempatLahir: v.optional(v.string()),\r\n    tanggalLahir: v.optional(v.string()),\r\n    pendidikanTerakhir: v.optional(v.string()),\r\n    mapel: v.optional(v.string()),\r\n    unitKerja: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    status: v.optional(v.string()),\r\n    tmt: v.optional(v.string()),  // NEW: Tanggal Mulai Tugas\r\n    isCertified: v.optional(v.boolean()),\r\n    phoneNumber: v.optional(v.string()),\r\n    email: v.optional(v.string()),\r\n    isActive: v.optional(v.boolean()),\r\n    pdpkpnu: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    \r\n    // Check for duplicate NUPTK\r\n    const existing = await ctx.db\r\n      .query(\"teachers\")\r\n      .withIndex(\"by_nuptk\", (q) => q.eq(\"nuptk\", args.nuptk))\r\n      .first();\r\n    \r\n    if (existing) {\r\n      throw new Error(`Teacher with NUPTK ${args.nuptk} already exists`);\r\n    }\r\n    \r\n    return await ctx.db.insert(\"teachers\", {\r\n      ...args,\r\n      isActive: args.isActive ?? true,\r\n      createdAt: now,\r\n      updatedAt: now,\r\n    });\r\n  },\r\n});\r\n\r\n// Update teacher\r\nexport const update = mutation({\r\n  args: {\r\n    id: v.id(\"teachers\"),\r\n    nuptk: v.optional(v.string()),\r\n    nama: v.optional(v.string()),\r\n    nip: v.optional(v.string()),\r\n    jenisKelamin: v.optional(v.string()),\r\n    tempatLahir: v.optional(v.string()),\r\n    tanggalLahir: v.optional(v.string()),\r\n    pendidikanTerakhir: v.optional(v.string()),\r\n    mapel: v.optional(v.string()),\r\n    unitKerja: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n    status: v.optional(v.string()),\r\n    tmt: v.optional(v.string()),  // NEW: Tanggal Mulai Tugas\r\n    isCertified: v.optional(v.boolean()),\r\n    phoneNumber: v.optional(v.string()),\r\n    email: v.optional(v.string()),\r\n    isActive: v.optional(v.boolean()),\r\n    pdpkpnu: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const { id, ...updates } = args;\r\n    \r\n    await ctx.db.patch(id, {\r\n      ...updates,\r\n      updatedAt: Date.now(),\r\n    });\r\n    \r\n    return id;\r\n  },\r\n});\r\n\r\n// Delete teacher (soft delete)\r\nexport const remove = mutation({\r\n  args: { id: v.id(\"teachers\") },\r\n  handler: async (ctx, args) => {\r\n    await ctx.db.patch(args.id, {\r\n      isActive: false,\r\n      updatedAt: Date.now(),\r\n    });\r\n  },\r\n});\r\n\r\n// Bulk delete all teachers (hard delete)\r\nexport const bulkDelete = mutation({\r\n  args: {},\r\n  handler: async (ctx) => {\r\n    const allTeachers = await ctx.db.query(\"teachers\").collect();\r\n    for (const teacher of allTeachers) {\r\n      await ctx.db.delete(teacher._id);\r\n    }\r\n    return { count: allTeachers.length };\r\n  },\r\n});\r\n\r\n// Bulk create teachers (for import) - ULTRA FLEXIBLE VERSION\r\nexport const bulkCreate = mutation({\r\n  args: {\r\n    teachers: v.array(v.any()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    const results = [];\r\n    const errors = [];\r\n    \r\n    for (const teacher of args.teachers) {\r\n      try {\r\n        // Ensure required fields exist\r\n        if (!teacher.nuptk || !teacher.nama) {\r\n          results.push(null);\r\n          errors.push(`Missing required fields for: ${teacher.nama || 'Unknown'}`);\r\n          continue;\r\n        }\r\n        \r\n        // Filter out null/undefined values\r\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n        const cleanData: any = {\r\n          nuptk: String(teacher.nuptk),\r\n          nama: String(teacher.nama),\r\n        };\r\n        \r\n        // Map optional fields\r\n        if (teacher.status) cleanData.status = teacher.status;\r\n        if (teacher.unitKerja) cleanData.unitKerja = teacher.unitKerja;\r\n        else if (teacher.satminkal) cleanData.unitKerja = teacher.satminkal; // Fallback for legacy\r\n        \r\n        if (teacher.pendidikanTerakhir) cleanData.pendidikanTerakhir = teacher.pendidikanTerakhir;\r\n        if (teacher.tmt) cleanData.tmt = teacher.tmt;\r\n        if (teacher.kecamatan) cleanData.kecamatan = teacher.kecamatan;\r\n        if (teacher.mapel) cleanData.mapel = teacher.mapel;\r\n        if (teacher.phoneNumber) cleanData.phoneNumber = teacher.phoneNumber;\r\n        if (teacher.email) cleanData.email = teacher.email;\r\n        if (teacher.isCertified !== undefined) cleanData.isCertified = teacher.isCertified;\r\n        if (teacher.isVerified !== undefined) cleanData.isVerified = teacher.isVerified; // NEW\r\n        if (teacher.pdpkpnu) cleanData.pdpkpnu = teacher.pdpkpnu;\r\n        \r\n        // Identity\r\n        if (teacher.tempatLahir) cleanData.tempatLahir = teacher.tempatLahir;\r\n        if (teacher.tanggalLahir) cleanData.tanggalLahir = teacher.tanggalLahir;\r\n        if (teacher.nip) cleanData.nip = teacher.nip;\r\n        if (teacher.jenisKelamin) cleanData.jenisKelamin = teacher.jenisKelamin;\r\n        if (teacher.birthPlace) cleanData.tempatLahir = teacher.birthPlace; // Fallback\r\n        if (teacher.birthDate) cleanData.tanggalLahir = teacher.birthDate; // Fallback\r\n\r\n        // Check for duplicate\r\n        const existing = await ctx.db\r\n            .query(\"teachers\")\r\n            .withIndex(\"by_nuptk\", (q) => q.eq(\"nuptk\", teacher.nuptk))\r\n            .first();\r\n        \r\n        try {\r\n            if (!existing) {\r\n                const id = await ctx.db.insert(\"teachers\", {\r\n                    ...cleanData,\r\n                    isActive: true,\r\n                    createdAt: now,\r\n                    updatedAt: now,\r\n                });\r\n                results.push(id);\r\n            } else {\r\n                // UPDATE EXISTING RECORD (UPSERT)\r\n                // This allows re-importing to fix missing fields or update data\r\n                await ctx.db.patch(existing._id, {\r\n                    ...cleanData,\r\n                    updatedAt: now,\r\n                });\r\n                results.push(existing._id);\r\n            }\r\n        } catch (err) {\r\n            results.push(null);\r\n            errors.push(`Error for ${teacher.nama}: ${(err as Error).message}`);\r\n        }\r\n      } catch (err) {\r\n        results.push(null);\r\n        errors.push(`Error for ${teacher.nama || 'Unknown'}: ${(err as Error).message}`);\r\n      }\r\n    }\r\n    \r\n    return { \r\n      count: results.filter(id => id !== null).length, \r\n      ids: results,\r\n      errors: errors.length > 0 ? errors : undefined,\r\n      version: \"2.0 (Fix Upsert)\" \r\n    };\r\n  },\r\n});\r\n\r\n// Get teacher count by filters\r\nexport const count = query({\r\n  args: {\r\n    unitKerja: v.optional(v.string()),\r\n    kecamatan: v.optional(v.string()),\r\n  },\r\n  handler: async (ctx, args) => {\r\n    let teachers = await ctx.db\r\n      .query(\"teachers\")\r\n      .withIndex(\"by_active\", (q) => q.eq(\"isActive\", true))\r\n      .collect();\r\n    \r\n    if (args.unitKerja) {\r\n      teachers = teachers.filter(t => t.unitKerja === args.unitKerja);\r\n    }\r\n    \r\n    if (args.kecamatan) {\r\n      teachers = teachers.filter(t => t.kecamatan === args.kecamatan);\r\n    }\r\n    \r\n    return teachers.length;\r\n  },\r\n});\r\n\r\n// NEW: Robust Import Mutation (Replaces bulkCreate)\r\nexport const importTeachers = mutation({\r\n  args: {\r\n    teachers: v.array(v.any()), // Accept loose JSON to prevent validation errors before processing\r\n  },\r\n  handler: async (ctx, args) => {\r\n    const now = Date.now();\r\n    let success = 0;\r\n    let updated = 0;\r\n    const errors: string[] = [];\r\n\r\n    for (const t of args.teachers) {\r\n      try {\r\n        // 1. Sanitize & Normalize Data\r\n        const nuptk = String(t.nuptk || t.NUPTK || \"\").trim();\r\n        const nama = String(t.nama || t.NAMA || t.Name || \"\").trim();\r\n\r\n        if (!nuptk || !nama) continue; // Skip invalid rows\r\n\r\n        // Map Fields (Prioritize New Names, Fallback to Old/Excel Names)\r\n        const unit = t.unitKerja || t.satminkal || t.SATMINKAL || t['Unit Kerja'] || t.sekolah || \"\";\r\n        const status = t.status || t.STATUS || t.Status || \"GTT\";\r\n        const tmt = t.tmt || t.TMT || \"\";\r\n        const pendidikan = t.pendidikanTerakhir || t.pendidikan || t.PENDIDIKAN || \"\";\r\n        const mapel = t.mapel || t.MAPEL || t.jabatan || \"\";\r\n        \r\n        const cleanData = {\r\n          nuptk,\r\n          nama,\r\n          unitKerja: unit,\r\n          status: status,\r\n          tmt: tmt,\r\n          pendidikanTerakhir: pendidikan,\r\n          mapel: mapel,\r\n          // Optional identitas\r\n          nip: t.nip || t.NIP || undefined,\r\n          tempatLahir: t.tempatLahir || t.birthPlace || undefined,\r\n          tanggalLahir: t.tanggalLahir || t.birthDate || undefined,\r\n          jenisKelamin: t.jenisKelamin || t.jk || undefined,\r\n          pdpkpnu: t.pdpkpnu || \"Belum\",\r\n          isCertified: t.isCertified === true || t.isCertified === \"true\",\r\n          \r\n          updatedAt: now,\r\n        };\r\n\r\n        // 2. Check Existing\r\n        const existing = await ctx.db\r\n          .query(\"teachers\")\r\n          .withIndex(\"by_nuptk\", q => q.eq(\"nuptk\", nuptk))\r\n          .first();\r\n\r\n        if (existing) {\r\n          // UPSERT (Update)\r\n          await ctx.db.patch(existing._id, cleanData);\r\n          updated++;\r\n        } else {\r\n          // INSERT (New)\r\n          // Convex requires all fields to match schema structure\r\n          // We spread cleanData and ensure required fields (if any) are present\r\n          await ctx.db.insert(\"teachers\", {\r\n            ...cleanData,\r\n            isActive: true,\r\n            createdAt: now,\r\n          });\r\n          success++;\r\n        }\r\n      } catch (err: any) {\r\n        console.error(`Import Error for ${t.nama}:`, err);\r\n        errors.push(`${t.nama}: ${err.message}`);\r\n      }\r\n    }\r\n\r\n    return { \r\n      count: success + updated, \r\n      new: success, \r\n      updated: updated, \r\n      errors, \r\n      version: \"3.0 (Fresh Import)\" \r\n    };\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\testNotification.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'ctx' is defined but never used.","line":6,"column":19,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'args' is defined but never used.","line":6,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":28}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { mutation } from \"./_generated/server\";\r\nimport { v } from \"convex/values\";\r\n\r\nexport const createTestNotificationById = mutation({\r\n  args: { userId: v.id(\"users\") },\r\n  handler: async (ctx, args) => {\r\n    return \"restored\";\r\n  },\r\n});\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\convex\\verification.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\e2e\\auth.spec.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\generate-template.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\generate-template.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\playwright.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\scripts\\restore_fix.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\SignaturePad.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'onCancel' is defined but never used.","line":9,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":48},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":34,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":34,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1225,1228],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1225,1228],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1661,1664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1661,1664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":22,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":25,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2029,2032],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2029,2032],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useRef, useState, useEffect } from 'react';\r\nimport { Button } from '@/components/ui/button';\r\n\r\ninterface SignaturePadProps {\r\n    onSave: (blob: Blob) => void;\r\n    onCancel: () => void;\r\n}\r\n\r\nexport function SignaturePad({ onSave, onCancel }: SignaturePadProps) {\r\n    const canvasRef = useRef<HTMLCanvasElement>(null);\r\n    const [isDrawing, setIsDrawing] = useState(false);\r\n    const [hasSignature, setHasSignature] = useState(false);\r\n\r\n    useEffect(() => {\r\n        const canvas = canvasRef.current;\r\n        if (canvas) {\r\n            // Set canvas size (simple approach: use offsetWidth/Height)\r\n            // Ideally we wait for layout, but for now simple init\r\n            setTimeout(() => {\r\n                if (canvas.parentElement) {\r\n                     canvas.width = canvas.parentElement.offsetWidth;\r\n                     canvas.height = 300;\r\n                     const ctx = canvas.getContext('2d');\r\n                     if (ctx) {\r\n                        ctx.lineWidth = 2;\r\n                        ctx.lineCap = 'round';\r\n                        ctx.strokeStyle = 'black';\r\n                     }\r\n                }\r\n            }, 100);\r\n        }\r\n    }, []);\r\n\r\n    const getPos = (e: any) => {\r\n        const canvas = canvasRef.current;\r\n        if (!canvas) return { x: 0, y: 0 };\r\n        const rect = canvas.getBoundingClientRect();\r\n        const clientX = e.touches ? e.touches[0].clientX : e.clientX;\r\n        const clientY = e.touches ? e.touches[0].clientY : e.clientY;\r\n        return {\r\n            x: clientX - rect.left,\r\n            y: clientY - rect.top\r\n        };\r\n    };\r\n\r\n    const startDrawing = (e: any) => {\r\n        setIsDrawing(true);\r\n        const ctx = canvasRef.current?.getContext('2d');\r\n        const pos = getPos(e);\r\n        ctx?.beginPath();\r\n        ctx?.moveTo(pos.x, pos.y);\r\n       // e.preventDefault(); // Sometimes blocks clicking, let's see. \r\n       // Generally preventDefault on touch is needed to stop scroll.\r\n    };\r\n\r\n    const draw = (e: any) => {\r\n        if (!isDrawing) return;\r\n        const ctx = canvasRef.current?.getContext('2d');\r\n        const pos = getPos(e);\r\n        ctx?.lineTo(pos.x, pos.y);\r\n        ctx?.stroke();\r\n        setHasSignature(true);\r\n        e.preventDefault();\r\n    };\r\n\r\n    const stopDrawing = () => {\r\n        setIsDrawing(false);\r\n        const ctx = canvasRef.current?.getContext('2d');\r\n        ctx?.closePath();\r\n    };\r\n\r\n    const clear = () => {\r\n        const canvas = canvasRef.current;\r\n        const ctx = canvas?.getContext('2d');\r\n        if (canvas && ctx) {\r\n            ctx.clearRect(0, 0, canvas.width, canvas.height);\r\n            setHasSignature(false);\r\n        }\r\n    };\r\n\r\n    const handleSave = () => {\r\n        canvasRef.current?.toBlob((blob) => {\r\n            if (blob) onSave(blob);\r\n        });\r\n    };\r\n\r\n    return (\r\n        <div className=\"w-full space-y-4\">\r\n            <div className=\"border border-gray-300 rounded-md bg-white touch-none\">\r\n                <canvas\r\n                    ref={canvasRef}\r\n                    className=\"w-full h-[300px] cursor-crosshair block\"\r\n                    onMouseDown={startDrawing}\r\n                    onMouseMove={draw}\r\n                    onMouseUp={stopDrawing}\r\n                    onMouseLeave={stopDrawing}\r\n                    onTouchStart={startDrawing}\r\n                    onTouchMove={draw}\r\n                    onTouchEnd={stopDrawing}\r\n                />\r\n            </div>\r\n            <div className=\"flex justify-between items-center text-sm text-muted-foreground\">\r\n                <p>Tanda tangan di area di atas.</p>\r\n                <div className=\"space-x-2\">\r\n                    <Button type=\"button\" variant=\"outline\" onClick={clear}>Hapus</Button>\r\n                    <Button type=\"button\" onClick={handleSave} disabled={!hasSignature}>Simpan</Button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\approval\\ApprovalTimeline.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'index' is defined but never used.","line":72,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":72,"endColumn":34}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useQuery } from \"convex/react\"\r\nimport { api } from \"../../../convex/_generated/api\"\r\nimport { CheckCircle, XCircle, MessageCircle, FileText, Clock } from \"lucide-react\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { formatDistanceToNow } from \"date-fns\"\r\nimport { id } from \"date-fns/locale\"\r\n\r\ninterface ApprovalTimelineProps {\r\n  documentId: string\r\n}\r\n\r\nexport function ApprovalTimeline({ documentId }: ApprovalTimelineProps) {\r\n  const history = useQuery(api.approvalHistory.getApprovalHistory, {\r\n    documentId: documentId,\r\n  })\r\n\r\n  if (!history || history.length === 0) {\r\n    return (\r\n      <div className=\"text-center py-8 text-muted-foreground\">\r\n        <Clock className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\r\n        <p>Belum ada riwayat approval</p>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const getActionIcon = (action: string) => {\r\n    switch (action) {\r\n      case \"approve\":\r\n        return <CheckCircle className=\"h-5 w-5 text-green-600\" />\r\n      case \"reject\":\r\n        return <XCircle className=\"h-5 w-5 text-red-600\" />\r\n      case \"comment\":\r\n        return <MessageCircle className=\"h-5 w-5 text-blue-600\" />\r\n      default:\r\n        return <FileText className=\"h-5 w-5 text-gray-600\" />\r\n    }\r\n  }\r\n\r\n  const getActionLabel = (action: string) => {\r\n    const labels: Record<string, string> = {\r\n      submit: \"Diajukan\",\r\n      approve: \"Disetujui\",\r\n      reject: \"Ditolak\",\r\n      comment: \"Komentar\",\r\n      update: \"Diupdate\",\r\n      review: \"Direview\",\r\n    }\r\n    return labels[action] || action\r\n  }\r\n\r\n  const getActionColor = (action: string) => {\r\n    switch (action) {\r\n      case \"approve\":\r\n        return \"bg-green-100 border-green-300\"\r\n      case \"reject\":\r\n        return \"bg-red-100 border-red-300\"\r\n      case \"comment\":\r\n        return \"bg-blue-100 border-blue-300\"\r\n      default:\r\n        return \"bg-gray-100 border-gray-300\"\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-2\">\r\n      <h3 className=\"font-semibold text-sm mb-4\">Riwayat Approval</h3>\r\n      \r\n      <div className=\"relative space-y-6\">\r\n        {/* Vertical line */}\r\n        <div className=\"absolute left-5 top-0 bottom-0 w-px bg-gray-200\" />\r\n        \r\n        {history.map((item, index) => (\r\n          <div key={item._id} className=\"relative flex gap-4\">\r\n            {/* Icon circle */}\r\n            <div className={cn(\r\n              \"relative z-10 flex h-10 w-10 items-center justify-center rounded-full border-2\",\r\n              getActionColor(item.action)\r\n            )}>\r\n              {getActionIcon(item.action)}\r\n            </div>\r\n            \r\n            {/* Content */}\r\n            <div className=\"flex-1 pb-4\">\r\n              <div className=\"flex items-start justify-between gap-2\">\r\n                <div>\r\n                  <p className=\"font-medium text-sm\">\r\n                    {getActionLabel(item.action)}\r\n                    {item.toStatus && item.fromStatus && (\r\n                      <span className=\"text-xs text-muted-foreground ml-2\">\r\n                        ({item.fromStatus}  {item.toStatus})\r\n                      </span>\r\n                    )}\r\n                  </p>\r\n                  <p className=\"text-xs text-muted-foreground mt-0.5\">\r\n                    {item.performedByName}\r\n                    {item.performedByRole && (\r\n                      <span className=\"ml-1\">({item.performedByRole})</span>\r\n                    )}\r\n                  </p>\r\n                </div>\r\n                \r\n                <p className=\"text-xs text-muted-foreground whitespace-nowrap\">\r\n                  {formatDistanceToNow(new Date(item.performedAt), {\r\n                    addSuffix: true,\r\n                    locale: id,\r\n                  })}\r\n                </p>\r\n              </div>\r\n              \r\n              {/* Comment/Reason */}\r\n              {item.comment && (\r\n                <div className=\"mt-2 rounded-md bg-gray-50 p-3 text-sm border border-gray-200\">\r\n                  <p className=\"text-gray-700\">{item.comment}</p>\r\n                </div>\r\n              )}\r\n              \r\n              {/* Rejection reason from metadata */}\r\n              {item.metadata?.rejectionReason && !item.comment && (\r\n                <div className=\"mt-2 rounded-md bg-red-50 p-3 text-sm border border-red-200\">\r\n                  <p className=\"text-red-700\">\r\n                    <span className=\"font-medium\">Alasan penolakan:</span> {item.metadata.rejectionReason}\r\n                  </p>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\Can.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\DuplicateIndicator.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":17,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":17,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[432,435],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[432,435],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { AlertTriangle } from 'lucide-react';\r\nimport {\r\n  Tooltip,\r\n  TooltipContent,\r\n  TooltipProvider,\r\n  TooltipTrigger,\r\n} from '@/components/ui/tooltip';\r\n\r\ninterface DuplicateIndicatorProps {\r\n  type?: 'NUPTK' | 'NIK' | 'NSM' | 'NPSN' | 'Name+School';\r\n  count?: number;\r\n  records?: Array<{\r\n    id: string;\r\n    nama: string;\r\n    [key: string]: any;\r\n  }>;\r\n}\r\n\r\n/**\r\n * Badge indicator for duplicate data\r\n */\r\nexport const DuplicateIndicator: React.FC<DuplicateIndicatorProps> = ({\r\n  type,\r\n  count = 0,\r\n  records = [],\r\n}) => {\r\n  if (!type || count === 0) return null;\r\n\r\n  const getMessage = () => {\r\n    switch (type) {\r\n      case 'NUPTK':\r\n        return `Duplikat NUPTK (${count} data)`;\r\n      case 'NIK':\r\n        return `Duplikat NIK (${count} data)`;\r\n      case 'NSM':\r\n        return `Duplikat NSM (${count} data)`;\r\n      case 'NPSN':\r\n        return `Duplikat NPSN (${count} data)`;\r\n      case 'Name+School':\r\n        return `Duplikat Nama+Sekolah (${count} data)`;\r\n      default:\r\n        return `Duplikat (${count})`;\r\n    }\r\n  };\r\n\r\n  const tooltipContent = (\r\n    <div className=\"max-w-xs\">\r\n      <p className=\"font-semibold mb-1\">{getMessage()}</p>\r\n      <div className=\"space-y-1\">\r\n        {records.slice(0, 3).map((record) => (\r\n          <p key={record.id} className=\"text-xs\">\r\n             {record.nama}\r\n          </p>\r\n        ))}\r\n        {records.length > 3 && (\r\n          <p className=\"text-xs italic\">\r\n            +{records.length - 3} lainnya...\r\n          </p>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n\r\n  return (\r\n    <TooltipProvider>\r\n      <Tooltip>\r\n        <TooltipTrigger>\r\n          <Badge variant=\"destructive\" className=\"ml-2\">\r\n            <AlertTriangle className=\"h-3 w-3 mr-1\" />\r\n            {type}\r\n          </Badge>\r\n        </TooltipTrigger>\r\n        <TooltipContent>{tooltipContent}</TooltipContent>\r\n      </Tooltip>\r\n    </TooltipProvider>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\GlobalErrorBoundary.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\NIKInput.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\components\\common\\NIKInput.tsx:67:7\n  65 |   useEffect(() => {\n  66 |     if (!value) {\n> 67 |       setWarning('');\n     |       ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  68 |       setProvince('');\n  69 |       return;\n  70 |     }","line":67,"column":7,"nodeType":null,"endLine":67,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { AlertCircle, CheckCircle } from 'lucide-react';\r\n\r\ninterface NIKInputProps {\r\n  label?: string;\r\n  value: string;\r\n  onChange: (value: string) => void;\r\n  required?: boolean;\r\n  className?: string;\r\n}\r\n\r\n// Indonesian province codes (first 2 digits of NIK)\r\nconst PROVINCE_CODES: Record<string, string> = {\r\n  '11': 'Aceh',\r\n  '12': 'Sumatra Utara',\r\n  '13': 'Sumatra Barat',\r\n  '14': 'Riau',\r\n  '15': 'Jambi',\r\n  '16': 'Sumatra Selatan',\r\n  '17': 'Bengkulu',\r\n  '18': 'Lampung',\r\n  '19': 'Kepulauan Bangka Belitung',\r\n  '21': 'Kepulauan Riau',\r\n  '31': 'DKI Jakarta',\r\n  '32': 'Jawa Barat',\r\n  '33': 'Jawa Tengah',\r\n  '34': 'DI Yogyakarta',\r\n  '35': 'Jawa Timur',\r\n  '36': 'Banten',\r\n  '51': 'Bali',\r\n  '52': 'Nusa Tenggara Barat',\r\n  '53': 'Nusa Tenggara Timur',\r\n  '61': 'Kalimantan Barat',\r\n  '62': 'Kalimantan Tengah',\r\n  '63': 'Kalimantan Selatan',\r\n  '64': 'Kalimantan Timur',\r\n  '65': 'Kalimantan Utara',\r\n  '71': 'Sulawesi Utara',\r\n  '72': 'Sulawesi Tengah',\r\n  '73': 'Sulawesi Selatan',\r\n  '74': 'Sulawesi Tenggara',\r\n  '75': 'Gorontalo',\r\n  '76': 'Sulawesi Barat',\r\n  '81': 'Maluku',\r\n  '82': 'Maluku Utara',\r\n  '91': 'Papua Barat',\r\n  '94': 'Papua',\r\n};\r\n\r\n/**\r\n * NIK input with Indonesian NIK validation (warning only, doesn't block)\r\n */\r\nexport const NIKInput: React.FC<NIKInputProps> = ({\r\n  label = 'NIK',\r\n  value,\r\n  onChange,\r\n  required = false,\r\n  className = '',\r\n}) => {\r\n  const [warning, setWarning] = useState('');\r\n  const [province, setProvince] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (!value) {\r\n      setWarning('');\r\n      setProvince('');\r\n      return;\r\n    }\r\n\r\n    // Must be exactly 16 digits\r\n    if (!/^[0-9]{16}$/.test(value)) {\r\n      setWarning('NIK harus 16 digit angka');\r\n      setProvince('');\r\n      return;\r\n    }\r\n\r\n    // Check province code (first 2 digits)\r\n    const provinceCode = value.substring(0, 2);\r\n    const provinceName = PROVINCE_CODES[provinceCode];\r\n\r\n    if (!provinceName) {\r\n      setWarning(`Kode provinsi ${provinceCode} tidak valid`);\r\n      setProvince('');\r\n    } else {\r\n      setWarning('');\r\n      setProvince(provinceName);\r\n    }\r\n  }, [value]);\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    // Only allow numbers, max 16 digits\r\n    const cleaned = e.target.value.replace(/\\D/g, '').substring(0, 16);\r\n    onChange(cleaned);\r\n  };\r\n\r\n  const isValid = value.length === 16 && province && !warning;\r\n\r\n  return (\r\n    <div className={className}>\r\n      {label && (\r\n        <Label htmlFor=\"nik-input\">\r\n          {label}\r\n          {required && <span className=\"text-red-500 ml-1\">*</span>}\r\n        </Label>\r\n      )}\r\n      <Input\r\n        id=\"nik-input\"\r\n        type=\"text\"\r\n        value={value}\r\n        onChange={handleChange}\r\n        placeholder=\"16 digit NIK\"\r\n        maxLength={16}\r\n        className={warning ? 'border-yellow-500' : isValid ? 'border-green-500' : ''}\r\n      />\r\n      {warning && (\r\n        <div className=\"flex items-center gap-1 mt-1 text-sm text-yellow-600\">\r\n          <AlertCircle className=\"h-3 w-3\" />\r\n          <span>{warning}</span>\r\n        </div>\r\n      )}\r\n      {isValid && (\r\n        <div className=\"flex items-center gap-1 mt-1 text-sm text-green-600\">\r\n          <CheckCircle className=\"h-3 w-3\" />\r\n          <span>Provinsi: {province}</span>\r\n        </div>\r\n      )}\r\n      <p className=\"text-xs text-gray-500 mt-1\">\r\n        Nomor Induk Kependudukan (16 digit)\r\n      </p>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\NotificationDropdown.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":27,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":27,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[988,991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[988,991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\common\\PhoneInput.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":1,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":36}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { AlertCircle } from 'lucide-react';\r\n\r\ninterface PhoneInputProps {\r\n  label?: string;\r\n  value: string;\r\n  onChange: (value: string) => void;\r\n  error?: string;\r\n  required?: boolean;\r\n  className?: string;\r\n}\r\n\r\n/**\r\n * Phone input with Indonesian format validation\r\n * Auto-converts +62 or 62 to 08\r\n */\r\nexport const PhoneInput: React.FC<PhoneInputProps> = ({\r\n  label = 'No. HP',\r\n  value,\r\n  onChange,\r\n  error: externalError,\r\n  required = false,\r\n  className = '',\r\n}) => {\r\n  const [internalError, setInternalError] = useState('');\r\n\r\n  const validateAndFormat = (input: string) => {\r\n    if (!input) {\r\n      setInternalError('');\r\n      return '';\r\n    }\r\n\r\n    // Remove all non-digit characters\r\n    let cleaned = input.replace(/\\D/g, '');\r\n\r\n    // Convert +62 or 62 to 08\r\n    if (cleaned.startsWith('62')) {\r\n      cleaned = '0' + cleaned.substring(2);\r\n    }\r\n\r\n    // Validate format: 08[0-9]{8,11}\r\n    if (cleaned && !cleaned.startsWith('08')) {\r\n      setInternalError('Nomor HP harus dimulai dengan 08');\r\n    } else if (cleaned.length > 13) {\r\n      setInternalError('Nomor HP maksimal 13 digit');\r\n      cleaned = cleaned.substring(0, 13);\r\n    } else if (cleaned.length > 0 && cleaned.length < 10) {\r\n      setInternalError('Nomor HP minimal 10 digit');\r\n    } else {\r\n      setInternalError('');\r\n    }\r\n\r\n    return cleaned;\r\n  };\r\n\r\n  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const formatted = validateAndFormat(e.target.value);\r\n    onChange(formatted);\r\n  };\r\n\r\n  const displayError = externalError || internalError;\r\n\r\n  return (\r\n    <div className={className}>\r\n      {label && (\r\n        <Label htmlFor=\"phone-input\">\r\n          {label}\r\n          {required && <span className=\"text-red-500 ml-1\">*</span>}\r\n        </Label>\r\n      )}\r\n      <Input\r\n        id=\"phone-input\"\r\n        type=\"tel\"\r\n        value={value}\r\n        onChange={handleChange}\r\n        placeholder=\"08xxxxxxxxxx\"\r\n        className={displayError ? 'border-red-500' : ''}\r\n      />\r\n      {displayError && (\r\n        <div className=\"flex items-center gap-1 mt-1 text-sm text-red-500\">\r\n          <AlertCircle className=\"h-3 w-3\" />\r\n          <span>{displayError}</span>\r\n        </div>\r\n      )}\r\n      <p className=\"text-xs text-gray-500 mt-1\">\r\n        Format: 08xxxxxxxxxx (10-13 digit)\r\n      </p>\r\n    </div>\r\n  );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\layout\\AppShell.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\layout\\ProtectedLayout.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Outlet' is defined but never used.","line":1,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":26},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\components\\layout\\ProtectedLayout.tsx:12:7\n  10 |     const token = localStorage.getItem(\"token\")\n  11 |     if (!token) {\n> 12 |       setIsAuthenticated(false)\n     |       ^^^^^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  13 |       // Only toast if we were trying to access a specific page and got booted\n  14 |       if(location.pathname !== \"/login\" && location.pathname !== \"/\") {\n  15 |           toast.error(\"Sesi habis, silakan login kembali.\")","line":12,"column":7,"nodeType":null,"endLine":12,"endColumn":25}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Navigate, Outlet, useLocation } from \"react-router-dom\"\r\nimport { useEffect, useState } from \"react\"\r\nimport { toast } from \"sonner\"\r\n\r\nexport default function ProtectedLayout({ children }: { children: React.ReactNode }) {\r\n  const [isAuthenticated, setIsAuthenticated] = useState<boolean | null>(null)\r\n  const location = useLocation()\r\n\r\n  useEffect(() => {\r\n    const token = localStorage.getItem(\"token\")\r\n    if (!token) {\r\n      setIsAuthenticated(false)\r\n      // Only toast if we were trying to access a specific page and got booted\r\n      if(location.pathname !== \"/login\" && location.pathname !== \"/\") {\r\n          toast.error(\"Sesi habis, silakan login kembali.\")\r\n      }\r\n    } else {\r\n      setIsAuthenticated(true)\r\n    }\r\n  }, [location])\r\n\r\n  if (isAuthenticated === null) {\r\n      return null // Or a loader\r\n  }\r\n\r\n  if (!isAuthenticated) {\r\n    return <Navigate to=\"/login\" state={{ from: location }} replace />\r\n  }\r\n\r\n  return <>{children}</>\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\shared\\StatusBadge.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\PageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\SoftPageHeader.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\badge.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":35,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":35,"endColumn":30}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst badgeVariants = cva(\r\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default:\r\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\r\n        secondary:\r\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\r\n        destructive:\r\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\r\n        outline: \"text-foreground\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nexport interface BadgeProps\r\n  extends React.HTMLAttributes<HTMLDivElement>,\r\n    VariantProps<typeof badgeVariants> {}\r\n\r\nfunction Badge({ className, variant, ...props }: BadgeProps) {\r\n  return (\r\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\r\n  )\r\n}\r\n\r\nexport { Badge, badgeVariants }\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\button.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":2,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":55,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":55,"endColumn":32}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { Slot } from \"@radix-ui/react-slot\"\r\nimport { cva, type VariantProps } from \"class-variance-authority\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nconst buttonVariants = cva(\r\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\r\n  {\r\n    variants: {\r\n      variant: {\r\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\r\n        destructive:\r\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\r\n        outline:\r\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\r\n        secondary:\r\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\r\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\r\n        link: \"text-primary underline-offset-4 hover:underline\",\r\n      },\r\n      size: {\r\n        default: \"h-10 px-4 py-2\",\r\n        sm: \"h-9 rounded-md px-3\",\r\n        lg: \"h-11 rounded-md px-8\",\r\n        icon: \"h-10 w-10\",\r\n      },\r\n    },\r\n    defaultVariants: {\r\n      variant: \"default\",\r\n      size: \"default\",\r\n    },\r\n  }\r\n)\r\n\r\nexport interface ButtonProps\r\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\r\n    VariantProps<typeof buttonVariants> {\r\n  asChild?: boolean\r\n}\r\n\r\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\r\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\r\n    const Comp = asChild ? Slot : \"button\"\r\n    return (\r\n      <Comp\r\n        className={cn(buttonVariants({ variant, size, className }))}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nButton.displayName = \"Button\"\r\n\r\nexport { Button, buttonVariants }\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\card.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\checkbox.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\command.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":27,"column":11,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":27,"endColumn":29,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[1024,1075],"text":"type CommandDialogProps = DialogProps"},"desc":"Replace empty interface with a type alias."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandDialogProps' is defined but never used.","line":27,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":29}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\r\nimport { Command as CommandPrimitive } from \"cmdk\"\r\nimport { Search } from \"lucide-react\"\r\n\r\nimport { cn } from \"@/lib/utils\"\r\n// import { Dialog, DialogContent } from \"@/components/ui/dialog\" // We might not have Dialog yet, but let's see. We do have dialog.tsx based on file list.\r\n\r\n// To avoid circular or complex deps if Dialog isn't perfect, I'll allow standard command usage first.\r\n// If CommandDialog is needed, I'll uncomment. But standard Command is usually enough for popovers.\r\n\r\nconst Command = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive\r\n    ref={ref}\r\n    className={cn(\r\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\nCommand.displayName = CommandPrimitive.displayName\r\n\r\ninterface CommandDialogProps extends DialogProps {}\r\n\r\n// const CommandDialog = ({ children, ...props }: CommandDialogProps) => {\r\n//   return (\r\n//     <Dialog {...props}>\r\n//       <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\r\n//         <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\r\n//           {children}\r\n//         </Command>\r\n//       </DialogContent>\r\n//     </Dialog>\r\n//   )\r\n// }\r\n\r\nconst CommandInput = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Input>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\r\n>(({ className, ...props }, ref) => (\r\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\r\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\r\n    <CommandPrimitive.Input\r\n      ref={ref}\r\n      className={cn(\r\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  </div>\r\n))\r\n\r\nCommandInput.displayName = CommandPrimitive.Input.displayName\r\n\r\nconst CommandList = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.List>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.List\r\n    ref={ref}\r\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\r\n    {...props}\r\n  />\r\n))\r\n\r\nCommandList.displayName = CommandPrimitive.List.displayName\r\n\r\nconst CommandEmpty = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Empty>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\r\n>((props, ref) => (\r\n  <CommandPrimitive.Empty\r\n    ref={ref}\r\n    className=\"py-6 text-center text-sm\"\r\n    {...props}\r\n  />\r\n))\r\n\r\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\r\n\r\nconst CommandGroup = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Group>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Group\r\n    ref={ref}\r\n    className={cn(\r\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\n\r\nCommandGroup.displayName = CommandPrimitive.Group.displayName\r\n\r\nconst CommandSeparator = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Separator>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Separator\r\n    ref={ref}\r\n    className={cn(\"-mx-1 h-px bg-border\", className)}\r\n    {...props}\r\n  />\r\n))\r\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\r\n\r\nconst CommandItem = React.forwardRef<\r\n  React.ElementRef<typeof CommandPrimitive.Item>,\r\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\r\n>(({ className, ...props }, ref) => (\r\n  <CommandPrimitive.Item\r\n    ref={ref}\r\n    className={cn(\r\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n))\r\n\r\nCommandItem.displayName = CommandPrimitive.Item.displayName\r\n\r\nconst CommandShortcut = ({\r\n  className,\r\n  ...props\r\n}: React.HTMLAttributes<HTMLSpanElement>) => {\r\n  return (\r\n    <span\r\n      className={cn(\r\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\r\n        className\r\n      )}\r\n      {...props}\r\n    />\r\n  )\r\n}\r\nCommandShortcut.displayName = \"CommandShortcut\"\r\n\r\nexport {\r\n  Command,\r\n  // CommandDialog,\r\n  CommandInput,\r\n  CommandList,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandItem,\r\n  CommandShortcut,\r\n  CommandSeparator,\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\input.tsx","messages":[{"ruleId":"@typescript-eslint/no-empty-object-type","severity":2,"message":"An interface declaring no members is equivalent to its supertype.","line":4,"column":18,"nodeType":"Identifier","messageId":"noEmptyInterfaceWithSuper","endLine":4,"endColumn":28,"suggestions":[{"messageId":"replaceEmptyInterfaceWithSuper","fix":{"range":[75,153],"text":"type InputProps = React.InputHTMLAttributes<HTMLInputElement>"},"desc":"Replace empty interface with a type alias."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from \"react\"\r\nimport { cn } from \"@/lib/utils\"\r\n\r\nexport interface InputProps\r\n  extends React.InputHTMLAttributes<HTMLInputElement> {}\r\n\r\nconst Input = React.forwardRef<HTMLInputElement, InputProps>(\r\n  ({ className, type, ...props }, ref) => {\r\n    return (\r\n      <input\r\n        type={type}\r\n        className={cn(\r\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\r\n          className\r\n        )}\r\n        ref={ref}\r\n        {...props}\r\n      />\r\n    )\r\n  }\r\n)\r\nInput.displayName = \"Input\"\r\n\r\nexport { Input }\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\label.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\popover.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\select.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\separator.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\skeleton.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\sonner.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\table.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\tabs.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\components\\ui\\textarea.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\ai\\components\\AiChatAssistant.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":12,"column":10,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":12,"endColumn":13,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[462,465],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[462,465],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1536,1539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1536,1539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react';\r\nimport { Card, CardContent, CardDescription, CardFooter, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Send, Sparkles, Loader2, Bot, User } from 'lucide-react';\r\nimport { api } from '@/lib/api';\r\nimport { toast } from 'sonner';\r\n\r\ninterface Message {\r\n  role: 'user' | 'assistant';\r\n  content: string;\r\n  data?: any[];\r\n  sql?: string;\r\n}\r\n\r\nexport default function AiChatAssistant() {\r\n  const [messages, setMessages] = useState<Message[]>([]);\r\n  const [input, setInput] = useState('');\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [suggestedQuestions, setSuggestedQuestions] = useState<string[]>([]);\r\n\r\n  // Load suggested questions on mount\r\n  useState(() => {\r\n    api.ai.getSuggestedQuestions().then((data) => {\r\n      setSuggestedQuestions(data.questions || []);\r\n    });\r\n  });\r\n\r\n  const handleSend = async (question?: string) => {\r\n    const userMessage = question || input.trim();\r\n    if (!userMessage) return;\r\n\r\n    setInput('');\r\n    setMessages((prev) => [...prev, { role: 'user', content: userMessage }]);\r\n    setIsLoading(true);\r\n\r\n    try {\r\n      const response = await api.ai.query({ question: userMessage });\r\n\r\n      setMessages((prev) => [\r\n        ...prev,\r\n        {\r\n          role: 'assistant',\r\n          content: response.answer,\r\n          data: response.data,\r\n          sql: response.sql,\r\n        },\r\n      ]);\r\n    } catch (error: any) {\r\n      console.error('[AI Chat Error]', error);\r\n      toast.error('Gagal memproses pertanyaan. Coba lagi.');\r\n      \r\n      // Remove user message on error\r\n      setMessages((prev) => prev.slice(0, -1));\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6 max-w-5xl\">\r\n      <Card className=\"h-[calc(100vh-12rem)] flex flex-col\">\r\n        <CardHeader>\r\n          <div className=\"flex items-center gap-3\">\r\n            <div className=\"p-2 bg-primary/10 rounded-lg\">\r\n              <Sparkles className=\"w-6 h-6 text-primary\" />\r\n            </div>\r\n            <div>\r\n              <CardTitle className=\"text-2xl\">AI Assistant</CardTitle>\r\n              <CardDescription>\r\n                Tanyakan apa saja tentang data guru, SK, atau madrasah\r\n              </CardDescription>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n\r\n        <CardContent className=\"flex-1 overflow-y-auto space-y-4\">\r\n          {messages.length === 0 && (\r\n            <div className=\"text-center py-12\">\r\n              <div className=\"inline-flex p-4 bg-primary/5 rounded-full mb-4\">\r\n                <Bot className=\"w-12 h-12 text-primary opacity-50\" />\r\n              </div>\r\n              <h3 className=\"text-lg font-semibold mb-2\">\r\n                Selamat datang di AI Assistant\r\n              </h3>\r\n              <p className=\"text-muted-foreground mb-6\">\r\n                Mulai percakapan dengan mengetik pertanyaan atau pilih contoh di bawah\r\n              </p>\r\n\r\n              {suggestedQuestions.length > 0 && (\r\n                <div className=\"space-y-2 max-w-md mx-auto\">\r\n                  <p className=\"text-sm font-medium text-left\">Contoh pertanyaan:</p>\r\n                  {suggestedQuestions.map((q, i) => (\r\n                    <Button\r\n                      key={i}\r\n                      variant=\"outline\"\r\n                      className=\"w-full justify-start text-left\"\r\n                      onClick={() => handleSend(q)}\r\n                      disabled={isLoading}\r\n                    >\r\n                      <Sparkles className=\"w-4 h-4 mr-2 flex-shrink-0\" />\r\n                      <span className=\"truncate\">{q}</span>\r\n                    </Button>\r\n                  ))}\r\n                </div>\r\n              )}\r\n            </div>\r\n          )}\r\n\r\n          {messages.map((msg, i) => (\r\n            <MessageBubble key={i} message={msg} />\r\n          ))}\r\n\r\n          {isLoading && (\r\n            <div className=\"flex items-center gap-2 text-muted-foreground pl-2\">\r\n              <Loader2 className=\"w-4 h-4 animate-spin\" />\r\n              <span className=\"text-sm\">AI sedang berpikir...</span>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n\r\n        <CardFooter className=\"border-t pt-4\">\r\n          <div className=\"flex gap-2 w-full\">\r\n            <Input\r\n              placeholder=\"Tanyakan sesuatu... (contoh: Berapa guru yang belum sertifikasi?)\"\r\n              value={input}\r\n              onChange={(e) => setInput(e.target.value)}\r\n              onKeyPress={(e) => e.key === 'Enter' && !isLoading && handleSend()}\r\n              disabled={isLoading}\r\n              className=\"flex-1\"\r\n            />\r\n            <Button \r\n              onClick={() => handleSend()} \r\n              disabled={isLoading || !input.trim()}\r\n              size=\"icon\"\r\n            >\r\n              <Send className=\"w-4 h-4\" />\r\n            </Button>\r\n          </div>\r\n        </CardFooter>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction MessageBubble({ message }: { message: Message }) {\r\n  const isUser = message.role === 'user';\r\n\r\n  return (\r\n    <div className={`flex gap-3 ${isUser ? 'flex-row-reverse' : 'flex-row'}`}>\r\n      <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center ${\r\n        isUser ? 'bg-primary text-primary-foreground' : 'bg-muted'\r\n      }`}>\r\n        {isUser ? <User className=\"w-4 h-4\" /> : <Bot className=\"w-4 h-4\" />}\r\n      </div>\r\n\r\n      <div className={`flex-1 max-w-[80%] ${isUser ? 'items-end' : 'items-start'}`}>\r\n        <div\r\n          className={`rounded-lg p-3 ${\r\n            isUser\r\n              ? 'bg-primary text-primary-foreground ml-auto'\r\n              : 'bg-muted'\r\n          }`}\r\n        >\r\n          <p className=\"text-sm whitespace-pre-wrap\">{message.content}</p>\r\n\r\n          {message.data && message.data.length > 0 && (\r\n            <div className=\"mt-3 pt-3 border-t border-current/10\">\r\n              <p className=\"text-xs opacity-70 mb-1\">\r\n                 Ditemukan {message.data.length} hasil\r\n              </p>\r\n            </div>\r\n          )}\r\n\r\n          {message.sql && (\r\n            <details className=\"mt-2\">\r\n              <summary className=\"text-xs cursor-pointer opacity-70 hover:opacity-100\">\r\n                 Lihat SQL Query\r\n              </summary>\r\n              <pre className=\"mt-2 p-2 bg-black/10 rounded text-xs overflow-x-auto\">\r\n                {message.sql}\r\n              </pre>\r\n            </details>\r\n          )}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\approval\\YayasanApprovalPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'SignaturePad' is defined but never used.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isSignModalOpen' is assigned a value but never used.","line":36,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setIsSignModalOpen' is assigned a value but never used.","line":36,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":36,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'signTargetId' is assigned a value but never used.","line":38,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'setSignTargetId' is assigned a value but never used.","line":38,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":38,"endColumn":39},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'currentTahunAjaran' is assigned a value but never used.","line":75,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":75,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4762,4765],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4762,4765],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4788,4791],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4788,4791],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":169,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6471,6474],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6471,6474],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\nimport { BadgeCheck, CheckCircle, Download, FileText, XCircle, Upload } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { api } from \"@/lib/api\"  // Keep for file upload only\r\nimport { toast } from \"sonner\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { SignaturePad } from \"@/components/SignaturePad\"\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogDescription,\r\n  DialogHeader,\r\n  DialogTitle,\r\n} from \"@/components/ui/dialog\"\r\n//  CONVEX for real-time data\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\nimport { Id } from \"../../../convex/_generated/dataModel\"\r\n\r\nexport default function YayasanApprovalPage() {\r\n  //  REAL-TIME CONVEX QUERY - Auto-updates!\r\n  const allRequests = useQuery(convexApi.headmasters.list, {\r\n    status: undefined  // Get all statuses\r\n  }) || []\r\n\r\n  //  CONVEX MUTATIONS\r\n  const approveMutation = useMutation(convexApi.headmasters.approve)\r\n  const rejectMutation = useMutation(convexApi.headmasters.reject)\r\n\r\n  // --- SIGNATURE STATE ---\r\n  const [isSignModalOpen, setIsSignModalOpen] = useState(false)\r\n\r\n  const [signTargetId, setSignTargetId] = useState<string | null>(null)\r\n  \r\n  // --- UPLOAD SK FINAL STATE ---\r\n  const [isUploadModalOpen, setIsUploadModalOpen] = useState(false)\r\n  const [uploadTargetId, setUploadTargetId] = useState<string | null>(null)\r\n\r\n  // --- REJECTION STATE ---\r\n  const [isRejectModalOpen, setIsRejectModalOpen] = useState(false)\r\n  const [rejectTargetId, setRejectTargetId] = useState<string | null>(null)\r\n  const [rejectReason, setRejectReason] = useState(\"\")\r\n\r\n  // Pagination State\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const itemsPerPage = 10\r\n\r\n  const calculateTahunAjaran = (dateInput: Date | string = new Date()) => {\r\n      const d = new Date(dateInput);\r\n      if (isNaN(d.getTime())) return \"\";\r\n      const year = d.getFullYear();\r\n      const month = d.getMonth(); // 0-11\r\n      // July (6) starts new academic year\r\n      if (month >= 6) {\r\n          return `${year}/${year + 1}`;\r\n      } else {\r\n          return `${year - 1}/${year}`;\r\n      }\r\n  }\r\n\r\n  // --- SK SETTINGS STATE ---\r\n  const [nomorFormat, setNomorFormat] = useState(\"{NOMOR}/PC.L/A.II/H-34.B/{BULAN}/{TAHUN}\")\r\n  const [nomorStart, setNomorStart] = useState(\"0001\")\r\n  const [tanggalPenetapan, setTanggalPenetapan] = useState(\"\")\r\n  const [nomorSuratMasuk, setNomorSuratMasuk] = useState(\"\")\r\n  const [tanggalSuratMasuk, setTanggalSuratMasuk] = useState(\"\")\r\n  const [tahunAjaran, setTahunAjaran] = useState(calculateTahunAjaran())\r\n  const [defaultKecamatan, setDefaultKecamatan] = useState(\"\")\r\n  // Auto-update tahunAjaran when tanggalPenetapan changes\r\n  const currentTahunAjaran = tanggalPenetapan ? calculateTahunAjaran(tanggalPenetapan) : tahunAjaran\r\n  // -------------------------\r\n\r\n  const toRoman = (num: number): string => {\r\n      const roman = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}\r\n      let str = '', i\r\n      for ( i in roman ) {\r\n          while ( num >= roman[i as keyof typeof roman] ) {\r\n              str += i\r\n              num -= roman[i as keyof typeof roman]\r\n          }\r\n      }\r\n      return str\r\n  }\r\n\r\n  const parseDateSimple = (str: string) => {\r\n      if(!str) return new Date()\r\n      const d = new Date(str)\r\n      if(!isNaN(d.getTime())) return d\r\n      return new Date()\r\n  }\r\n\r\n  // Direct approve without signature (signature feature disabled temporarily)\r\n  const handleDirectApprove = async (id: string) => {\r\n      try {\r\n          toast.info(\"Menyetujui dokumen...\")\r\n          const userId = localStorage.getItem(\"user\") ? JSON.parse(localStorage.getItem(\"user\")!).id : \"temp_user\" \r\n          await approveMutation({ \r\n            id: id as Id<\"headmasterTenures\">,\r\n            approvedBy: userId as Id<\"users\">\r\n          })\r\n\r\n          toast.success(\"SK Kepala Disetujui!\")\r\n          // No need to reload - Convex auto-updates!\r\n\r\n      } catch (e) {\r\n          console.error(e)\r\n          toast.error(\"Gagal menyetujui: \" + (e as Error).message)\r\n      }\r\n  }\r\n\r\n  const handleUploadAndApprove = async (file: File) => {\r\n      if (!uploadTargetId) return\r\n      try {\r\n          toast.info(\"Mengunggah SK Final...\")\r\n          const uploadRes = await api.uploadFile(file)\r\n          const skUrl = (uploadRes as any).url || (uploadRes as any).filename\r\n\r\n          toast.info(\"Menyimpan SK Final...\")\r\n          const userId = localStorage.getItem(\"user\") ? JSON.parse(localStorage.getItem(\"user\")!).id : \"temp_user\"\r\n          await approveMutation({ \r\n            id: uploadTargetId as Id<\"headmasterTenures\">,\r\n            approvedBy: userId as Id<\"users\">,\r\n            skUrl: skUrl\r\n          })\r\n\r\n          toast.success(\"SK Final Berhasil Diupload & Disetujui!\")\r\n          setIsUploadModalOpen(false)\r\n          setUploadTargetId(null)\r\n          // No need to reload - Convex auto-updates!\r\n      } catch (e) {\r\n          toast.error(\"Gagal: \" + (e as Error).message)\r\n      }\r\n  }\r\n\r\n  //  No need for useEffect/loadData - Convex auto-updates!\r\n  // Filter requests based on status if needed\r\n  const requests = allRequests\r\n\r\n\r\n\r\n  const openRejectModal = (id: string) => {\r\n      setRejectTargetId(id)\r\n      setRejectReason(\"\")\r\n      setIsRejectModalOpen(true)\r\n  }\r\n\r\n  const handleReject = async () => {\r\n      if (!rejectTargetId || !rejectReason.trim()) {\r\n          toast.error(\"Alasan penolakan harus diisi!\")\r\n          return;\r\n      }\r\n      try {\r\n          toast.info(\"Memproses penolakan...\");\r\n          const userId = localStorage.getItem(\"user\") ? JSON.parse(localStorage.getItem(\"user\")!).id : \"temp_user\"\r\n          await rejectMutation({ \r\n            id: rejectTargetId as Id<\"headmasterTenures\">,\r\n            rejectedBy: userId as Id<\"users\">\r\n          })\r\n          toast.success(\"SK Kepala Ditolak.\")\r\n          setIsRejectModalOpen(false)\r\n          setRejectTargetId(null)\r\n          setRejectReason(\"\")\r\n          // No need to reload - Convex auto-updates!\r\n      } catch (e: any) {\r\n          console.error(\"Reject Error:\", e);\r\n          toast.error(\"Gagal menolak: \" + (e?.message || \"Unknown error\"))\r\n      }\r\n  }\r\n\r\n  // Pagination Logic\r\n  const totalPages = Math.ceil(requests.length / itemsPerPage)\r\n  const paginatedRequests = requests.slice(\r\n      (currentPage - 1) * itemsPerPage,\r\n      currentPage * itemsPerPage\r\n  )\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n       <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Approval Ketua Yayasan</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Validasi dan persetujuan pengangkatan Kepala Madrasah.\r\n          </p>\r\n        </div>\r\n\r\n        {/* --- GLOBAL SETTINGS CARD --- */}\r\n        <Card className=\"bg-slate-50/50 border-blue-100\">\r\n            <CardHeader className=\"pb-3 border-b bg-slate-50\">\r\n                <CardTitle className=\"text-sm font-semibold flex items-center gap-2 text-slate-700\">\r\n                    <FileText className=\"h-4 w-4 text-blue-600\"/> Pengaturan Surat Keputusan (Global Kamad)\r\n                </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"pt-4 grid sm:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2 col-span-2\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">Format Nomor Surat (Otomatis)</Label>\r\n                    <div className=\"flex gap-2\">\r\n                         <Input \r\n                            className=\"w-24 bg-white font-mono text-center\"\r\n                            value={nomorStart}\r\n                            onChange={e => setNomorStart(e.target.value)}\r\n                            placeholder=\"0001\"\r\n                        />\r\n                        <Input \r\n                            value={nomorFormat}\r\n                            onChange={e => setNomorFormat(e.target.value)}\r\n                            placeholder=\"Format...\"\r\n                            className=\"flex-1 bg-white font-mono\"\r\n                        />\r\n                    </div>\r\n                    <p className=\"text-[10px] text-muted-foreground\">Kode: {'{NOMOR}, {BULAN}, {TAHUN}, {BL_ROMA}'}</p>\r\n                </div>\r\n                <div className=\"space-y-2 col-span-2 sm:col-span-1\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">Tanggal Penetapan</Label>\r\n                    <Input \r\n                        value={tanggalPenetapan}\r\n                        onChange={e => setTanggalPenetapan(e.target.value)}\r\n                        placeholder=\"Contoh: 01 Juli 2025\"\r\n                        className=\"bg-white\"\r\n                    />\r\n                </div>\r\n                 <div className=\"space-y-2\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">No. Surat Permohonan</Label>\r\n                    <Input \r\n                        value={nomorSuratMasuk}\r\n                        onChange={e => setNomorSuratMasuk(e.target.value)}\r\n                        placeholder=\"Contoh: 005/MWC/...\"\r\n                        className=\"bg-white\"\r\n                    />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">Tgl. Surat Permohonan</Label>\r\n                    <Input \r\n                        value={tanggalSuratMasuk}\r\n                        onChange={e => setTanggalSuratMasuk(e.target.value)}\r\n                        placeholder=\"Contoh: 20 Juni 2025\"\r\n                        className=\"bg-white\"\r\n                    />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">Kecamatan (Default)</Label>\r\n                    <Input \r\n                        value={defaultKecamatan}\r\n                        onChange={e => setDefaultKecamatan(e.target.value)}\r\n                        placeholder=\"Isi jika data sekolah kosong\"\r\n                        className=\"bg-white\"\r\n                    />\r\n                </div>\r\n                 <div className=\"space-y-2\">\r\n                    <Label className=\"text-xs font-semibold text-slate-600 uppercase\">Tahun Ajaran</Label>\r\n                    <Input \r\n                        value={tahunAjaran}\r\n                        onChange={e => setTahunAjaran(e.target.value)}\r\n                        placeholder=\"2024/2025\"\r\n                        className=\"bg-white\"\r\n                    />\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Daftar Pengajuan Masuk</CardTitle>\r\n          <CardDescription>\r\n             Menunggu persetujuan Anda.\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"rounded-md border\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead>Nama Calon</TableHead>\r\n                  <TableHead>Madrasah Tujuan</TableHead>\r\n                  <TableHead>Periode</TableHead>\r\n                  <TableHead>TMT - Berakhir</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead className=\"text-right\">Aksi</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {!allRequests ? (\r\n                    <TableRow><TableCell colSpan={6} className=\"text-center h-24\">Memuat...</TableCell></TableRow>\r\n                ) : requests.length === 0 ? (\r\n                    <TableRow><TableCell colSpan={6} className=\"text-center h-24 text-muted-foreground\">Tidak ada pengajuan pending.</TableCell></TableRow>\r\n                ) : (\r\n                  paginatedRequests.map((item) => (\r\n                    <TableRow key={item.id}>\r\n                      <TableCell className=\"font-medium\">\r\n                          {item.teacher?.nama}\r\n                          <div className=\"text-xs text-muted-foreground\">NIP: {item.teacher?.nip || '-'}</div>\r\n                      </TableCell>\r\n                      <TableCell>{item.school?.nama}</TableCell>\r\n                      <TableCell>\r\n                          <Badge variant=\"outline\">Ke-{item.periode}</Badge>\r\n                      </TableCell>\r\n                      <TableCell>\r\n                          {new Date(item.tmt).toLocaleDateString(\"id-ID\")} s.d. <br/>\r\n                          {new Date(item.endDate).toLocaleDateString(\"id-ID\")}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                         <StatusBadge status={item.status} />\r\n                         {item.digitalSignatureUrl && (\r\n                             <div className=\"mt-1 flex items-center text-[10px] text-green-600\">\r\n                                 <FileText className=\"w-3 h-3 mr-1\"/> TTD Digital Ada\r\n                             </div>\r\n                         )}\r\n                      </TableCell>\r\n                      <TableCell className=\"text-right space-x-2\">\r\n                        {/* Approve/Reject buttons for pending submissions */}\r\n                        {['pending', 'submitted', 'verified', 'Submitted', 'Verified'].includes(item.status) && (\r\n                            <>\r\n                                 <Button size=\"sm\" variant=\"destructive\" onClick={() => openRejectModal(item.id)}>\r\n                                     <XCircle className=\"w-4 h-4 mr-1\" /> Tolak\r\n                                 </Button>\r\n                                {/* Direct approve button (signature disabled) */}\r\n                                <Button size=\"sm\" className=\"bg-green-600 hover:bg-green-700\" onClick={() => handleDirectApprove(item.id)}>\r\n                                    <CheckCircle className=\"w-4 h-4 mr-1\" /> Setujui\r\n                                </Button>\r\n                            </>\r\n                        )}\r\n                        {/* ACTION: UPLOAD SK FINAL (Manual) */}\r\n                        {['pending', 'submitted', 'verified', 'approved', 'active', 'Submitted', 'Verified', 'Approved', 'Active'].includes(item.status) && (\r\n                             <Button size=\"sm\" variant=\"outline\" className=\"border-green-600 text-green-600 hover:bg-green-50\" onClick={() => {\r\n                                setUploadTargetId(item.id)\r\n                                setIsUploadModalOpen(true)\r\n                            }}>\r\n                                <Upload className=\"w-4 h-4 mr-1\" /> {item.skUrl ? \"Update SK Final\" : \"Upload SK Final\"}\r\n                            </Button>\r\n                        )}\r\n\r\n                        {/* Show \"Cetak SK\" button for approved status */}\r\n                        {['approved', 'Approved'].includes(item.status) && (\r\n                             <div className=\"flex items-center justify-end space-x-2\">\r\n                                <BadgeCheck className=\"w-5 h-5 text-green-600\"/> \r\n                                <span className=\"mr-2 hidden sm:inline\">Disetujui</span>\r\n                                 {item.suratPermohonanUrl && (\r\n                                     <Button size=\"sm\" variant=\"outline\" className=\"text-blue-600 border-blue-600 hover:bg-blue-50\" onClick={() => window.open(item.suratPermohonanUrl, '_blank')}>\r\n                                         <FileText className=\"w-4 h-4 mr-1\"/> Lihat Surat\r\n                                     </Button>\r\n                                 )}\r\n\r\n                                 <Button size=\"sm\" variant=\"outline\" onClick={async () => {\r\n                                    try {\r\n                                        toast.info(\"Memproses SK...\");\r\n                                        \r\n                                        // 1. Smart Selection\r\n                                        let templateBlob = null;\r\n                                        const teacher = item.teacher || {};\r\n                                        const jabatan = (teacher.jabatan || \"Kepala Madrasah\").toLowerCase();\r\n                                        const nip = (teacher.nip || \"\").replace(/[^0-9]/g, \"\");\r\n                                        const isPlt = jabatan.includes(\"plt\") || jabatan.includes(\"pelaksana\");\r\n                                        const isPns = nip.length > 10 || (teacher.statusKepegawaian || \"\").includes(\"PNS\");\r\n\r\n                                        if (isPlt) {\r\n                                            templateBlob = localStorage.getItem(\"sk_template_kamad_plt_blob\") || localStorage.getItem(\"sk_template_kamad_blob\");\r\n                                        } else if (isPns) {\r\n                                            templateBlob = localStorage.getItem(\"sk_template_kamad_pns_blob\") || localStorage.getItem(\"sk_template_kamad_blob\");\r\n                                        } else {\r\n                                            templateBlob = localStorage.getItem(\"sk_template_kamad_nonpns_blob\") || localStorage.getItem(\"sk_template_kamad_blob\");\r\n                                        }\r\n                                        \r\n                                        if (templateBlob) {\r\n                                            const { generateSkDocx } = await import(\"@/lib/sk-generator\");\r\n                                            const { saveAs } = await import(\"file-saver\");\r\n                                            const savedSettings = localStorage.getItem(\"app_settings\");\r\n                                            const settings = savedSettings ? JSON.parse(savedSettings) : {};\r\n                                            \r\n                                            // --- ROBUST DATA MAPPING ---\r\n                                            const dateObj = parseDateSimple(tanggalPenetapan)\r\n                                            const dd = String(dateObj.getDate()).padStart(2, '0')\r\n                                            const mmAngka = String(dateObj.getMonth() + 1)\r\n                                            const mmRoma = toRoman(dateObj.getMonth() + 1)\r\n                                            const yyyy = dateObj.getFullYear()\r\n                                            \r\n                                            // Format Requested: {NOMOR}/PC.L/A.II/H-34.B/{BULAN}/{TAHUN}\r\n                                            // Format Requested: {NOMOR}/PC.L/A.II/H-34.B/{BULAN}/{TAHUN}\r\n                                            const generatedNomor = nomorFormat\r\n                                              .replace(/{NOMOR}/g, item.nomorSk?.split(\"/\")[0] || nomorStart) \r\n                                              .replace(/{TANGGAL}/g, dd)\r\n                                              .replace(/{BULAN}/g, mmAngka) // Numeric as per request\r\n                                              .replace(/{BL_ROMA}/g, mmRoma)\r\n                                              .replace(/{TAHUN}/g, String(yyyy))\r\n\r\n                                            const finalTmt = new Date(item.tmt).toLocaleDateString(\"id-ID\", {day: 'numeric', month: 'long', year: 'numeric'})\r\n                                            const finalValid = new Date(item.endDate).toLocaleDateString(\"id-ID\", {day: 'numeric', month: 'long', year: 'numeric'})\r\n                                            const finalPenetapan = tanggalPenetapan || new Date().toLocaleDateString(\"id-ID\", {day: 'numeric', month: 'long', year: 'numeric'})\r\n\r\n                                            const data = {\r\n                                                // --- STANDARD FIELDS ---\r\n                                                NAMA: item.teacher?.nama || \"\",\r\n                                                NIP: item.teacher?.nip || \"-\",\r\n                                                NUPTK: item.teacher?.nuptk || \"-\",\r\n                                                JABATAN: \"Kepala Madrasah\",\r\n                                                STATUS: \"Tetap\",\r\n                                                PENDIDIKAN: item.teacher?.pendidikanTerakhir || item.teacher?.education || \"-\", \r\n                                                ALAMAT: item.teacher?.address || \"-\",\r\n                                                KABUPATEN: \"Pasuruan\",\r\n                                                TENTANG: \"PENGANGKATAN KEPALA MADRASAH\",\r\n                                                TAHUN_AJARAN: tahunAjaran,\r\n                                                KETUA_NAMA: settings.signerKetuaName || \".....\",\r\n                                                SEKRETARIS_NAMA: settings.signerSekretarisName || \".....\",\r\n                                                MASA_BHAKTI: `${new Date(item.tmt).getFullYear()} - ${new Date(item.endDate).getFullYear()}`,\r\n                                                TANGGAL_BERAKHIR: finalValid,\r\n                                                \r\n                                                // --- DATES ---\r\n                                                TMT: finalTmt,\r\n                                                \"Tanggal Penetapan\": finalPenetapan,\r\n                                                \"TANGGAL PENETAPAN\": finalPenetapan,\r\n                                                \r\n                                                // --- NUMBERS & MONTHS ---\r\n                                                NOMOR: item.nomorSk?.split(\"/\")[0] || \"....\", \r\n                                                \"NOMOR SURAT\": generatedNomor,\r\n                                                \"NOMOR_SK\": generatedNomor,\r\n                                                BULAN: String(new Date(finalPenetapan).getMonth() + 1), // Numeric (e.g. \"12\")\r\n                                                TAHUN: String(yyyy),\r\n                                                \"BULAN_ROMA\": mmRoma, // Roman fallback\r\n\r\n                                                // --- SURAT PERMOHONAN ---\r\n                                                \"NOMOR SURAT PERMOHONAN\": item.suratPermohonanNumber || nomorSuratMasuk || \"-\",\r\n                                                \"TANGGAL SURAT PERMOHONAN\": (item.suratPermohonanDate ? new Date(item.suratPermohonanDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : \"\") || tanggalSuratMasuk || \"-\",\r\n\r\n                                                // --- LOCATION / SCHOOL ---\r\n                                                UNIT_KERJA: item.school?.nama || \"\",\r\n                                                \"Unit Kerja\": item.school?.nama || \"\",\r\n                                                \"UNIT KERJA\": item.school?.nama || \"\", // Spaces\r\n                                                MADRASAH: item.school?.nama || \"\",\r\n                                                LEMBAGA: item.school?.nama || \"\",\r\n                                                \r\n                                                KECAMATAN: item.school?.district || defaultKecamatan || \".....\",\r\n                                                \"Kecamatan\": item.school?.district || defaultKecamatan || \".....\",\r\n\r\n                                                // --- PERSONAL IDENTITY / TTL ---\r\n                                                TTL: (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`\r\n                                                    : \"-\",\r\n                                                \"TEMPAT_TANGGAL_LAHIR\": (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`\r\n                                                    : \"-\",\r\n                                                \"TEMPAT, TANGGAL LAHIR\": (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}` \r\n                                                    : \"-\",\r\n                                                \"Tempat Tanggal Lahir\": (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`\r\n                                                    : \"-\",\r\n                                                \"Tempat/Tanggal Lahir\": (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}`\r\n                                                    : \"-\",\r\n                                                \r\n                                                // --- MA'ARIF ID (WITH QUOTE VARIATIONS) ---\r\n                                                \"NOMOR INDUK MA'ARIF\": item.teacher?.nuptk || \"-\", // Straight\r\n                                                \"NOMOR INDUK MAARIF\": item.teacher?.nuptk || \"-\", // Smart\r\n                                                \"NOMOR INDUK MAARIF\": item.teacher?.nuptk || \"-\",  // None\r\n                                                \"Nomor Induk Maarif\": item.teacher?.nuptk || \"-\",\r\n\r\n                                                // --- ALIASES (Lowercase/Mixed) for Compatibility ---\r\n                                                nama: item.teacher?.nama,\r\n                                                nip: item.teacher?.nip || \"-\",\r\n                                                nuptk: item.teacher?.nuptk || \"-\",\r\n                                                jabatan: \"Kepala Madrasah\",\r\n                                                unit_kerja: item.school?.nama,\r\n                                                madrasah: item.school?.nama,\r\n                                                lembaga: item.school?.nama,\r\n                                                tmt: finalTmt,\r\n                                                ttl: (item.teacher?.birthPlace && item.teacher?.birthDate) \r\n                                                    ? `${item.teacher.birthPlace}, ${new Date(item.teacher.birthDate).toLocaleDateString('id-ID')}`\r\n                                                    : \"-\",\r\n                                                alamat: item.teacher?.address || \"-\",\r\n                                                \r\n                                                \"Nama\": item.teacher?.nama,\r\n                                                // \"NIP\" removed (duplicate of line 376)\r\n                                                \"Jabatan\": \"Kepala Madrasah\",\r\n                                                \"Madrasah\": item.school?.nama,\r\n                                                \r\n                                                \"Nomor Surat Permohonan\": item.suratPermohonanNumber || nomorSuratMasuk || \"-\",\r\n                                                \"Tanggal Surat Permohonan\": (item.suratPermohonanDate ? new Date(item.suratPermohonanDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }) : \"\") || tanggalSuratMasuk || \"-\",\r\n                                                \"Tahun Ajaran\": tahunAjaran\r\n                                            };\r\n\r\n                                            console.log(\"DEBUG SK ITEM:\", item);\r\n                                            console.log(\"DEBUG SK DATA:\", data);\r\n                                            \r\n                                            const blob = generateSkDocx(templateBlob, data);\r\n                                            saveAs(blob, `SK_Kepala_${item.teacher?.nama || 'Madrasah'}.docx`);\r\n                                            toast.success(\"SK Berhasil diunduh\");\r\n\r\n                                        } else {\r\n                                            // Fallback\r\n                                            const blob = await api.downloadSkHeadmaster(item.id);\r\n                                            const url = window.URL.createObjectURL(blob);\r\n                                            const a = document.createElement('a');\r\n                                            a.href = url;\r\n                                            a.download = `SK_Kepala_${item.teacher?.nama || 'Madrasah'}.pdf`;\r\n                                            a.click();\r\n                                            window.URL.revokeObjectURL(url);\r\n                                            toast.success(\"SK PDF Berhasil diunduh\");\r\n                                        }\r\n\r\n                                    } catch(e) {\r\n                                        console.error(e);\r\n                                        toast.error(\"Gagal: \" + (e as Error).message);\r\n                                    }\r\n                                }}>\r\n                                    <Download className=\"w-4 h-4 mr-1\" /> Cetak SK\r\n                                </Button>\r\n                            </div>\r\n                        )}\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n\r\n          {/* Pagination Controls */}\r\n          {allRequests && requests.length > itemsPerPage && (\r\n            <div className=\"flex items-center justify-end space-x-2 py-4 px-2\">\r\n              <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                Halaman {currentPage} dari {totalPages} ({requests.length} data)\r\n              </div>\r\n              <div className=\"space-x-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(1)}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  First\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  Prev\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  Next\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(totalPages)}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  Last\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Signature modal removed - feature disabled */}\r\n      \r\n      {/* Upload Final SK Dialog */}\r\n      <Dialog open={isUploadModalOpen} onOpenChange={setIsUploadModalOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle>Upload SK Final (Manual)</DialogTitle>\r\n            <DialogDescription>\r\n              Upload file SK yang sudah ditandatangani (PDF). Status akan berubah menjadi Approved.\r\n            </DialogDescription>\r\n          </DialogHeader>\r\n          <div className=\"space-y-4\">\r\n              <div className=\"grid gap-2\">\r\n                 <Label>File SK Final (PDF)</Label>\r\n                 <Input \r\n                    type=\"file\" \r\n                    accept=\".pdf\"\r\n                    onChange={(e) => {\r\n                        if(e.target.files?.[0]) handleUploadAndApprove(e.target.files[0])\r\n                    }} \r\n                 />\r\n              </div>\r\n          </div>\r\n         </DialogContent>\r\n       </Dialog>\r\n      \r\n       {/* Rejection Modal */}\r\n       <Dialog open={isRejectModalOpen} onOpenChange={setIsRejectModalOpen}>\r\n         <DialogContent className=\"sm:max-w-md\">\r\n           <DialogHeader>\r\n             <DialogTitle className=\"text-red-600\">Tolak SK Pengangkatan</DialogTitle>\r\n             <DialogDescription>\r\n               Masukkan alasan penolakan SK. Alasan ini akan dikirimkan ke pengaju.\r\n             </DialogDescription>\r\n           </DialogHeader>\r\n           <div className=\"space-y-4 py-4\">\r\n               <div className=\"grid gap-2\">\r\n                  <Label htmlFor=\"rejectReason\">Alasan Penolakan *</Label>\r\n                  <textarea \r\n                     id=\"rejectReason\"\r\n                     className=\"flex min-h-[120px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\r\n                     placeholder=\"Contoh: Data calon tidak lengkap, dokumen pendukung kurang, dll...\"\r\n                     value={rejectReason}\r\n                     onChange={(e) => setRejectReason(e.target.value)}\r\n                  />\r\n                  <p className=\"text-xs text-muted-foreground\">\r\n                     Minimal 10 karakter\r\n                  </p>\r\n               </div>\r\n               <div className=\"flex gap-2 justify-end\">\r\n                   <Button variant=\"outline\" onClick={() => setIsRejectModalOpen(false)}>\r\n                       Batal\r\n                   </Button>\r\n                   <Button \r\n                       variant=\"destructive\" \r\n                       onClick={handleReject}\r\n                       disabled={!rejectReason.trim() || rejectReason.trim().length < 10}\r\n                   >\r\n                       <XCircle className=\"w-4 h-4 mr-1\" /> Konfirmasi Penolakan\r\n                   </Button>\r\n               </div>\r\n           </div>\r\n         </DialogContent>\r\n       </Dialog>\r\n     </div>\r\n   )\r\n }\r\n \r\n function StatusBadge({ status }: { status: string }) {\r\n    const map: Record<string, string> = {\r\n        'Draft': 'bg-gray-100 text-gray-800',\r\n        'Submitted': 'bg-blue-100 text-blue-800',\r\n        'Verified': 'bg-purple-100 text-purple-800',\r\n        'Approved': 'bg-green-100 text-green-800',\r\n        'Rejected': 'bg-red-100 text-red-800',\r\n        'Active': 'bg-emerald-100 text-emerald-800',\r\n        'Expired': 'bg-orange-100 text-orange-800',\r\n    }\r\n    return (\r\n        <span className={cn(\"px-2.5 py-0.5 rounded-full text-xs font-medium border\", map[status] || map['Draft'])}>\r\n            {status}\r\n        </span>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\archive\\ArchivePage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\auth\\ChangePasswordPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\auth\\LoginPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":49,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":49,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1495,1498],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1495,1498],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardFooter,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { useState } from \"react\"\r\nimport { useNavigate, Link } from \"react-router-dom\"\r\nimport { toast } from \"sonner\"\r\n//  CONVEX AUTH\r\nimport { useMutation } from \"convex/react\"\r\nimport { api } from \"../../../convex/_generated/api\"\r\n\r\nexport default function LoginPage() {\r\n  const navigate = useNavigate()\r\n  const [loading, setLoading] = useState(false)\r\n  \r\n  // Convex login mutation\r\n  const loginMutation = useMutation(api.auth.login)\r\n\r\n  const handleLogin = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    setLoading(true)\r\n    \r\n    // Get values\r\n    const emailInput = (document.getElementById(\"email\") as HTMLInputElement)?.value || \"\"\r\n    const passwordInput = (document.getElementById(\"password\") as HTMLInputElement)?.value || \"\"\r\n\r\n    try {\r\n        //  Call Convex login\r\n        const data = await loginMutation({\r\n          email: emailInput,\r\n          password: passwordInput,\r\n        })\r\n        \r\n        // Save token (user ID)\r\n        localStorage.setItem(\"token\", data.token)\r\n        \r\n        // Save user data\r\n        localStorage.setItem(\"user\", JSON.stringify(data.user))\r\n\r\n        toast.success(\"Login Berhasil!\")\r\n        navigate(\"/dashboard\")\r\n    } catch (err: any) {\r\n        console.error(err);\r\n        toast.error(err.message || \"Login Gagal! Username atau Password salah.\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex min-h-screen items-center justify-center bg-gray-50/50 p-4\">\r\n      <Card className=\"w-full max-w-sm shadow-xl\">\r\n        <CardHeader className=\"space-y-1 text-center\">\r\n          <div className=\"mb-2 flex justify-center\">\r\n            <div className=\"flex h-12 w-12 items-center justify-center rounded-lg bg-primary text-primary-foreground\">\r\n              {/* Logo placeholder */}\r\n              <img src=\"/logo-icon.png\" alt=\"Logo\" className=\"h-10 w-10 object-contain\" />\r\n            </div>\r\n          </div>\r\n          <CardTitle className=\"text-2xl font-bold tracking-tight\">\r\n            SIMMACI\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Sistem Informasi Manajemen Maarif NU Cilacap \r\n          </CardDescription>\r\n        </CardHeader>\r\n        <form onSubmit={handleLogin}>\r\n          <CardContent className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"email\">Username / Email</Label>\r\n              <Input\r\n                id=\"email\"\r\n                type=\"text\"\r\n                placeholder=\"admin\"\r\n                required\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <div className=\"flex items-center justify-between\">\r\n                <Label htmlFor=\"password\">Password</Label>\r\n              </div>\r\n              <Input id=\"password\" type=\"password\" required placeholder=\"***\" />\r\n            </div>\r\n          </CardContent>\r\n          <CardFooter className=\"flex flex-col gap-2\">\r\n            <Button className=\"w-full\" type=\"submit\" disabled={loading}>\r\n              {loading ? \"Masuk...\" : \"Masuk\"}\r\n            </Button>\r\n            <div className=\"text-center text-sm\">\r\n                Belum punya akun? <Link to=\"/register\" className=\"text-primary hover:underline\">Daftar disini</Link>\r\n            </div>\r\n          </CardFooter>\r\n        </form>\r\n        <div className=\"px-8 pb-8 text-center text-xs text-muted-foreground\">\r\n          <p>Lembaga Pendidikan Ma'arif NU Cilacap</p>\r\n        </div>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\auth\\RegisterPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":53,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":53,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1484,1487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1484,1487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport {\r\n  Card,\r\n  CardContent,\r\n  CardDescription,\r\n  CardFooter,\r\n  CardHeader,\r\n  CardTitle,\r\n} from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { useState } from \"react\"\r\nimport { useNavigate, Link } from \"react-router-dom\"\r\nimport { toast } from \"sonner\"\r\n//  CONVEX for user registration\r\nimport { useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\nexport default function RegisterPage() {\r\n  const navigate = useNavigate()\r\n  const [loading, setLoading] = useState(false)\r\n  \r\n  const [formData, setFormData] = useState({\r\n      name: \"\",\r\n      unitKerja: \"\",\r\n      email: \"\",\r\n      password: \"\",\r\n      confirmPassword: \"\"\r\n  })\r\n\r\n  //  CONVEX MUTATION\r\n  const registerUser = useMutation(convexApi.auth.register)\r\n\r\n  const handleRegister = async (e: React.FormEvent) => {\r\n    e.preventDefault()\r\n    \r\n    if (formData.password !== formData.confirmPassword) {\r\n        toast.error(\"Konfirmasi password tidak sesuai.\")\r\n        return\r\n    }\r\n\r\n    setLoading(true)\r\n\r\n    try {\r\n        await registerUser({\r\n            email: formData.email,\r\n            password: formData.password,\r\n            name: formData.name,\r\n            unit: formData.unitKerja\r\n        })\r\n        toast.success(\"Pendaftaran berhasil! Silakan login.\")\r\n        navigate(\"/login\")\r\n    } catch (err: any) {\r\n        console.error(\"Registration error:\", err)\r\n        toast.error(err.message || \"Pendaftaran gagal. Username mungkin sudah digunakan.\")\r\n    } finally {\r\n        setLoading(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex min-h-screen items-center justify-center bg-gray-50/50 p-4\">\r\n      <Card className=\"w-full max-w-sm shadow-xl\">\r\n        <CardHeader className=\"space-y-1 text-center\">\r\n          <CardTitle className=\"text-2xl font-bold tracking-tight\">\r\n            Pendaftaran Operator\r\n          </CardTitle>\r\n          <CardDescription>\r\n            Buat akun untuk mengelola dokumen sekolah Anda\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <form onSubmit={handleRegister}>\r\n          <CardContent className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"name\">Nama Lengkap (Operator)</Label>\r\n              <Input\r\n                id=\"name\"\r\n                required\r\n                placeholder=\"Misal: Budi Santoso\"\r\n                value={formData.name}\r\n                onChange={e => setFormData({...formData, name: e.target.value})}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"unit\">Nama Sekolah / Lembaga</Label>\r\n              <Input\r\n                id=\"unit\"\r\n                required\r\n                placeholder=\"Misal: MI Ma'arif 01...\"\r\n                value={formData.unitKerja}\r\n                onChange={e => setFormData({...formData, unitKerja: e.target.value})}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"email\">Username / Email Login</Label>\r\n              <Input\r\n                id=\"email\"\r\n                required\r\n                placeholder=\"username123\"\r\n                value={formData.email}\r\n                onChange={e => setFormData({...formData, email: e.target.value})}\r\n              />\r\n            </div>\r\n            <div className=\"space-y-2\">\r\n              <Label htmlFor=\"password\">Password</Label>\r\n              <Input \r\n                id=\"password\" \r\n                type=\"password\" \r\n                required \r\n                value={formData.password}\r\n                onChange={e => setFormData({...formData, password: e.target.value})}\r\n              />\r\n            </div>\r\n             <div className=\"space-y-2\">\r\n              <Label htmlFor=\"confirmPassword\">Konfirmasi Password</Label>\r\n              <Input \r\n                id=\"confirmPassword\" \r\n                type=\"password\" \r\n                required \r\n                value={formData.confirmPassword}\r\n                onChange={e => setFormData({...formData, confirmPassword: e.target.value})}\r\n              />\r\n            </div>\r\n          </CardContent>\r\n          <CardFooter className=\"flex flex-col gap-2\">\r\n            <Button className=\"w-full\" type=\"submit\" disabled={loading}>\r\n              {loading ? \"Mendaftar...\" : \"Daftar Sekarang\"}\r\n            </Button>\r\n            <div className=\"text-center text-sm\">\r\n                Sudah punya akun? <Link to=\"/login\" className=\"text-primary hover:underline\">Masuk disini</Link>\r\n            </div>\r\n          </CardFooter>\r\n        </form>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\DashboardPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[574,577],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[574,577],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { School, Users, FileText, CheckCircle, AlertOctagon, Clock } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { useQuery } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\nimport { DashboardCharts } from \"./components/DashboardCharts\"\r\nimport DashboardOperator from \"./components/DashboardOperator\"\r\n\r\nexport default function DashboardPage() {\r\n  // Load user directly to prevent flash and avoid useEffect\r\n  const [user] = useState<any>(() => {\r\n    const u = localStorage.getItem(\"user\")\r\n    return u ? JSON.parse(u) : null\r\n  })\r\n\r\n  // Placeholder for alerts\r\n\r\n  \r\n  //  REAL-TIME CONVEX QUERY - Auto-updates!\r\n  const convexStats = useQuery(convexApi.dashboard.getStats)\r\n  const analyticsStats = useQuery(convexApi.analytics.getDashboardStats) // New Peta Mutu Data\r\n  const logs = useQuery(convexApi.logs.getRecentLogs, {}) // New Activity Logs\r\n  \r\n  //  SK MONITORING QUERIES\r\n  const operatorSchool = user?.role === \"operator\" ? user?.unitKerja : undefined\r\n  \r\n  const skStats = useQuery(convexApi.dashboard.getSkStatistics, { \r\n    unitKerja: operatorSchool \r\n  })\r\n  const skTrend = useQuery(convexApi.dashboard.getSkTrendByMonth, { \r\n    months: 6,\r\n    unitKerja: operatorSchool \r\n  })\r\n\r\n  //  REDIRECT OPERATOR (After all hooks are called)\r\n  if (user && user.role === 'operator') {\r\n      return <DashboardOperator />\r\n  }\r\n\r\n\r\n  // Use Convex real-time data directly\r\n  const stats = convexStats ? {\r\n    schoolCount: convexStats.totalSchools,\r\n    teacherCount: convexStats.totalTeachers,\r\n    studentCount: convexStats.totalStudents,\r\n    skCount: convexStats.totalSk,\r\n  } : {\r\n    schoolCount: 0,\r\n    teacherCount: 0,\r\n    studentCount: 0,\r\n    skCount: 0,\r\n  }\r\n\r\n  const masterDataStats = [\r\n    { title: \"Total Sekolah\", value: stats.schoolCount, icon: School, color: \"text-blue-500\" },\r\n    { title: \"Total Guru/PTK\", value: stats.teacherCount, icon: Users, color: \"text-green-500\" },\r\n    { title: \"Total Siswa\", value: stats.studentCount, icon: Users, color: \"text-orange-500\" },\r\n  ]\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-2\">\r\n         <div className=\"flex items-center gap-3\">\r\n           <h1 className=\"text-3xl font-bold tracking-tight\">Dashboard Overview</h1>\r\n           {convexStats && (\r\n             <div className=\"flex items-center gap-1.5 px-2.5 py-1 bg-green-100 border border-green-300 rounded-full\">\r\n               <div className=\"w-2 h-2 bg-green-500 rounded-full animate-pulse\" />\r\n               <span className=\"text-xs font-semibold text-green-700\">LIVE</span>\r\n             </div>\r\n           )}\r\n         </div>\r\n         <p className=\"text-muted-foreground\">\r\n            Selamat datang, <span className=\"font-semibold text-foreground\">{user?.name || \"Admin\"}</span> ({user?.role === 'super_admin' ? 'Super Admin' : 'Operator'}).\r\n         </p>\r\n      </div>\r\n\r\n\r\n\r\n      <div className=\"grid gap-4 md:grid-cols-3\">\r\n        {masterDataStats.map((stat, i) => (\r\n          <Card key={i}>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">\r\n                {stat.title}\r\n              </CardTitle>\r\n              <stat.icon className={`h-4 w-4 ${stat.color}`} />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stat.value}</div>\r\n\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n       {/*  PETA MUTU / ANALYTICS CHARTS */}\r\n       <DashboardCharts data={analyticsStats} />\r\n\r\n       {/*  SK MONITORING SECTION */}\r\n       {skStats && (\r\n         <>\r\n           <div className=\"mt-8\">\r\n             <h2 className=\"text-2xl font-bold tracking-tight mb-4\">Monitoring Surat Keputusan</h2>\r\n           </div>\r\n\r\n           {/* SK Statistics Cards */}\r\n           <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n             <Card>\r\n               <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                 <CardTitle className=\"text-sm font-medium\">Total SK</CardTitle>\r\n                 <FileText className=\"h-4 w-4 text-blue-500\" />\r\n               </CardHeader>\r\n               <CardContent>\r\n                 <div className=\"text-2xl font-bold\">{skStats.total}</div>\r\n                 <p className=\"text-xs text-muted-foreground\">\r\n                   Semua pengajuan SK\r\n                 </p>\r\n               </CardContent>\r\n             </Card>\r\n\r\n             <Card>\r\n               <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                 <CardTitle className=\"text-sm font-medium\">Pending Review</CardTitle>\r\n                 <Clock className=\"h-4 w-4 text-yellow-500\" />\r\n               </CardHeader>\r\n               <CardContent>\r\n                 <div className=\"text-2xl font-bold text-yellow-600\">{skStats.pending}</div>\r\n                 <p className=\"text-xs text-muted-foreground\">\r\n                   Menunggu persetujuan\r\n                 </p>\r\n               </CardContent>\r\n             </Card>\r\n\r\n             <Card>\r\n               <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                 <CardTitle className=\"text-sm font-medium\">Disetujui</CardTitle>\r\n                 <CheckCircle className=\"h-4 w-4 text-green-500\" />\r\n               </CardHeader>\r\n               <CardContent>\r\n                 <div className=\"text-2xl font-bold text-green-600\">{skStats.approved}</div>\r\n                 <p className=\"text-xs text-muted-foreground\">\r\n                   SK telah disetujui\r\n                 </p>\r\n               </CardContent>\r\n             </Card>\r\n\r\n             <Card>\r\n               <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n                 <CardTitle className=\"text-sm font-medium\">Ditolak</CardTitle>\r\n                 <AlertOctagon className=\"h-4 w-4 text-red-500\" />\r\n               </CardHeader>\r\n               <CardContent>\r\n                 <div className=\"text-2xl font-bold text-red-600\">{skStats.rejected}</div>\r\n                 <p className=\"text-xs text-muted-foreground\">\r\n                   Perlu perbaikan\r\n                 </p>\r\n               </CardContent>\r\n             </Card>\r\n           </div>\r\n\r\n           {/* SK Trend Chart */}\r\n           {skTrend && skTrend.length > 0 && (\r\n             <Card className=\"mt-4\">\r\n               <CardHeader>\r\n                 <CardTitle>Trend Pengajuan SK (6 Bulan Terakhir)</CardTitle>\r\n               </CardHeader>\r\n               <CardContent>\r\n                 <div className=\"h-[300px] w-full\">\r\n                   <div className=\"flex items-end justify-around h-full gap-2 pb-8\">\r\n                     {skTrend.map((data, idx) => {\r\n                       const maxCount = Math.max(...skTrend.map(d => d.count))\r\n                       const height = maxCount > 0 ? (data.count / maxCount) * 100 : 0\r\n                       \r\n                       return (\r\n                         <div key={idx} className=\"flex flex-col items-center flex-1\">\r\n                           <div className=\"text-xs font-semibold mb-1\">{data.count}</div>\r\n                           <div \r\n                             className=\"w-full bg-blue-500 hover:bg-blue-600 transition-all rounded-t-md\" \r\n                             style={{ height: `${height}%`, minHeight: data.count > 0 ? '20px' : '0px' }}\r\n                           />\r\n                           <div className=\"text-xs text-muted-foreground mt-2 whitespace-nowrap\">\r\n                             {data.month}\r\n                           </div>\r\n                         </div>\r\n                       )\r\n                     })}\r\n                   </div>\r\n                 </div>\r\n               </CardContent>\r\n             </Card>\r\n           )}\r\n         </>\r\n       )}\r\n\r\n       {/*  ACTIVITY & STATUS SECTION - Moved to bottom */}\r\n       <div className=\"grid gap-4 md:grid-cols-2 mt-6\">\r\n          <Card className=\"col-span-1\">\r\n             <CardHeader>\r\n                 <CardTitle>Aktivitas Terkini</CardTitle>\r\n             </CardHeader>\r\n             <CardContent>\r\n                 <div className=\"space-y-4\">\r\n                     {logs ? (\r\n                         logs.length > 0 ? (\r\n                            logs.map((log, i) => (\r\n                                <div key={i} className=\"flex items-center gap-4 border-b pb-2 last:border-0\">\r\n                                   <div className=\"h-2 w-2 rounded-full bg-blue-500\"/>\r\n                                   <div className=\"flex-1 space-y-1\">\r\n                                       <p className=\"text-sm font-medium leading-none\">{log.action}</p>\r\n                                       <p className=\"text-xs text-muted-foreground\">{log.details}</p>\r\n                                   </div>\r\n                                   <div className=\"text-xs text-muted-foreground\">\r\n                                     {new Date(log.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}\r\n                                   </div>\r\n                                </div>\r\n                            ))\r\n                         ) : (\r\n                             <p className=\"text-sm text-muted-foreground\">Belum ada aktivitas.</p>\r\n                         )\r\n                     ) : (\r\n                         <p className=\"text-sm text-muted-foreground\">Memuat aktivitas...</p>\r\n                     )}\r\n                 </div>\r\n             </CardContent>\r\n          </Card>\r\n\r\n           <Card className=\"col-span-1\">\r\n             <CardHeader>\r\n                 <CardTitle>Status Import Data EMIS</CardTitle>\r\n             </CardHeader>\r\n             <CardContent>\r\n                 <div className=\"flex items-center gap-2 mb-4\">\r\n                    <CheckCircle className=\"h-5 w-5 text-green-500\"/>\r\n                    <span className=\"text-sm font-medium\">Terakhir sinkronisasi: 24 Des 2025, 08:00</span>\r\n                 </div>\r\n                 <div className=\"rounded-md bg-muted p-4\">\r\n                     <p className=\"text-xs text-muted-foreground\">Data sinkronisasi mencakup 140 Sekolah. 2 Sekolah gagal impor data.</p>\r\n                 </div>\r\n             </CardContent>\r\n          </Card>\r\n       </div>\r\n     </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\DashboardCharts.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\dashboard\\components\\DashboardCharts.tsx:23:5\n  21 |\n  22 |   useEffect(() => {\n> 23 |     setIsClient(true)\n     |     ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  24 |   }, [])\n  25 |\n  26 |   useEffect(() => {","line":23,"column":5,"nodeType":null,"endLine":23,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'name' is defined but never used.","line":125,"column":46,"nodeType":null,"messageId":"unusedVar","endLine":125,"endColumn":50}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Legend } from \"recharts\"\r\nimport { useEffect, useState } from \"react\"\r\n\r\nconst COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d']\r\n\r\n// ... imports remain same\r\n\r\ninterface DashboardChartsProps {\r\n    data?: {\r\n        status: { name: string, value: number }[]\r\n        units: { name: string, jumlah: number }[]\r\n        certification: { name: string, value: number }[]\r\n        kecamatan: { name: string, jumlah: number }[]\r\n    }\r\n}\r\n\r\nexport function DashboardCharts({ data }: DashboardChartsProps) {\r\n  const [isClient, setIsClient] = useState(false)\r\n  const [hasError, setHasError] = useState(false)\r\n\r\n  useEffect(() => {\r\n    setIsClient(true)\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    const handleError = () => setHasError(true)\r\n    window.addEventListener('error', handleError)\r\n    return () => window.removeEventListener('error', handleError)\r\n  }, [])\r\n\r\n  if (!isClient) return null\r\n  if (hasError) {\r\n    return (\r\n      <Card className=\"mt-6\">\r\n          <CardContent className=\"pt-6 text-center text-muted-foreground\">\r\n              Charts unavailable.\r\n          </CardContent>\r\n      </Card>\r\n    )\r\n  }\r\n\r\n  const statusData = data?.status || []\r\n  const unitData = data?.units || []\r\n  const certData = data?.certification || []\r\n  const kecData = data?.kecamatan || []\r\n\r\n  return (\r\n    <div className=\"space-y-6 mt-6\">\r\n        \r\n        {/* ROW 1: Status & Unit Kerja */}\r\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-7\">\r\n            <Card className=\"col-span-4\">\r\n                <CardHeader>\r\n                <CardTitle>Distribusi Guru per Unit Kerja</CardTitle>\r\n                <CardDescription>5 Lembaga dengan jumlah guru terbanyak.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"pl-2\">\r\n                <div className=\"h-[300px]\">\r\n                    {unitData.length > 0 ? (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <BarChart data={unitData}>\r\n                                <XAxis dataKey=\"name\" stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} />\r\n                                <YAxis stroke=\"#888888\" fontSize={12} tickLine={false} axisLine={false} />\r\n                                <Tooltip />\r\n                                <Bar dataKey=\"jumlah\" fill=\"#3b82f6\" radius={[4, 4, 0, 0]} barSize={40} />\r\n                            </BarChart>\r\n                        </ResponsiveContainer>\r\n                    ) : <div className=\"flex items-center justify-center h-full text-muted-foreground\">No Data</div>}\r\n                </div>\r\n                </CardContent>\r\n            </Card>\r\n            \r\n            <Card className=\"col-span-3\">\r\n                <CardHeader>\r\n                <CardTitle>Status Kepegawaian</CardTitle>\r\n                <CardDescription>Proporsi guru berdasarkan status.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                <div className=\"h-[300px]\">\r\n                    {statusData.length > 0 ? (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <PieChart>\r\n                                <Pie\r\n                                    data={statusData}\r\n                                    cx=\"50%\"\r\n                                    cy=\"50%\"\r\n                                    innerRadius={60}\r\n                                    outerRadius={80}\r\n                                    paddingAngle={5}\r\n                                    dataKey=\"value\"\r\n                                >\r\n                                    {statusData.map((_entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\r\n                                    ))}\r\n                                </Pie>\r\n                                <Tooltip />\r\n                                <Legend />\r\n                            </PieChart>\r\n                        </ResponsiveContainer>\r\n                    ) : <div className=\"flex items-center justify-center h-full text-muted-foreground\">No Data</div>}\r\n                </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n\r\n        {/* ROW 2: Certification & Kecamatan */}\r\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-7\">\r\n             <Card className=\"col-span-3\">\r\n                <CardHeader>\r\n                <CardTitle>Status Sertifikasi</CardTitle>\r\n                <CardDescription>Guru yang sudah vs belum sertifikasi.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent>\r\n                <div className=\"h-[300px]\">\r\n                    {certData.length > 0 ? (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <PieChart>\r\n                                <Pie\r\n                                    data={certData}\r\n                                    cx=\"50%\"\r\n                                    cy=\"50%\"\r\n                                    outerRadius={80}\r\n                                    dataKey=\"value\"\r\n                                    label={({name, percent}) => `${(percent * 100).toFixed(0)}%`}\r\n                                >\r\n                                    {certData.map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={entry.name.includes(\"Belum\") ? '#e5e7eb' : '#22c55e'} />\r\n                                    ))}\r\n                                </Pie>\r\n                                <Tooltip />\r\n                                <Legend />\r\n                            </PieChart>\r\n                        </ResponsiveContainer>\r\n                    ) : <div className=\"flex items-center justify-center h-full text-muted-foreground\">No Data</div>}\r\n                </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            <Card className=\"col-span-4\">\r\n                <CardHeader>\r\n                <CardTitle>Sebaran per Kecamatan</CardTitle>\r\n                <CardDescription>Konsentrasi guru di setiap wilayah.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"pl-2\">\r\n                <div className=\"h-[300px]\">\r\n                    {kecData.length > 0 ? (\r\n                        <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                            <BarChart data={kecData} layout=\"vertical\">\r\n                                <XAxis type=\"number\" hide />\r\n                                <YAxis dataKey=\"name\" type=\"category\" width={100} stroke=\"#888888\" fontSize={11} tickLine={false} axisLine={false} />\r\n                                <Tooltip />\r\n                                <Bar dataKey=\"jumlah\" fill=\"#f59e0b\" radius={[0, 4, 4, 0]} barSize={20} />\r\n                            </BarChart>\r\n                        </ResponsiveContainer>\r\n                    ) : <div className=\"flex items-center justify-center h-full text-muted-foreground\">No Data</div>}\r\n                </div>\r\n                </CardContent>\r\n            </Card>\r\n        </div>\r\n\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\DashboardOperator.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":41,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":41,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1874,1877],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1874,1877],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\n\r\nimport { School, Users, FileText, CheckCircle, Clock } from \"lucide-react\"\r\nimport { useQuery } from \"convex/react\"\r\nimport { api } from \"../../../../convex/_generated/api\"\r\nimport { useNavigate } from \"react-router-dom\"\r\n\r\nexport default function DashboardOperator() {\r\n  const navigate = useNavigate()\r\n  const userStr = localStorage.getItem(\"user\")\r\n  const user = userStr ? JSON.parse(userStr) : null\r\n\r\n  // Pass email explicitly\r\n  const stats = useQuery(api.dashboard.getSchoolStats, user?.email ? { email: user.email } : \"skip\")\r\n\r\n  /* DEBUG: Check stats payload */\r\n  // console.log(\"Operator Stats:\", stats)\r\n\r\n  const quickActions = [\r\n    { label: \"Data Guru\", icon: Users, path: \"/dashboard/master/teachers\", color: \"bg-blue-100 text-blue-700\" },\r\n    { label: \"Data Siswa\", icon: School, path: \"/dashboard/master/students\", color: \"bg-orange-100 text-orange-700\" },\r\n    { label: \"Buat SK\", icon: FileText, path: \"/dashboard/sk/new\", color: \"bg-green-100 text-green-700\" }, // Bulk Submission\r\n    { label: \"Profil Sekolah\", icon: School, path: \"/dashboard/school/profile\", color: \"bg-purple-100 text-purple-700\" },\r\n  ]\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-2\">\r\n        <h1 className=\"text-3xl font-bold tracking-tight\">Dashboard Sekolah</h1>\r\n        <p className=\"text-muted-foreground\">\r\n           Selamat datang, Operator <span className=\"font-semibold text-foreground\">{user?.unitKerja || \"Sekolah\"}</span>.\r\n        </p>\r\n      </div>\r\n\r\n      {stats === undefined ? (\r\n        <div className=\"grid gap-4 md:grid-cols-4\">\r\n            {[1,2,3,4].map(i => (\r\n                <div key={i} className=\"h-32 rounded-lg bg-gray-100 animate-pulse\" />\r\n            ))}\r\n        </div>\r\n      ) : (stats === null || (stats as any).error) ? (\r\n         // Error state\r\n         <div className=\"p-4 bg-yellow-50 text-yellow-800 rounded-lg space-y-2\">\r\n            <p className=\"font-semibold\">Data statistik tidak tersedia.</p>\r\n            <div className=\"text-xs font-mono bg-yellow-100 p-2 rounded overflow-auto\">\r\n                <strong>Debug Info:</strong><br/>\r\n                User Email (Local): \"{user?.email}\"<br/>\r\n                User Unit: \"{user?.unit}\"<br/>\r\n                Stats Raw: {JSON.stringify(stats, null, 2)}<br/>\r\n                API Args: {JSON.stringify(user?.email ? { email: user.email } : \"skip\")}\r\n            </div>\r\n         </div>\r\n      ) : (\r\n        <div className=\"grid gap-4 md:grid-cols-2 lg:grid-cols-4\">\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Total Guru</CardTitle>\r\n              <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.teachers}</div>\r\n              <p className=\"text-xs text-muted-foreground\">Guru Aktif</p>\r\n            </CardContent>\r\n          </Card>\r\n          \r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Total Siswa</CardTitle>\r\n              <School className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.students}</div>\r\n              <p className=\"text-xs text-muted-foreground\">Terdaftar</p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">SK Terbit</CardTitle>\r\n              <CheckCircle className=\"h-4 w-4 text-green-500\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.skApproved}</div>\r\n              <p className=\"text-xs text-muted-foreground\">Sudah diverifikasi</p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">SK Draft</CardTitle>\r\n              <Clock className=\"h-4 w-4 text-yellow-500\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{stats.skDrafts}</div>\r\n              <p className=\"text-xs text-muted-foreground\">Menunggu persetujuan</p>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n\r\n      {/* QUICK ACTIONS */}\r\n      <div>\r\n        <h3 className=\"text-lg font-semibold mb-3\">Akses Cepat</h3>\r\n        <div className=\"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4\">\r\n            {quickActions.map((action, i) => (\r\n                <Card \r\n                    key={i} \r\n                    className=\"cursor-pointer hover:shadow-md transition-all border-l-4 border-l-transparent hover:border-l-primary\"\r\n                    onClick={() => navigate(action.path)}\r\n                >\r\n                    <CardContent className=\"flex flex-col items-center justify-center p-6 gap-3 text-center\">\r\n                        <div className={`p-3 rounded-full ${action.color}`}>\r\n                            <action.icon className=\"h-6 w-6\" />\r\n                        </div>\r\n                        <span className=\"font-medium text-sm\">{action.label}</span>\r\n                    </CardContent>\r\n                </Card>\r\n            ))}\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\KecamatanBarChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\MonthlySKTrendChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\PDPKPNUCard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\SKStatusPieChart.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\dashboard\\components\\SkeletonLoaders.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\emis-import\\EmisImportPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'api' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":13}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import ImportWizard from \"./components/ImportWizard\"\r\nimport { api } from \"@/lib/api\"\r\n\r\nexport default function EmisImportPage() {\r\n  // The following code block seems to be intended for a component that handles the upload logic,\r\n  // likely within the ImportWizard or a similar component.\r\n  // For the purpose of this edit, it's placed here as per the instruction's structure,\r\n  // assuming `parsedData`, `setIsUploading`, `setFile`, `setParsedData`, `setStep`, `fileInputRef`, and `toast`\r\n  // would be defined or imported within this scope if this function were to be used directly here.\r\n  // However, given the existing `ImportWizard` component, this logic might belong inside it.\r\n  // I'm placing it here as a standalone function for now, as the instruction doesn't provide context\r\n  // on where these variables are defined.\r\n  // This function is not called anywhere in the current EmisImportPage component.\r\n\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-2\">\r\n         <h1 className=\"text-3xl font-bold tracking-tight\">Import Data EMIS</h1>\r\n         <p className=\"text-muted-foreground\">Upload file export EMIS (Excel/CSV) untuk memperbarui data Sekolah, Guru, dan Siswa.</p>\r\n      </div>\r\n\r\n      <ImportWizard />\r\n\r\n      <div className=\"rounded-lg border bg-blue-50 p-4 text-sm text-blue-900\">\r\n         <strong>Catatan:</strong> Pastikan format file sesuai dengan template standar EMIS terbaru. Sistem akan otomatis mendeteksi kolom yang sesuai.\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\emis-import\\components\\FileUploadStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'disabled' is defined but never used.","line":14,"column":58,"nodeType":null,"messageId":"unusedVar","endLine":14,"endColumn":66},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":56,"column":32,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":35,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2618,2621],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2618,2621],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3660,3663],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3660,3663],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { UploadCloud, FileSpreadsheet, Loader2 } from \"lucide-react\"\r\nimport { useCallback, useState } from \"react\"\r\nimport * as XLSX from \"xlsx\"\r\nimport * as mammoth from \"mammoth\"\r\n\r\ninterface FileUploadStepProps {\r\n  onFileAccepted: (file: File, headers: string[], data: Record<string, unknown>[]) => void\r\n  disabled?: boolean\r\n  onDownloadTeacherTemplate?: () => void\r\n  onDownloadStudentTemplate?: () => void\r\n}\r\n\r\nexport default function FileUploadStep({ onFileAccepted, disabled, onDownloadTeacherTemplate, onDownloadStudentTemplate }: FileUploadStepProps) {\r\n  const [isDragOver, setIsDragOver] = useState(false)\r\n  const [isProcessing, setIsProcessing] = useState(false)\r\n\r\n  const processFile = useCallback((file: File) => {\r\n    setIsProcessing(true)\r\n    const reader = new FileReader()\r\n\r\n    reader.onload = async (e) => {\r\n        try {\r\n            const data = e.target?.result\r\n            if (!data) return\r\n\r\n            let jsonData: Record<string, unknown>[] = []\r\n\r\n            if (file.name.endsWith(\".docx\") || file.name.endsWith(\".doc\")) {\r\n                 try {\r\n                     // Use static import\r\n                     const arrayBuffer = data as ArrayBuffer;\r\n                     const result = await mammoth.convertToHtml({ arrayBuffer });\r\n                     const html = result.value;\r\n                     \r\n                     const parser = new DOMParser();\r\n                     const doc = parser.parseFromString(html, 'text/html');\r\n                     const table = doc.querySelector('table');\r\n\r\n                     if (table) {\r\n                         const rows = Array.from(table.querySelectorAll('tr'));\r\n                         if (rows.length > 0) {\r\n                             const headers = Array.from(rows[0].querySelectorAll('td, th')).map(cell => cell.textContent?.trim() || \"\");\r\n                             jsonData = rows.slice(1).map(row => {\r\n                                 const cells = Array.from(row.querySelectorAll('td'));\r\n                                 const obj: Record<string, unknown> = {};\r\n                                 headers.forEach((header, index) => {\r\n                                     obj[header] = cells[index]?.textContent?.trim() || \"\";\r\n                                 });\r\n                                 return obj;\r\n                             });\r\n                         }\r\n                     } else {\r\n                         throw new Error(\"Tidak ditemukan tabel dalam file Word ini.\");\r\n                     }\r\n                 } catch (err: any) {\r\n                     console.error(\"Mammoth error:\", err);\r\n                     throw new Error(\"Gagal memproses file Word: \" + err.message);\r\n                 }\r\n            } else {\r\n                // EXCEL / CSV Processing\r\n                const workbook = XLSX.read(data, { type: 'binary' })\r\n                const sheetName = workbook.SheetNames[0]\r\n                const sheet = workbook.Sheets[sheetName]\r\n                jsonData = XLSX.utils.sheet_to_json(sheet, { defval: \"\" }) as Record<string, unknown>[]\r\n            }\r\n            \r\n            if (jsonData.length > 0) {\r\n                 const headers = Object.keys(jsonData[0] as object)\r\n                 // Artificial delay for UX\r\n                 setTimeout(() => {\r\n                    onFileAccepted(file, headers, jsonData)\r\n                    setIsProcessing(false)\r\n                 }, 800)\r\n            } else {\r\n                alert(\"File kosong atau format tidak valid\")\r\n                setIsProcessing(false)\r\n            }\r\n        } catch (error: any) {\r\n            console.error(error)\r\n            alert(error.message || \"Gagal membaca file\")\r\n            setIsProcessing(false)\r\n        }\r\n    }\r\n    \r\n    if (file.name.endsWith(\".docx\") || file.name.endsWith(\".doc\")) {\r\n        reader.readAsArrayBuffer(file)\r\n    } else {\r\n        reader.readAsBinaryString(file)\r\n    }\r\n  }, [onFileAccepted])\r\n\r\n  const handleDrop = (e: React.DragEvent) => {\r\n    e.preventDefault()\r\n    setIsDragOver(false)\r\n    const files = e.dataTransfer.files\r\n    if (files.length > 0) {\r\n        processFile(files[0])\r\n    }\r\n  }\r\n\r\n  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      if (e.target.files && e.target.files.length > 0) {\r\n          processFile(e.target.files[0])\r\n      }\r\n  }\r\n\r\n  return (\r\n    <div className=\"flex h-full flex-col items-center justify-center p-12 text-center\">\r\n      <div \r\n        className={`flex w-full max-w-xl flex-col items-center justify-center rounded-xl border-2 border-dashed p-10 transition-colors\r\n            ${isDragOver ? \"border-primary bg-blue-50\" : \"border-slate-200 bg-slate-50\"}\r\n        `}\r\n        onDragOver={(e) => { e.preventDefault(); setIsDragOver(true) }}\r\n        onDragLeave={() => setIsDragOver(false)}\r\n        onDrop={handleDrop}\r\n      >\r\n        <div className=\"mb-4 rounded-full bg-slate-100 p-4\">\r\n             {isProcessing ? <Loader2 className=\"h-8 w-8 animate-spin text-primary\" /> : <UploadCloud className=\"h-8 w-8 text-slate-500\" />}\r\n        </div>\r\n        \r\n        <h3 className=\"mb-1 text-lg font-semibold\">\r\n            {isProcessing ? \"Memproses File...\" : \"Upload File EMIS\"}\r\n        </h3>\r\n        <p className=\"mb-6 text-sm text-muted-foreground\">\r\n             Drag & drop file Excel (.xlsx), Word (.docx) atau CSV di sini.\r\n        </p>\r\n\r\n        <div className=\"relative\">\r\n             <input \r\n                type=\"file\" \r\n                accept=\".xlsx, .xls, .csv, .docx, .doc\" \r\n                aria-label=\"Upload Excel, CSV, or Word file\"\r\n                className=\"absolute inset-0 cursor-pointer opacity-0\"\r\n                onChange={handleFileSelect}\r\n                disabled={isProcessing}\r\n            />\r\n            <Button disabled={isProcessing}>Pilih File</Button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"mt-8 grid grid-cols-2 gap-4 text-left\">\r\n          <button \r\n            type=\"button\"\r\n            onClick={onDownloadTeacherTemplate}\r\n            disabled={!onDownloadTeacherTemplate || isProcessing}\r\n            className=\"flex items-center gap-3 rounded-lg border p-3 hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer\"\r\n          >\r\n               <FileSpreadsheet className=\"h-5 w-5 text-green-600\"/>\r\n               <div className=\"text-xs text-left\">\r\n                   <p className=\"font-medium\">Template Guru</p>\r\n                   <span className=\"text-muted-foreground\">Download .xlsx / .docx</span>\r\n               </div>\r\n          </button>\r\n          <button \r\n            type=\"button\"\r\n            onClick={onDownloadStudentTemplate}\r\n            disabled={!onDownloadStudentTemplate || isProcessing}\r\n            className=\"flex items-center gap-3 rounded-lg border p-3 hover:bg-slate-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer\"\r\n          >\r\n               <FileSpreadsheet className=\"h-5 w-5 text-green-600\"/>\r\n               <div className=\"text-xs text-left\">\r\n                   <p className=\"font-medium\">Template Siswa</p>\r\n                   <span className=\"text-muted-foreground\">Download .xlsx / .docx</span>\r\n               </div>\r\n          </button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\emis-import\\components\\ImportWizard.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\emis-import\\components\\MappingStep.tsx","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\emis-import\\components\\MappingStep.tsx:44:5\n  42 |         }\n  43 |     })\n> 44 |     setMapping(initialMapping)\n     |     ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  45 |   }, [headers])\n  46 |\n  47 |   const handleMapChange = (targetKey: string, sourceHeader: string) => {","line":44,"column":5,"nodeType":null,"endLine":44,"endColumn":15}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\" // Note: Assuming we have Table component\r\nimport { ArrowLeft, ArrowRight, RotateCcw } from \"lucide-react\"\r\nimport { useEffect, useState } from \"react\"\r\n\r\n// Defines the internal schema we expect\r\nconst TARGET_SCHEMA = [\r\n    { key: \"nisn\", label: \"NISN\", required: true },\r\n    { key: \"nik\", label: \"NIK\", required: true },\r\n    { key: \"name\", label: \"Nama Lengkap\", required: true },\r\n    { key: \"gender\", label: \"Jenis Kelamin (L/P)\", required: true },\r\n    { key: \"birthPlace\", label: \"Tempat Lahir\", required: false },\r\n    { key: \"birthDate\", label: \"Tanggal Lahir\", required: false },\r\n    { key: \"class\", label: \"Kelas\", required: true },\r\n    { key: \"fatherName\", label: \"Nama Ayah\", required: false },\r\n    { key: \"motherName\", label: \"Nama Ibu\", required: false },\r\n    { key: \"address\", label: \"Alamat\", required: false },\r\n]\r\n\r\ninterface MappingStepProps {\r\n  headers: string[]\r\n  sampleData: Record<string, unknown>[] // First few rows to show examples\r\n  onNext: (mapping: Record<string, string>) => void\r\n  onBack: () => void\r\n}\r\n\r\nexport default function MappingStep({ headers, sampleData, onNext, onBack }: MappingStepProps) {\r\n  const [mapping, setMapping] = useState<Record<string, string>>({})\r\n\r\n  // Auto-map logic\r\n  useEffect(() => {\r\n    const initialMapping: Record<string, string> = {}\r\n    TARGET_SCHEMA.forEach(field => {\r\n        // Simple fuzzy match: check if header includes field key or label parts\r\n        const match = headers.find(h => \r\n            h.toLowerCase().includes(field.key) || \r\n            h.toLowerCase().includes(field.label.split(\" \")[0].toLowerCase())\r\n        )\r\n        if (match) {\r\n            initialMapping[field.key] = match\r\n        }\r\n    })\r\n    setMapping(initialMapping)\r\n  }, [headers])\r\n\r\n  const handleMapChange = (targetKey: string, sourceHeader: string) => {\r\n      setMapping(prev => ({ ...prev, [targetKey]: sourceHeader }))\r\n  }\r\n\r\n  const isFormValid = TARGET_SCHEMA.every(field => !field.required || mapping[field.key])\r\n\r\n  return (\r\n    <div className=\"p-6\">\r\n      <div className=\"mb-6 flex items-center justify-between\">\r\n         <div>\r\n            <h3 className=\"text-lg font-semibold\">Mapping Data</h3>\r\n            <p className=\"text-sm text-muted-foreground\">Pasangkan kolom dari file Excel Anda ke kolom sistem Database SIM Maarif.</p>\r\n         </div>\r\n         <Button variant=\"outline\" size=\"sm\" onClick={() => setMapping({})}>\r\n            <RotateCcw className=\"mr-2 h-4 w-4\"/> Reset Mapping\r\n         </Button>\r\n      </div>\r\n\r\n      <div className=\"rounded-md border\">\r\n        <Table>\r\n            <TableHeader>\r\n                <TableRow>\r\n                    <TableHead className=\"w-[300px]\">Kolom Sistem (Target)</TableHead>\r\n                    <TableHead className=\"w-[300px]\">Kolom File Excel (Sumber)</TableHead>\r\n                    <TableHead>Contoh Data (Baris 1)</TableHead>\r\n                </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n                {TARGET_SCHEMA.map((field) => {\r\n                    const selectedSource = mapping[field.key]\r\n                    const sampleValue = selectedSource && sampleData.length > 0 ? sampleData[0][selectedSource] : \"-\"\r\n                    \r\n                    return (\r\n                        <TableRow key={field.key}>\r\n                            <TableCell>\r\n                                <div className=\"flex flex-col\">\r\n                                    <span className=\"font-medium\">\r\n                                        {field.label} {field.required && <span className=\"text-red-500\">*</span>}\r\n                                    </span>\r\n                                    <span className=\"text-xs text-muted-foreground\">{field.key}</span>\r\n                                </div>\r\n                            </TableCell>\r\n                            <TableCell>\r\n                                <Select \r\n                                    value={selectedSource || \"\"} \r\n                                    onValueChange={(val) => handleMapChange(field.key, val)}\r\n                                >\r\n                                    <SelectTrigger>\r\n                                        <SelectValue placeholder=\"Pilih Kolom...\" />\r\n                                    </SelectTrigger>\r\n                                    <SelectContent>\r\n                                        {headers.map(h => (\r\n                                            <SelectItem key={h} value={h}>{h}</SelectItem>\r\n                                        ))}\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </TableCell>\r\n                            <TableCell className=\"text-muted-foreground\">\r\n                                {String(sampleValue)}\r\n                            </TableCell>\r\n                        </TableRow>\r\n                    )\r\n                })}\r\n            </TableBody>\r\n        </Table>\r\n      </div>\r\n\r\n      <div className=\"mt-8 flex justify-between\">\r\n          <Button variant=\"outline\" onClick={onBack}>\r\n              <ArrowLeft className=\"mr-2 h-4 w-4\"/> Kembali\r\n          </Button>\r\n          <Button onClick={() => onNext(mapping)} disabled={!isFormValid}>\r\n              Lanjut Validasi <ArrowRight className=\"ml-2 h-4 w-4\"/>\r\n          </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\emis-import\\components\\PreviewStep.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":11,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":14,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[507,510],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[507,510],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":90,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":90,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3847,3850],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3847,3850],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useMemo, useState } from \"react\"\r\nimport { toast } from \"sonner\"\r\nimport { CheckCircle, AlertCircle, Save, ArrowLeft } from \"lucide-react\"\r\nimport { Button } from \"@/components/ui/button\"\r\n//  CONVEX for bulk import\r\nimport { useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../../convex/_generated/api\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\n\r\ninterface PreviewStepProps {\r\n    data: any[]\r\n    mapping: Record<string, string>\r\n    onBack: () => void\r\n    onFinish: () => void\r\n}\r\n\r\nexport function PreviewStep({ data, mapping, onBack, onFinish }: PreviewStepProps) {\r\n    const [isSaving, setIsSaving] = useState(false)\r\n    \r\n    //  CONVEX MUTATION for bulk import\r\n    const bulkCreateMutation = useMutation(convexApi.students.bulkCreate)\r\n\r\n  // Transform Data\r\n  const transformedData = useMemo(() => {\r\n      return data.map((row, idx) => {\r\n          // Explicitly cast to Record<string, unknown> to allow dynamic property access\r\n          const newRow: Record<string, unknown> & { _id: number, _errors: string[] } = { _id: idx, _errors: [] }\r\n          Object.entries(mapping).forEach(([targetKey, sourceHeader]) => {\r\n              newRow[targetKey] = row[sourceHeader]\r\n          })\r\n\r\n          // Validation Logic\r\n          if (!newRow.nisn) newRow._errors.push(\"NISN wajib diisi\")\r\n          else if (!/^\\d{10}$/.test(String(newRow.nisn))) newRow._errors.push(\"Format NISN salah (10 digit)\")\r\n\r\n          if (!newRow.nik) newRow._errors.push(\"NIK wajib diisi\")\r\n          else if (!/^\\d{16}$/.test(String(newRow.nik))) newRow._errors.push(\"Format NIK salah (16 digit)\")\r\n\r\n          if (!newRow.name) newRow._errors.push(\"Nama wajib diisi\")\r\n          if (!newRow.gender) newRow._errors.push(\"JK wajib diisi\")\r\n          if (!newRow.class) newRow._errors.push(\"Kelas wajib diisi\")\r\n          \r\n          if (!newRow.birthDate) newRow._errors.push(\"Tgl Lahir wajib diisi\")\r\n          if (!newRow.birthPlace) newRow._errors.push(\"Tempat Lahir wajib diisi\")\r\n\r\n          return newRow\r\n      })\r\n  }, [data, mapping])\r\n\r\n  const invalidRows = transformedData.filter(r => r._errors.length > 0)\r\n  const validCount = transformedData.length - invalidRows.length\r\n\r\n  const handleSave = async () => {\r\n      setIsSaving(true)\r\n      try {\r\n          // Filter only valid rows and map EMIS fields to student schema\r\n          const validData = transformedData\r\n            .filter(r => r._errors.length === 0)\r\n            .map((row) => ({\r\n              nisn: String(row.nisn),\r\n              nama: String(row.name || ''),\r\n              nomorIndukMaarif: row.nomorIndukMaarif ? String(row.nomorIndukMaarif) : undefined,\r\n              jenisKelamin: row.gender ? String(row.gender) : undefined,\r\n              tempatLahir: row.birthPlace ? String(row.birthPlace) : undefined,\r\n              tanggalLahir: row.birthDate ? String(row.birthDate) : undefined,\r\n              alamat: row.alamat ? String(row.alamat) : undefined,\r\n              kecamatan: row.kecamatan ? String(row.kecamatan) : undefined,\r\n              namaSekolah: row.namaSekolah ? String(row.namaSekolah) : undefined,\r\n              kelas: row.class ? String(row.class) : undefined,\r\n              nomorTelepon: row.nomorTelepon ? String(row.nomorTelepon) : undefined,\r\n              namaWali: row.namaWali ? String(row.namaWali) : undefined,\r\n            }))\r\n          \r\n          if (validData.length === 0) {\r\n              toast.error(\"Tidak ada data valid untuk disimpan\")\r\n              return\r\n          }\r\n\r\n          //  CALL CONVEX MUTATION\r\n          const result = await bulkCreateMutation({ students: validData })\r\n          toast.success(`Berhasil menyimpan ${result.count} data siswa`)\r\n          onFinish()\r\n      } catch (err: any) {\r\n          toast.error(err.message || \"Gagal menyimpan data\")\r\n      } finally {\r\n          setIsSaving(false)\r\n      }\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-6\">\r\n      <div className=\"mb-6\">\r\n         <h3 className=\"text-lg font-semibold\">Validasi & Preview</h3>\r\n         <div className=\"mt-2 flex gap-4 text-sm\">\r\n             <div className=\"rounded-md bg-green-50 px-3 py-1 text-green-700\">\r\n                 <CheckCircle className=\"mr-1 inline h-4 w-4\"/> {validCount} Baris Valid\r\n             </div>\r\n             <div className=\"rounded-md bg-red-50 px-3 py-1 text-red-700\">\r\n                 <AlertCircle className=\"mr-1 inline h-4 w-4\"/> {invalidRows.length} Baris Error\r\n             </div>\r\n         </div>\r\n      </div>\r\n\r\n      <div className=\"max-h-[500px] overflow-auto rounded-md border\">\r\n        <Table>\r\n            <TableHeader>\r\n                <TableRow>\r\n                     <TableHead className=\"w-[50px]\">No</TableHead>\r\n                     <TableHead>NISN</TableHead>\r\n                     <TableHead>Nama Lengkap</TableHead>\r\n                     <TableHead>JK</TableHead>\r\n                     <TableHead>Kelas</TableHead>\r\n                     <TableHead>Status</TableHead>\r\n                </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n                {transformedData.slice(0, 50).map((row, i) => (\r\n                    <TableRow key={row._id} className={row._errors.length > 0 ? \"bg-red-50 hover:bg-red-100\" : \"\"}>\r\n                        <TableCell>{i + 1}</TableCell>\r\n                        <TableCell>{String(row.nisn || '-')}</TableCell>\r\n                        <TableCell>{String(row.name || '-')}</TableCell>\r\n                        <TableCell>{String(row.gender || '-')}</TableCell>\r\n                        <TableCell>{String(row.class || '-')}</TableCell>\r\n                        <TableCell>\r\n                            {row._errors.length > 0 ? (\r\n                                <span className=\"text-xs font-medium text-red-600\">\r\n                                    {row._errors.join(\", \")}\r\n                                </span>\r\n                            ) : (\r\n                                <span className=\"text-xs text-green-600\">OK</span>\r\n                            )}\r\n                        </TableCell>\r\n                    </TableRow>\r\n                ))}\r\n            </TableBody>\r\n        </Table>\r\n      </div>\r\n      <p className=\"mt-2 text-xs text-muted-foreground\">* Menampilkan 50 data pertama.</p>\r\n\r\n      <div className=\"mt-8 flex justify-between\">\r\n          <Button variant=\"outline\" onClick={onBack} disabled={isSaving}>\r\n              <ArrowLeft className=\"mr-2 h-4 w-4\"/> Kembali\r\n          </Button>\r\n          <Button onClick={handleSave} disabled={isSaving || (invalidRows.length > 0 && validCount === 0)}>\r\n              {isSaving ? \"Menyimpan...\" : `Simpan ${validCount} Data Valid`} <Save className=\"ml-2 h-4 w-4\"/>\r\n          </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\CompetitionDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[848,851],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[848,851],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":169,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7298,7301],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7298,7301],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7372,7375],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7372,7375],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nimport React, { useEffect, useState } from 'react';\r\nimport { useParams, useNavigate } from 'react-router-dom';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport ExcelImportModal from \"../master-data/components/ExcelImportModal\";\r\nimport { ArrowLeft, Loader2, Download } from 'lucide-react';\r\nimport ParticipantList from './components/ParticipantList';\r\nimport ResultInput from './components/ResultInput';\r\n\r\nimport { API_URL } from '@/lib/api';\r\n\r\nexport default function CompetitionDetailPage() {\r\n  const { competitionId } = useParams();\r\n  const navigate = useNavigate();\r\n  const [competition, setCompetition] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  useEffect(() => {\r\n    if (competitionId) {\r\n      setLoading(true);\r\n      setError(null);\r\n      fetch(`${API_URL}/events/competitions/${competitionId}`)\r\n        .then(async (res) => {\r\n            if (!res.ok) {\r\n                const text = await res.text();\r\n                throw new Error(`Error ${res.status}: ${text}`);\r\n            }\r\n            return res.json();\r\n        })\r\n        .then((data) => setCompetition(data))\r\n        .catch((err) => {\r\n            console.error(err);\r\n            setError(err.message);\r\n        })\r\n        .finally(() => setLoading(false));\r\n    }\r\n  }, [competitionId]);\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex justify-center items-center h-screen\">\r\n        <Loader2 className=\"animate-spin\" />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (error) {\r\n      return (\r\n          <div className=\"p-8 text-center\">\r\n              <h3 className=\"text-lg font-semibold text-red-600\">Terjadi Kesalahan</h3>\r\n              <p className=\"text-gray-500\">{error}</p>\r\n              <Button variant=\"outline\" onClick={() => navigate(-1)} className=\"mt-4\">\r\n                <ArrowLeft size={16} className=\"mr-2\" /> Kembali\r\n              </Button>\r\n          </div>\r\n      )\r\n  }\r\n\r\n  if (!competition) {\r\n    return <div className=\"p-8\">Kompetisi tidak ditemukan.</div>;\r\n  }\r\n\r\n  return (\r\n    <div className=\"p-8 space-y-6\">\r\n      <Button variant=\"outline\" onClick={() => navigate(-1)} className=\"mb-4\">\r\n        <ArrowLeft size={16} className=\"mr-2\" /> Kembali\r\n      </Button>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <div className=\"flex justify-between items-start\">\r\n            <div>\r\n              <CardTitle className=\"text-3xl\">{competition.name}</CardTitle>\r\n              <p className=\"text-gray-500 mt-2\">\r\n                {competition.event?.name} | {competition.category} | {competition.type}\r\n              </p>\r\n            </div>\r\n            <div className=\"text-right text-sm text-gray-500\">\r\n              <p>\r\n                {competition.date && !isNaN(new Date(competition.date).getTime()) \r\n                  ? new Date(competition.date).toLocaleDateString('id-ID', { dateStyle: 'full' }) \r\n                  : '-'}\r\n              </p>\r\n              <p>{competition.location || '-'}</p>\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n      </Card>\r\n\r\n      <Tabs defaultValue=\"participants\">\r\n        <TabsList>\r\n          <TabsTrigger value=\"participants\">Peserta ({competition.participants?.length || 0})</TabsTrigger>\r\n          <TabsTrigger value=\"results\">Hasil / Nilai</TabsTrigger>\r\n          <TabsTrigger value=\"certificates\">Sertifikat</TabsTrigger>\r\n        </TabsList>\r\n\r\n        <TabsContent value=\"participants\">\r\n          <ParticipantList competitionId={competition.id} participants={competition.participants || []} />\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"results\" className=\"pt-4\">\r\n             <div className=\"flex justify-end mb-4\">\r\n                <ExcelImportModal \r\n                    title=\"Import Hasil Kompetisi\"\r\n                    description=\"Upload file Excel (.xlsx). Format: Juara, Nama, Lembaga, Nilai.\"\r\n                    triggerLabel=\"Import Hasil (Excel)\"\r\n                    onFileImport={async (file) => {\r\n                        if(!competitionId) return;\r\n                        await api.importCompetitionResults(competitionId, file)\r\n                        window.location.reload()\r\n                    }}\r\n                />\r\n            </div>\r\n            <ResultInput competitionId={competitionId!} />\r\n        </TabsContent>\r\n\r\n        <TabsContent value=\"certificates\">\r\n          <Card>\r\n            <CardContent className=\"p-6\">\r\n                <div className=\"mb-6 p-4 border rounded bg-gray-50\">\r\n                    <h4 className=\"font-semibold mb-2\">Template Sertifikat Custom</h4>\r\n                    <p className=\"text-sm text-gray-500 mb-2\">Upload gambar (JPG/PNG) untuk dijadikan background sertifikat.</p>\r\n                    <div className=\"flex items-center gap-2\">\r\n                        <Input \r\n                            type=\"file\" \r\n                            accept=\"image/*\"\r\n                            onChange={async (e) => {\r\n                                const file = e.target.files?.[0];\r\n                                if (!file) return;\r\n                                \r\n                                const formData = new FormData();\r\n                                formData.append('file', file);\r\n                                \r\n                                try {\r\n                                    setLoading(true);\r\n                                    const res = await fetch(`${API_URL}/events/competitions/${competition.id}/template`, {\r\n                                        method: 'POST',\r\n                                        body: formData,\r\n                                    });\r\n                                    if (res.ok) {\r\n                                        alert('Template berhasil diupload!');\r\n                                        // Refresh competition data\r\n                                        const updated = await res.json();\r\n                                        setCompetition(updated); \r\n                                    } else {\r\n                                        alert('Gagal upload template');\r\n                                    }\r\n                                } catch (err) {\r\n                                    console.error(err);\r\n                                    alert('Terjadi kesalahan saat upload');\r\n                                } finally {\r\n                                    setLoading(false);\r\n                                }\r\n                            }}\r\n                        />\r\n                    </div>\r\n                    {competition.certificateTemplate && (\r\n                        <p className=\"text-xs text-green-600 mt-2\"> Template custom aktif</p>\r\n                    )}\r\n                </div>\r\n\r\n              <h3 className=\"text-lg font-semibold mb-4\">Download Sertifikat</h3>\r\n              <div className=\"grid gap-2\">\r\n                {competition.participants?.length === 0 && <p className=\"text-gray-500\">Belum ada peserta.</p>}\r\n                {competition.participants?.map((p: any) => {\r\n                  const result = competition.results?.find((r: any) => r.participantId === p.id || r.participant?.id === p.id);\r\n                  return (\r\n                    <div key={p.id} className=\"flex justify-between items-center p-3 border rounded hover:bg-gray-50\">\r\n                      <div>\r\n                        <div className=\"font-medium\">{p.name}</div>\r\n                        <div className=\"text-xs text-gray-500\">{p.institution}</div>\r\n                        {result && (\r\n                            <div className=\"text-xs text-blue-600 mt-1 font-medium\">\r\n                                {result.rank ? `Juara ${result.rank}` : 'Peserta'} \r\n                                {result.score ? ` (Nilai: ${result.score})` : ''}\r\n                            </div>\r\n                        )}\r\n                      </div>\r\n                      <a\r\n                        href={`${API_URL}/events/competitions/${competition.id}/certificates/${p.id}`}\r\n                        target=\"_blank\"\r\n                        rel=\"noreferrer\"\r\n                      >\r\n                        <Button variant=\"outline\" size=\"sm\">\r\n                          <Download size={14} className=\"mr-2\" /> Download\r\n                        </Button>\r\n                      </a>\r\n                    </div>\r\n                  );\r\n                })}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\CreateEventPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'API_URL' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":17}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { API_URL } from '@/lib/api';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Label } from '@/components/ui/label';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { useNavigate } from 'react-router-dom';\r\nimport { Loader2 } from 'lucide-react';\r\n\r\nexport default function CreateEventPage() {\r\n  const navigate = useNavigate();\r\n  const [loading, setLoading] = useState(false);\r\n  const [formData, setFormData] = useState({\r\n    name: '',\r\n    category: '',\r\n    type: 'Individual',\r\n    date: '',\r\n    location: '',\r\n    description: '',\r\n  });\r\n\r\n  const handleSubmit = async (e: React.FormEvent) => {\r\n    e.preventDefault();\r\n    setLoading(true);\r\n    try {\r\n      await api.createEvent(formData);\r\n      toast.success(\"Event berhasil dibuat\");\r\n      navigate('/dashboard/events');\r\n    } catch (error) {\r\n      console.error(error);\r\n      toast.error(\"Gagal membuat event\");\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"max-w-2xl mx-auto p-6\">\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Buat Event Baru</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <form onSubmit={handleSubmit} className=\"space-y-4\">\r\n            <div className=\"space-y-2\">\r\n              <Label>Nama Event / Lomba</Label>\r\n              <Input\r\n                required\r\n                value={formData.name}\r\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\r\n                placeholder=\"Contoh: Porseni Kabupaten 2024\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Kategori</Label>\r\n                <Input \r\n                   required\r\n                   value={formData.category}\r\n                   onChange={(e) => setFormData({ ...formData, category: e.target.value })}\r\n                   placeholder=\"Contoh: Olahraga, Seni\"\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Tipe Peserta</Label>\r\n                <Select\r\n                  value={formData.type}\r\n                  onValueChange={(val) => setFormData({ ...formData, type: val })}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"Individual\">Individu / Perorangan</SelectItem>\r\n                    <SelectItem value=\"Team\">Tim / Beregu</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid grid-cols-2 gap-4\">\r\n              <div className=\"space-y-2\">\r\n                <Label>Tanggal Pelaksanaan</Label>\r\n                <Input\r\n                  type=\"date\"\r\n                  required\r\n                  value={formData.date}\r\n                  onChange={(e) => setFormData({ ...formData, date: e.target.value })}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-2\">\r\n                <Label>Lokasi</Label>\r\n                <Input\r\n                  value={formData.location}\r\n                  onChange={(e) => setFormData({ ...formData, location: e.target.value })}\r\n                  placeholder=\"Tempat pelaksanaan\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-2\">\r\n              <Label>Deskripsi / Keterangan</Label>\r\n              <Textarea\r\n                value={formData.description}\r\n                onChange={(e) => setFormData({ ...formData, description: e.target.value })}\r\n                placeholder=\"Deskripsi tambahan...\"\r\n              />\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-2 pt-4\">\r\n              <Button type=\"button\" variant=\"outline\" onClick={() => navigate('/dashboard/events')}>\r\n                Batal\r\n              </Button>\r\n              <Button type=\"submit\" disabled={loading}>\r\n                {loading && <Loader2 className=\"animate-spin mr-2\" size={16} />}\r\n                Simpan Event\r\n              </Button>\r\n            </div>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\EventDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[820,823],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[820,823],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":222,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":222,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11436,11439],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11436,11439],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":264,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":264,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13684,13687],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13684,13687],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\events\\EventDetailPage.tsx:290:9\n  288 |\n  289 |     useEffect(() => {\n> 290 |         fetchTally();\n      |         ^^^^^^^^^^ Avoid calling setState() directly within an effect\n  291 |     }, [eventId]);\n  292 |\n  293 |     if (loading) return <div className=\"py-8 text-center text-gray-500\"><Loader2 className=\"animate-spin inline mr-2\" /> Memuat data medali...</div>;","line":290,"column":9,"nodeType":null,"endLine":290,"endColumn":19},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchTally'. Either include it or remove the dependency array.","line":291,"column":8,"nodeType":"ArrayExpression","endLine":291,"endColumn":17,"suggestions":[{"desc":"Update the dependencies array to be: [eventId, fetchTally]","fix":{"range":[14502,14511],"text":"[eventId, fetchTally]"}}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchEvent'. Either include it or remove the dependency array.","line":37,"column":6,"nodeType":"ArrayExpression","endLine":37,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [fetchEvent, id]","fix":{"range":[1488,1492],"text":"[fetchEvent, id]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":4,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { API_URL } from '@/lib/api';\r\nimport { useParams, Link } from 'react-router-dom';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Plus, Trophy, Calendar, MapPin, ChevronRight, Loader2 } from 'lucide-react';\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\n\r\nexport default function EventDetailPage() {\r\n  const { id } = useParams();\r\n  const [event, setEvent] = useState<any>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [isCreateOpen, setIsCreateOpen] = useState(false);\r\n  const [newCompetition, setNewCompetition] = useState({\r\n      name: '',\r\n      category: 'Olahraga',\r\n      type: 'Individual',\r\n      date: '',\r\n      location: ''\r\n  });\r\n\r\n  const fetchEvent = () => {\r\n      setLoading(true);\r\n      fetch(`${API_URL}/events/${id}`)\r\n        .then(res => res.json())\r\n        .then(data => setEvent(data))\r\n        .catch(err => console.error(err))\r\n        .finally(() => setLoading(false));\r\n  };\r\n\r\n  useEffect(() => {\r\n    fetchEvent();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [id]);\r\n\r\n  const [isBulk, setIsBulk] = useState(false);\r\n  const [bulkNames, setBulkNames] = useState('');\r\n  const [saving, setSaving] = useState(false);\r\n\r\n  // ... (useEffect remains same)\r\n\r\n  const handleCreateCompetition = async () => {\r\n      setSaving(true);\r\n      try {\r\n          if (isBulk) {\r\n              const names = bulkNames.split('\\n').filter(n => n.trim().length > 0);\r\n              const promises = names.map(name => \r\n                  fetch(`${API_URL}/events/${id}/competitions`, {\r\n                      method: 'POST',\r\n                      headers: { 'Content-Type': 'application/json' },\r\n                      body: JSON.stringify({\r\n                          ...newCompetition,\r\n                          name: name.trim(),\r\n                          date: newCompetition.date || null, // Sanitize empty string to null\r\n                          location: newCompetition.location || null\r\n                      })\r\n                  })\r\n              );\r\n              await Promise.all(promises);\r\n          } else {\r\n              await fetch(`${API_URL}/events/${id}/competitions`, {\r\n                  method: 'POST',\r\n                  headers: { 'Content-Type': 'application/json' },\r\n                  body: JSON.stringify({\r\n                      ...newCompetition,\r\n                      date: newCompetition.date || null, // Sanitize empty string to null\r\n                      location: newCompetition.location || null\r\n                  })\r\n              });\r\n          }\r\n          \r\n          setIsCreateOpen(false);\r\n          setNewCompetition({ name: '', category: 'Olahraga', type: 'Individual', date: '', location: '' });\r\n          setBulkNames('');\r\n          setIsBulk(false);\r\n          fetchEvent();\r\n      } catch (error) {\r\n          console.error(error);\r\n      } finally {\r\n          setSaving(false);\r\n      }\r\n  };\r\n\r\n  if (loading) return <div className=\"flex justify-center p-8\"><Loader2 className=\"animate-spin\" /></div>;\r\n  if (!event) return <div>Event tidak ditemukan.</div>;\r\n\r\n  return (\r\n    <div className=\"p-6 space-y-6\">\r\n      <div className=\"flex justify-between items-start\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold\">{event.name}</h1>\r\n          <p className=\"text-gray-500 mt-1 flex items-center gap-2\">\r\n             <Calendar size={14} /> {event.date && !isNaN(new Date(event.date).getTime()) ? new Date(event.date).toLocaleDateString('id-ID', { dateStyle: 'full' }) : '-'}\r\n             <span className=\"mx-2\"></span>\r\n             <MapPin size={14} /> {event.location}\r\n          </p>\r\n          <p className=\"text-gray-600 mt-2\">{event.description}</p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n            <Dialog open={isCreateOpen} onOpenChange={setIsCreateOpen}>\r\n                <DialogTrigger asChild>\r\n                  <Button>\r\n                    <Plus size={16} className=\"mr-2\" /> Tambah Cabang Lomba\r\n                  </Button>\r\n                </DialogTrigger>\r\n                <DialogContent>\r\n                    <DialogHeader>\r\n                        <DialogTitle>Tambah Cabang Lomba</DialogTitle>\r\n                    </DialogHeader>\r\n                    <div className=\"space-y-4 py-4\">\r\n                        <div className=\"flex items-center space-x-2 pb-2 border-b\">\r\n                            <input \r\n                                type=\"checkbox\" \r\n                                id=\"bulkMode\" \r\n                                className=\"rounded border-gray-300\"\r\n                                checked={isBulk}\r\n                                onChange={e => setIsBulk(e.target.checked)}\r\n                            />\r\n                            <label htmlFor=\"bulkMode\" className=\"text-sm cursor-pointer select-none\">\r\n                                Mode Input Banyak (Bulk Insert)\r\n                            </label>\r\n                        </div>\r\n\r\n                        {isBulk ? (\r\n                             <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium\">Daftar Nama Lomba (Satu per baris)</label>\r\n                                <textarea \r\n                                    className=\"flex min-h-[150px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\"\r\n                                    value={bulkNames}\r\n                                    onChange={e => setBulkNames(e.target.value)}\r\n                                    placeholder={`Lari 100m Putri\\nLari 100m Putra\\nPidato Bahasa Arab\\nPidato Bahasa Inggris`}\r\n                                />\r\n                                <p className=\"text-xs text-muted-foreground\">Setiap baris akan menjadi satu cabang lomba dengan pengaturan yang sama di bawah ini.</p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium\">Nama Lomba</label>\r\n                                <Input \r\n                                    value={newCompetition.name} \r\n                                    onChange={e => setNewCompetition({...newCompetition, name: e.target.value})}\r\n                                    placeholder=\"Contoh: Lari 100m Putri\"\r\n                                />\r\n                            </div>\r\n                        )}\r\n\r\n                        <div className=\"grid grid-cols-2 gap-4\">\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium\">Kategori</label>\r\n                                <Select \r\n                                    value={newCompetition.category} \r\n                                    onValueChange={v => setNewCompetition({...newCompetition, category: v})}\r\n                                >\r\n                                    <SelectTrigger><SelectValue /></SelectTrigger>\r\n                                    <SelectContent>\r\n                                        <SelectItem value=\"Olahraga\">Olahraga</SelectItem>\r\n                                        <SelectItem value=\"Seni\">Seni</SelectItem>\r\n                                        <SelectItem value=\"Akademik\">Akademik</SelectItem>\r\n                                        <SelectItem value=\"Keagamaan\">Keagamaan</SelectItem>\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                            <div className=\"space-y-2\">\r\n                                <label className=\"text-sm font-medium\">Jenis</label>\r\n                                <Select \r\n                                    value={newCompetition.type} \r\n                                    onValueChange={v => setNewCompetition({...newCompetition, type: v})}\r\n                                >\r\n                                    <SelectTrigger><SelectValue /></SelectTrigger>\r\n                                    <SelectContent>\r\n                                        <SelectItem value=\"Individual\">Individual</SelectItem>\r\n                                        <SelectItem value=\"Beregu\">Beregu</SelectItem>\r\n                                    </SelectContent>\r\n                                </Select>\r\n                            </div>\r\n                        </div>\r\n                         <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium\">Jadwal (Opsional)</label>\r\n                            <Input \r\n                                type=\"datetime-local\"\r\n                                value={newCompetition.date} \r\n                                onChange={e => setNewCompetition({...newCompetition, date: e.target.value})}\r\n                            />\r\n                        </div>\r\n                         <div className=\"space-y-2\">\r\n                            <label className=\"text-sm font-medium\">Lokasi (Opsional)</label>\r\n                            <Input \r\n                                value={newCompetition.location} \r\n                                onChange={e => setNewCompetition({...newCompetition, location: e.target.value})}\r\n                                placeholder=\"Contoh: Lapangan Utama\"\r\n                            />\r\n                        </div>\r\n                        <Button onClick={handleCreateCompetition} className=\"w-full\" disabled={saving}>\r\n                            {saving ? <Loader2 className=\"animate-spin mr-2\" size={16} /> : null}\r\n                            Simpan {isBulk ? 'Semua' : ''}\r\n                        </Button>\r\n                    </div>\r\n                </DialogContent>\r\n            </Dialog>\r\n        </div>\r\n      </div>\r\n\r\n      <Tabs defaultValue=\"competitions\" className=\"space-y-4\">\r\n          <TabsList>\r\n              <TabsTrigger value=\"competitions\">Daftar Cabang Lomba</TabsTrigger>\r\n              <TabsTrigger value=\"medals\">Perolehan Medali</TabsTrigger>\r\n          </TabsList>\r\n\r\n          <TabsContent value=\"competitions\" className=\"space-y-4\">\r\n              <h2 className=\"text-xl font-semibold flex items-center gap-2\">\r\n                  <Trophy size={20} className=\"text-blue-500\" /> Daftar Cabang Lomba\r\n              </h2>\r\n              \r\n              <div className=\"grid md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n                  {event.competitions?.length === 0 && (\r\n                      <div className=\"col-span-full text-center py-12 text-gray-500 bg-gray-50 rounded-lg border border-dashed\">\r\n                          Belum ada cabang lomba. Silakan tambahkan lomba baru.\r\n                      </div>\r\n                  )}\r\n                  {event.competitions?.map((comp: any) => (\r\n                      <Link to={`/dashboard/competitions/${comp.id}`} key={comp.id}>\r\n                        <Card className=\"hover:border-blue-500 transition-colors cursor-pointer\">\r\n                            <CardHeader className=\"pb-2\">\r\n                                <CardTitle className=\"text-lg flex justify-between\">\r\n                                    {comp.name}\r\n                                    <ChevronRight size={16} className=\"text-gray-400\" />\r\n                                </CardTitle>\r\n                            </CardHeader>\r\n                            <CardContent>\r\n                                <div className=\"flex gap-2 text-xs text-gray-500 mb-4\">\r\n                                    <span className=\"px-2 py-1 bg-gray-100 rounded\">{comp.category}</span>\r\n                                    <span className=\"px-2 py-1 bg-gray-100 rounded\">{comp.type}</span>\r\n                                </div>\r\n                                <div className=\"space-y-1 text-sm text-gray-600\">\r\n                                    <p className=\"flex items-center gap-2\">\r\n                                        <Calendar size={12} /> \r\n                                        {comp.date && !isNaN(new Date(comp.date).getTime())\r\n                                            ? new Date(comp.date).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) \r\n                                            : 'Jadwal belum diatur'}\r\n                                    </p>\r\n                                    <p className=\"flex items-center gap-2\">\r\n                                        <MapPin size={12} />\r\n                                        {comp.location || 'Lokasi belum diatur'}\r\n                                    </p>\r\n                                </div>\r\n                            </CardContent>\r\n                        </Card>\r\n                      </Link>\r\n                  ))}\r\n              </div>\r\n          </TabsContent>\r\n\r\n          <TabsContent value=\"medals\">\r\n              <MedalTally eventId={id!} />\r\n          </TabsContent>\r\n      </Tabs>\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction MedalTally({ eventId }: { eventId: string }) {\r\n    const [tally, setTally] = useState<any[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    const fetchTally = () => {\r\n        setLoading(true);\r\n        fetch(`${API_URL}/events/${eventId}/tally`)\r\n            .then(res => {\r\n                if (!res.ok) throw new Error('Failed to fetch');\r\n                return res.json();\r\n            })\r\n            .then(data => {\r\n                if (Array.isArray(data)) {\r\n                    setTally(data);\r\n                } else {\r\n                    console.error(\"Invalid tally data\", data);\r\n                    setTally([]);\r\n                }\r\n            })\r\n            .catch(err => {\r\n                console.error(err);\r\n                setTally([]);\r\n            })\r\n            .finally(() => setLoading(false));\r\n    };\r\n\r\n    useEffect(() => {\r\n        fetchTally();\r\n    }, [eventId]);\r\n\r\n    if (loading) return <div className=\"py-8 text-center text-gray-500\"><Loader2 className=\"animate-spin inline mr-2\" /> Memuat data medali...</div>;\r\n\r\n    return (\r\n        <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n                <CardTitle>Klasemen Perolehan Medali</CardTitle>\r\n                <Button variant=\"outline\" size=\"sm\" onClick={fetchTally}>\r\n                     Refresh\r\n                </Button>\r\n            </CardHeader>\r\n            <CardContent>\r\n                <div className=\"rounded-md border\">\r\n                    <table className=\"w-full text-sm\">\r\n                        <thead className=\"bg-gray-50 border-b\">\r\n                            <tr>\r\n                                <th className=\"h-12 px-4 text-left font-medium text-gray-500\">Peringkat</th>\r\n                                <th className=\"h-12 px-4 text-left font-medium text-gray-500\">Lembaga / Sekolah</th>\r\n                                <th className=\"h-12 px-4 text-center font-medium text-yellow-600\">Emas</th>\r\n                                <th className=\"h-12 px-4 text-center font-medium text-gray-600\">Perak</th>\r\n                                <th className=\"h-12 px-4 text-center font-medium text-orange-600\">Perunggu</th>\r\n                                <th className=\"h-12 px-4 text-center font-medium text-gray-900\">Total</th>\r\n                            </tr>\r\n                        </thead>\r\n                        <tbody>\r\n                            {tally.length === 0 ? (\r\n                                <tr>\r\n                                    <td colSpan={6} className=\"h-24 text-center text-gray-500\">Belum ada data perolehan medali.</td>\r\n                                </tr>\r\n                            ) : (\r\n                                tally.map((item, index) => (\r\n                                    <tr key={index} className=\"border-b last:border-0 hover:bg-gray-50\">\r\n                                        <td className=\"p-4 font-medium\">{index + 1}</td>\r\n                                        <td className=\"p-4\">{item.institution}</td>\r\n                                        <td className=\"p-4 text-center font-bold text-yellow-600\">{item.gold}</td>\r\n                                        <td className=\"p-4 text-center font-bold text-gray-600\">{item.silver}</td>\r\n                                        <td className=\"p-4 text-center font-bold text-orange-600\">{item.bronze}</td>\r\n                                        <td className=\"p-4 text-center font-bold\">{item.total}</td>\r\n                                    </tr>\r\n                                ))\r\n                            )}\r\n                        </tbody>\r\n                    </table>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n    );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\EventsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":10,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[439,442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[439,442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'isLoading' is assigned a value but never used.","line":11,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":37,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":37,"endColumn":17}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useEffect, useState } from 'react';\r\nimport { api } from '@/lib/api';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Plus, Calendar, MapPin, Trash2 } from 'lucide-react';\r\nimport { Link } from 'react-router-dom';\r\nimport { toast } from 'sonner';\r\n\r\nexport default function EventsPage() {\r\n  const [events, setEvents] = useState<any[]>([]);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n\r\n  useEffect(() => {\r\n    loadEvents();\r\n  }, []);\r\n\r\n  const loadEvents = async () => {\r\n    try {\r\n        const data = await api.getEvents();\r\n        setEvents(data);\r\n    } catch (e) {\r\n        console.error(e);\r\n        toast.error(\"Gagal memuat event\");\r\n    } finally {\r\n        setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const handleDelete = async (e: React.MouseEvent, id: string) => {\r\n      e.preventDefault(); // Prevent Link navigation\r\n      if (!confirm(\"Hapus event ini?\")) return;\r\n\r\n      try {\r\n          await api.deleteEvent(id);\r\n          toast.success(\"Event dihapus\");\r\n          loadEvents();\r\n      } catch (e) {\r\n          toast.error(\"Gagal menghapus event\");\r\n      }\r\n  };\r\n\r\n  return (\r\n    <div className=\"p-6\">\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <h1 className=\"text-2xl font-bold\">Manajemen Lomba / Event</h1>\r\n        <Link to=\"/dashboard/events/new\">\r\n          <Button className=\"flex items-center gap-2\">\r\n            <Plus size={16} />\r\n            Buat Event Baru\r\n          </Button>\r\n        </Link>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n        {events.map((event) => (\r\n          <Link to={`/dashboard/events/${event.id}`} key={event.id} className=\"block group\">\r\n            <Card className=\"hover:shadow-lg transition-shadow cursor-pointer h-full relative\">\r\n              <CardHeader>\r\n                <div className=\"flex justify-between items-start\">\r\n                  <div>\r\n                    <span className=\"text-xs font-semibold px-2 py-1 bg-blue-100 text-blue-800 rounded-full\">\r\n                      {event.category}\r\n                    </span>\r\n                    <CardTitle className=\"mt-2 text-lg\">{event.name}</CardTitle>\r\n                  </div>\r\n                  <span className={`text-xs px-2 py-1 rounded-full ${\r\n                    event.status === 'OPEN' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'\r\n                  }`}>\r\n                    {event.status}\r\n                  </span>\r\n                </div>\r\n              </CardHeader>\r\n              <CardContent>\r\n                <div className=\"space-y-2 text-sm text-gray-600\">\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <Calendar size={14} />\r\n                    <span>{new Date(event.date).toLocaleDateString()}</span>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-2\">\r\n                    <MapPin size={14} />\r\n                    <span>{event.location}</span>\r\n                  </div>\r\n                  <p className=\"line-clamp-2 mt-2\">{event.description}</p>\r\n                </div>\r\n              </CardContent>\r\n\r\n              {/* Delete Button - Visible on Hover */}\r\n              <div className=\"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                  <Button \r\n                    variant=\"destructive\" \r\n                    size=\"icon\" \r\n                    className=\"h-8 w-8 rounded-full shadow-md\"\r\n                    onClick={(e) => handleDelete(e, event.id)}\r\n                  >\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                  </Button>\r\n              </div>\r\n            </Card>\r\n          </Link>\r\n        ))}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\components\\ParticipantList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\events\\components\\ResultInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\master-data\\SchoolDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useState' is defined but never used.","line":2,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Teacher' is defined but never used.","line":11,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":18},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'School' is defined but never used.","line":23,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":46,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":46,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1407,1410],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1407,1410],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2165,2168],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2165,2168],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useParams, useNavigate } from 'react-router-dom';\r\nimport { useEffect, useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\r\nimport { ArrowLeft, Phone, MapPin, User, Users, GraduationCap, Building2 } from 'lucide-react';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { useQuery } from \"convex/react\";\r\nimport { api as convexApi } from \"../../../convex/_generated/api\";\r\n\r\ninterface Teacher {\r\n  id: string;\r\n  nip: string;\r\n  nama: string;\r\n  status: string;\r\n  mapel: string;\r\n  sertifikasi: boolean;\r\n  isActive: boolean;\r\n  phoneNumber?: string;\r\n  kecamatan?: string;\r\n}\r\n\r\ninterface School {\r\n  id: string;\r\n  nsm: string;\r\n  npsn: string;\r\n  nama: string;\r\n  alamat: string;\r\n  kecamatan: string;\r\n  kepala: string;\r\n  noHpKepala?: string;\r\n  statusJamiyyah?: string;\r\n  akreditasi?: string;\r\n  status?: string;\r\n}\r\n\r\nexport default function SchoolDetailPage() {\r\n  const { id } = useParams();\r\n  const navigate = useNavigate();\r\n\r\n  // Get current user for RBAC\r\n  const userStr = localStorage.getItem(\"user\");\r\n  const user = userStr ? JSON.parse(userStr) : null;\r\n\r\n  // Use Convex real-time queries\r\n  const schoolData = useQuery(convexApi.schools.get, id ? { id: id as any } : \"skip\");\r\n  const teachersData = useQuery(convexApi.teachers.list, { \r\n    unitKerja: schoolData?.nama,\r\n    userEmail: user?.email \r\n  });\r\n\r\n  const loading = schoolData === undefined;\r\n  \r\n  // Map Convex data to School interface\r\n  const school = schoolData ? {\r\n    id: schoolData._id,\r\n    nsm: schoolData.nsm || \"\",\r\n    npsn: schoolData.npsn || \"\",\r\n    nama: schoolData.nama || \"\",\r\n    alamat: schoolData.alamat || \"\",\r\n    kecamatan: schoolData.kecamatan || \"\",\r\n    kepala: schoolData.kepalaMadrasah || \"\",\r\n    noHpKepala: schoolData.telepon || \"\",\r\n    statusJamiyyah: schoolData.statusJamiyyah || \"\",\r\n    akreditasi: schoolData.akreditasi || \"\",\r\n  } : null;\r\n\r\n  // Map teachers data\r\n  const teachers = (teachersData || []).map((t: any) => ({\r\n    id: t._id,\r\n    nip: t.nip || t.nuptk || \"\",\r\n    nama: t.nama || \"\",\r\n    status: t.status || \"\",\r\n    mapel: t.mapel || \"\",\r\n    sertifikasi: t.isCertified || false,\r\n    isActive: t.isActive ?? true,\r\n    phoneNumber: t.phoneNumber,\r\n    kecamatan: t.kecamatan,\r\n  }));\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-screen\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto\"></div>\r\n          <p className=\"mt-4 text-muted-foreground\">Memuat data...</p>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!school) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-screen\">\r\n        <div className=\"text-center\">\r\n          <Building2 className=\"h-16 w-16 text-muted-foreground mx-auto mb-4\" />\r\n          <h2 className=\"text-2xl font-bold mb-2\">Madrasah Tidak Ditemukan</h2>\r\n          <p className=\"text-muted-foreground mb-4\">Data madrasah yang Anda cari tidak tersedia</p>\r\n          <Button onClick={() => navigate('/dashboard/master/schools')}>\r\n            <ArrowLeft className=\"h-4 w-4 mr-2\" /> Kembali ke Daftar\r\n          </Button>\r\n        </div>\r\n      </div>\r\n    );\r\n  }\r\n\r\n  const activeTeachers = teachers.filter(t => t.isActive);\r\n  const certifiedTeachers = teachers.filter(t => t.sertifikasi);\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-start gap-4\">\r\n        <Button variant=\"ghost\" size=\"sm\" onClick={() => navigate('/dashboard/master/schools')}>\r\n          <ArrowLeft className=\"h-4 w-4 mr-2\" /> Kembali\r\n        </Button>\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">{school.nama}</h1>\r\n          <p className=\"text-sm text-muted-foreground\">NSM: {school.nsm}</p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* School Info Card */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Building2 className=\"h-5 w-5\" />\r\n            Informasi Madrasah\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <dl className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1\">NSM</dt>\r\n              <dd className=\"text-base font-semibold\">{school.nsm}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1\">NPSN</dt>\r\n              <dd className=\"text-base font-semibold\">{school.npsn || '-'}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50 md:col-span-2\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1 flex items-center gap-1\">\r\n                <MapPin className=\"h-3 w-3\" /> Alamat\r\n              </dt>\r\n              <dd className=\"text-base\">{school.alamat}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Kecamatan</dt>\r\n              <dd className=\"text-base font-semibold\">{school.kecamatan}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1 flex items-center gap-1\">\r\n                <User className=\"h-3 w-3\" /> Kepala Sekolah\r\n              </dt>\r\n              <dd className=\"text-base font-semibold\">{school.kepala || '-'}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1 flex items-center gap-1\">\r\n                <Phone className=\"h-3 w-3\" /> No HP Kepala\r\n              </dt>\r\n              <dd className=\"text-base font-mono\">{school.noHpKepala || '-'}</dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Status Jamiyyah</dt>\r\n              <dd className=\"text-base\">\r\n                <Badge variant=\"outline\">{school.statusJamiyyah || '-'}</Badge>\r\n              </dd>\r\n            </div>\r\n            <div className=\"p-3 rounded-lg bg-muted/50\">\r\n              <dt className=\"text-sm font-medium text-muted-foreground mb-1\">Akreditasi</dt>\r\n              <dd className=\"text-base\">\r\n                <Badge variant=\"default\">{school.akreditasi || '-'}</Badge>\r\n              </dd>\r\n            </div>\r\n          </dl>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Statistics */}\r\n      <div className=\"grid gap-4 md:grid-cols-3\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Guru & Tendik</CardTitle>\r\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{teachers.length}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {activeTeachers.length} aktif, {teachers.length - activeTeachers.length} non-aktif\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n        \r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Guru Bersertifikat</CardTitle>\r\n            <GraduationCap className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{certifiedTeachers.length}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {teachers.length > 0 ? ((certifiedTeachers.length / teachers.length) * 100).toFixed(0) : 0}% dari total\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Guru Aktif</CardTitle>\r\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{activeTeachers.length}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              {teachers.length > 0 ? ((activeTeachers.length / teachers.length) * 100).toFixed(0) : 0}% dari total\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Teachers Table */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Daftar Guru & Tenaga Kependidikan</CardTitle>\r\n          <p className=\"text-sm text-muted-foreground\">\r\n            Guru yang terdaftar di {school.nama}\r\n          </p>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {teachers.length === 0 ? (\r\n            <div className=\"text-center py-8\">\r\n              <Users className=\"h-12 w-12 text-muted-foreground mx-auto mb-4\" />\r\n              <p className=\"text-muted-foreground\">\r\n                Belum ada data guru untuk madrasah ini\r\n              </p>\r\n            </div>\r\n          ) : (\r\n            <div className=\"rounded-md border\">\r\n              <Table>\r\n                <TableHeader>\r\n                  <TableRow>\r\n                    <TableHead>NUPTK/NIP</TableHead>\r\n                    <TableHead>Nama</TableHead>\r\n                    <TableHead>Status</TableHead>\r\n                    <TableHead>Mapel</TableHead>\r\n                    <TableHead className=\"text-center\">Sertifikasi</TableHead>\r\n                    <TableHead className=\"text-center\">Status Aktif</TableHead>\r\n                  </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                  {teachers.map(teacher => (\r\n                    <TableRow key={teacher.id}>\r\n                      <TableCell className=\"font-mono text-sm\">{teacher.nip}</TableCell>\r\n                      <TableCell className=\"font-medium\">{teacher.nama}</TableCell>\r\n                      <TableCell>{teacher.status}</TableCell>\r\n                      <TableCell>{teacher.mapel || '-'}</TableCell>\r\n                      <TableCell className=\"text-center\">\r\n                        {teacher.sertifikasi ? (\r\n                          <Badge variant=\"default\" className=\"bg-green-600\">Ya</Badge>\r\n                        ) : (\r\n                          <Badge variant=\"secondary\">Belum</Badge>\r\n                        )}\r\n                      </TableCell>\r\n                      <TableCell className=\"text-center\">\r\n                        {teacher.isActive ? (\r\n                          <Badge variant=\"default\">Aktif</Badge>\r\n                        ) : (\r\n                          <Badge variant=\"destructive\">Non-Aktif</Badge>\r\n                        )}\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))}\r\n                </TableBody>\r\n              </Table>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\master-data\\SchoolListPage.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":588,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":588,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[25502,25505],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[25502,25505],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\master-data\\StudentListPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":53,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":53,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2171,2174],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2171,2174],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\master-data\\StudentListPage.tsx:128:7\n  126 |\n  127 |   useEffect(() => {\n> 128 |       setCurrentPage(1)\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  129 |   }, [searchTerm, sortConfig])\n  130 |\n  131 |   // Sort Handler","line":128,"column":7,"nodeType":null,"endLine":128,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":160,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":160,"endColumn":17},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":173,"column":67,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":70,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5667,5670],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5667,5670],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":177,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5840,5843],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5840,5843],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":198,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":198,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6583,6586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6583,6586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { Plus, Search, Trash2, Edit, ArrowUpDown, ArrowUp, ArrowDown, Download, FileSpreadsheet } from \"lucide-react\"\r\nimport { useState, useEffect, useMemo } from \"react\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { api } from \"@/lib/api\"\r\nimport SoftPageHeader from \"@/components/ui/SoftPageHeader\"\r\nimport ExcelImportModal from \"./components/ExcelImportModal\"\r\n//  CONVEX REAL-TIME\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\ninterface Student {\r\n  id: string\r\n  nisn: string\r\n  nama: string\r\n  kelas: string\r\n  sekolah: string\r\n  jk: \"L\" | \"P\"\r\n}\r\n\r\nexport default function StudentListPage() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  \r\n  // Manual Add Logic\r\n  const [isAddOpen, setIsAddOpen] = useState(false)\r\n  const [formData, setFormData] = useState<Partial<Student>>({\r\n      nisn: \"\", nama: \"\", kelas: \"\", sekolah: \"\", jk: \"L\"\r\n  })\r\n  const [isImportModalOpen, setIsImportModalOpen] = useState(false)\r\n\r\n  // PERMISSION: Filter by Unit Kerja for Operators\r\n  const [userUnit] = useState<string | null>(() => {\r\n    try {\r\n        const u = localStorage.getItem(\"user\")\r\n        if (u) {\r\n            const user = JSON.parse(u)\r\n            if (user.role !== \"super_admin\" && user.unitKerja) {\r\n                return user.unitKerja\r\n            }\r\n        }\r\n    } catch(e) { return null }\r\n    return null\r\n  })\r\n\r\n  //  REAL-TIME CONVEX QUERY\r\n  const convexStudents = useQuery(convexApi.students.list, {\r\n    namaSekolah: userUnit || undefined,\r\n  })\r\n\r\n  // Map Convex data to Student interface\r\n  const students = (convexStudents || []).map((s: any) => ({\r\n    id: s._id,\r\n    nisn: s.nisn || \"\",\r\n    nama: s.nama || \"\",\r\n    kelas: s.kelas || \"\",\r\n    sekolah: s.namaSekolah || \"\",\r\n    jk: s.jenisKelamin === \"Perempuan\" ? \"P\" : \"L\",\r\n  }))\r\n\r\n  // Convex mutations\r\n  const deleteStudentMutation = useMutation(convexApi.students.remove)\r\n\r\n  // Delete confirmation modal state\r\n  const [deleteConfirmOpen, setDeleteConfirmOpen] = useState(false)\r\n  const [studentToDelete, setStudentToDelete] = useState<{id: string, name: string} | null>(null)\r\n\r\n  // Sorting State\r\n  const [sortConfig, setSortConfig] = useState<{ key: keyof Student; direction: 'asc' | 'desc' } | null>(null);\r\n\r\n  const loadStudents = async () => {\r\n    // No longer needed - Convex auto-updates!\r\n    // Kept for compatibility\r\n  }\r\n\r\n\r\n  const filtered = students.filter(s => {\r\n    // 1. Role Filter\r\n    if (userUnit && s.sekolah !== userUnit) return false\r\n\r\n    return s.nama.toLowerCase().includes(searchTerm.toLowerCase()) || \r\n    s.nisn.includes(searchTerm) ||\r\n    s.sekolah.toLowerCase().includes(searchTerm.toLowerCase())\r\n  })\r\n\r\n  const sortedStudents = useMemo(() => {\r\n    const sortableItems = [...filtered];\r\n    if (sortConfig !== null) {\r\n      sortableItems.sort((a, b) => {\r\n        // Handle undefined values\r\n        const aValue = a[sortConfig.key] || \"\";\r\n        const bValue = b[sortConfig.key] || \"\";\r\n\r\n        if (aValue < bValue) {\r\n          return sortConfig.direction === 'asc' ? -1 : 1;\r\n        }\r\n        if (aValue > bValue) {\r\n          return sortConfig.direction === 'asc' ? 1 : -1;\r\n        }\r\n        return 0;\r\n      });\r\n    }\r\n    return sortableItems;\r\n  }, [filtered, sortConfig]);\r\n\r\n  // Pagination Logic\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const itemsPerPage = 10\r\n  const totalPages = Math.ceil(sortedStudents.length / itemsPerPage)\r\n\r\n  const paginatedStudents = sortedStudents.slice(\r\n      (currentPage - 1) * itemsPerPage,\r\n      currentPage * itemsPerPage\r\n  )\r\n\r\n  useEffect(() => {\r\n      setCurrentPage(1)\r\n  }, [searchTerm, sortConfig])\r\n\r\n  // Sort Handler\r\n  const requestSort = (key: keyof Student) => {\r\n    let direction: 'asc' | 'desc' = 'asc';\r\n    if (sortConfig && sortConfig.key === key && sortConfig.direction === 'asc') {\r\n      direction = 'desc';\r\n    }\r\n    setSortConfig({ key, direction });\r\n  };\r\n  \r\n  const getSortIcon = (name: keyof Student) => {\r\n      if (!sortConfig || sortConfig.key !== name) {\r\n          return <ArrowUpDown className=\"ml-2 h-4 w-4\" />\r\n      }\r\n      return sortConfig.direction === 'asc' ? <ArrowUp className=\"ml-2 h-4 w-4\" /> : <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n  }\r\n\r\n  const handleAdd = async () => {\r\n      if (!formData.nama || !formData.nisn) {\r\n          alert(\"Nama dan NISN wajib diisi\")\r\n          return\r\n      }\r\n      \r\n      try {\r\n          // TODO: Implement createStudent API\r\n          alert(\"Fitur tambah siswa belum diimplementasikan di backend\")\r\n          // await api.createStudent(formData)\r\n          // loadStudents()\r\n          setIsAddOpen(false)\r\n          setFormData({ nisn: \"\", nama: \"\", kelas: \"\", sekolah: \"\", jk: \"L\" })\r\n      } catch (e) {\r\n          alert(\"Gagal menambah siswa\")\r\n      }\r\n  }\r\n\r\n  const handleDelete = async (id: string, name: string) => {\r\n      setStudentToDelete({ id, name })\r\n      setDeleteConfirmOpen(true)\r\n  }\r\n\r\n  const confirmDelete = async () => {\r\n      if (!studentToDelete) return\r\n      try {\r\n          await deleteStudentMutation({ id: studentToDelete.id as any })\r\n          alert(` Siswa \"${studentToDelete.name}\" berhasil dihapus!`)\r\n          setDeleteConfirmOpen(false)\r\n          setStudentToDelete(null)\r\n      } catch (e: any) {\r\n          console.error('Delete error:', e)\r\n          alert(\" Gagal menghapus siswa: \" + e.message)\r\n      }\r\n  }\r\n\r\n  const cancelDelete = () => {\r\n      setDeleteConfirmOpen(false)\r\n      setStudentToDelete(null)\r\n  }\r\n\r\n  const handleExport = async () => {\r\n      try {\r\n          const blob = await api.exportStudents(userUnit || undefined)\r\n          const url = window.URL.createObjectURL(new Blob([blob]));\r\n          const link = document.createElement('a');\r\n          link.href = url;\r\n          link.setAttribute('download', `Data_Siswa_${new Date().toISOString().split('T')[0]}.xlsx`);\r\n          document.body.appendChild(link);\r\n          link.click();\r\n          link.parentNode?.removeChild(link);\r\n      } catch (e: any) {\r\n          console.error(e)\r\n          alert(\"Gagal mengexport data.\")\r\n      }\r\n  }\r\n\r\n  const downloadTemplate = async () => {\r\n      try {\r\n          const blob = await api.downloadStudentTemplate();\r\n          const url = window.URL.createObjectURL(new Blob([blob]));\r\n          const link = document.createElement('a');\r\n          link.href = url;\r\n          link.setAttribute('download', 'TEMPLATE_IMPORT_DATA_SISWA.xlsx');\r\n          document.body.appendChild(link);\r\n          link.click();\r\n          link.parentNode?.removeChild(link);\r\n          window.URL.revokeObjectURL(url);\r\n      } catch (error) {\r\n          console.error('Failed to download template:', error);\r\n          alert('Gagal mendownload template. Silakan coba lagi.');\r\n      }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <SoftPageHeader\r\n        title=\"Data Siswa\"\r\n        description=\"Data peserta didik di lingkungan LP Ma'arif NU Cilacap\"\r\n        actions={[\r\n          {\r\n            label: 'Export Excel',\r\n            onClick: handleExport,\r\n            variant: 'mint',\r\n            icon: <Download className=\"h-5 w-5 text-gray-700\" />\r\n          },\r\n          {\r\n            label: 'Download Template',\r\n            onClick: downloadTemplate,\r\n            variant: 'purple',\r\n            icon: <FileSpreadsheet className=\"h-5 w-5 text-gray-700\" />\r\n          },\r\n          {\r\n            label: 'Tambah Manual',\r\n            onClick: () => setIsAddOpen(true),\r\n            variant: 'cream',\r\n            icon: <Plus className=\"h-5 w-5 text-gray-700\" />\r\n          },\r\n          {\r\n            label: 'Import Excel',\r\n            onClick: () => setIsImportModalOpen(true),\r\n            variant: 'blue',\r\n            icon: <FileSpreadsheet className=\"h-5 w-5 text-gray-700\" />\r\n          }\r\n        ]}\r\n      />\r\n\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n             <div className=\"relative\">\r\n              <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n              <Input\r\n                placeholder=\"Cari nama, NISN, atau sekolah...\"\r\n                className=\"pl-9 max-w-sm\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n              />\r\n            </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n            <div className=\"rounded-md border\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead onClick={() => requestSort('nisn')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">NISN {getSortIcon('nisn')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('nama')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Nama Lengkap {getSortIcon('nama')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('jk')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">L/P {getSortIcon('jk')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('kelas')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Kelas {getSortIcon('kelas')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('sekolah')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Asal Sekolah {getSortIcon('sekolah')}</div>\r\n                      </TableHead>\r\n                      <TableHead className=\"text-right\">Aksi</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {paginatedStudents.length === 0 ? (\r\n                        <TableRow>\r\n                            <TableCell colSpan={6} className=\"h-24 text-center\">\r\n                                Tidak ada data siswa ditemukan.\r\n                            </TableCell>\r\n                        </TableRow>\r\n                    ) : (\r\n                        paginatedStudents.map((item) => (\r\n                          <TableRow key={item.id}>\r\n                            <TableCell className=\"font-medium\">{item.nisn}</TableCell>\r\n                            <TableCell>{item.nama}</TableCell>\r\n                            <TableCell>{item.jk}</TableCell>\r\n                            <TableCell>{item.kelas}</TableCell>\r\n                            <TableCell>{item.sekolah}</TableCell>\r\n                            <TableCell className=\"text-right space-x-2\">\r\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8\" onClick={() => {\r\n                                    setFormData(item)\r\n                                    setIsAddOpen(true)\r\n                                }}><Edit className=\"h-4 w-4\" /></Button>\r\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-red-500 hover:text-red-700\" onClick={() => handleDelete(item.id, item.nama)}><Trash2 className=\"h-4 w-4\" /></Button>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        ))\r\n                    )}\r\n                  </TableBody>\r\n                </Table>\r\n            </div>\r\n            \r\n            {/* Pagination Controls */}\r\n            <div className=\"flex items-center justify-end space-x-2 py-4\">\r\n                <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                    Halaman {currentPage} dari {totalPages} ({filtered.length} data)\r\n                </div>\r\n                <div className=\"space-x-2\">\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(1)}\r\n                        disabled={currentPage === 1}\r\n                    >\r\n                        First\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\r\n                        disabled={currentPage === 1}\r\n                    >\r\n                        Prev\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\r\n                        disabled={currentPage === totalPages}\r\n                    >\r\n                        Next\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(totalPages)}\r\n                        disabled={currentPage === totalPages}\r\n                    >\r\n                        Last\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n        </CardContent>\r\n    </Card>\r\n\r\n      <Dialog open={isAddOpen} onOpenChange={setIsAddOpen}>\r\n        <DialogContent>\r\n            <DialogHeader>\r\n                <DialogTitle>Tambah Data Siswa</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"grid gap-4 py-4\">\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"nisn\" className=\"text-right\">NISN</Label>\r\n                    <Input id=\"nisn\" className=\"col-span-3\" value={formData.nisn} onChange={e => setFormData({...formData, nisn: e.target.value})} />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"nama\" className=\"text-right\">Nama</Label>\r\n                    <Input id=\"nama\" className=\"col-span-3\" value={formData.nama} onChange={e => setFormData({...formData, nama: e.target.value})} />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"jk\" className=\"text-right\">Jenis Kelamin</Label>\r\n                    <Select value={formData.jk} onValueChange={(val: \"L\" | \"P\") => setFormData({...formData, jk: val})}>\r\n                        <SelectTrigger id=\"jk\" className=\"col-span-3\">\r\n                            <SelectValue placeholder=\"Pilih L/P\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"L\">Laki-laki</SelectItem>\r\n                            <SelectItem value=\"P\">Perempuan</SelectItem>\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"kelas\" className=\"text-right\">Kelas</Label>\r\n                    <Input id=\"kelas\" className=\"col-span-3\" value={formData.kelas} onChange={e => setFormData({...formData, kelas: e.target.value})} />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"sekolah\" className=\"text-right\">Asal Sekolah</Label>\r\n                    <Input id=\"sekolah\" className=\"col-span-3\" value={formData.sekolah} onChange={e => setFormData({...formData, sekolah: e.target.value})} />\r\n                </div>\r\n            </div>\r\n            <DialogFooter>\r\n                <Button variant=\"outline\" onClick={() => setIsAddOpen(false)}>Batal</Button>\r\n                <Button onClick={handleAdd}>Simpan</Button>\r\n            </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Excel Import Modal */}\r\n      <ExcelImportModal\r\n        isOpen={isImportModalOpen}\r\n        onClose={() => setIsImportModalOpen(false)}\r\n        onImportSuccess={loadStudents}\r\n        title=\"Import Data Siswa\"\r\n        description=\"Upload file Excel (.xlsx) untuk import data siswa\"\r\n        onFileImport={async (file) => {\r\n          await api.importStudents(file)\r\n        }}\r\n      />\r\n\r\n      {/* Delete Confirmation Modal */}\r\n      <Dialog open={deleteConfirmOpen} onOpenChange={setDeleteConfirmOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2 text-red-600\">\r\n              <Trash2 className=\"h-5 w-5\" />\r\n              Konfirmasi Hapus\r\n            </DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"py-4\">\r\n            <p className=\"text-sm text-muted-foreground mb-2\">\r\n              Yakin ingin menghapus siswa:\r\n            </p>\r\n            <p className=\"font-semibold text-lg mb-3\">\r\n              {studentToDelete?.name}\r\n            </p>\r\n            <div className=\"bg-red-50 border border-red-200 rounded-md p-3 mb-2\">\r\n              <p className=\"text-sm text-red-800 font-medium flex items-center gap-2\">\r\n                 Perhatian\r\n              </p>\r\n              <p className=\"text-xs text-red-700 mt-1\">\r\n                Data akan terhapus <strong>PERMANENT</strong> dari database dan tidak dapat dikembalikan!\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"gap-2 sm:gap-0\">\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={cancelDelete}\r\n            >\r\n              Batal\r\n            </Button>\r\n            <Button\r\n              variant=\"destructive\"\r\n              onClick={confirmDelete}\r\n              className=\"bg-red-600 hover:bg-red-700\"\r\n            >\r\n              <Trash2 className=\"h-4 w-4 mr-2\" />\r\n              Ya, Hapus\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\master-data\\TeacherListPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'TabsContent' is defined but never used.","line":15,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'removeTeacherMutation' is assigned a value but never used.","line":71,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":71,"endColumn":30},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":82,"column":51,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":82,"endColumn":54,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3518,3521],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3518,3521],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":104,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":104,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4203,4206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4203,4206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":163,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":163,"endColumn":14},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":188,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":188,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7332,7335],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7332,7335],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":195,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":195,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7600,7603],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7600,7603],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'getStatusColor' is assigned a value but never used.","line":274,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":274,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":299,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":299,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11100,11103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11100,11103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":321,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":321,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12426,12429],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12426,12429],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":404,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":404,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15226,15229],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15226,15229],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":416,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":416,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15738,15741],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15738,15741],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":801,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":801,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[39913,39916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[39913,39916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":896,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":896,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44242,44245],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44242,44245],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":915,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":915,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[45524,45527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[45524,45527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":927,"column":24,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":927,"endColumn":25,"suggestions":[{"messageId":"removeEscape","fix":{"range":[46036,46037],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[46036,46036],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":942,"column":50,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":942,"endColumn":51,"suggestions":[{"messageId":"removeEscape","fix":{"range":[46776,46777],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[46776,46776],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":942,"column":54,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":942,"endColumn":55,"suggestions":[{"messageId":"removeEscape","fix":{"range":[46780,46781],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[46780,46780],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":942,"column":67,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":942,"endColumn":68,"suggestions":[{"messageId":"removeEscape","fix":{"range":[46793,46794],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[46793,46793],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":942,"column":71,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":942,"endColumn":72,"suggestions":[{"messageId":"removeEscape","fix":{"range":[46797,46798],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[46797,46797],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":952,"column":48,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":952,"endColumn":49,"suggestions":[{"messageId":"removeEscape","fix":{"range":[47533,47534],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[47533,47533],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":963,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":963,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[48088,48091],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[48088,48091],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1046,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1046,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[53103,53106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[53103,53106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1106,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1106,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[56595,56598],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[56595,56598],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":24,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { Plus, Search, Edit, BadgeCheck, UserMinus, UserCheck, Archive, FileSpreadsheet, ArrowUpDown, ArrowUp, ArrowDown, Check, X, Download, Trash2 } from \"lucide-react\"\r\nimport { useState, useEffect, useMemo } from \"react\"\r\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from \"@/components/ui/dialog\"\r\nimport { Tabs, TabsList, TabsTrigger, TabsContent } from \"@/components/ui/tabs\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport ExcelImportModal from \"./components/ExcelImportModal\"\r\nimport { api } from \"@/lib/api\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport SoftPageHeader from \"@/components/ui/SoftPageHeader\"\r\n//  CONVEX REAL-TIME\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\n\r\ninterface Teacher {\r\n  id: string\r\n  nuptk: string\r\n  nama: string\r\n  status: string\r\n  mapel: string\r\n  satminkal: string        // Legacy\r\n  unitKerja?: string       // NEW: proper field name\r\n  phoneNumber?: string\r\n  isCertified: boolean\r\n  isActive: boolean\r\n  pdpkpnu: string\r\n  kecamatan?: string\r\n  birthPlace?: string      // Legacy\r\n  birthDate?: string       // Legacy\r\n  tempatLahir?: string     // NEW: proper field name\r\n  tanggalLahir?: string    // NEW: proper field name\r\n  tmt?: string             // NEW: Tanggal Mulai Tugas\r\n}\r\n\r\nexport default function TeacherListPage() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [filterKecamatan, setFilterKecamatan] = useState(\"\")\r\n  const [filterCertified, setFilterCertified] = useState(\"all\") // all, true, false\r\n  \r\n  //  AUTO-FILTER for operators (only see their school's teachers)\r\n  const userStr = localStorage.getItem(\"user\")\r\n  const user = userStr ? JSON.parse(userStr) : null\r\n  const isOperator = user?.role === \"operator\"\r\n  const userSchoolId = user?.unitKerja\r\n  \r\n  // If operator, force filter to their school\r\n  const effectiveUnitKerja = isOperator && userSchoolId ? userSchoolId : (filterKecamatan || undefined)\r\n  \r\n  //  REAL-TIME CONVEX QUERY - Auto-updates!\r\n  const convexTeachers = useQuery(convexApi.teachers.list, {\r\n    unitKerja: effectiveUnitKerja,\r\n    kecamatan: filterKecamatan || undefined,\r\n    isCertified: filterCertified,\r\n    userEmail: user?.email, // Required for RBAC\r\n  })\r\n\r\n  // Mutations for real-time updates\r\n  const updateTeacherMutation = useMutation(convexApi.teachers.update)\r\n  const removeTeacherMutation = useMutation(convexApi.teachers.remove)\r\n  const bulkDeleteTeacherMutation = useMutation(convexApi.teachers.bulkDelete)\r\n  const createTeacherMutation = useMutation(convexApi.teachers.create)\r\n  // v4.0 ISOLATED IMPORT: Use new file to bypass caching issues\r\n  const bulkCreateMutation = useMutation(convexApi.importData.run)\r\n\r\n  // Toggle status confirmation modal state\r\n  const [toggleConfirmOpen, setToggleConfirmOpen] = useState(false)\r\n  const [teacherToToggle, setTeacherToToggle] = useState<{id: string, name: string, currentStatus: boolean} | null>(null)\r\n\r\n  // Map Convex data to existing Teacher interface\r\n  const teachers = (convexTeachers || []).map((t: any) => ({\r\n    id: t._id,\r\n    nuptk: t.nuptk || \"\",\r\n    nama: t.nama || \"\",\r\n    status: t.status || \"\",\r\n    mapel: t.mapel || \"\",\r\n    satminkal: t.unitKerja || \"\",\r\n    unitKerja: t.unitKerja,\r\n    phoneNumber: t.phoneNumber,\r\n    isCertified: t.isCertified || false,\r\n    isActive: t.isActive !== false,\r\n    pdpkpnu: t.pdpkpnu || \"Belum\",\r\n    kecamatan: t.kecamatan,\r\n    birthPlace: t.tempatLahir,\r\n    birthDate: t.tanggalLahir,\r\n    tempatLahir: t.tempatLahir,\r\n    tanggalLahir: t.tanggalLahir,\r\n    tmt: t.tmt,\r\n    pendidikanTerakhir: t.pendidikanTerakhir,\r\n  }))\r\n\r\n  //  AUTO-CALCULATE STATUS (same logic as SK Generator)\r\n  const calculateTeacherStatus = (teacher: any): string => {\r\n    const pendidikan = (teacher.pendidikanTerakhir || \"\").toLowerCase()\r\n    const nama = (teacher.nama || \"\").toLowerCase()\r\n    const tmt = teacher.tmt\r\n\r\n    // 1. Check Education Level (S1 or higher)\r\n    const educationKeywords = [\"s1\", \"s.1\", \"sarjana\", \"s2\", \"s.2\", \"magister\", \"s3\", \"s.3\", \"doktor\", \"div\", \"d4\"]\r\n    const titleKeywords = [\"s.pd\", \"s.ag\", \"s.e\", \"s.kom\", \"s.h\", \"s.sos\", \"s.hum\", \"s.ip\", \"m.pd\", \"m.ag\", \"m.e\", \"m.kom\", \"dra.\", \"drs.\", \"lc.\", \"b.a\"]\r\n    \r\n    const hasEducation = educationKeywords.some(k => pendidikan.includes(k))\r\n    const hasTitle = titleKeywords.some(k => nama.includes(k))\r\n\r\n    // If not S1+, return Tendik\r\n    if (!hasEducation && !hasTitle) {\r\n      return \"Tendik\"\r\n    }\r\n\r\n    // 2. Check TMT (Tenure)\r\n    if (!tmt) return \"GTT\" // Default to GTT if no TMT\r\n\r\n    let tmtDate = new Date()\r\n    if (tmt && typeof tmt === 'string' && tmt.includes(\"/\")) {\r\n      const parts = tmt.split(\"/\")\r\n      if (parts.length === 3) tmtDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`)\r\n    } else if (tmt) {\r\n      tmtDate = new Date(tmt)\r\n    }\r\n\r\n    const now = new Date()\r\n    let yearsDiff = now.getFullYear() - tmtDate.getFullYear()\r\n    const monthDiff = now.getMonth() - tmtDate.getMonth()\r\n    const dayDiff = now.getDate() - tmtDate.getDate()\r\n    \r\n    if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {\r\n      yearsDiff--\r\n    }\r\n\r\n    // 3. Determine GTY or GTT\r\n    return yearsDiff >= 2 ? \"GTY (Guru Tetap Yayasan)\" : \"GTT (Guru Tidak Tetap)\"\r\n  }\r\n\r\n  const [activeFilter, setActiveFilter] = useState(\"active\") // active, inactive, all\r\n  const [isImportModalOpen, setIsImportModalOpen] = useState(false) // Import modal state\r\n  \r\n  // NEW: Schools data for dropdown in Add/Edit Modal\r\n  const schools = useQuery(convexApi.schools.list) || []\r\n  const [schoolSearch, setSchoolSearch] = useState(\"\")\r\n  const [openSchoolDropdown, setOpenSchoolDropdown] = useState(false)\r\n\r\n  // PERMISSION: Filter by Unit Kerja for Operators\r\n  const [userUnit] = useState<string | null>(() => {\r\n    try {\r\n        const u = localStorage.getItem(\"user\")\r\n        if (u) {\r\n            const user = JSON.parse(u)\r\n            if (user.role !== \"super_admin\" && user.unitKerja) {\r\n                return user.unitKerja\r\n            }\r\n        }\r\n    } catch(e) { return null }\r\n    return null\r\n  })\r\n\r\n  // Sorting State\r\n  const [sortConfig, setSortConfig] = useState<{ key: keyof Teacher; direction: 'asc' | 'desc' } | null>(null);\r\n\r\n  // Note: loadTeachers now handled by Convex real-time query!\r\n  const loadTeachers = async () => {\r\n    // No longer needed - Convex auto-updates!\r\n    // Kept for Excel import success callback compatibility\r\n  }\r\n\r\n\r\n  const toggleStatus = async (id: string, currentStatus: boolean, name: string) => {\r\n    setTeacherToToggle({ id, name, currentStatus })\r\n    setToggleConfirmOpen(true)\r\n  }\r\n\r\n  const confirmToggle = async () => {\r\n    if (!teacherToToggle) return\r\n    const newStatus = !teacherToToggle.currentStatus\r\n    \r\n    try {\r\n      await updateTeacherMutation({ \r\n        id: teacherToToggle.id as any, \r\n        isActive: newStatus \r\n      })\r\n      const action = newStatus ? \"diaktifkan\" : \"dinonaktifkan\"\r\n      alert(` Guru \"${teacherToToggle.name}\" berhasil ${action}!`)\r\n      setToggleConfirmOpen(false)\r\n      setTeacherToToggle(null)\r\n    } catch (error: any) {\r\n      alert(\" Gagal mengubah status: \" + error.message)\r\n    }\r\n  }\r\n\r\n  const cancelToggle = () => {\r\n    setToggleConfirmOpen(false)\r\n    setTeacherToToggle(null)\r\n  }\r\n\r\n  const filtered = useMemo(() => teachers.filter(t => {\r\n      // 1. Role Filter\r\n      if (userUnit && t.satminkal?.toLowerCase() !== userUnit.toLowerCase()) return false\r\n\r\n      // 2. Active Status Filter\r\n      if (activeFilter === \"active\" && !t.isActive) return false\r\n      if (activeFilter === \"inactive\" && t.isActive) return false\r\n\r\n      // 3. Search Filter\r\n      const term = searchTerm.toLowerCase()\r\n      return (t.nama || \"\").toLowerCase().includes(term) || (t.nuptk || \"\").toLowerCase().includes(term)\r\n  }), [teachers, userUnit, activeFilter, searchTerm])\r\n\r\n  // Get unique kecamatan for filter dropdown\r\n  const uniqueKecamatan = useMemo(() => {\r\n    const kecs = teachers.map(t => t.kecamatan).filter(Boolean);\r\n    return Array.from(new Set(kecs)).sort();\r\n  }, [teachers]);\r\n\r\n  const sortedTeachers = useMemo(() => {\r\n    const sortableItems = [...filtered];\r\n    if (sortConfig !== null) {\r\n      sortableItems.sort((a, b) => {\r\n        // Handle undefined values\r\n        const aValue = a[sortConfig.key] || \"\";\r\n        const bValue = b[sortConfig.key] || \"\";\r\n\r\n        if (aValue < bValue) {\r\n          return sortConfig.direction === 'asc' ? -1 : 1;\r\n        }\r\n        if (aValue > bValue) {\r\n          return sortConfig.direction === 'asc' ? 1 : 1;\r\n        }\r\n        return 0;\r\n      });\r\n    }\r\n    return sortableItems;\r\n  }, [filtered, sortConfig]);\r\n\r\n  // Pagination Logic\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const itemsPerPage = 10\r\n  const totalPages = Math.ceil(sortedTeachers.length / itemsPerPage)\r\n\r\n  const paginatedTeachers = sortedTeachers.slice(\r\n      (currentPage - 1) * itemsPerPage,\r\n      currentPage * itemsPerPage\r\n  )\r\n\r\n  useEffect(() => {\r\n      setCurrentPage(1)\r\n  }, [searchTerm, activeFilter, sortConfig])\r\n\r\n  // Sort Handler\r\n  const requestSort = (key: keyof Teacher) => {\r\n    let direction: 'asc' | 'desc' = 'asc';\r\n    if (sortConfig && sortConfig.key === key && sortConfig.direction === 'asc') {\r\n      direction = 'desc';\r\n    }\r\n    setSortConfig({ key, direction });\r\n  };\r\n  \r\n  const getSortIcon = (name: keyof Teacher) => {\r\n      if (!sortConfig || sortConfig.key !== name) {\r\n          return <ArrowUpDown className=\"ml-2 h-4 w-4\" />\r\n      }\r\n      return sortConfig.direction === 'asc' ? <ArrowUp className=\"ml-2 h-4 w-4\" /> : <ArrowDown className=\"ml-2 h-4 w-4\" />\r\n  }\r\n\r\n  const getStatusColor = (status: string) => {\r\n      switch(status) {\r\n          case \"PNS\": return \"bg-blue-100 text-blue-800 hover:bg-blue-100\"\r\n          case \"GTY\": return \"bg-green-100 text-green-800 hover:bg-green-100\"\r\n          default: return \"bg-slate-100 text-slate-800 hover:bg-slate-100\"\r\n      }\r\n  }\r\n\r\n  // Manual Add/Edit Logic\r\n  const [isAddOpen, setIsAddOpen] = useState(false)\r\n  const [isEditMode, setIsEditMode] = useState(false)\r\n  const [formData, setFormData] = useState<Partial<Teacher>>({\r\n      nama: \"\", nuptk: \"\", status: \"GTY\", satminkal: \"\", mapel: \"\", phoneNumber: \"\", birthPlace: \"\", birthDate: \"\"\r\n  })\r\n\r\n  const handleSave = async () => {\r\n      if(!formData.nama) {\r\n          alert(\"Nama wajib diisi!\")\r\n          return\r\n      }\r\n\r\n      try {\r\n        console.log(\"[DEBUG] formData before payload:\", formData);\r\n        \r\n        // Build payload with only defined values\r\n        const rawPayload: any = {\r\n            nuptk: String(formData.nuptk || `TMP-${Date.now()}`),\r\n            nama: String(formData.nama || \"\"),\r\n        };\r\n        \r\n        // Add optional fields only if they have values\r\n        if (formData.status) rawPayload.status = formData.status;\r\n        if (formData.unitKerja || formData.satminkal) rawPayload.unitKerja = formData.unitKerja || formData.satminkal;\r\n        if (formData.mapel) rawPayload.mapel = formData.mapel;\r\n        if (formData.phoneNumber) rawPayload.phoneNumber = formData.phoneNumber;\r\n        if (formData.pdpkpnu) rawPayload.pdpkpnu = formData.pdpkpnu;\r\n        if (formData.kecamatan) rawPayload.kecamatan = formData.kecamatan;\r\n        if (formData.tempatLahir || formData.birthPlace) rawPayload.tempatLahir = formData.tempatLahir || formData.birthPlace;\r\n        if (formData.tanggalLahir || formData.birthDate) rawPayload.tanggalLahir = formData.tanggalLahir || formData.birthDate;\r\n        if (formData.tmt) rawPayload.tmt = formData.tmt;\r\n        if (formData.isCertified !== undefined) rawPayload.isCertified = formData.isCertified;\r\n        \r\n        console.log(\"[DEBUG] Payload being sent:\", rawPayload);\r\n\r\n        if (isEditMode && formData.id) {\r\n            //  Update via Convex\r\n            await updateTeacherMutation({ \r\n              id: formData.id as any,\r\n              ...rawPayload\r\n            })\r\n            alert(\"Berhasil memperbarui data guru\")\r\n        } else {\r\n            //  Create via Convex\r\n            await createTeacherMutation(rawPayload)\r\n            alert(\"Berhasil menambah guru\")\r\n        }\r\n        \r\n        // Convex auto-updates UI, but close dialog\r\n        closeDialog()\r\n      } catch (e) {\r\n          console.error(\"Save error:\", e)\r\n          alert(\"Gagal menyimpan guru\")\r\n      }\r\n  }\r\n\r\n  const openAdd = () => {\r\n      setIsEditMode(false)\r\n      setFormData({ nuptk: \"\", nama: \"\", status: \"\", satminkal: \"\", mapel: \"\", phoneNumber: \"\", birthPlace: \"\", birthDate: \"\" })\r\n      setIsAddOpen(true)\r\n  }\r\n\r\n  const openEdit = (teacher: Teacher) => {\r\n      console.log(\"[HANDLERS] openEdit:\", teacher)\r\n    setIsEditMode(true)  // CRITICAL FIX: Set edit mode to true!\r\n    setFormData(teacher)\r\n    setIsAddOpen(true)\r\n  }\r\n\r\n  const handleDownloadTemplate = async () => {\r\n    const XLSX = await import('xlsx')\r\n    \r\n    // Create template data with sample row\r\n    const templateData = [\r\n      {\r\n        'NUPTK': 'Contoh: 1234567890123456',\r\n        'Nama': 'Contoh: Ahmad Fauzi',\r\n        'NIP': 'Opsional',\r\n        'Jenis Kelamin': 'L/P',\r\n        'Tempat Lahir': 'Contoh: Cilacap',\r\n        'Tanggal Lahir': 'DD/MM/YYYY',\r\n        'Pendidikan Terakhir': 'S1/S2/S3',\r\n        'Unit Kerja': 'Contoh: MI Maarif Cilacap',\r\n        'Kecamatan': 'Contoh: Cilacap Tengah',\r\n        'Status': 'GTY/GTT/PPPK/PNS',\r\n        'TMT': 'DD/MM/YYYY',\r\n        'No HP': '081234567890',\r\n        'Email': 'contoh@email.com',\r\n        'Sertifikasi': 'Ya/Tidak',\r\n        'PDPKPNU': 'Ya/Belum',\r\n      }\r\n    ]\r\n    \r\n    const worksheet = XLSX.utils.json_to_sheet(templateData)\r\n    const workbook = XLSX.utils.book_new()\r\n    XLSX.utils.book_append_sheet(workbook, worksheet, 'Data Guru')\r\n    \r\n    // Download file\r\n    XLSX.writeFile(workbook, 'Template_Import_Guru.xlsx')\r\n  }\r\n\r\n  const closeDialog = () => {\r\n      setIsAddOpen(false)\r\n      setIsEditMode(false)\r\n      setFormData({ nuptk: \"\", nama: \"\", status: \"\", satminkal: \"\", mapel: \"\", phoneNumber: \"\", birthPlace: \"\", birthDate: \"\" })\r\n  }\r\n\r\n  const handleExport = async () => {\r\n      try {\r\n          const blob = await api.exportTeachers(\r\n              userUnit || undefined, \r\n              filterKecamatan || undefined, \r\n              filterCertified\r\n          )\r\n          const url = window.URL.createObjectURL(new Blob([blob]));\r\n          const link = document.createElement('a');\r\n          link.href = url;\r\n          link.setAttribute('download', `Data_Guru_${new Date().toISOString().split('T')[0]}.xlsx`);\r\n          document.body.appendChild(link);\r\n          link.click();\r\n          link.parentNode?.removeChild(link);\r\n      } catch (e: any) {\r\n          console.error(e)\r\n          alert(\"Gagal mengexport data.\")\r\n      }\r\n  }\r\n\r\n  const handleDeleteAll = async () => {\r\n      if (confirm(`PERHATIAN: Ini akan menghapus SEMUA ${teachers.length} data guru!\\n\\nApakah Anda yakin?`)) {\r\n          if (confirm(\"Konfirmasi sekali lagi - hapus semua data guru?\")) {\r\n              try {\r\n                  const result = await bulkDeleteTeacherMutation({})\r\n                  alert(`Berhasil menghapus ${result.count} guru!`)\r\n              } catch (e: any) {\r\n                  alert(\"Gagal menghapus: \" + e.message)\r\n              }\r\n          }\r\n      }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <SoftPageHeader\r\n        title=\"Data Guru & Tenaga Kependidikan\"\r\n        description=\"Manajemen data guru dan tenaga kependidikan di lingkungan LP Ma'arif NU Cilacap\"\r\n        actions={[\r\n          {\r\n            label: 'Export Excel',\r\n            onClick: handleExport,\r\n            variant: 'mint',\r\n            icon: <Download className=\"h-5 w-5 text-gray-700\" />\r\n          },\r\n          ...(userStr && [\"super_admin\", \"admin\"].includes(JSON.parse(userStr).role) ? [{\r\n            label: 'Delete All',\r\n            onClick: handleDeleteAll,\r\n            variant: 'purple' as const,\r\n            icon: <Trash2 className=\"h-5 w-5 text-gray-700\" />\r\n          }] : []),\r\n          {\r\n            label: 'Tambah Manual',\r\n            onClick: openAdd,\r\n            variant: 'cream',\r\n            icon: <Plus className=\"h-5 w-5 text-gray-700\" />\r\n          },\r\n          {\r\n            label: 'Import Excel',\r\n            onClick: () => setIsImportModalOpen(true),\r\n            variant: 'blue',\r\n            icon: <FileSpreadsheet className=\"h-5 w-5 text-gray-700\" />\r\n          }\r\n        ]}\r\n      />\r\n\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n            <div className=\"flex flex-col gap-4\">\r\n                {/* Search and Filters Row */}\r\n                <div className=\"flex flex-col sm:flex-row gap-2\">\r\n                   <div className=\"relative flex-1 min-w-[200px]\">\r\n                       <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                       <Input\r\n                           placeholder=\"Cari nama atau unit kerja...\"\r\n                           className=\"pl-9\"\r\n                           value={searchTerm}\r\n                           onChange={(e) => setSearchTerm(e.target.value)}\r\n                       />\r\n                   </div>\r\n                   \r\n                   <Select value={filterKecamatan} onValueChange={setFilterKecamatan}>\r\n                       <SelectTrigger className=\"w-full sm:w-[180px]\">\r\n                           <SelectValue placeholder=\"Semua Kecamatan\" />\r\n                       </SelectTrigger>\r\n                       <SelectContent>\r\n                           {uniqueKecamatan.filter((k): k is string => Boolean(k)).map(k => (\r\n                               <SelectItem key={k} value={k}>{k}</SelectItem>\r\n                           ))}\r\n                       </SelectContent>\r\n                   </Select>\r\n\r\n                   <Select value={filterCertified} onValueChange={setFilterCertified}>\r\n                       <SelectTrigger className=\"w-full sm:w-[150px]\">\r\n                           <SelectValue placeholder=\"Sertifikasi\" />\r\n                       </SelectTrigger>\r\n                       <SelectContent>\r\n                           <SelectItem value=\"all\">Semua Status</SelectItem>\r\n                           <SelectItem value=\"true\">Sertifikasi</SelectItem>\r\n                           <SelectItem value=\"false\">Belum Sertifikasi</SelectItem>\r\n                       </SelectContent>\r\n                   </Select>\r\n                </div>\r\n\r\n                {/* Tabs Row - Separate for clarity */}\r\n                <Tabs value={activeFilter} onValueChange={setActiveFilter}>\r\n                   <TabsList className=\"grid w-full grid-cols-3 max-w-md\">\r\n                       <TabsTrigger value=\"active\">Aktif</TabsTrigger>\r\n                       <TabsTrigger value=\"inactive\">Non-Aktif / Resign</TabsTrigger>\r\n                       <TabsTrigger value=\"all\">Semua</TabsTrigger>\r\n                   </TabsList>\r\n                </Tabs>\r\n           </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n            <div className=\"rounded-md border\">\r\n                <Table>\r\n                  <TableHeader>\r\n                    <TableRow>\r\n                      <TableHead onClick={() => requestSort('nuptk')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Nomor Induk {getSortIcon('nuptk')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('nama')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Nama {getSortIcon('nama')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('status')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Status {getSortIcon('status')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('isCertified')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Sertifikasi {getSortIcon('isCertified')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('pdpkpnu')} className=\"cursor-pointer hover:bg-muted/50 transition-colors text-center\">\r\n                          <div className=\"flex items-center justify-center\">PDPKPNU {getSortIcon('pdpkpnu')}</div>\r\n                      </TableHead>\r\n                      <TableHead onClick={() => requestSort('unitKerja')} className=\"cursor-pointer hover:bg-muted/50 transition-colors\">\r\n                          <div className=\"flex items-center\">Satminkal {getSortIcon('unitKerja')}</div>\r\n                      </TableHead>\r\n                      <TableHead className=\"text-right\">Aksi</TableHead>\r\n                    </TableRow>\r\n                  </TableHeader>\r\n                  <TableBody>\r\n                    {paginatedTeachers.length === 0 ? (\r\n                        <TableRow>\r\n                            <TableCell colSpan={7} className=\"h-24 text-center\">\r\n                                Tidak ada data guru ditemukan.\r\n                            </TableCell>\r\n                        </TableRow>\r\n                    ) : (\r\n                        paginatedTeachers.map((item) => (\r\n                          <TableRow key={item.id} className={!item.isActive ? \"bg-slate-50 opacity-60\" : \"\"}>\r\n                            <TableCell className=\"font-medium\">{item.nuptk}</TableCell>\r\n                            <TableCell>\r\n                                <div className=\"flex flex-col\">\r\n                                    <span className=\"font-medium\">{item.nama}</span>\r\n                                    {!item.isActive && <span className=\"text-xs text-red-500 font-bold flex items-center mt-1\"><Archive className=\"h-3 w-3 mr-1\"/> NON-AKTIF</span>}\r\n                                </div>\r\n                            </TableCell>\r\n                            <TableCell>\r\n                                {/*  ENHANCED STATUS BADGE */}\r\n                                {(() => {\r\n                                    const status = calculateTeacherStatus(item)\r\n                                    \r\n                                    if (status === \"Tendik\") {\r\n                                        return (\r\n                                            <Badge className=\"gap-1.5 bg-gradient-to-r from-slate-500 to-slate-600 text-white border-0 shadow-sm hover:shadow-md transition-all\" variant=\"secondary\">\r\n                                                <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\" />\r\n                                                </svg>\r\n                                                <span className=\"font-semibold\">Tendik</span>\r\n                                            </Badge>\r\n                                        )\r\n                                    }\r\n                                    \r\n                                    if (status === \"GTT (Guru Tidak Tetap)\") {\r\n                                        return (\r\n                                            <Badge className=\"gap-1.5 bg-gradient-to-r from-amber-500 to-orange-500 text-white border-0 shadow-sm hover:shadow-md transition-all\" variant=\"secondary\">\r\n                                                <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\r\n                                                </svg>\r\n                                                <span className=\"font-semibold\">GTT</span>\r\n                                            </Badge>\r\n                                        )\r\n                                    }\r\n                                    \r\n                                    if (status === \"GTY (Guru Tetap Yayasan)\") {\r\n                                        return (\r\n                                            <Badge className=\"gap-1.5 bg-gradient-to-r from-emerald-500 to-green-600 text-white border-0 shadow-sm hover:shadow-md transition-all\" variant=\"secondary\">\r\n                                                <svg className=\"w-3.5 h-3.5\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\r\n                                                    <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z\" />\r\n                                                </svg>\r\n                                                <span className=\"font-semibold\">GTY</span>\r\n                                            </Badge>\r\n                                        )\r\n                                    }\r\n                                    \r\n                                    // Fallback\r\n                                    return (\r\n                                        <Badge className=\"gap-1.5\" variant=\"outline\">\r\n                                            {status}\r\n                                        </Badge>\r\n                                    )\r\n                                })()}\r\n                            </TableCell>\r\n                            <TableCell>\r\n                                {item.isCertified ? (\r\n                                    <div className=\"flex items-center text-green-600 text-xs\">\r\n                                        <BadgeCheck className=\"mr-1 h-3 w-3\" /> Sertifikasi\r\n                                    </div>\r\n                                ) : item.status === 'PNS' ? (\r\n                                    <span className=\"text-xs text-muted-foreground\">-</span>\r\n                                ) : (\r\n                                    <Badge variant=\"outline\" className=\"text-xs\">\r\n                                        Honorer\r\n                                    </Badge>\r\n                                )}\r\n                            </TableCell>\r\n                            <TableCell className=\"text-center\">\r\n                                {item.pdpkpnu === 'Sudah' ? (\r\n                                    <div className=\"flex justify-center text-green-600\">\r\n                                        <Check className=\"h-5 w-5\" />\r\n                                    </div>\r\n                                ) : (\r\n                                    <div className=\"flex justify-center text-red-500\">\r\n                                        <X className=\"h-5 w-5\" />\r\n                                    </div>\r\n                                )}\r\n                            </TableCell>\r\n                            <TableCell>{item.unitKerja || item.satminkal}</TableCell>\r\n                            <TableCell className=\"text-right space-x-2\">\r\n                                <Button \r\n                                    variant=\"ghost\" \r\n                                    size=\"icon\" \r\n                                    className=\"h-8 w-8 text-amber-600 hover:text-amber-800\"\r\n                                    onClick={() => toggleStatus(item.id, item.isActive, item.nama)}\r\n                                    title={item.isActive ? \"Non-Aktifkan\" : \"Aktifkan Kembali\"}\r\n                                >\r\n                                    {item.isActive ? <UserMinus className=\"h-4 w-4\" /> : <UserCheck className=\"h-4 w-4\" />}\r\n                                </Button>\r\n                                <Button variant=\"ghost\" size=\"icon\" className=\"h-8 w-8 text-blue-600 hover:text-blue-800\" onClick={() => openEdit(item)}><Edit className=\"h-4 w-4\" /></Button>\r\n                            </TableCell>\r\n                          </TableRow>\r\n                        ))\r\n                    )}\r\n                  </TableBody>\r\n                </Table>\r\n            </div>\r\n            \r\n            {/* Pagination Controls */}\r\n            <div className=\"flex items-center justify-end space-x-2 py-4\">\r\n                <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                    Halaman {currentPage} dari {totalPages} ({filtered.length} data)\r\n                </div>\r\n                <div className=\"space-x-2\">\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(1)}\r\n                        disabled={currentPage === 1}\r\n                    >\r\n                        First\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\r\n                        disabled={currentPage === 1}\r\n                    >\r\n                        Prev\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\r\n                        disabled={currentPage === totalPages}\r\n                    >\r\n                        Next\r\n                    </Button>\r\n                    <Button\r\n                        variant=\"outline\"\r\n                        size=\"sm\"\r\n                        onClick={() => setCurrentPage(totalPages)}\r\n                        disabled={currentPage === totalPages}\r\n                    >\r\n                        Last\r\n                    </Button>\r\n                </div>\r\n            </div>\r\n\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Dialog open={isAddOpen} onOpenChange={setIsAddOpen}>\r\n        <DialogContent>\r\n            <DialogHeader>\r\n                <DialogTitle>{isEditMode ? 'Edit' : 'Tambah'} Guru Manual</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"grid gap-4 py-4\">\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"nama\" className=\"text-right\">Nama</Label>\r\n                    <Input id=\"nama\" className=\"col-span-3\" value={formData.nama || \"\"} onChange={e => setFormData({...formData, nama: e.target.value})} />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"nuptk\" className=\"text-right\">Nomor Induk Ma'arif</Label>\r\n                    <Input id=\"nuptk\" className=\"col-span-3\" value={formData.nuptk || \"\"} onChange={e => setFormData({...formData, nuptk: e.target.value})} placeholder=\"NUPTK 16 digit atau NIM Ma'arif\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"status\" className=\"text-right\">Status</Label>\r\n                    <Input id=\"status\" className=\"col-span-3\" value={formData.status || \"\"} onChange={e => setFormData({...formData, status: e.target.value})} placeholder=\"PNS / GTY / GTT\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"unitKerja\" className=\"text-right\">Satminkal</Label>\r\n                    <div className=\"col-span-3 relative\">\r\n                         {/* Manual Searchable Dropdown for School */}\r\n                         <div className=\"relative\">\r\n                            <Input\r\n                                id=\"unitKerja\"\r\n                                placeholder=\"Cari unit kerja / sekolah...\"\r\n                                value={formData.unitKerja || formData.satminkal || schoolSearch}\r\n                                onChange={(e) => {\r\n                                    setSchoolSearch(e.target.value)\r\n                                    setOpenSchoolDropdown(true)\r\n                                    // Also update form data temporarily to allow typing new schools if needed? \r\n                                    // Better to force selection but allow typing for filtering.\r\n                                    // Wait, if I bind value to formData.unitKerja, typing filters weirdly.\r\n                                    // Strategy: Logic similar to Headmaster page.\r\n                                    // But here we might want to allow custom names? \r\n                                    // \"Satminkal\" might be outside the list? \r\n                                    // User wants \"Search in Dropdown\".\r\n                                    // Let's assume standard behavior: Input for filtering, click to select.\r\n                                    \r\n                                    // If we bind value to custom search, we need to handle \"Edit\" mode where value is already set.\r\n                                    // I will use a separate Input for search if dropdown is open? No, that's complex.\r\n                                    \r\n                                    // SIMPLIFIED MANUAL DROPDOWN (Matches other pages):\r\n                                    // 1. Trigger button (Display Name) -> Opens Popover -> Input + List.\r\n                                    // BUT, here it's inside a Dialog, so Popover might be clipped or complex.\r\n                                    // I'll use a simple absolute div overlay \"Suggestions\" below the input.\r\n                                    setFormData({...formData, unitKerja: e.target.value, satminkal: e.target.value})\r\n                                }}\r\n                                onFocus={() => setOpenSchoolDropdown(true)}\r\n                                // onBlur={() => setTimeout(() => setOpenSchoolDropdown(false), 200)} // Removed, using onMouseDown\r\n                                className=\"w-full\"\r\n                                autoComplete=\"off\"\r\n                            />\r\n                            {openSchoolDropdown && (\r\n                                <div className=\"absolute z-50 mt-1 w-full max-h-60 overflow-auto rounded-md border bg-white p-1 shadow-lg text-sm\">\r\n                                    {schools\r\n                                        .filter(s => s.nama.toLowerCase().includes((formData.unitKerja || schoolSearch).toLowerCase()))\r\n                                        .slice(0, 100)\r\n                                        .map((school) => (\r\n                                          <div\r\n                                            key={school._id}\r\n                                            className=\"cursor-pointer rounded-sm px-2 py-1.5 hover:bg-slate-100\"\r\n                                            onMouseDown={(e) => {\r\n                                                e.preventDefault(); // Prevent blur\r\n                                                setFormData({...formData, unitKerja: school.nama, satminkal: school.nama})\r\n                                                setSchoolSearch(\"\")\r\n                                                setOpenSchoolDropdown(false)\r\n                                            }}\r\n                                          >\r\n                                            {school.nama}\r\n                                          </div>\r\n                                        ))\r\n                                    }\r\n                                    {schools.length === 0 && <div className=\"p-2 text-muted-foreground\">Memuat data sekolah...</div>}\r\n                                    {schools.length > 0 && schools.filter(s => s.nama.toLowerCase().includes((formData.unitKerja || schoolSearch).toLowerCase())).length === 0 && (\r\n                                         <div className=\"p-2 text-muted-foreground\">Tidak ditemukan (Gunakan data manual)</div>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n                         </div>\r\n                    </div>\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"phoneNumber\" className=\"text-right\">Nomor HP</Label>\r\n                    <Input id=\"phoneNumber\" className=\"col-span-3\" value={formData.phoneNumber || \"\"} onChange={e => setFormData({...formData, phoneNumber: e.target.value})} placeholder=\"081234567890\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"pdpkpnu\" className=\"text-right\">PDPKPNU</Label>\r\n                    <Input id=\"pdpkpnu\" className=\"col-span-3\" value={formData.pdpkpnu || \"\"} onChange={e => setFormData({...formData, pdpkpnu: e.target.value})} placeholder=\"Sudah / Belum\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"tempatLahir\" className=\"text-right\">Tempat Lahir</Label>\r\n                    <Input id=\"tempatLahir\" className=\"col-span-3\" value={formData.tempatLahir || \"\"} onChange={e => setFormData({...formData, tempatLahir: e.target.value})} placeholder=\"Contoh: Cilacap\" />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"tanggalLahir\" className=\"text-right\">Tanggal Lahir</Label>\r\n                    <Input id=\"tanggalLahir\" type=\"date\" className=\"col-span-3\" value={formData.tanggalLahir || \"\"} onChange={e => setFormData({...formData, tanggalLahir: e.target.value})} />\r\n                </div>\r\n                <div className=\"grid grid-cols-4 items-center gap-4\">\r\n                    <Label htmlFor=\"tmt\" className=\"text-right\">TMT (Tanggal Mulai Tugas)</Label>\r\n                    <Input id=\"tmt\" type=\"date\" className=\"col-span-3\" value={formData.tmt || \"\"} onChange={e => setFormData({...formData, tmt: e.target.value})} />\r\n                </div>\r\n            </div>\r\n            <DialogFooter>\r\n                <Button variant=\"outline\" onClick={closeDialog}>Batal</Button>\r\n                <Button onClick={handleSave}>Simpan</Button>\r\n            </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n\r\n      {/* Excel Import Modal */}\r\n      <ExcelImportModal\r\n        isOpen={isImportModalOpen}\r\n        onClose={() => setIsImportModalOpen(false)}\r\n        onImportSuccess={loadTeachers}\r\n        onDownloadTeacherTemplate={handleDownloadTemplate}\r\n        title=\"Import Data Guru\"\r\n        description=\"Upload file Excel (.xlsx) untuk import data guru\"\r\n        onFileImport={async (file) => {\r\n          // Excel Date Serial Number Converter\r\n          const excelSerialToDate = (serial: any): string | undefined => {\r\n            if (!serial) return undefined\r\n            \r\n            // If already a string (text format), return as-is\r\n            if (typeof serial === 'string') return serial\r\n            \r\n            // If number (Excel serial date), convert to date string\r\n            if (typeof serial === 'number') {\r\n              // Excel serial starts from 1900-01-01 (but has a leap year bug for 1900)\r\n              const excelEpoch = new Date(1899, 11, 30) // Dec 30, 1899\r\n              const date = new Date(excelEpoch.getTime() + serial * 24 * 60 * 60 * 1000)\r\n              \r\n              // Format as YYYY-MM-DD for database\r\n              const year = date.getFullYear()\r\n              const month = String(date.getMonth() + 1).padStart(2, '0')\r\n              const day = String(date.getDate()).padStart(2, '0')\r\n              const result = `${year}-${month}-${day}`\r\n              console.log(`[excelSerialToDate] ${serial}  ${result}`)\r\n              return result\r\n            }\r\n            \r\n            return undefined\r\n          }\r\n\r\n          console.log('[IMPORT] excelSerialToDate function defined:', typeof excelSerialToDate)\r\n\r\n          // Parse Excel file client-side\r\n          const XLSX = await import('xlsx')\r\n          const data = await file.arrayBuffer()\r\n          const workbook = XLSX.read(data)\r\n          const worksheet = workbook.Sheets[workbook.SheetNames[0]]\r\n          \r\n          // 1. Convert to 2D Array first to find header\r\n          const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as string[][]\r\n          console.log('[IMPORT] Total rows found:', rows.length)\r\n\r\n          if (rows.length === 0) {\r\n              alert(\"File kosong or format tidak valid.\")\r\n              return\r\n          }\r\n\r\n          // 2. Header Discovery Logic (Same as Bulk SK)\r\n          // Look for row containing \"Nama\" AND (\"NUPTK\" or \"NIM\" or \"Nomor Induk\")\r\n          let headerRowIndex = -1\r\n          let colMap: Record<string, number> = {} // Key -> Column Index\r\n          \r\n          // Standardized Keys we want to find\r\n          const REQUIRED_KEYS = {\r\n              \"nama\": [\"nama\", \"nama lengkap\", \"nama guru\"],\r\n              \"nuptk\": [\"nuptk\", \"nomor induk\", \"nim\", \"niy\", \"nip\"],\r\n              \"tmt\": [\"tmt\", \"tanggal mulai\", \"mulai tugas\"],\r\n              \"status\": [\"status\", \"status kepegawaian\"],\r\n              \"sertifikasi\": [\"sertifikasi\", \"status sertifikasi\"],\r\n              \"pdpkpnu\": [\"pdpkpnu\", \"status pdpkpnu\"],\r\n              \"pendidikan\": [\"pendidikan\", \"pendidikan terakhir\", \"ijazah\"],\r\n              \"lahir\": [\"tanggal lahir\", \"tgl lahir\"],\r\n              \"tempatlahir\": [\"tempat lahir\", \"tmp lahir\", \"kota lahir\"],\r\n              \"unitkerja\": [\"unit kerja\", \"satminkal\", \"sekolah\", \"madrasah\"]\r\n          }\r\n\r\n          console.log(\"Scanning for headers...\")\r\n          for (let i = 0; i < Math.min(rows.length, 15); i++) {\r\n                const rowStr = Array.from(rows[i] || []).map(c => (c || \"\").toString().toLowerCase().trim())\r\n                \r\n                // Check match count\r\n                let matchCount = 0\r\n                const currentMap: Record<string, number> = {}\r\n\r\n                Object.entries(REQUIRED_KEYS).forEach(([key, possibleHeaders]) => {\r\n                    const idx = rowStr.findIndex(cell => possibleHeaders.some(h => cell.includes(h)))\r\n                    if (idx >= 0) {\r\n                        currentMap[key] = idx\r\n                        matchCount++\r\n                    }\r\n                })\r\n\r\n                if (matchCount >= 2) { // At least Name + one other thing\r\n                    headerRowIndex = i\r\n                    colMap = currentMap\r\n                    console.log(`[IMPORT] Header found at row ${i} with ${matchCount} matches!`)\r\n                    break\r\n                }\r\n          }\r\n\r\n          if (headerRowIndex === -1) {\r\n              alert(\"Gagal menemukan baris Header (Nama, NUPTK, dll) dalam 15 baris pertama.\")\r\n              return\r\n          }\r\n\r\n          // 3. Extract Data using detected columns\r\n          const jsonData = []\r\n          for(let r = headerRowIndex + 1; r < rows.length; r++) {\r\n              const row = rows[r]\r\n              if (!row || row.length === 0) continue\r\n              \r\n              const rowObj: any = {}\r\n              // Map discovered columns\r\n              if (colMap[\"nama\"] !== undefined) rowObj[\"Nama\"] = row[colMap[\"nama\"]]\r\n              if (colMap[\"nuptk\"] !== undefined) rowObj[\"NUPTK\"] = row[colMap[\"nuptk\"]]\r\n              if (colMap[\"tmt\"] !== undefined) rowObj[\"TMT\"] = row[colMap[\"tmt\"]]\r\n              if (colMap[\"status\"] !== undefined) rowObj[\"Status\"] = row[colMap[\"status\"]]\r\n              if (colMap[\"sertifikasi\"] !== undefined) rowObj[\"Sertifikasi\"] = row[colMap[\"sertifikasi\"]]\r\n              if (colMap[\"pdpkpnu\"] !== undefined) rowObj[\"PDPKPNU\"] = row[colMap[\"pdpkpnu\"]]\r\n              if (colMap[\"pendidikan\"] !== undefined) rowObj[\"Pendidikan Terakhir\"] = row[colMap[\"pendidikan\"]]\r\n              if (colMap[\"lahir\"] !== undefined) rowObj[\"Tanggal Lahir\"] = row[colMap[\"lahir\"]]\r\n              if (colMap[\"tempatlahir\"] !== undefined) rowObj[\"Tempat Lahir\"] = row[colMap[\"tempatlahir\"]]\r\n              if (colMap[\"unitkerja\"] !== undefined) rowObj[\"Unit Kerja\"] = row[colMap[\"unitkerja\"]]\r\n                            \r\n              jsonData.push(rowObj)\r\n          }\r\n\r\n          console.log('[IMPORT] Extracted data:', jsonData.length, 'rows')\r\n          \r\n          // Helper: Robust Date Parser\r\n          const parseIndonesianDate = (dateStr: any): Date | null => {\r\n              if (!dateStr) return null\r\n              \r\n              // 1. Direct Number (Excel Serial)\r\n              if (typeof dateStr === 'number') {\r\n                  const excelEpoch = new Date(1899, 11, 30);\r\n                  return new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000)\r\n              }\r\n\r\n              const str = String(dateStr).trim()\r\n              \r\n              // 2. Stringified Number (Excel Serial) - allow decimals\r\n              if (/^[\\d\\.]+$/.test(str) && !isNaN(parseFloat(str))) { \r\n                  const val = parseFloat(str)\r\n                  // Heuristic: Excel dates are usually > 10000 (after 1927). \r\n                  // If small number, might be \"2023\" (year) which is NOT a date serial.\r\n                  if (val > 1000) {\r\n                      const excelEpoch = new Date(1899, 11, 30);\r\n                      return new Date(excelEpoch.getTime() + val * 24 * 60 * 60 * 1000)\r\n                  }\r\n              }\r\n\r\n              // 3. Standard Date\r\n              const d = new Date(str)\r\n              if (!isNaN(d.getTime()) && !/^\\d+$/.test(str)) return d\r\n              \r\n              // 4. DD/MM/YYYY\r\n              const parts = str.match(/(\\d{1,2})[\\/\\-\\.](\\d{1,2})[\\/\\-\\.](\\d{4})/)\r\n              if (parts) return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`)\r\n              \r\n              // 5. Indonesian Months\r\n              const months: {[key: string]: string} = {\r\n                  'januari': '01', 'februari': '02', 'maret': '03', 'april': '04', 'mei': '05', 'juni': '06',\r\n                  'juli': '07', 'agustus': '08', 'september': '09', 'oktober': '10', 'november': '11', 'desember': '12',\r\n                  'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06',\r\n                  'jul': '07', 'aug': '08', 'agt': '08', 'sep': '09', 'oct': '10', 'okt': '10', 'nov': '11', 'dec': '12', 'des': '12'\r\n              }\r\n              const txtParts = str.split(/[\\s\\-\\/]+/)\r\n              if (txtParts.length >= 3) {\r\n                  const day = txtParts[0].replace(/[^0-9]/g, '')\r\n                  const monthTxt = txtParts[1].toLowerCase()\r\n                  const year = txtParts[2].replace(/[^0-9]/g, '')\r\n                  if (months[monthTxt] && year && day) return new Date(`${year}-${months[monthTxt]}-${day}`)\r\n              }\r\n              return null\r\n          }\r\n\r\n          // Map Excel columns to Convex schema with improved status/certification detection\r\n          const teachers = jsonData.map((row: any, index: number) => {\r\n            try {\r\n              // 4. Parse Dates FIRST (to be available for logic)\r\n              const tmtVal = row.TMT || row.tmt || row['Tanggal Mulai Tugas']\r\n              const tmtDateObj = parseIndonesianDate(tmtVal)\r\n              const tmtFormatted = tmtDateObj ? tmtDateObj.toISOString().split('T')[0] : undefined\r\n\r\n              const birthDateObj = parseIndonesianDate(row['Tanggal Lahir'] || row.tanggalLahir)\r\n              const birthDateFormatted = birthDateObj ? birthDateObj.toISOString().split('T')[0] : undefined\r\n\r\n              // 1. Detect Status\r\n              const rawStatus = row.Status || row.status || row.STATUS || \"\"\r\n              let detectedStatus = \"GTT\" // Default fallback\r\n\r\n              if (rawStatus) {\r\n                  const s = String(rawStatus).toLowerCase()\r\n                  if (s.includes(\"gty\") || s.includes(\" tetap\") || s.includes(\"sertifikasi\")) detectedStatus = \"GTY\"\r\n                  else if (s.includes(\"gtt\") || s.includes(\"honor\") || s.includes(\"tidak tetap\")) detectedStatus = \"GTT\"\r\n                  else if (s.includes(\"pns\") || s.includes(\"asn\") || s.includes(\"pppk\")) detectedStatus = \"PNS\"\r\n                  else if (s.includes(\"tendik\")) detectedStatus = \"Tendik\"\r\n                  else detectedStatus = rawStatus // Use raw if unknown\r\n              } else {\r\n                  // Fallback: Calculate from TMT if status is empty\r\n                  if (tmtDateObj) {\r\n                       const yearsOfService = (Date.now() - tmtDateObj.getTime()) / (1000 * 60 * 60 * 24 * 365)\r\n                       if (yearsOfService >= 2) detectedStatus = \"GTY\"\r\n                  }\r\n              }\r\n              \r\n              // 2. Parse Certification\r\n              let isCertified = false\r\n              const certColumn = row.Sertifikasi || row.sertifikasi || row.SERTIFIKASI || row['Status Sertifikasi'] || row.isCertified\r\n              if (certColumn) {\r\n                  const c = String(certColumn).toLowerCase()\r\n                  isCertified = c.includes(\"ya\") || c.includes(\"sudah\") || c.includes(\"sertifi\") || c === \"v\" || c === \"true\" || c === \"1\"\r\n              }\r\n              \r\n              // 3. Parse PDPKPNU\r\n              let pdpkpnu = \"Belum\"\r\n              const pdpkpnuCol = row.PDPKPNU || row.pdpkpnu || row['Status PDPKPNU']\r\n              if (pdpkpnuCol) {\r\n                   const p = String(pdpkpnuCol).toLowerCase()\r\n                   if (p.includes(\"sudah\") || p.includes(\"lulus\") || p.includes(\"ya\") || p === \"v\") pdpkpnu = \"Sudah\"\r\n              }\r\n\r\n              const nuptk = String(row.NUPTK || row.nuptk || row.NIM || `TMP-${Date.now()}-${index}`)\r\n              const nama = String(row.Nama || row.nama || row.NAMA || \"\")\r\n              const pendidikan = row['Pendidikan Terakhir'] || row.pendidikan || \"-\"\r\n              const tempatLahir = row['Tempat Lahir'] || row.tempatLahir || \"-\"\r\n              const unitKerja = row['Unit Kerja'] || row.unitKerja || \"-\"\r\n              \r\n              // Skip if no name\r\n              if (!nama || nama.trim() === '') return null\r\n              \r\n              // DEBUG: Log first row\r\n              if (index === 0) {\r\n                  console.log(\"[IMPORT DEBUG] Row 0 Analysis:\", {\r\n                      nama, rawTmt: tmtVal, parsedTmt: tmtDateObj, calculatedStatus: detectedStatus, colMap\r\n                  })\r\n                  \r\n                  const debugColMap = Object.entries(colMap).map(([k, v]) => `${k}: ${v}`).join(', ')\r\n                  alert(` Debug Baris Pertama:\\n\\nNama: ${nama}\\nUnit: ${unitKerja}\\nPendidikan: ${pendidikan}\\nTTL: ${tempatLahir}, ${birthDateFormatted}\\nTMT Raw: ${tmtVal}\\nTMT Parsed: ${tmtFormatted}\\nStatus: ${detectedStatus}\\n\\nDetected Cols: ${debugColMap}`)\r\n              }\r\n\r\n              return {\r\n                nuptk: nuptk,\r\n                nama: nama,\r\n                nip: row.NIP || row.nip || undefined,\r\n                jenisKelamin: row['Jenis Kelamin'] || row.jenisKelamin || row.JK || undefined,\r\n                tempatLahir: row['Tempat Lahir'] || row.tempatLahir || undefined,\r\n                tanggalLahir: birthDateFormatted,\r\n                pendidikanTerakhir: row['Pendidikan Terakhir'] || row.pendidikan || row.Pendidikan || undefined,\r\n                unitKerja: (row['Unit Kerja'] || row.unitKerja || row.UNIT_KERJA ||\r\n                           row.satminkal || row.Satminkal || row.SATMINKAL ||\r\n                           row['Satuan Pendidikan'] || row.sekolah || row.Sekolah) || undefined,\r\n                status: detectedStatus,\r\n                tmt: tmtFormatted,\r\n                kecamatan: row.Kecamatan || row.kecamatan || row.KECAMATAN || undefined,\r\n                phoneNumber: row['No HP'] || row.phoneNumber || row['Nomor HP'] || undefined,\r\n                email: row.Email || row.email || row.EMAIL || undefined,\r\n                pdpkpnu: pdpkpnu,\r\n                isCertified: isCertified,\r\n              }\r\n            } catch (error: any) {\r\n              console.error('[IMPORT] Error parsing row', index, ':', error)\r\n              return null\r\n            }\r\n          }).filter(t => t !== null) // Remove null entries\r\n          \r\n          console.log('[IMPORT] Parsed teachers:', teachers.length)\r\n          console.log('[IMPORT] Sample:', teachers[0])\r\n          \r\n          \r\n          if (teachers.length === 0) {\r\n            alert(' Tidak ada data valid yang bisa diimport. Pastikan file Excel memiliki kolom: NUPTK dan Nama')\r\n            return\r\n          }\r\n\r\n          // --- DEBUG PAYLOAD INSPECTOR ---\r\n          if (teachers.length > 0) {\r\n              const sample = teachers[0]\r\n              const debugStr = ` PAYLOAD DATA GURU CHECK:\\n\\nNama: ${sample.nama}\\nUnit: ${sample.unitKerja}\\nTMT: ${sample.tmt}\\nStatus: ${sample.status}\\nPendidikan: ${sample.pendidikanTerakhir}\\n\\nJika field di atas kosong, cek Header Excel anda.`\r\n              alert(debugStr)\r\n              console.log(\"PAYLOAD FULL:\", teachers)\r\n          }\r\n          // -------------------------------\r\n          \r\n          try {\r\n            // Call ISOLATED Mutation (v4.0)\r\n            // We need to use api.importData.run\r\n            // Since I cannot change the hook import easily at the top, I will assume the 'api' object \r\n            // is available globally or I can import it dynamic? NO.\r\n            // I must rely on the fact that `api` is imported from `@/lib/api`.\r\n            // But wait, `useMutation` requires the function reference.\r\n            // I cannot easy switch the function passed to useMutation without changing the top of the file.\r\n            \r\n            // EMERGENCY HACK:\r\n            // Since I can't guarantee the top-level import change will work without context, \r\n            // I will ask the user to wait? NO.\r\n            // I will use `api.importData.run` if I can access `api`. \r\n            // Actually, in Convex + React, we usually do `const mutate = useMutation(api.importData.run)`.\r\n            // I need to change lines 1-100 to import the new API?\r\n            \r\n            // Let's look at line 19 of TeacherListPage: `import { api } from \"@/lib/api\"`.\r\n            // So `api` is available!\r\n            // But `bulkCreateMutation` is a hook result `const bulkCreateMutation = useMutation(...)`.\r\n            // I cannot change what the hook was initialized with dynamically.\r\n            \r\n            // I MUST CHANGE THE TOP OF THE FILE.\r\n            // I will verify where `bulkCreateMutation` is defined.\r\n             const result = await bulkCreateMutation({ teachers: teachers }) \r\n            \r\n            // NOTE: I am assuming `bulkCreateMutation` is now pointing to `api.teachers.importTeachers`\r\n            // If not, I need to update the `useMutation` hook at the top of component.\r\n            // But since I cannot see the top file imports easily in one go, I'll rely on the user reloading or me updating the hook.\r\n            // WAIT - I need to update the hook!\r\n            \r\n            if (result.errors && result.errors.length > 0) {\r\n              console.warn('[IMPORT] Errors:', result.errors)\r\n              alert(` Selesai! (Backend v${result.version || '?'})\\n\\nSukses: ${result.new} Baru, ${result.updated} Update\\nError: ${result.errors.length}`)\r\n            } else {\r\n              alert(` IMPOR SUKSES SEMPURNA! (Backend v${result.version || '?'})\\n\\nTotal: ${result.count} data masuk.`)\r\n            }\r\n          } catch (error: any) {\r\n            console.error('[IMPORT ERROR]', error)\r\n            alert(` Gagal import: ${error.message || 'Unknown error'}\\n\\nSilakan cek console (F12) untuk detail error.`)\r\n          }\r\n        }}\r\n      />\r\n\r\n      {/* Toggle Status Confirmation Modal */}\r\n      <Dialog open={toggleConfirmOpen} onOpenChange={setToggleConfirmOpen}>\r\n        <DialogContent className=\"sm:max-w-md\">\r\n          <DialogHeader>\r\n            <DialogTitle className=\"flex items-center gap-2 text-amber-600\">\r\n              {teacherToToggle?.currentStatus ? <UserMinus className=\"h-5 w-5\" /> : <UserCheck className=\"h-5 w-5\" />}\r\n              Konfirmasi {teacherToToggle?.currentStatus ? \"Non-Aktifkan\" : \"Aktifkan\"}\r\n            </DialogTitle>\r\n          </DialogHeader>\r\n          <div className=\"py-4\">\r\n            <p className=\"text-sm text-muted-foreground mb-2\">\r\n              Yakin ingin {teacherToToggle?.currentStatus ? \"menonaktifkan\" : \"mengaktifkan kembali\"} guru:\r\n            </p>\r\n            <p className=\"font-semibold text-lg mb-3\">\r\n              {teacherToToggle?.name}\r\n            </p>\r\n            <div className={`${teacherToToggle?.currentStatus ? 'bg-amber-50 border-amber-200' : 'bg-green-50 border-green-200'} border rounded-md p-3 mb-2`}>\r\n              <p className={`text-sm font-medium flex items-center gap-2 ${teacherToToggle?.currentStatus ? 'text-amber-800' : 'text-green-800'}`}>\r\n                {teacherToToggle?.currentStatus ? '' : ''} {teacherToToggle?.currentStatus ? 'Perhatian' : 'Informasi'}\r\n              </p>\r\n              <p className={`text-xs mt-1 ${teacherToToggle?.currentStatus ? 'text-amber-700' : 'text-green-700'}`}>\r\n                {teacherToToggle?.currentStatus \r\n                  ? 'Guru akan dinonaktifkan dan tidak akan muncul di laporan aktif.'\r\n                  : 'Guru akan diaktifkan kembali dan muncul di laporan aktif.'}\r\n              </p>\r\n            </div>\r\n          </div>\r\n          <DialogFooter className=\"gap-2 sm:gap-0\">\r\n            <Button\r\n              variant=\"outline\"\r\n              onClick={cancelToggle}\r\n            >\r\n              Batal\r\n            </Button>\r\n            <Button\r\n              variant={teacherToToggle?.currentStatus ? \"destructive\" : \"default\"}\r\n              onClick={confirmToggle}\r\n              className={teacherToToggle?.currentStatus ? \"bg-amber-600 hover:bg-amber-700\" : \"bg-green-600 hover:bg-green-700\"}\r\n            >\r\n              {teacherToToggle?.currentStatus ? <UserMinus className=\"h-4 w-4 mr-2\" /> : <UserCheck className=\"h-4 w-4 mr-2\" />}\r\n              Ya, {teacherToToggle?.currentStatus ? \"Non-Aktifkan\" : \"Aktifkan\"}\r\n            </Button>\r\n          </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\master-data\\components\\ExcelImportModal.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\monitoring\\HeadmasterExpiryPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":19},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useState' is defined but never used.","line":5,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":29},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Headmaster' is defined but never used.","line":8,"column":11,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":21}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\nimport { FileDown, AlertTriangle, CheckCircle } from \"lucide-react\"\r\nimport { useEffect, useState } from \"react\"\r\nimport * as XLSX from \"xlsx\"\r\n\r\ninterface Headmaster {\r\n  id: string\r\n  nama: string\r\n  unitKerja: string\r\n  tmt: string\r\n  expiryDate: Date\r\n  daysRemaining: number\r\n  status: \"expired\" | \"warning\" | \"safe\"\r\n}\r\n\r\n  import { useQuery } from \"convex/react\"\r\n  import { api } from \"../../../convex/_generated/api\"\r\n\r\n  export default function HeadmasterExpiryPage() {\r\n    // Fetch from Convex\r\n    const headmasters = useQuery(api.headmaster.getExpiringHeadmasters, { thresholdDays: 365 }) || []\r\n\r\n  const handleDownloadExcel = () => {\r\n    const data = headmasters.map((h, i) => ({\r\n      \"No\": i + 1,\r\n      \"Nama Kepala\": h.nama,\r\n      \"Unit Kerja\": h.unitKerja,\r\n      \"TMT Awal\": new Date(h.tmt).toLocaleDateString(\"id-ID\"),\r\n      \"Tanggal Habis Masa Jabatan\": h.expiryDate.toLocaleDateString(\"id-ID\"),\r\n      \"Sisa Waktu (Hari)\": h.daysRemaining < 0 ? `Lewat ${Math.abs(h.daysRemaining)} hari` : `${h.daysRemaining} hari`,\r\n      \"Status\": h.status === \"expired\" ? \"Sudah Habis\" : \"Akan Habis (< 1 Tahun)\"\r\n    }))\r\n\r\n    const ws = XLSX.utils.json_to_sheet(data)\r\n    const wb = XLSX.utils.book_new()\r\n    XLSX.utils.book_append_sheet(wb, ws, \"Kepala Expired\")\r\n    XLSX.writeFile(wb, \"Monitoring_Kepala_Madrasah_Expired.xlsx\")\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Monitoring Kepala Madrasah</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Daftar Kepala Madrasah yang masa jabatannya akan habis dalam 1 tahun ke depan atau sudah lewat.\r\n          </p>\r\n        </div>\r\n        <Button onClick={handleDownloadExcel} className=\"bg-green-600 hover:bg-green-700\">\r\n          <FileDown className=\"mr-2 h-4 w-4\" /> Download Excel\r\n        </Button>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Daftar Peringatan Dini</CardTitle>\r\n          <CardDescription>\r\n            Menampilkan {headmasters.length} data kepala yang perlu perhatian khusus.\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"rounded-md border\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead className=\"w-[50px]\">No</TableHead>\r\n                  <TableHead>Nama Kepala</TableHead>\r\n                  <TableHead>Unit Kerja</TableHead>\r\n                  <TableHead>Periode Ke</TableHead>\r\n                  <TableHead>TMT Awal</TableHead>\r\n                  <TableHead>Habis Masa Jabatan</TableHead>\r\n                  <TableHead>Sisa Waktu</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {headmasters.length === 0 ? (\r\n                  <TableRow>\r\n                    <TableCell colSpan={7} className=\"text-center h-24 text-muted-foreground\">\r\n                      <CheckCircle className=\"mx-auto h-8 w-8 text-green-500 mb-2\" />\r\n                      Tidak ada kepala madrasah yang masa jabatannya habis dalam 1 tahun ke depan.\r\n                    </TableCell>\r\n                  </TableRow>\r\n                ) : (\r\n                  headmasters.map((h, i) => (\r\n                    <TableRow key={h.id} className={h.status === 'expired' || h.status === 'limit_exceeded' ? 'bg-red-50' : ''}>\r\n                      <TableCell>{i + 1}</TableCell>\r\n                      <TableCell className=\"font-medium\">\r\n                          {h.nama}\r\n                          {h.status === 'limit_exceeded' && <span className=\"block text-xs text-red-600 font-bold\">Max 3 Periode!</span>}\r\n                      </TableCell>\r\n                      <TableCell>{h.unitKerja}</TableCell>\r\n                      <TableCell className=\"text-center font-bold\">\r\n                          {h.periode} / {h.maxPeriode}\r\n                      </TableCell>\r\n                      <TableCell>{new Date(h.tmt).toLocaleDateString(\"id-ID\")}</TableCell>\r\n                      <TableCell>{new Date(h.expiryDate).toLocaleDateString(\"id-ID\")}</TableCell>\r\n                      <TableCell className={h.daysRemaining < 0 ? \"text-red-600 font-bold\" : \"text-amber-600 font-bold\"}>\r\n                         {h.daysRemaining < 0 ? `Lewat ${Math.abs(h.daysRemaining)} hari` : `${h.daysRemaining} hari`}\r\n                      </TableCell>\r\n                      <TableCell>\r\n                        {h.status === 'expired' ? (\r\n                            <span className=\"flex items-center text-red-600 text-xs font-bold border border-red-200 bg-red-100 px-2 py-1 rounded-full w-fit\">\r\n                                <AlertTriangle className=\"w-3 h-3 mr-1\" /> EXPIRED\r\n                            </span>\r\n                        ) : h.status === 'limit_exceeded' ? (\r\n                            <span className=\"flex items-center text-red-600 text-xs font-bold border border-red-200 bg-red-100 px-2 py-1 rounded-full w-fit\">\r\n                                <AlertTriangle className=\"w-3 h-3 mr-1\" /> MAX LIMIT\r\n                            </span>\r\n                        ) : (\r\n                            <span className=\"text-amber-600 text-xs font-bold border border-amber-200 bg-amber-100 px-2 py-1 rounded-full\">\r\n                                WARNING\r\n                            </span>\r\n                        )}\r\n                      </TableCell>\r\n                    </TableRow>\r\n                  ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\reports\\ReportPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":11,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":11,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[557,560],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[557,560],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[837,840],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[837,840],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":20,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[942,945],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[942,945],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadData'. Either include it or remove the dependency array.","line":25,"column":6,"nodeType":"ArrayExpression","endLine":25,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [loadData]","fix":{"range":[1030,1032],"text":"[loadData]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":63,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":66,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1249,1252],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1249,1252],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":35,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":35,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1371,1374],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1371,1374],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":65,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":68,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1756,1759],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1756,1759],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":64,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":64,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2307,2310],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2307,2310],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2697,2700],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2697,2700],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":8,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\nimport { Printer, Search, Loader2 } from \"lucide-react\"\r\nimport { useEffect, useState } from \"react\"\r\n// import { api } from \"@/lib/api\"\r\nimport { toast } from \"sonner\"\r\n\r\nconst api = {\r\n  getTeachers: async () => [] as any[]\r\n}\r\n\r\nexport default function ReportPage() {\r\n  const [reportType, setReportType] = useState(\"teachers_by_unit\")\r\n  const [selectedUnit, setSelectedUnit] = useState(\"all\")\r\n  const [units, setUnits] = useState<string[]>([])\r\n  const [previewData, setPreviewData] = useState<any[]>([])\r\n  const [isLoading, setIsLoading] = useState(true)\r\n  const [allData, setAllData] = useState<any[]>([])\r\n  \r\n  // Load real data from API\r\n  useEffect(() => {\r\n    loadData()\r\n  }, [])\r\n\r\n  const loadData = async () => {\r\n      setIsLoading(true)\r\n      try {\r\n          // Fetch from API\r\n          const res = await api.getTeachers();\r\n          const teachers = Array.isArray(res) ? res : (res as any).data || [];\r\n          \r\n          // Map Backend Fields to Report Format\r\n          const mapped = teachers.map((t: any) => ({\r\n              ...t,\r\n              // Fix: API returns 'unitKerja', not 'satminkal'. Use t.unitKerja first.\r\n              unitKerja: t.unitKerja || t.satminkal || \"Tanpa Unit\",\r\n              nip: t.nuptk || t.nip || \"-\"\r\n          }));\r\n\r\n          setAllData(mapped);\r\n\r\n          // Extract unique Units\r\n          const uniqueUnits = Array.from(new Set(mapped.map((t: any) => t.unitKerja))).sort() as string[]\r\n          setUnits(uniqueUnits)\r\n          \r\n          generatePreview(mapped, reportType, selectedUnit)\r\n      } catch (e) {\r\n          console.error(e)\r\n          toast.error(\"Gagal memuat data guru\")\r\n      } finally {\r\n          setIsLoading(false)\r\n      }\r\n  }\r\n\r\n  // Regenerate when filters change\r\n  useEffect(() => {\r\n    if (allData.length > 0) {\r\n        generatePreview(allData, reportType, selectedUnit)\r\n    }\r\n  }, [reportType, selectedUnit, allData])\r\n\r\n  const generatePreview = (teachers: any[], type: string, unit: string) => {\r\n      if (type === \"teachers_by_unit\") {\r\n          let filtered = teachers\r\n          if (unit !== \"all\") {\r\n              filtered = teachers.filter(t => t.unitKerja === unit)\r\n          }\r\n          setPreviewData(filtered)\r\n      } else if (type === \"stats\") {\r\n          // Generate Stats (PNS, GTY, GTT)\r\n          const stats: Record<string, any> = {}\r\n          teachers.forEach(t => {\r\n              const u = t.unitKerja || \"Tanpa Unit\"\r\n              if (!stats[u]) stats[u] = { name: u, pns: 0, gty: 0, gtt: 0, total: 0 }\r\n              \r\n              const s = (t.status || \"\").toUpperCase()\r\n              if (s.includes(\"PNS\") || s.includes(\"ASN\") || s.includes(\"PPPK\")) stats[u].pns++\r\n              else if (s.includes(\"GTY\")) stats[u].gty++\r\n              else stats[u].gtt++\r\n              \r\n              stats[u].total++\r\n          })\r\n          setPreviewData(Object.values(stats))\r\n      }\r\n  }\r\n\r\n  const handlePrint = () => {\r\n    window.print()\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between print:hidden\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold tracking-tight\">Laporan & Rekapitulasi</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Cetak laporan data guru dan statistik kepegawaian (Realtime Data).\r\n          </p>\r\n        </div>\r\n        <Button onClick={handlePrint} className=\"bg-blue-600 hover:bg-blue-700\" disabled={isLoading}>\r\n          <Printer className=\"mr-2 h-4 w-4\" /> Cetak Laporan (PDF)\r\n        </Button>\r\n      </div>\r\n\r\n      {/* FILTERS - HIDDEN ON PRINT */}\r\n      <Card className=\"print:hidden\">\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center gap-2\">\r\n            <Search className=\"w-5 h-5\"/> Filter Laporan\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"flex flex-col md:flex-row gap-4\">\r\n            <div className=\"w-full md:w-1/3 space-y-2\">\r\n                <label className=\"text-sm font-medium\">Jenis Laporan</label>\r\n                <Select value={reportType} onValueChange={setReportType}>\r\n                    <SelectTrigger>\r\n                        <SelectValue />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        <SelectItem value=\"teachers_by_unit\">Daftar Guru per Unit Kerja</SelectItem>\r\n                        <SelectItem value=\"stats\">Statistik Kepegawaian (Rekap)</SelectItem>\r\n                    </SelectContent>\r\n                </Select>\r\n            </div>\r\n            {reportType === \"teachers_by_unit\" && (\r\n                <div className=\"w-full md:w-1/3 space-y-2\">\r\n                    <label className=\"text-sm font-medium\">Pilih Unit Kerja</label>\r\n                    <Select value={selectedUnit} onValueChange={setSelectedUnit}>\r\n                        <SelectTrigger>\r\n                            <SelectValue placeholder=\"Semua Unit\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"all\">-- Semua Unit --</SelectItem>\r\n                            {units.map(u => (\r\n                                <SelectItem key={u} value={u}>{u}</SelectItem>\r\n                            ))}\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n            )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* REPORT PREVIEW - VISIBLE ON PRINT */}\r\n      <div className=\"print:block bg-white p-8 sm:p-0 min-h-[500px]\">\r\n          {/* HEADER CETAK */}\r\n          <div className=\"hidden print:block mb-8 border-b-2 border-black pb-4 text-center\">\r\n              <h2 className=\"text-2xl font-bold uppercase\">Lembaga Pendidikan Ma'arif NU Cilacap</h2>\r\n              <p className=\"text-sm\">Jl. Masjid No. 09, Cilacap Tengah, Kabupaten Cilacap</p>\r\n              <h3 className=\"text-xl font-bold mt-4 uppercase\">\r\n                  {reportType === 'stats' ? 'Laporan Statistik Kepegawaian' : `Data Guru - ${selectedUnit === 'all' ? 'Semua Unit' : selectedUnit}`}\r\n              </h3>\r\n              <p className=\"text-sm text-gray-500\">Tanggal Cetak: {new Date().toLocaleDateString(\"id-ID\")}</p>\r\n          </div>\r\n\r\n          <div className=\"rounded-md border print:border-none\">\r\n            <Table className=\"print:text-sm\">\r\n                {reportType === \"teachers_by_unit\" ? (\r\n                    <>\r\n                        <TableHeader>\r\n                            <TableRow className=\"bg-slate-100 print:bg-gray-200\">\r\n                                <TableHead className=\"w-[50px] font-bold text-black border print:border-black\">No</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">NIP / NUPTK</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">Nama Lengkap</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">Status</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">Unit Kerja</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">Mapel</TableHead>\r\n                            </TableRow>\r\n                        </TableHeader>\r\n                        <TableBody>\r\n                            {isLoading ? (\r\n                                <TableRow><TableCell colSpan={6} className=\"text-center h-24\"><Loader2 className=\"animate-spin inline mr-2\"/> Memuat Data...</TableCell></TableRow>\r\n                            ) : previewData.length === 0 ? (\r\n                                <TableRow>\r\n                                    <TableCell colSpan={6} className=\"text-center h-24\">Tidak ada data.</TableCell>\r\n                                </TableRow>\r\n                            ) : (\r\n                                previewData.map((rox, i) => (\r\n                                    <TableRow key={i} className=\"print:break-inside-avoid\">\r\n                                        <TableCell className=\"border print:border-black\">{i + 1}</TableCell>\r\n                                        <TableCell className=\"border print:border-black\">{rox.nip}</TableCell>\r\n                                        <TableCell className=\"font-medium border print:border-black\">{rox.nama}</TableCell>\r\n                                        <TableCell className=\"border print:border-black\">{rox.status}</TableCell>\r\n                                        <TableCell className=\"border print:border-black\">{rox.unitKerja}</TableCell>\r\n                                        <TableCell className=\"border print:border-black\">{rox.mapel || '-'}</TableCell>\r\n                                    </TableRow>\r\n                                ))\r\n                            )}\r\n                        </TableBody>\r\n                    </>\r\n                ) : (\r\n                    <>\r\n                        <TableHeader>\r\n                            <TableRow className=\"bg-slate-100 print:bg-gray-200\">\r\n                                <TableHead className=\"w-[50px] font-bold text-black border print:border-black\">No</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black\">Unit Kerja</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black text-center\">PNS/ASN</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black text-center\">GTY</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black text-center\">GTT/Guru Lain</TableHead>\r\n                                <TableHead className=\"font-bold text-black border print:border-black text-center\">Total</TableHead>\r\n                            </TableRow>\r\n                        </TableHeader>\r\n                        <TableBody>\r\n                             {isLoading ? (\r\n                                <TableRow><TableCell colSpan={6} className=\"text-center h-24\"><Loader2 className=\"animate-spin inline mr-2\"/> Memuat Statistik...</TableCell></TableRow>\r\n                             ) : previewData.map((rox, i) => (\r\n                                <TableRow key={i} className=\"print:break-inside-avoid\">\r\n                                    <TableCell className=\"border print:border-black\">{i + 1}</TableCell>\r\n                                    <TableCell className=\"font-medium border print:border-black\">{rox.name}</TableCell>\r\n                                    <TableCell className=\"text-center border print:border-black\">{rox.pns}</TableCell>\r\n                                    <TableCell className=\"text-center border print:border-black\">{rox.gty}</TableCell>\r\n                                    <TableCell className=\"text-center border print:border-black\">{rox.gtt}</TableCell>\r\n                                    <TableCell className=\"text-center font-bold border print:border-black\">{rox.total}</TableCell>\r\n                                </TableRow>\r\n                             ))}\r\n                        </TableBody>\r\n                    </>\r\n                )}\r\n            </Table>\r\n          </div>\r\n\r\n          <div className=\"hidden print:flex justify-end mt-12 w-full break-inside-avoid\">\r\n              <div className=\"text-center mr-8\">\r\n                  <p>Cilacap, {new Date().toLocaleDateString(\"id-ID\", { day: 'numeric', month: 'long', year: 'numeric' })}</p>\r\n                  <p className=\"mt-2\">Ketua Pengurus Cabang</p>\r\n                  <div className=\"h-24\"></div>\r\n                  <p className=\"font-bold border-b border-black inline-block min-w-[200px]\"></p>\r\n              </div>\r\n          </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\reports\\SkReportPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":80,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":83,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1705,1708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1705,1708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":45,"column":106,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":45,"endColumn":109,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1731,1734],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1731,1734],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3492,3495],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3492,3495],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":308,"column":58,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":308,"endColumn":61,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11271,11274],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11271,11274],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from 'react'\r\nimport { useQuery } from 'convex/react'\r\nimport { api } from '../../../convex/_generated/api'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '../../components/ui/card'\r\nimport { Button } from '../../components/ui/button'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../../components/ui/select'\r\nimport { Label } from '../../components/ui/label'\r\nimport { Download } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\nimport * as XLSX from 'xlsx'\r\n\r\nexport default function SkReportPage() {\r\n  // Get user - with error handling\r\n  let user = null\r\n  let isOperator = false\r\n  \r\n  try {\r\n    const userStr = localStorage.getItem('user')\r\n    if (userStr) {\r\n      user = JSON.parse(userStr)\r\n      isOperator = user.role === 'operator'\r\n    }\r\n  } catch (error) {\r\n    console.error('Error parsing user:', error)\r\n  }\r\n\r\n  // State\r\n  const [startDate, setStartDate] = useState('')\r\n  const [endDate, setEndDate] = useState('')\r\n  const [selectedSchool, setSelectedSchool] = useState('all')\r\n  const [selectedStatus, setSelectedStatus] = useState('all')\r\n\r\n  // Fetch schools - with error handling\r\n  const schools = useQuery(api.schools.list, {})\r\n  \r\n  // Find operator's school ID by name\r\n  const operatorSchoolId = isOperator && user?.unitKerja \r\n    ? schools?.find(s => s.nama === user.unitKerja)?._id\r\n    : undefined\r\n  \r\n  // Build query args - with null checks\r\n  const queryArgs = {\r\n    startDate: startDate ? new Date(startDate).getTime() : undefined,\r\n    endDate: endDate ? new Date(endDate + 'T23:59:59').getTime() : undefined,\r\n    schoolId: (selectedSchool && selectedSchool !== 'all') ? selectedSchool as any : operatorSchoolId as any,\r\n    status: (selectedStatus && selectedStatus !== 'all') ? selectedStatus : undefined,\r\n  }\r\n  \r\n  // Fetch report data - with error handling\r\n  const reportData = useQuery(api.reports.generateSkReport, queryArgs)\r\n  \r\n  // Debug logging\r\n  console.log(' SK Report Debug:', {\r\n    user,\r\n    isOperator,\r\n    queryArgs,\r\n    reportData,\r\n    schools\r\n  })\r\n\r\n  // Reset filters\r\n  const handleResetFilters = () => {\r\n    setStartDate('')\r\n    setEndDate('')\r\n    setSelectedSchool('all')\r\n    setSelectedStatus('all')\r\n  }\r\n\r\n  // Excel Export Handler\r\n  const handleExportExcel = () => {\r\n    if (!reportData || !reportData.data || reportData.data.length === 0) {\r\n      toast.error('Tidak ada data untuk di-export')\r\n      return\r\n    }\r\n\r\n    try {\r\n      // Create workbook\r\n      const wb = XLSX.utils.book_new()\r\n\r\n      // Sheet 1: Ringkasan\r\n      const summaryData = [\r\n        ['LAPORAN SURAT KEPUTUSAN'],\r\n        ['Tanggal Export:', new Date().toLocaleString('id-ID')],\r\n        [],\r\n        ['RINGKASAN DATA'],\r\n        ['Total SK', reportData.summary.total],\r\n        ['Draft', reportData.summary.draft],\r\n        ['Pending Review', reportData.summary.pending],\r\n        ['Disetujui', reportData.summary.approved],\r\n        ['Ditolak', reportData.summary.rejected],\r\n        [],\r\n        ['BREAKDOWN JENIS SK'],\r\n        ['Pengangkatan', reportData.byType.pengangkatan],\r\n        ['Mutasi', reportData.byType.mutasi],\r\n        ['Promosi', reportData.byType.promosi],\r\n        ['Pemberhentian', reportData.byType.pemberhentian],\r\n      ]\r\n      const wsSummary = XLSX.utils.aoa_to_sheet(summaryData)\r\n      XLSX.utils.book_append_sheet(wb, wsSummary, 'Ringkasan')\r\n\r\n      // Sheet 2: Data SK\r\n      const skData = reportData.data.map((sk: any, index: number) => ({\r\n        'No': index + 1,\r\n        'Nomor SK': sk.nomorSk,\r\n        'Jenis SK': sk.jenisSk,\r\n        'Nama': sk.nama,\r\n        'Jabatan': sk.jabatan || '-',\r\n        'Sekolah': sk.schoolName || 'N/A',\r\n        'Status': sk.status,\r\n        'Tanggal Penetapan': sk.tanggalPenetapan || '-',\r\n        'Tanggal Dibuat': new Date(sk.createdAt).toLocaleDateString('id-ID'),\r\n      }))\r\n      const wsData = XLSX.utils.json_to_sheet(skData)\r\n      \r\n      // Set column widths\r\n      wsData['!cols'] = [\r\n        { wch: 5 },  // No\r\n        { wch: 20 }, // Nomor SK\r\n        { wch: 15 }, // Jenis SK\r\n        { wch: 25 }, // Nama\r\n        { wch: 20 }, // Jabatan\r\n        { wch: 30 }, // Sekolah\r\n        { wch: 12 }, // Status\r\n        { wch: 18 }, // Tanggal Penetapan\r\n        { wch: 15 }, // Tanggal Dibuat\r\n      ]\r\n      \r\n      XLSX.utils.book_append_sheet(wb, wsData, 'Data SK')\r\n\r\n      // Generate filename\r\n      const filename = `Laporan_SK_${new Date().toISOString().split('T')[0]}.xlsx`\r\n      \r\n      // Export\r\n      XLSX.writeFile(wb, filename)\r\n      \r\n      toast.success(`Berhasil export ${reportData.data.length} data SK ke Excel`)\r\n    } catch (error) {\r\n      console.error('Export error:', error)\r\n      toast.error('Gagal export data')\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"container mx-auto p-6 space-y-6\">\r\n      {/* Header */}\r\n      <div>\r\n        <h1 className=\"text-3xl font-bold\">Laporan Surat Keputusan</h1>\r\n        <p className=\"text-muted-foreground mt-1\">\r\n          Generate dan export laporan SK dengan berbagai filter\r\n        </p>\r\n      </div>\r\n\r\n      {/* Filters Card */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Filter Laporan</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"grid gap-4\">\r\n            {/* Date Range */}\r\n            <div className=\"grid md:grid-cols-2 gap-4\">\r\n              <div>\r\n                <Label>Tanggal Mulai</Label>\r\n                <input\r\n                  type=\"date\"\r\n                  value={startDate}\r\n                  onChange={(e) => setStartDate(e.target.value)}\r\n                  className=\"w-full mt-1 p-2 border rounded\"\r\n                />\r\n              </div>\r\n              <div>\r\n                <Label>Tanggal Akhir</Label>\r\n                <input\r\n                  type=\"date\"\r\n                  value={endDate}\r\n                  onChange={(e) => setEndDate(e.target.value)}\r\n                  className=\"w-full mt-1 p-2 border rounded\"\r\n                />\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"grid md:grid-cols-2 gap-4\">\r\n              {/* School Filter (Super Admin only) */}\r\n              {!isOperator && (\r\n                <div>\r\n                  <Label>Sekolah</Label>\r\n                  <Select value={selectedSchool} onValueChange={setSelectedSchool}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Semua Sekolah\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      <SelectItem value=\"all\">Semua Sekolah</SelectItem>\r\n                      {schools?.map(school => (\r\n                        <SelectItem key={school._id} value={school._id}>\r\n                          {school.nama}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                </div>\r\n              )}\r\n              \r\n              {/* Status Filter */}\r\n              <div>\r\n                <Label>Status</Label>\r\n                <Select value={selectedStatus} onValueChange={setSelectedStatus}>\r\n                  <SelectTrigger>\r\n                    <SelectValue placeholder=\"Semua Status\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Semua Status</SelectItem>\r\n                    <SelectItem value=\"draft\">Draft</SelectItem>\r\n                    <SelectItem value=\"pending\">Pending Review</SelectItem>\r\n                    <SelectItem value=\"approved\">Disetujui</SelectItem>\r\n                    <SelectItem value=\"rejected\">Ditolak</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n\r\n            {/* Action Buttons */}\r\n            <div className=\"flex gap-2\">\r\n              <Button variant=\"outline\" onClick={handleResetFilters}>\r\n                Reset Filter\r\n              </Button>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Summary Stats - Now with real data! */}\r\n      {reportData ? (\r\n        <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"text-2xl font-bold\">{reportData.summary.total}</div>\r\n              <div className=\"text-xs text-muted-foreground\">Total SK</div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"text-2xl font-bold text-gray-600\">\r\n                {reportData.summary.draft}\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground\">Draft</div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"text-2xl font-bold text-yellow-600\">\r\n                {reportData.summary.pending}\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground\">Pending</div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"text-2xl font-bold text-green-600\">\r\n                {reportData.summary.approved}\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground\">Disetujui</div>\r\n            </CardContent>\r\n          </Card>\r\n          <Card>\r\n            <CardContent className=\"p-4\">\r\n              <div className=\"text-2xl font-bold text-red-600\">\r\n                {reportData.summary.rejected}\r\n              </div>\r\n              <div className=\"text-xs text-muted-foreground\">Ditolak</div>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-2 md:grid-cols-5 gap-4\">\r\n          {['Total SK', 'Draft', 'Pending', 'Disetujui', 'Ditolak'].map((label) => (\r\n            <Card key={label}>\r\n              <CardContent className=\"p-4\">\r\n                <div className=\"text-2xl font-bold text-gray-300 animate-pulse\">--</div>\r\n                <div className=\"text-xs text-muted-foreground\">{label}</div>\r\n              </CardContent>\r\n            </Card>\r\n          ))}\r\n        </div>\r\n      )}\r\n\r\n      {/* Preview Table - Simple version */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>\r\n            Preview Data ({reportData?.data?.length || 0} records)\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          {reportData && reportData.data && reportData.data.length > 0 ? (\r\n            <div className=\"overflow-x-auto\">\r\n              <table className=\"w-full text-sm\">\r\n                <thead>\r\n                  <tr className=\"border-b\">\r\n                    <th className=\"text-left p-2\">No</th>\r\n                    <th className=\"text-left p-2\">Nomor SK</th>\r\n                    <th className=\"text-left p-2\">Nama</th>\r\n                    <th className=\"text-left p-2\">Sekolah</th>\r\n                    <th className=\"text-left p-2\">Status</th>\r\n                    <th className=\"text-left p-2\">Tanggal</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody>\r\n                  {reportData.data.slice(0, 10).map((sk: any, index: number) => (\r\n                    <tr key={sk._id} className=\"border-b hover:bg-gray-50\">\r\n                      <td className=\"p-2\">{index + 1}</td>\r\n                      <td className=\"p-2\">{sk.nomorSk}</td>\r\n                      <td className=\"p-2\">{sk.nama}</td>\r\n                      <td className=\"p-2\">{sk.schoolName || 'N/A'}</td>\r\n                      <td className=\"p-2\">\r\n                        <span className={`px-2 py-1 rounded text-xs ${\r\n                          sk.status === 'approved' ? 'bg-green-100 text-green-800' :\r\n                          sk.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :\r\n                          sk.status === 'rejected' ? 'bg-red-100 text-red-800' :\r\n                          'bg-gray-100 text-gray-800'\r\n                        }`}>\r\n                          {sk.status}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"p-2\">\r\n                        {new Date(sk.createdAt).toLocaleDateString('id-ID')}\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n              {reportData.data.length > 10 && (\r\n                <p className=\"text-sm text-muted-foreground mt-2 text-center\">\r\n                  Menampilkan 10 dari {reportData.data.length} records\r\n                </p>\r\n              )}\r\n            </div>\r\n          ) : (\r\n            <p className=\"text-center text-muted-foreground py-8\">\r\n              {reportData === undefined ? 'Loading...' : 'No data to display'}\r\n            </p>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Export Button - Now functional! */}\r\n      <div>\r\n        <Button \r\n          onClick={handleExportExcel}\r\n          disabled={!reportData || reportData.data.length === 0}\r\n        >\r\n          <Download className=\"w-4 h-4 mr-2\" />\r\n          Export to Excel ({reportData?.data?.length || 0} records)\r\n        </Button>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\reports\\SkReportPageSimple.tsx","messages":[{"ruleId":null,"nodeType":null,"fatal":true,"severity":2,"message":"Parsing error: Expression expected.","line":16,"column":0}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":1,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useMemo } from 'react'\r\nimport { useQuery } from 'convex/react'\r\nimport { api } from '../../../convex/_generated/api'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Label } from '@/components/ui/label'\r\nimport { Download, Printer, Filter, X, Check, ChevronsUpDown } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\nimport * as XLSX from 'xlsx'\r\nimport { cn } from \"@/lib/utils\"\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\"\r\nimport { PieChart, Pie, Cell, ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Legend, CartesianGrid } from 'recharts'\r\n\r\n// Chart Colors\r\nconst COLORS = {\r\n  approved: '#22c55e', // green-500\r\n  pending: '#f59e0b', // amber-500\r\n  rejected: '#ef4444', // red-500\r\n  draft: '#94a3b8',    // slate-400\r\n}\r\n\r\nconst TYPE_COLORS = [\r\n    '#3b82f6', // blue\r\n    '#8b5cf6', // violet\r\n    '#ec4899', // pink\r\n    '#06b6d4', // cyan\r\n]\r\n\r\nexport default function SkReportPageSimple() {\r\n  // 1. User Context & Role Safety\r\n  let user = null\r\n  let isOperator = false\r\n  let userUnitKerja = ''\r\n  \r\n  try {\r\n    const userStr = localStorage.getItem('user')\r\n    if (userStr) {\r\n      user = JSON.parse(userStr)\r\n      isOperator = user.role === 'operator'\r\n      userUnitKerja = user.unitKerja || ''\r\n    }\r\n  } catch (error) {\r\n    console.error('Error parsing user:', error)\r\n  }\r\n\r\n  // 2. State Management\r\n  const [startDate, setStartDate] = useState('')\r\n  const [endDate, setEndDate] = useState('')\r\n  const [selectedSchool, setSelectedSchool] = useState('all')\r\n  const [selectedStatus, setSelectedStatus] = useState('all')\r\n  const [openSchool, setOpenSchool] = useState(false)\r\n  const [searchQuery, setSearchQuery] = useState(\"\")\r\n\r\n  // 3. Data Fetching\r\n  const convexSchools = useQuery(api.schools.list, {})\r\n\r\n  // Transform schools data\r\n  const schools = useMemo(() => (convexSchools || [])\r\n    .filter(s => s && s.nama)\r\n    .map(s => ({\r\n      _id: s._id,\r\n      nama: s.nama\r\n    })), [convexSchools])\r\n  \r\n  // Logic: Operator can only see their school\r\n  const operatorSchool = isOperator ? schools.find(s => s.nama === userUnitKerja) : null\r\n  const effectiveSchoolId = isOperator ? (operatorSchool?._id) : (selectedSchool !== 'all' ? selectedSchool : undefined)\r\n\r\n  // Filter schools for dropdown search\r\n\r\n\r\n  const queryArgs = {\r\n    startDate: startDate ? new Date(startDate).getTime() : undefined,\r\n    endDate: endDate ? new Date(endDate + 'T23:59:59').getTime() : undefined,\r\n    schoolId: effectiveSchoolId as any, \r\n    status: (selectedStatus && selectedStatus !== 'all') ? selectedStatus : undefined,\r\n  }\r\n\r\n  const reportData = useQuery(api.reports.generateSkReport, queryArgs)\r\n\r\n  // 4. Handlers\r\n  const handlePrint = () => {\r\n    window.print()\r\n  }\r\n\r\n  const handleExportExcel = () => {\r\n    if (!reportData || !reportData.data || reportData.data.length === 0) {\r\n      toast.error('Tidak ada data untuk di-export')\r\n      return\r\n    }\r\n\r\n    try {\r\n      const wb = XLSX.utils.book_new()\r\n\r\n      // Summary Sheet\r\n      const summaryData = [\r\n        ['LAPORAN DATA SK'],\r\n        ['Periode:', startDate && endDate ? `${startDate} s/d ${endDate}` : 'Semua Waktu'],\r\n        ['Dicetak Oleh:', user?.nama || 'System'],\r\n        ['Waktu Cetak:', new Date().toLocaleString('id-ID')],\r\n        [],\r\n        ['RINGKASAN'],\r\n        ['Total Dokumen', reportData.summary.total],\r\n        ['Draft', reportData.summary.draft],\r\n        ['Pending', reportData.summary.pending],\r\n        ['Approved', reportData.summary.approved],\r\n        ['Rejected', reportData.summary.rejected]\r\n      ]\r\n      const wsSummary = XLSX.utils.aoa_to_sheet(summaryData)\r\n      XLSX.utils.book_append_sheet(wb, wsSummary, 'Ringkasan')\r\n\r\n      // Details Sheet\r\n      const detailsData = reportData.data.map((item: any, i: number) => ({\r\n        'No': i + 1,\r\n        'Nomor SK': item.nomorSk,\r\n        'Jenis SK': item.jenisSk,\r\n        'Nama Guru': item.nama,\r\n        'Unit Kerja': item.schoolName || '-',\r\n        'Status': item.status,\r\n        'Tanggal Input': new Date(item.createdAt).toLocaleDateString('id-ID')\r\n      }))\r\n      const wsDetails = XLSX.utils.json_to_sheet(detailsData)\r\n      \r\n      // Auto-width columns\r\n      const wscols = Object.keys(detailsData[0] || {}).map(() => ({ wch: 20 }))\r\n      wsDetails['!cols'] = wscols\r\n      \r\n      XLSX.utils.book_append_sheet(wb, wsDetails, 'Data Detail')\r\n\r\n      XLSX.writeFile(wb, `Laporan_SK_${new Date().toISOString().split('T')[0]}.xlsx`)\r\n      toast.success('Excel berhasil didownload')\r\n    } catch (e) {\r\n      console.error(e)\r\n      toast.error('Gagal export excel')\r\n    }\r\n  }\r\n\r\n  const resetFilters = () => {\r\n    setStartDate('')\r\n    setEndDate('')\r\n    setSelectedSchool('all')\r\n    setSelectedStatus('all')\r\n    setSearchQuery(\"\")\r\n  }\r\n\r\n  // 5. Render\r\n  return (\r\n    <div className=\"min-h-screen bg-slate-50/50 pb-20\">\r\n      \r\n      {/* --- PRINT STYLE STYLE BLOCK --- */}\r\n      <style>{`\r\n        @media print {\r\n          @page { size: landscape; margin: 10mm; }\r\n          body { background: white; font-family: 'Times New Roman', serif; }\r\n          .no-print { display: none !important; }\r\n          .print-only { display: block !important; }\r\n          .card-print { border: none !important; box-shadow: none !important; }\r\n          table { width: 100%; border-collapse: collapse; font-size: 11pt; }\r\n          th, td { border: 1px solid black; padding: 4px 8px; }\r\n          th { background: #f0f0f0 !important; color: black !important; }\r\n        }\r\n        .print-only { display: none; }\r\n      `}</style>\r\n      \r\n      {/* HEADER (Screen Only) */}\r\n      <div className=\"no-print bg-white border-b px-6 py-4 flex flex-col md:flex-row md:items-center justify-between gap-4\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight text-slate-800\">Laporan & Rekap SK</h1>\r\n          <p className=\"text-slate-500 text-sm\">Download laporan format Excel atau cetak PDF langsung.</p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n           <Button variant=\"outline\" onClick={handlePrint}>\r\n             <Printer className=\"w-4 h-4 mr-2\" />\r\n             Cetak / PDF\r\n           </Button>\r\n           <Button className=\"bg-green-600 hover:bg-green-700\" onClick={handleExportExcel}>\r\n             <Download className=\"w-4 h-4 mr-2\" />\r\n             Export Excel\r\n           </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <div className=\"container mx-auto p-4 space-y-6\">\r\n        \r\n        {/* FILTERS (Screen Only) */}\r\n        <Card className=\"no-print\">\r\n          <CardHeader className=\"pb-3 border-b bg-slate-50\">\r\n            <div className=\"flex items-center justify-between\">\r\n              <CardTitle className=\"text-base font-semibold flex items-center gap-2\">\r\n                <Filter className=\"w-4 h-4\" /> Filter Data\r\n              </CardTitle>\r\n              {(startDate || endDate || selectedStatus !== 'all' || (selectedSchool !== 'all' && !isOperator)) && (\r\n                <Button variant=\"ghost\" size=\"sm\" onClick={resetFilters} className=\"text-red-500 h-8\">\r\n                  <X className=\"w-3 h-3 mr-1\" /> Reset\r\n                </Button>\r\n              )}\r\n            </div>\r\n          </CardHeader>\r\n          <CardContent className=\"pt-4 grid grid-cols-1 md:grid-cols-4 gap-4\">\r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs\">Tanggal Awal</Label>\r\n                <input \r\n                  type=\"date\" \r\n                  className=\"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring\"\r\n                  value={startDate}\r\n                  onChange={e => setStartDate(e.target.value)}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs\">Tanggal Akhir</Label>\r\n                <input \r\n                  type=\"date\" \r\n                  className=\"flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring\"\r\n                  value={endDate}\r\n                  onChange={e => setEndDate(e.target.value)}\r\n                />\r\n              </div>\r\n              <div className=\"space-y-1\">\r\n                <Label className=\"text-xs\">Status SK</Label>\r\n                <Select value={selectedStatus} onValueChange={setSelectedStatus}>\r\n                  <SelectTrigger className=\"h-9\">\r\n                    <SelectValue placeholder=\"Semua Status\" />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"all\">Semua Status</SelectItem>\r\n                    <SelectItem value=\"approved\">Disetujui (Approved)</SelectItem>\r\n                    <SelectItem value=\"draft\">Draft</SelectItem>\r\n                    <SelectItem value=\"pending\">Menunggu Review</SelectItem>\r\n                    <SelectItem value=\"rejected\">Ditolak</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n              \r\n              {!isOperator && (\r\n                <div className=\"space-y-1 flex flex-col\">\r\n                  <Label className=\"text-xs mb-1\">Unit Kerja (Sekolah)</Label>\r\n                  <Popover open={openSchool} onOpenChange={setOpenSchool}>\r\n                    <PopoverTrigger asChild>\r\n                      <Button\r\n                        variant=\"outline\"\r\n                        role=\"combobox\"\r\n                        aria-expanded={openSchool}\r\n                        className=\"h-9 w-full justify-between\"\r\n                      >\r\n                        {selectedSchool !== \"all\"\r\n                          ? schools.find((school) => school._id === selectedSchool)?.nama\r\n                          : \"Semua Sekolah\"}\r\n                        <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                      </Button>\r\n                    </PopoverTrigger>\r\n                    <PopoverContent className=\"w-[300px] p-0\" align=\"start\">\r\n                      <div className=\"flex flex-col border rounded-md bg-white\">\r\n                        {/* Manual Search Input */}\r\n                        <div className=\"flex items-center border-b px-3\">\r\n                          <Input\r\n                            placeholder=\"Ketik nama sekolah...\"\r\n                            value={searchQuery}\r\n                            onChange={(e) => setSearchQuery(e.target.value)}\r\n                            className=\"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-slate-500 disabled:cursor-not-allowed disabled:opacity-50 border-none focus-visible:ring-0 px-0\"\r\n                            autoFocus\r\n                          />\r\n                        </div>\r\n                        \r\n                        {/* Manual List */}\r\n                        <div className=\"max-h-[300px] overflow-y-auto overflow-x-hidden p-1\">\r\n                           {/* Debug info */}\r\n                           <div className=\"px-2 py-1.5 text-xs text-slate-400 border-b mb-1\">\r\n                              Menampilkan {schools.filter(s => s.nama.toLowerCase().includes(searchQuery.toLowerCase())).length} dari {schools.length} sekolah\r\n                           </div>\r\n\r\n                          {/* Option: Semua Sekolah */}\r\n                          <div\r\n                            className={cn(\r\n                              \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-slate-100 hover:text-slate-900 cursor-pointer\",\r\n                              selectedSchool === 'all' && \"bg-slate-100\"\r\n                            )}\r\n                            onMouseDown={(e) => {\r\n                              e.preventDefault();\r\n                              e.stopPropagation();\r\n                              setSelectedSchool(\"all\")\r\n                              setOpenSchool(false)\r\n                              setSearchQuery(\"\")\r\n                            }}\r\n                          >\r\n                            <Check\r\n                              className={cn(\r\n                                \"mr-2 h-4 w-4\",\r\n                                selectedSchool === \"all\" ? \"opacity-100\" : \"opacity-0\"\r\n                              )}\r\n                            />\r\n                            Semua Sekolah\r\n                          </div>\r\n\r\n                          {/* Filtered Schools */}\r\n                          {schools\r\n                            .filter(s => s.nama.toLowerCase().includes(searchQuery.toLowerCase()))\r\n                            .slice(0, 100) // Performance limit\r\n                            .map((school) => (\r\n                              <div\r\n                                key={school._id}\r\n                                className={cn(\r\n                                  \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-slate-100 hover:text-slate-900 cursor-pointer\",\r\n                                  selectedSchool === school._id && \"bg-slate-100\"\r\n                                )}\r\n                                onMouseDown={(e) => {\r\n                                  // Use onMouseDown to prevent blur interaction issues\r\n                                  e.preventDefault();\r\n                                  e.stopPropagation();\r\n                                  setSelectedSchool(school._id === selectedSchool ? \"all\" : school._id)\r\n                                  setOpenSchool(false)\r\n                                  setSearchQuery(\"\")\r\n                                }}\r\n                              >\r\n                                <Check\r\n                                  className={cn(\r\n                                    \"mr-2 h-4 w-4\",\r\n                                    selectedSchool === school._id ? \"opacity-100\" : \"opacity-0\"\r\n                                  )}\r\n                                />\r\n                                {school.nama}\r\n                              </div>\r\n                          ))}\r\n                          \r\n                          {schools.filter(s => s.nama.toLowerCase().includes(searchQuery.toLowerCase())).length === 0 && (\r\n                             <div className=\"py-6 text-center text-sm text-muted-foreground\">\r\n                               Sekolah tidak ditemukan.\r\n                             </div>\r\n                          )}\r\n                        </div>\r\n                      </div>\r\n                    </PopoverContent>\r\n                  </Popover>\r\n                </div>\r\n              )}\r\n          </CardContent>\r\n        </Card>\r\n\r\n        {/* LOADING STATE */}\r\n        {!reportData ? (\r\n          <div className=\"p-8 text-center text-slate-400 no-print\">\r\n            Memuat data laporan...\r\n          </div>\r\n        ) : (\r\n          <>\r\n            {/* STATS CHARTS (Screen Only) */}\r\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 no-print mb-6\">\r\n               <Card>\r\n                 <CardHeader>\r\n                    <CardTitle className=\"text-sm font-bold uppercase text-slate-500\">Status Dokumen</CardTitle>\r\n                 </CardHeader>\r\n                 <CardContent className=\"h-[250px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <PieChart>\r\n                            <Pie\r\n                                data={[\r\n                                    { name: 'Disetujui', value: reportData.summary.approved, fill: COLORS.approved },\r\n                                    { name: 'Menunggu', value: reportData.summary.pending, fill: COLORS.pending },\r\n                                    { name: 'Ditolak', value: reportData.summary.rejected, fill: COLORS.rejected },\r\n                                    { name: 'Draft', value: reportData.summary.draft, fill: COLORS.draft },\r\n                                ].filter(x => x.value > 0)}\r\n                                cx=\"50%\"\r\n                                cy=\"50%\"\r\n                                innerRadius={60}\r\n                                outerRadius={80}\r\n                                paddingAngle={5}\r\n                                dataKey=\"value\"\r\n                                label={({name, percent}) => `${name} (${(percent * 100).toFixed(0)}%)`}\r\n                            >\r\n                                <Cell fill={COLORS.approved} />\r\n                                <Cell fill={COLORS.pending} />\r\n                                <Cell fill={COLORS.rejected} />\r\n                                <Cell fill={COLORS.draft} />\r\n                            </Pie>\r\n                            <Tooltip />\r\n                        </PieChart>\r\n                    </ResponsiveContainer>\r\n                 </CardContent>\r\n               </Card>\r\n\r\n               <Card>\r\n                 <CardHeader>\r\n                    <CardTitle className=\"text-sm font-bold uppercase text-slate-500\">Jenis SK</CardTitle>\r\n                 </CardHeader>\r\n                 <CardContent className=\"h-[250px]\">\r\n                    <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n                        <BarChart\r\n                            layout=\"vertical\"\r\n                            data={[\r\n                                { name: 'GTY', value: reportData.byType?.gty || 0, fill: TYPE_COLORS[0] },\r\n                                { name: 'GTT', value: reportData.byType?.gtt || 0, fill: TYPE_COLORS[1] },\r\n                                { name: 'Kamad', value: reportData.byType?.kamad || 0, fill: TYPE_COLORS[2] },\r\n                                { name: 'Tendik', value: reportData.byType?.tendik || 0, fill: TYPE_COLORS[3] },\r\n                            ]}\r\n                            margin={{ top: 5, right: 30, left: 20, bottom: 5 }}\r\n                        >\r\n                            <CartesianGrid strokeDasharray=\"3 3\" horizontal={true} vertical={false} />\r\n                            <XAxis type=\"number\" hide />\r\n                            <YAxis dataKey=\"name\" type=\"category\" width={80} />\r\n                            <Tooltip cursor={{fill: 'transparent'}} />\r\n                            <Bar dataKey=\"value\" name=\"Jumlah\" radius={[0, 4, 4, 0]}>\r\n                                {\r\n                                    [0,1,2,3].map((entry, index) => (\r\n                                        <Cell key={`cell-${index}`} fill={TYPE_COLORS[index % TYPE_COLORS.length]} />\r\n                                    ))\r\n                                }\r\n                            </Bar>\r\n                        </BarChart>\r\n                    </ResponsiveContainer>\r\n                 </CardContent>\r\n               </Card>\r\n            </div>\r\n\r\n            {/* KEY STATS ROW */}\r\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 no-print mb-6\">\r\n               <Card>\r\n                 <CardContent className=\"p-4 flex flex-col items-center justify-center\">\r\n                    <span className=\"text-3xl font-bold text-slate-800\">{reportData.summary.total}</span>\r\n                    <span className=\"text-xs text-slate-500 uppercase font-bold mt-1\">Total Dokumen</span>\r\n                 </CardContent>\r\n               </Card>\r\n               <Card className=\"bg-green-50/50 border-green-100\">\r\n                 <CardContent className=\"p-4 flex flex-col items-center justify-center\">\r\n                    <span className=\"text-3xl font-bold text-green-600\">{reportData.summary.approved}</span>\r\n                    <span className=\"text-xs text-green-600 uppercase font-bold mt-1\">Disetujui</span>\r\n                 </CardContent>\r\n               </Card>\r\n               <Card className=\"bg-amber-50/50 border-amber-100\">\r\n                 <CardContent className=\"p-4 flex flex-col items-center justify-center\">\r\n                    <span className=\"text-3xl font-bold text-amber-600\">{reportData.summary.pending}</span>\r\n                    <span className=\"text-xs text-amber-600 uppercase font-bold mt-1\">Pending</span>\r\n                 </CardContent>\r\n               </Card>\r\n               <Card className=\"bg-red-50/50 border-red-100\">\r\n                 <CardContent className=\"p-4 flex flex-col items-center justify-center\">\r\n                    <span className=\"text-3xl font-bold text-red-600\">{reportData.summary.rejected}</span>\r\n                    <span className=\"text-xs text-red-600 uppercase font-bold mt-1\">Ditolak</span>\r\n                 </CardContent>\r\n               </Card>\r\n            </div>\r\n\r\n            {/* PRINT HEADER (Visible only on Print) */}\r\n            <div className=\"print-only text-center mb-6\">\r\n                <h2 className=\"text-xl font-bold uppercase\">Laporan Rekapitulasi Surat Keputusan (SK)</h2>\r\n                <h3 className=\"text-lg font-bold uppercase\">LP Ma'arif NU Cilacap</h3>\r\n                <p className=\"text-sm mt-2\">\r\n                    Periode: {startDate ? new Date(startDate).toLocaleDateString('id-ID') : 'Awal'} \r\n                    {' s/d '} \r\n                    {endDate ? new Date(endDate).toLocaleDateString('id-ID') : 'Sekarang'}\r\n                </p>\r\n                <div className=\"border-b-2 border-black mt-4 mb-6\"></div>\r\n            </div>\r\n\r\n            {/* MAIN TABLE (Screen & Print) */}\r\n            <Card className=\"card-print overflow-hidden\">\r\n              <div className=\"overflow-x-auto\">\r\n                <table className=\"w-full text-sm text-left\">\r\n                  <thead className=\"bg-slate-100 text-slate-700 font-semibold border-b\">\r\n                    <tr>\r\n                      <th className=\"p-3 w-12 text-center\">No</th>\r\n                      <th className=\"p-3\">Nomor SK</th>\r\n                      <th className=\"p-3\">Nama Guru / Tendik</th>\r\n                      <th className=\"p-3\">Jenis SK</th>\r\n                      <th className=\"p-3\">Unit Kerja</th>\r\n                      <th className=\"p-3 w-32 text-center\">Status</th>\r\n                      <th className=\"p-3 w-32 text-center\">Tanggal</th>\r\n                    </tr>\r\n                  </thead>\r\n                  <tbody className=\"divide-y\">\r\n                    {reportData.data.length === 0 ? (\r\n                      <tr>\r\n                        <td colSpan={7} className=\"p-8 text-center text-slate-500\">\r\n                           Tidak ada data yang sesuai filter.\r\n                        </td>\r\n                      </tr>\r\n                    ) : (\r\n                      reportData.data.map((row: any, i: number) => (\r\n                        <tr key={row._id} className=\"hover:bg-slate-50\">\r\n                          <td className=\"p-3 text-center\">{i + 1}</td>\r\n                          <td className=\"p-3 font-mono text-xs\">{row.nomorSk || '-'}</td>\r\n                          <td className=\"p-3 font-medium\">{row.nama}</td>\r\n                          <td className=\"p-3\">{row.jenisSk}</td>\r\n                          <td className=\"p-3\">{row.schoolName || '-'}</td>\r\n                          <td className=\"p-3 text-center\">\r\n                            <span className={`\r\n                                px-2 py-0.5 rounded text-xs font-medium border\r\n                                ${row.status === 'approved' ? 'bg-green-100 text-green-700 border-green-200' : ''}\r\n                                ${row.status === 'pending' ? 'bg-amber-100 text-amber-700 border-amber-200' : ''}\r\n                                ${row.status === 'rejected' ? 'bg-red-100 text-red-700 border-red-200' : ''}\r\n                                ${row.status === 'draft' ? 'bg-slate-100 text-slate-700 border-slate-200' : ''}\r\n                            `}>\r\n                              {row.status.toUpperCase()}\r\n                            </span>\r\n                          </td>\r\n                          <td className=\"p-3 text-center text-slate-500\">\r\n                             {new Date(row.createdAt).toLocaleDateString('id-ID')}\r\n                          </td>\r\n                        </tr>\r\n                      ))\r\n                    )}\r\n                  </tbody>\r\n                </table>\r\n              </div>\r\n            </Card>\r\n\r\n            {/* PRINT FOOTER (Visible only on Print) */}\r\n             <div className=\"print-only mt-8 flex justify-end\">\r\n                <div className=\"text-center w-64\">\r\n                    <p>Cilacap, {new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p>\r\n                    <p className=\"mt-2\">Mengetahui,</p>\r\n                    <p>Ketua PC LP Ma'arif NU Cilacap</p>\r\n                    <br/><br/><br/>\r\n                    <p className=\"font-bold underline\">H. Munawar, S.Ag, M.Pd</p>\r\n                </div>\r\n            </div>\r\n\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\schools\\SchoolProfilePage.tsx","messages":[],"suppressedMessages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\schools\\SchoolProfilePage.tsx:35:7\n  33 |     if (school) {\n  34 |       // eslint-disable-next-line\n> 35 |       setFormData({\n     |       ^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  36 |         alamat: school.alamat || \"\",\n  37 |         telepon: school.telepon || \"\",\n  38 |         email: school.email || \"\",","line":35,"column":7,"nodeType":null,"endLine":35,"endColumn":18,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\settings\\SettingsPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'AlertTriangle' is defined but never used.","line":9,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":40},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasTemplate' is assigned a value but never used.","line":15,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":63,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":63,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2099,2102],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2099,2102],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'handleTemplateUpload' is assigned a value but never used.","line":123,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":123,"endColumn":29}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\"\r\n\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { toast } from \"sonner\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\nimport { Save, RefreshCw, AlertTriangle, Building, FileSignature, FileText, CheckCircle, Download } from \"lucide-react\"\r\nimport { useState, useEffect } from \"react\"\r\n\r\nexport default function SettingsPage() {\r\n  const [activeTab, setActiveTab] = useState(\"template\")\r\n  const [isSaving, setIsSaving] = useState(false)\r\n  const [hasTemplate, setHasTemplate] = useState(false)\r\n  \r\n  // Default Settings State\r\n  const [settings, setSettings] = useState({\r\n    // Profil Lembaga\r\n    namaYayasan: \"Lembaga Pendidikan Ma'arif NU Cilacap\",\r\n    alamatYayasan: \"Jl. Masjid No. 09, Cilacap\",\r\n    teleponYayasan: \"0282-123456\",\r\n    \r\n    // SK Settings - Dual Signatories\r\n    signerKetuaName: \"H. Munib\",\r\n    signerKetuaNip: \"\",\r\n    signerSekretarisName: \"H. Makhmud\",\r\n    signerSekretarisNip: \"\",\r\n    skPrefix: \"SK/YP-MACI\"\r\n  })\r\n\r\n  // Load from local storage on mount\r\n  useEffect(() => {\r\n    const saved = localStorage.getItem(\"app_settings\")\r\n    if (saved) {\r\n        try {\r\n            setSettings(prev => ({ ...prev, ...JSON.parse(saved) }))\r\n        } catch (e) { console.error(\"Failed to parse settings\", e) }\r\n    }\r\n    \r\n    // Check if template exists\r\n    if (localStorage.getItem(\"sk_template_blob\")) {\r\n        setHasTemplate(true)\r\n    }\r\n  }, [])\r\n\r\n  const handleChange = (key: string, value: string) => {\r\n    setSettings(prev => ({ ...prev, [key]: value }))\r\n  }\r\n\r\n  const handleSave = () => {\r\n    setIsSaving(true)\r\n    setTimeout(() => {\r\n        localStorage.setItem(\"app_settings\", JSON.stringify(settings))\r\n        setIsSaving(false)\r\n        alert(\"Pengaturan berhasil disimpan!\")\r\n    }, 800)\r\n  }\r\n\r\n\r\n  const handleDownloadBackup = () => {\r\n    try {\r\n        const backupData: Record<string, any> = {}\r\n        // Collect all keys related to the app\r\n        const keysToBackup = [\r\n            \"app_schools\", \r\n            \"app_teachers\", \r\n            \"app_students\", \r\n            \"app_settings\", \r\n            \"sk_submissions\",\r\n            \"sk_template_name\",\r\n            \"sk_template_blob\"\r\n        ]\r\n\r\n        keysToBackup.forEach(key => {\r\n            const val = localStorage.getItem(key)\r\n            if (val) backupData[key] = val\r\n        })\r\n\r\n        const payload = {\r\n            version: \"1.0\",\r\n            timestamp: new Date().toISOString(),\r\n            data: backupData\r\n        }\r\n\r\n        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: \"application/json\" })\r\n        saveAs(blob, `sim_maarif_backup_${new Date().toISOString().slice(0,10)}.json`)\r\n        toast.success(\"Backup berhasil didownload.\")\r\n    } catch (error) {\r\n        console.error(\"Backup failed\", error)\r\n        toast.error(\"Gagal membuat backup.\")\r\n    }\r\n  }\r\n\r\n  const handleRestoreBackup = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      const file = e.target.files?.[0]\r\n      if (!file) return\r\n\r\n      const reader = new FileReader()\r\n      reader.onload = (event) => {\r\n          try {\r\n              const json = JSON.parse(event.target?.result as string)\r\n              if (!json.data || !json.version) {\r\n                  throw new Error(\"Format file backup tidak valid.\")\r\n              }\r\n\r\n              // Restore keys\r\n              Object.keys(json.data).forEach(key => {\r\n                  localStorage.setItem(key, json.data[key])\r\n              })\r\n              \r\n              toast.success(\"Data berhasil dipulihkan! Halaman akan dimuat ulang...\")\r\n              setTimeout(() => window.location.reload(), 1500)\r\n\r\n          } catch (err) {\r\n              console.error(\"Restore failed\", err)\r\n              toast.error(\"Gagal memulihkan data. Pastikan file benar.\")\r\n          }\r\n      }\r\n      reader.readAsText(file)\r\n  }\r\n\r\n  const handleTemplateUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (file) {\r\n        const reader = new FileReader()\r\n        reader.onload = (evt) => {\r\n            const base64 = evt.target?.result as string\r\n            localStorage.setItem(\"sk_template_blob\", base64)\r\n            localStorage.setItem(\"sk_template_name\", file.name)\r\n            setHasTemplate(true)\r\n            alert(\"Template berhasil disimpan!\")\r\n        }\r\n        reader.readAsDataURL(file)\r\n    }\r\n  }\r\n\r\n  const handleResetData = () => {\r\n    if (confirm(\"PERINGATAN: Tindakan ini akan menghapus SEMUA data Guru, Siswa, dan SK yang tersimpan di browser ini. Lanjutkan?\")) {\r\n        localStorage.clear()\r\n        alert(\"System Reset Complete. Refreshing...\")\r\n        window.location.reload()\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Pengaturan Sistem</h1>\r\n            <p className=\"text-muted-foreground\">Konfigurasi profil lembaga, template SK, dan pejabat penandatangan.</p>\r\n        </div>\r\n        <Button onClick={handleSave} disabled={isSaving}>\r\n            {isSaving ? \"Menyimpan...\" : <><Save className=\"mr-2 h-4 w-4\" /> Simpan Perubahan</>}\r\n        </Button>\r\n      </div>\r\n\r\n      <Tabs defaultValue=\"template\" value={activeTab} onValueChange={setActiveTab}>\r\n        <TabsList className=\"grid w-full grid-cols-4 lg:w-[600px]\">\r\n           <TabsTrigger value=\"template\">Template SK</TabsTrigger>\r\n           <TabsTrigger value=\"signer\">Penandatangan</TabsTrigger>\r\n           <TabsTrigger value=\"profil\">Profil Lembaga</TabsTrigger>\r\n           <TabsTrigger value=\"system\">System</TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Template Tab */}\r\n        <TabsContent value=\"template\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\"><FileText className=\"h-5 w-5\"/> Template Generator SK</CardTitle>\r\n                    <CardDescription>Upload file Word (.docx) untuk masing-masing jenis SK.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-6\">\r\n                    <div className=\"grid gap-6 md:grid-cols-2\">\r\n                        {[\r\n                            { id: \"sk_template_gty\", label: \"SK Guru Tetap Yayasan (GTY)\", desc: \"Template untuk GTY\" },\r\n                            { id: \"sk_template_gtt\", label: \"SK Guru Tidak Tetap (GTT)\", desc: \"Template untuk GTT\" },\r\n                            { id: \"sk_template_tendik\", label: \"SK Tenaga Kependidikan\", desc: \"Template untuk Staff/TU\" },\r\n                            { id: \"sk_template_kamad_pns\", label: \"SK Kamad (PNS)\", desc: \"Khusus Kepala Sekolah PNS\" },\r\n                            { id: \"sk_template_kamad_nonpns\", label: \"SK Kamad (Non PNS)\", desc: \"Khusus Kepala Sekolah Non-PNS\" },\r\n                            { id: \"sk_template_kamad_plt\", label: \"SK Kamad (PLT)\", desc: \"Khusus Pelaksana Tugas (PLT)\" },\r\n                        ].map((template) => {\r\n                            const hasFile = !!localStorage.getItem(template.id + \"_blob\")\r\n                            const fileName = localStorage.getItem(template.id + \"_name\") || \"template.docx\"\r\n\r\n                            return (\r\n                                <div key={template.id} className=\"border p-4 rounded-lg bg-slate-50 relative group\">\r\n                                    <div className=\"mb-3\">\r\n                                        <h3 className=\"font-semibold text-sm text-slate-800\">{template.label}</h3>\r\n                                        <p className=\"text-xs text-muted-foreground\">{template.desc}</p>\r\n                                    </div>\r\n                                    \r\n                                    {hasFile ? (\r\n                                        <div className=\"flex items-center gap-3 p-3 bg-white border rounded\">\r\n                                            <div className=\"bg-green-100 p-2 rounded-full text-green-600\">\r\n                                                <CheckCircle className=\"h-4 w-4\" />\r\n                                            </div>\r\n                                            <div className=\"flex-1 min-w-0\">\r\n                                                <p className=\"text-xs font-medium truncate\">{fileName}</p>\r\n                                                <p className=\"text-[10px] text-green-600\">Siap digunakan</p>\r\n                                            </div>\r\n                                            <Button \r\n                                                variant=\"ghost\" \r\n                                                size=\"sm\" \r\n                                                className=\"h-6 w-6 p-0 text-red-500 hover:text-red-700\"\r\n                                                onClick={() => {\r\n                                                    if(confirm(\"Hapus template ini?\")) {\r\n                                                        localStorage.removeItem(template.id + \"_blob\")\r\n                                                        localStorage.removeItem(template.id + \"_name\")\r\n                                                        window.location.reload() // Quick refresh to update UI state\r\n                                                    }\r\n                                                }}\r\n                                            >\r\n                                                x\r\n                                            </Button>\r\n                                        </div>\r\n                                    ) : (\r\n                                        <div className=\"flex items-center justify-center p-4 border-2 border-dashed rounded bg-white hover:bg-slate-50 transition-colors cursor-pointer relative\">\r\n                                            <div className=\"text-center space-y-1\">\r\n                                                <Download className=\"mx-auto h-4 w-4 text-muted-foreground\" />\r\n                                                <span className=\"text-xs text-slate-500 block\">Upload .docx</span>\r\n                                            </div>\r\n                                            <input \r\n                                                type=\"file\" \r\n                                                accept=\".docx\"\r\n                                                className=\"absolute inset-0 opacity-0 cursor-pointer\"\r\n                                                onChange={(e) => {\r\n                                                    const file = e.target.files?.[0]\r\n                                                    if (file) {\r\n                                                        const reader = new FileReader()\r\n                                                        reader.onload = (evt) => {\r\n                                                            const base64 = evt.target?.result as string\r\n                                                            localStorage.setItem(template.id + \"_blob\", base64)\r\n                                                            localStorage.setItem(template.id + \"_name\", file.name)\r\n                                                            alert(`Template ${template.label} berhasil disimpan!`)\r\n                                                            window.location.reload()\r\n                                                        }\r\n                                                        reader.readAsDataURL(file)\r\n                                                    }\r\n                                                }}\r\n                                            />\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )\r\n                        })}\r\n                    </div>\r\n                \r\n                    <div className=\"bg-blue-50 p-4 rounded-md text-xs text-blue-700 space-y-2 border border-blue-100\">\r\n                         <p className=\"font-semibold\">Bantuan Placeholder:</p>\r\n                         <p>Gunakan kode berikut di dalam file Word anda, sistem akan otomatis menggantinya:</p>\r\n                         <div className=\"grid grid-cols-2 gap-2 font-mono\">\r\n                             <span>{`{{NAMA}}`} - Nama Lengkap</span>\r\n                             <span>{`{{NIP}}`} - NIP/PegID</span>\r\n                             <span>{`{{JABATAN}}`} - Jabatan</span>\r\n                             <span>{`{{UNIT_KERJA}}`} - Unit Kerja</span>\r\n                             <span>{`{{STATUS}}`} - Status Kepegawaian</span>\r\n                             <span>{`{{TTL}}`} - Tempat, Tgl Lahir</span>\r\n                             <span>{`{{PENDIDIKAN}}`} - Pendidikan Terakhir</span>\r\n                             <span>{`{{KETUA_NAMA}}`} - Nama Ketua</span>\r\n                             <span>{`{{SEKRETARIS_NAMA}}`} - Nama Sekretaris</span>\r\n                         </div>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </TabsContent>\r\n\r\n        {/* Signer Tab */}\r\n        <TabsContent value=\"signer\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\"><FileSignature className=\"h-5 w-5\"/> Pejabat Penandatangan</CardTitle>\r\n                    <CardDescription>Konfigurasi nama Ketua dan Sekretaris yang akan muncul di SK.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-6\">\r\n                    \r\n                    {/* KETUA */}\r\n                    <div className=\"space-y-3 p-4 border rounded-md bg-slate-50\">\r\n                        <h4 className=\"font-semibold text-sm uppercase tracking-wide text-slate-500\">Pihak 1: Ketua</h4>\r\n                        <div className=\"grid gap-2\">\r\n                            <Label>Nama Lengkap</Label>\r\n                            <Input \r\n                                value={settings.signerKetuaName} \r\n                                onChange={(e) => handleChange(\"signerKetuaName\", e.target.value)} \r\n                            />\r\n                        </div>\r\n                        <div className=\"grid gap-2\">\r\n                            <Label>NIY / NIP (Opsional)</Label>\r\n                            <Input \r\n                                value={settings.signerKetuaNip} \r\n                                onChange={(e) => handleChange(\"signerKetuaNip\", e.target.value)} \r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* SEKRETARIS */}\r\n                    <div className=\"space-y-3 p-4 border rounded-md bg-slate-50\">\r\n                        <h4 className=\"font-semibold text-sm uppercase tracking-wide text-slate-500\">Pihak 2: Sekretaris</h4>\r\n                        <div className=\"grid gap-2\">\r\n                            <Label>Nama Lengkap</Label>\r\n                            <Input \r\n                                value={settings.signerSekretarisName} \r\n                                onChange={(e) => handleChange(\"signerSekretarisName\", e.target.value)} \r\n                            />\r\n                        </div>\r\n                        <div className=\"grid gap-2\">\r\n                            <Label>NIY / NIP (Opsional)</Label>\r\n                            <Input \r\n                                value={settings.signerSekretarisNip} \r\n                                onChange={(e) => handleChange(\"signerSekretarisNip\", e.target.value)} \r\n                            />\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"grid gap-2 pt-4 border-t\">\r\n                         <Label>Prefix Nomor SK</Label>\r\n                         <Input \r\n                            value={settings.skPrefix} \r\n                            onChange={(e) => handleChange(\"skPrefix\", e.target.value)} \r\n                        />\r\n                         <p className=\"text-[10px] text-muted-foreground\">Format nomor: [Auto]/[Prefix]/[Bulan]/[Tahun]</p>\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </TabsContent>\r\n\r\n        {/* Profil Tab */}\r\n        <TabsContent value=\"profil\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"flex items-center gap-2\"><Building className=\"h-5 w-5\"/> Profil Yayasan / Cabang</CardTitle>\r\n                    <CardDescription>Informasi ini digunakan jika template membutuhkan data lembaga dinamis.</CardDescription>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4\">\r\n                    <div className=\"grid gap-2\">\r\n                        <Label>Nama Yayasan / Cabang</Label>\r\n                        <Input \r\n                            value={settings.namaYayasan} \r\n                            onChange={(e) => handleChange(\"namaYayasan\", e.target.value)} \r\n                        />\r\n                    </div>\r\n                    <div className=\"grid gap-2\">\r\n                        <Label>Alamat Lengkap</Label>\r\n                        <Input \r\n                            value={settings.alamatYayasan} \r\n                            onChange={(e) => handleChange(\"alamatYayasan\", e.target.value)} \r\n                        />\r\n                    </div>\r\n                    <div className=\"grid gap-2\">\r\n                        <Label>Telepon / Kontak</Label>\r\n                        <Input \r\n                            value={settings.teleponYayasan} \r\n                            onChange={(e) => handleChange(\"teleponYayasan\", e.target.value)} \r\n                        />\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n        </TabsContent>\r\n\r\n        {/* System Tab */}\r\n        <TabsContent value=\"system\" className=\"space-y-4\">\r\n          <div className=\"grid gap-6\">\r\n              {/* BACKUP SECTION */}\r\n              <div className=\"border rounded-md p-6 bg-blue-50/50 border-blue-100\">\r\n                  <div className=\"flex items-center gap-4 mb-4\">\r\n                      <div className=\"p-2 bg-blue-100 rounded-full text-blue-600\">\r\n                         <Save className=\"w-6 h-6\" />\r\n                      </div>\r\n                      <div>\r\n                          <h3 className=\"font-bold text-lg text-blue-900\">Backup Data Aplikasi</h3>\r\n                          <p className=\"text-sm text-blue-700\">Download seluruh data (Guru, Sekolah, Siswa, Template Settings) ke dalam file JSON untuk keamanan.</p>\r\n                      </div>\r\n                  </div>\r\n                  <Button onClick={handleDownloadBackup} variant=\"outline\" className=\"border-blue-300 text-blue-800 hover:bg-blue-100 w-full sm:w-auto\">\r\n                      <Download className=\"mr-2 h-4 w-4\" /> Download Backup (.json)\r\n                  </Button>\r\n              </div>\r\n\r\n              {/* RESTORE SECTION */}\r\n              <div className=\"border rounded-md p-6 bg-amber-50/50 border-amber-100\">\r\n                  <div className=\"flex items-center gap-4 mb-4\">\r\n                      <div className=\"p-2 bg-amber-100 rounded-full text-amber-600\">\r\n                         <RefreshCw className=\"w-6 h-6\" />\r\n                      </div>\r\n                      <div>\r\n                          <h3 className=\"font-bold text-lg text-amber-900\">Restore / Pulihkan Data</h3>\r\n                          <p className=\"text-sm text-amber-700\">Upload file backup (.json) untuk mengembalikan kondisi data. <span className=\"font-bold\">PERINGATAN: Data saat ini akan ditimpa!</span></p>\r\n                      </div>\r\n                  </div>\r\n                  <div className=\"flex items-center gap-4\">\r\n                      <div className=\"relative\">\r\n                          <Input \r\n                              type=\"file\" \r\n                              accept=\".json\"\r\n                              className=\"w-full max-w-sm bg-white\"\r\n                              onChange={handleRestoreBackup}\r\n                          />\r\n                      </div>\r\n                  </div>\r\n              </div>\r\n\r\n              {/* RESET SECTION */}\r\n              <div className=\"border rounded-md p-6 bg-red-50 border-red-100\">\r\n                 <h3 className=\"font-bold text-red-800 mb-2\">Danger Zone</h3>\r\n                 <p className=\"text-sm text-red-600 mb-4\">Menghapus seluruh data aplikasi dari browser ini. Tidak dapat dibatalkan.</p>\r\n                 <Button variant=\"destructive\" onClick={handleResetData}>\r\n                     Reset Data Aplikasi (Factory Reset)\r\n                 </Button>\r\n              </div>\r\n          </div>\r\n        </TabsContent>\r\n        \r\n      </Tabs>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\HeadmasterSubmissionPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'Command' is defined but never used.","line":23,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":23,"endColumn":10},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandEmpty' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandGroup' is defined but never used.","line":25,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":25,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandInput' is defined but never used.","line":26,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandItem' is defined but never used.","line":27,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CommandList' is defined but never used.","line":28,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":14}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3554,3557],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3554,3557],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":99,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":99,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3580,3583],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3580,3583],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":130,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":130,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4880,4883],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4880,4883],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\nimport { Textarea } from \"@/components/ui/textarea\"\r\nimport { useForm } from \"react-hook-form\"\r\nimport { zodResolver } from \"@hookform/resolvers/zod\"\r\nimport * as z from \"zod\"\r\nimport { ArrowLeft, Save, Check, ChevronsUpDown } from \"lucide-react\"\r\nimport { useNavigate } from \"react-router-dom\"\r\nimport { toast } from \"sonner\"\r\nimport { useState, useMemo } from \"react\"\r\n//  CONVEX for data and mutations\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\nimport { Id } from \"../../../convex/_generated/dataModel\"\r\n// Keep old API for file upload only\r\nimport { api } from \"@/lib/api\"\r\nimport { cn } from \"@/lib/utils\"\r\nimport {\r\n  Command,\r\n  CommandEmpty,\r\n  CommandGroup,\r\n  CommandInput,\r\n  CommandItem,\r\n  CommandList,\r\n} from \"@/components/ui/command\"\r\nimport {\r\n  Popover,\r\n  PopoverContent,\r\n  PopoverTrigger,\r\n} from \"@/components/ui/popover\"\r\n\r\nconst headmasterSchema = z.object({\r\n  teacherId: z.string().min(1, \"Calon Kepala wajib dipilih\"),\r\n  schoolId: z.string().min(1, \"Madrasah Tujuan wajib dipilih\"),\r\n  periode: z.string(), // We'll parse to number\r\n  tmt: z.string().min(1, \"TMT wajib diisi\"),\r\n  keterangan: z.string().optional(),\r\n  \r\n  // --- NEW FIELDS ---\r\n  suratPermohonanNumber: z.string().optional(),\r\n  suratPermohonanDate: z.string().optional(),\r\n  suratPermohonanUrl: z.string().optional(),\r\n})\r\n\r\ntype HeadmasterForm = z.infer<typeof headmasterSchema>\r\n\r\nexport default function HeadmasterSubmissionPage() {\r\n  const navigate = useNavigate()\r\n  const [isSubmitting, setIsSubmitting] = useState(false)\r\n  const [suratFile, setSuratFile] = useState<File | null>(null)\r\n  const [openTeacher, setOpenTeacher] = useState(false)\r\n  const [openSchool, setOpenSchool] = useState(false)\r\n  const [schoolSearch, setSchoolSearch] = useState(\"\") \r\n  const [teacherSearch, setTeacherSearch] = useState(\"\") // Manual teacher search state\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n      if (e.target.files && e.target.files[0]) {\r\n          setSuratFile(e.target.files[0])\r\n      }\r\n  }\r\n\r\n  //  REAL-TIME CONVEX QUERIES\r\n  const convexTeachers = useQuery(convexApi.teachers.list)\r\n  const convexSchools = useQuery(convexApi.schools.list)\r\n  \r\n  // Map to interface with id\r\n  const teachers = useMemo(() => (convexTeachers || []).map(t => ({\r\n    id: t._id,\r\n    nama: t.nama,\r\n    unitKerja: t.unitKerja\r\n  })), [convexTeachers])\r\n  \r\n  const schools = useMemo(() => (convexSchools || []).map(s => ({\r\n    id: s._id,\r\n    nama: s.nama\r\n  })), [convexSchools])\r\n\r\n  const form = useForm<HeadmasterForm>({\r\n    resolver: zodResolver(headmasterSchema),\r\n    defaultValues: {\r\n      periode: \"1\",\r\n    }\r\n  })\r\n  \r\n  //  CONVEX MUTATION\r\n  const createHeadmasterMutation = useMutation(convexApi.headmasters.create)\r\n\r\n  const onSubmit = async (data: HeadmasterForm) => {\r\n    setIsSubmitting(true)\r\n    try {\r\n        let finalUrl = null;\r\n        if (suratFile) {\r\n            toast.info(\"Mengunggah surat permohonan...\")\r\n            const uploadRes = await api.uploadFile(suratFile)\r\n            finalUrl = (uploadRes as any).url || (uploadRes as any).filename\r\n        }\r\n\r\n        // Get userId from localStorage\r\n        const userStr = localStorage.getItem(\"user\")\r\n        const userId = userStr ? JSON.parse(userStr).id : \"temp_user_id\"\r\n        \r\n        // Find teacher and school names for denormalization\r\n        const selectedTeacher = teachers.find(t => t.id === data.teacherId)\r\n        const selectedSchool = schools.find(s => s.id === data.schoolId)\r\n        \r\n        // Calculate end date (4 years from TMT)\r\n        const tmtDate = new Date(data.tmt)\r\n        const endDate = new Date(tmtDate)\r\n        endDate.setFullYear(endDate.getFullYear() + 4)\r\n\r\n        await createHeadmasterMutation({\r\n            teacherId: data.teacherId as Id<\"teachers\">,\r\n            teacherName: selectedTeacher?.nama || \"Unknown\",\r\n            schoolId: data.schoolId as Id<\"schools\">,\r\n            schoolName: selectedSchool?.nama || \"Unknown\",\r\n            periode: parseInt(data.periode),\r\n            startDate: data.tmt,\r\n            endDate: endDate.toISOString().split('T')[0],\r\n            status: \"pending\",\r\n            skUrl: finalUrl || undefined,\r\n            createdBy: userId as Id<\"users\">,\r\n        })\r\n        \r\n        toast.success(\"Pengajuan Kepala Madrasah Berhasil!\")\r\n        navigate(\"/dashboard/sk\")\r\n    } catch (err: any) {\r\n        toast.error(err.message || \"Gagal mengajukan\")\r\n    } finally {\r\n        setIsSubmitting(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-3xl mx-auto space-y-6\">\r\n      <div className=\"flex items-center gap-4\">\r\n          <Button variant=\"ghost\" onClick={() => navigate(\"/dashboard/sk\")} className=\"pl-0\">\r\n            <ArrowLeft className=\"mr-2 h-4 w-4\" /> Kembali\r\n          </Button>\r\n          <h1 className=\"text-2xl font-bold\">Pengajuan SK Kepala Madrasah</h1>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Formulir Masa Jabatan Kepala</CardTitle>\r\n          <CardDescription>\r\n             Mengajukan SK untuk Kepala Madrasah (Maksimal 3 Periode).\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\r\n            \r\n            {/* Teacher Selection (Searchable) */}\r\n             <div className=\"flex flex-col space-y-2\">\r\n              <Label>Pilih Calon Kepala (Dari Data Guru)</Label>\r\n              <Popover open={openTeacher} onOpenChange={setOpenTeacher}>\r\n                <PopoverTrigger asChild>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    role=\"combobox\"\r\n                    aria-expanded={openTeacher}\r\n                    className={cn(\r\n                      \"w-full justify-between\",\r\n                      !form.watch(\"teacherId\") && \"text-muted-foreground\"\r\n                    )}\r\n                  >\r\n                    {form.watch(\"teacherId\")\r\n                      ? teachers.find((teacher) => teacher.id === form.watch(\"teacherId\"))?.nama\r\n                      : \"Pilih Guru...\"}\r\n                    <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                  </Button>\r\n                </PopoverTrigger>\r\n                <PopoverContent className=\"w-[500px] p-0\" align=\"start\">\r\n                  <div className=\"flex flex-col border rounded-md bg-white\">\r\n                    <div className=\"flex items-center border-b px-3\">\r\n                      <Input\r\n                         placeholder=\"Cari nama guru...\"\r\n                         className=\"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-slate-500 disabled:cursor-not-allowed disabled:opacity-50 border-none focus-visible:ring-0 px-0\"\r\n                         value={teacherSearch}\r\n                         onChange={(e) => setTeacherSearch(e.target.value)}\r\n                         autoFocus\r\n                      />\r\n                    </div>\r\n                    <div className=\"max-h-[300px] overflow-y-auto overflow-x-hidden p-1\">\r\n                        {teachers\r\n                           .filter(t => t.nama.toLowerCase().includes(teacherSearch.toLowerCase()))\r\n                           .slice(0, 100)\r\n                           .map((teacher) => (\r\n                          <div\r\n                            key={teacher.id}\r\n                            className={cn(\r\n                              \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-slate-100 hover:text-slate-900 cursor-pointer\",\r\n                              teacher.id === form.watch(\"teacherId\") && \"bg-slate-100\"\r\n                            )}\r\n                            onMouseDown={(e) => {\r\n                               e.preventDefault();\r\n                               e.stopPropagation();\r\n                               form.setValue(\"teacherId\", teacher.id)\r\n                               setOpenTeacher(false)\r\n                               setTeacherSearch(\"\")\r\n                            }}\r\n                          >\r\n                            <Check\r\n                              className={cn(\r\n                                \"mr-2 h-4 w-4\",\r\n                                teacher.id === form.watch(\"teacherId\")\r\n                                  ? \"opacity-100\"\r\n                                  : \"opacity-0\"\r\n                              )}\r\n                            />\r\n                            {teacher.nama} - {teacher.unitKerja}\r\n                          </div>\r\n                        ))}\r\n                        {teachers.filter(t => t.nama.toLowerCase().includes(teacherSearch.toLowerCase())).length === 0 && (\r\n                            <div className=\"py-6 text-center text-sm text-muted-foreground\">Guru tidak ditemukan.</div>\r\n                        )}\r\n                    </div>\r\n                  </div>\r\n                </PopoverContent>\r\n              </Popover>\r\n               {form.formState.errors.teacherId && <p className=\"text-red-500 text-sm\">{form.formState.errors.teacherId.message}</p>}\r\n            </div>\r\n\r\n            {/* School Selection (Searchable) */}\r\n            <div className=\"flex flex-col space-y-2\">\r\n              <Label>Madrasah Tujuan (Tempat Menjabat)</Label>\r\n              <Popover open={openSchool} onOpenChange={setOpenSchool}>\r\n                <PopoverTrigger asChild>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    role=\"combobox\"\r\n                    aria-expanded={openSchool}\r\n                    className={cn(\r\n                      \"w-full justify-between\",\r\n                      !form.watch(\"schoolId\") && \"text-muted-foreground\"\r\n                    )}\r\n                  >\r\n                    {form.watch(\"schoolId\")\r\n                      ? schools.find((school) => school.id === form.watch(\"schoolId\"))?.nama\r\n                      : \"Pilih Madrasah...\"}\r\n                    <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\r\n                  </Button>\r\n                </PopoverTrigger>\r\n                <PopoverContent className=\"w-[500px] p-0\" align=\"start\">\r\n                  <div className=\"flex flex-col border rounded-md bg-white\">\r\n                    <div className=\"flex items-center border-b px-3\">\r\n                      <Input\r\n                         placeholder=\"Cari nama madrasah...\"\r\n                         className=\"flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-slate-500 disabled:cursor-not-allowed disabled:opacity-50 border-none focus-visible:ring-0 px-0\"\r\n                         value={schoolSearch}\r\n                         onChange={(e) => setSchoolSearch(e.target.value)}\r\n                         autoFocus\r\n                      />\r\n                    </div>\r\n                    <div className=\"max-h-[300px] overflow-y-auto overflow-x-hidden p-1\">\r\n                        {schools\r\n                            .filter(s => s.nama.toLowerCase().includes(schoolSearch.toLowerCase()))\r\n                            .slice(0, 100)\r\n                            .map((school) => (\r\n                              <div\r\n                                key={school.id}\r\n                                className={cn(\r\n                                  \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none hover:bg-slate-100 hover:text-slate-900 cursor-pointer\",\r\n                                  school.id === form.watch(\"schoolId\") && \"bg-slate-100\"\r\n                                )}\r\n                                onMouseDown={(e) => {\r\n                                   // Use onMouseDown to prevent blur from firing first\r\n                                   e.preventDefault(); \r\n                                   e.stopPropagation();\r\n                                   form.setValue(\"schoolId\", school.id);\r\n                                   setOpenSchool(false);\r\n                                   setSchoolSearch(\"\"); // Reset search\r\n                                }}\r\n                              >\r\n                                <Check\r\n                                  className={cn(\r\n                                    \"mr-2 h-4 w-4\",\r\n                                    school.id === form.watch(\"schoolId\")\r\n                                      ? \"opacity-100\"\r\n                                      : \"opacity-0\"\r\n                                  )}\r\n                                />\r\n                                {school.nama}\r\n                              </div>\r\n                            ))}\r\n                        {schools.filter(s => s.nama.toLowerCase().includes(schoolSearch.toLowerCase())).length === 0 && (\r\n                             <div className=\"py-6 text-center text-sm text-muted-foreground\">\r\n                               Madrasah tidak ditemukan.\r\n                             </div>\r\n                        )}\r\n                    </div>\r\n                  </div>\r\n                </PopoverContent>\r\n              </Popover>\r\n               {form.formState.errors.schoolId && <p className=\"text-red-500 text-sm\">{form.formState.errors.schoolId.message}</p>}\r\n            </div>\r\n\r\n            <div className=\"grid gap-4 md:grid-cols-2\">\r\n                 <div className=\"grid gap-2\">\r\n                    <Label>Periode Menjabat</Label>\r\n                    <Select onValueChange={(val) => form.setValue(\"periode\", val)} defaultValue=\"1\">\r\n                      <SelectTrigger>\r\n                        <SelectValue placeholder=\"Pilih Periode\" />\r\n                      </SelectTrigger>\r\n                      <SelectContent>\r\n                        <SelectItem value=\"1\">Periode Ke-1 (4 Tahun)</SelectItem>\r\n                        <SelectItem value=\"2\">Periode Ke-2 (4 Tahun)</SelectItem>\r\n                        <SelectItem value=\"3\">Periode Ke-3 (4 Tahun)</SelectItem>\r\n                      </SelectContent>\r\n                    </Select>\r\n                 </div>\r\n                  <div className=\"grid gap-2\">\r\n                    <Label>TMT (Tanggal Mulai Tugas)</Label>\r\n                    <Input type=\"date\" {...form.register(\"tmt\")} />\r\n                    {form.formState.errors.tmt && <p className=\"text-red-500 text-sm\">{form.formState.errors.tmt.message}</p>}\r\n                 </div>\r\n            </div>\r\n\r\n            <div className=\"grid gap-4 md:grid-cols-2\">\r\n                 <div className=\"grid gap-2\">\r\n                    <Label>Nomor Surat Permohonan</Label>\r\n                    <Input placeholder=\"Contoh: 005/MWC/...\" {...form.register(\"suratPermohonanNumber\")} />\r\n                 </div>\r\n                 <div className=\"grid gap-2\">\r\n                    <Label>Tanggal Surat Permohonan</Label>\r\n                    <Input type=\"date\" {...form.register(\"suratPermohonanDate\")} />\r\n                 </div>\r\n            </div>\r\n\r\n            <div className=\"grid gap-2\">\r\n                <Label>Upload Scan Surat Permohonan (PDF/Gambar)</Label>\r\n                <Input type=\"file\" onChange={handleFileChange} accept=\".pdf,.jpg,.jpeg,.png\" />\r\n                <p className=\"text-[10px] text-muted-foreground\">Maksimal 2MB.</p>\r\n            </div>\r\n\r\n            <div className=\"grid gap-2\">\r\n                <Label>Keterangan / Catatan</Label>\r\n                <Textarea placeholder=\"Catatan tambahan...\" {...form.register(\"keterangan\")} />\r\n            </div>\r\n\r\n            <div className=\"flex justify-end gap-2\">\r\n                <Button type=\"button\" variant=\"outline\" onClick={() => navigate(\"/dashboard/sk\")}>Batal</Button>\r\n                <Button type=\"submit\" disabled={isSubmitting}>\r\n                   {isSubmitting ? \"Menyimpan...\" : <><Save className=\"mr-2 h-4 w-4\" /> Simpan Pengajuan</>}\r\n                </Button>\r\n            </div>\r\n          </form>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\MySkPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":18,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[711,714],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[711,714],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":28,"column":18,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":28,"endColumn":21,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[898,901],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[898,901],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":33,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":33,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1024,1027],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1024,1027],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from \"@/components/ui/card\"\r\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\"\r\nimport { Badge } from \"@/components/ui/badge\"\r\nimport { Download, FileText, Search } from \"lucide-react\"\r\nimport { useState, useMemo } from \"react\"\r\nimport { Input } from \"@/components/ui/input\"\r\n//  CONVEX REAL-TIME\r\nimport { useQuery } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\ninterface SkDocument {\r\n  id: string\r\n  nomorSurat?: string\r\n  nama: string\r\n  jabatan: string\r\n  status: string\r\n  [key: string]: any\r\n}\r\n\r\ninterface HeadmasterApproval {\r\n  id: string\r\n  periode: number\r\n  status: string\r\n  skUrl?: string\r\n  teacher?: { nama: string }\r\n  school?: { nama: string }\r\n  [key: string]: any\r\n}\r\n\r\nexport default function MySkPage() {\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [user] = useState<any>(() => {\r\n    try {\r\n        const str = localStorage.getItem(\"user\")\r\n        return str ? JSON.parse(str) : null\r\n    } catch { return null }\r\n  })\r\n\r\n  // Pagination States\r\n  const [currentSkPage, setCurrentSkPage] = useState(1)\r\n  const [currentHmPage, setCurrentHmPage] = useState(1)\r\n  const itemsPerPage = 10\r\n\r\n  //  REAL-TIME CONVEX QUERY for SK - Auto-updates!\r\n  const convexSkData = useQuery(convexApi.sk.list, {\r\n    unitKerja: user?.unitKerja || undefined,\r\n    status: \"active\" // Only show active/approved SK\r\n  })\r\n\r\n  //  REAL-TIME CONVEX QUERY for Headmaster - Auto-updates!\r\n  const convexHeadmasterData = useQuery(convexApi.headmasters.list, {\r\n    schoolName: user?.unitKerja || undefined,\r\n  })\r\n\r\n  // Map Convex SK data to SkDocument interface\r\n  const skList: SkDocument[] = useMemo(() => {\r\n    if (!convexSkData) return []\r\n    \r\n    return convexSkData.map(doc => ({\r\n      id: doc._id,\r\n      nomorSurat: doc.nomorSk,\r\n      nama: doc.nama,\r\n      jabatan: doc.jabatan || \"-\",\r\n      status: doc.status === \"active\" ? \"Approved\" : doc.status,\r\n    }))\r\n  }, [convexSkData])\r\n\r\n  // Map Convex Headmaster data to HeadmasterApproval interface\r\n  const headmasterSkList: HeadmasterApproval[] = useMemo(() => {\r\n    if (!convexHeadmasterData) return []\r\n    \r\n    return convexHeadmasterData.map(hm => ({\r\n      id: hm._id,\r\n      periode: hm.periode,\r\n      status: hm.status === \"approved\" ? \"Approved\" : hm.status,\r\n      skUrl: hm.skUrl,\r\n      teacher: { nama: hm.teacherName },\r\n      school: { nama: hm.schoolName },\r\n    }))\r\n  }, [convexHeadmasterData])\r\n  // Derived state for filtering\r\n  const filteredSk = useMemo(() => {\r\n    if(!searchTerm) return skList\r\n    const lower = searchTerm.toLowerCase()\r\n    return skList.filter(item => \r\n        (item.nama || \"\").toLowerCase().includes(lower) || \r\n        (item.nomorSurat && item.nomorSurat.toLowerCase().includes(lower)) ||\r\n        (item.jabatan || \"\").toLowerCase().includes(lower)\r\n    )\r\n  }, [skList, searchTerm])\r\n\r\n  const handleDownload = (sk: SkDocument) => {\r\n      // Simulation\r\n      alert(`Mendownload SK: ${sk.nomorSurat || 'Draft'} untuk ${sk.nama}`)\r\n  }\r\n\r\n  // Pagination Logic for SK Digital\r\n  const totalSkPages = Math.ceil(filteredSk.length / itemsPerPage)\r\n  const paginatedSk = filteredSk.slice(\r\n      (currentSkPage - 1) * itemsPerPage,\r\n      currentSkPage * itemsPerPage\r\n  )\r\n\r\n  // Pagination Logic for Headmaster SK\r\n  const totalHmPages = Math.ceil(headmasterSkList.length / itemsPerPage)\r\n  const paginatedHm = headmasterSkList.slice(\r\n      (currentHmPage - 1) * itemsPerPage,\r\n      currentHmPage * itemsPerPage\r\n  )\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-2\">\r\n        <h1 className=\"text-2xl font-bold\">Arsip SK Unit Kerja</h1>\r\n        <p className=\"text-muted-foreground\">\r\n           Daftar SK yang diterbitkan untuk: <span className=\"font-semibold text-foreground\">{user?.unitKerja || \"Semua Unit\"}</span>\r\n        </p>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n            <div className=\"flex items-center justify-between\">\r\n                <div>\r\n                    <CardTitle>Daftar SK Digital</CardTitle>\r\n                    <CardDescription>SK yang telah diterbitkan dan ditandatangani secara digital.</CardDescription>\r\n                </div>\r\n                <div className=\"relative w-72\">\r\n                    <Search className=\"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                    <Input \r\n                        placeholder=\"Cari nama atau nomor SK...\" \r\n                        className=\"pl-8\"\r\n                        value={searchTerm}\r\n                        onChange={(e) => setSearchTerm(e.target.value)}\r\n                    />\r\n                </div>\r\n            </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n            <Table>\r\n                <TableHeader>\r\n                    <TableRow>\r\n                        <TableHead>Nomor SK</TableHead>\r\n                        <TableHead>Nama Guru / PTK</TableHead>\r\n                        <TableHead>Jabatan</TableHead>\r\n                        <TableHead>Status</TableHead>\r\n                        <TableHead className=\"text-right\">Aksi</TableHead>\r\n                    </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                    {filteredSk.length === 0 ? (\r\n                        <TableRow>\r\n                            <TableCell colSpan={5} className=\"text-center py-8 text-muted-foreground\">\r\n                                Belum ada SK yang diterbitkan untuk unit ini.\r\n                            </TableCell>\r\n                        </TableRow>\r\n                    ): (\r\n                        paginatedSk.map((sk, i) => (\r\n                            <TableRow key={i}>\r\n                                <TableCell className=\"font-medium\">\r\n                                    <div className=\"flex items-center gap-2\">\r\n                                        <FileText className=\"h-4 w-4 text-blue-500\" />\r\n                                        {sk.nomorSurat || <span className=\"text-muted-foreground italic\">Pending</span>}\r\n                                    </div>\r\n                                </TableCell>\r\n                                <TableCell>{sk.nama}</TableCell>\r\n                                <TableCell>{sk.jabatan}</TableCell>\r\n                                <TableCell>\r\n                                    <Badge variant=\"outline\" className={\r\n                                        sk.status === 'Approved' ? \"bg-green-50 text-green-700 border-green-200\" :\r\n                                        sk.status === 'Rejected' ? \"bg-red-50 text-red-700 border-red-200\" :\r\n                                        \"bg-yellow-50 text-yellow-700 border-yellow-200\"\r\n                                    }>\r\n                                        {sk.status}\r\n                                    </Badge>\r\n                                </TableCell>\r\n                                <TableCell className=\"text-right\">\r\n                                    {sk.status === 'Approved' && (\r\n                                        <Button size=\"sm\" variant=\"outline\" onClick={() => handleDownload(sk)}>\r\n                                            <Download className=\"mr-2 h-3 w-3\" />\r\n                                            Unduh PDF\r\n                                        </Button>\r\n                                    )}\r\n                                </TableCell>\r\n                            </TableRow>\r\n                        ))\r\n                    )}\r\n                </TableBody>\r\n            </Table>\r\n\r\n            {/* Pagination Controls for SK Digital */}\r\n            {filteredSk.length > itemsPerPage && (\r\n              <div className=\"flex items-center justify-end space-x-2 py-4 px-2\">\r\n                <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                  Halaman {currentSkPage} dari {totalSkPages} ({filteredSk.length} data)\r\n                </div>\r\n                <div className=\"space-x-2\">\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setCurrentSkPage(1)}\r\n                    disabled={currentSkPage === 1}\r\n                  >\r\n                    First\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setCurrentSkPage(p => Math.max(1, p - 1))}\r\n                    disabled={currentSkPage === 1}\r\n                  >\r\n                    Prev\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setCurrentSkPage(p => Math.min (totalSkPages, p + 1))}\r\n                    disabled={currentSkPage === totalSkPages}\r\n                  >\r\n                    Next\r\n                  </Button>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setCurrentSkPage(totalSkPages)}\r\n                    disabled={currentSkPage === totalSkPages}\r\n                  >\r\n                    Last\r\n                  </Button>\r\n                </div>\r\n              </div>\r\n            )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* --- SECTION FOR HEADMASTER SK --- */}\r\n      <Card>\r\n        <CardHeader>\r\n             <CardTitle>Riwayat Pengangkatan Kepala Madrasah</CardTitle>\r\n             <CardDescription>Status pengajuan SK Kepala Madrasah.</CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n             <Table>\r\n                <TableHeader>\r\n                    <TableRow>\r\n                        <TableHead>Nama Calon</TableHead>\r\n                        <TableHead>Periode</TableHead>\r\n                        <TableHead>Status</TableHead>\r\n                        <TableHead>SK Final</TableHead>\r\n                    </TableRow>\r\n                </TableHeader>\r\n                <TableBody>\r\n                    {headmasterSkList.length === 0 ? (\r\n                        <TableRow><TableCell colSpan={4} className=\"text-center text-muted-foreground\">Tidak ada data.</TableCell></TableRow>\r\n                    ) : (\r\n                        paginatedHm.map((item) => (\r\n                            <TableRow key={item.id}>\r\n                                <TableCell>\r\n                                    {item.teacher?.nama}\r\n                                    <div className=\"text-xs text-muted-foreground\">{item.school?.nama}</div>\r\n                                </TableCell>\r\n                                <TableCell>Periode Ke-{item.periode}</TableCell>\r\n                                <TableCell>\r\n                                     <Badge variant=\"outline\" className={\r\n                                        item.status === 'Approved' ? \"bg-green-50 text-green-700 border-green-200\" :\r\n                                        \"bg-yellow-50 text-yellow-700 border-yellow-200\"\r\n                                    }>\r\n                                        {item.status}\r\n                                    </Badge>\r\n                                </TableCell>\r\n                                <TableCell>\r\n                                    {item.skUrl ? (\r\n                                        <Button size=\"sm\" variant=\"outline\" className=\"text-blue-600\" onClick={() => window.open(item.skUrl, '_blank')}>\r\n                                            <Download className=\"w-4 h-4 mr-1\" /> Unduh SK\r\n                                        </Button>\r\n                                    ) : item.status === 'Approved' ? (\r\n                                        <span className=\"text-xs text-muted-foreground\">Belum diupload</span>\r\n                                    ) : (\r\n                                        <span className=\"text-xs text-muted-foreground\">-</span>\r\n                                    )}\r\n                                </TableCell>\r\n                            </TableRow>\r\n                        ))\r\n                    )}\r\n                </TableBody>\r\n             </Table>\r\n\r\n             {/* Pagination Controls for Headmaster SK */}\r\n             {headmasterSkList.length > itemsPerPage && (\r\n               <div className=\"flex items-center justify-end space-x-2 py-4 px-2\">\r\n                 <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                   Halaman {currentHmPage} dari {totalHmPages} ({headmasterSkList.length} data)\r\n                 </div>\r\n                 <div className=\"space-x-2\">\r\n                   <Button\r\n                     variant=\"outline\"\r\n                     size=\"sm\"\r\n                     onClick={() => setCurrentHmPage(1)}\r\n                     disabled={currentHmPage === 1}\r\n                   >\r\n                     First\r\n                   </Button>\r\n                   <Button\r\n                     variant=\"outline\"\r\n                     size=\"sm\"\r\n                     onClick={() => setCurrentHmPage(p => Math.max(1, p - 1))}\r\n                     disabled={currentHmPage === 1}\r\n                   >\r\n                     Prev\r\n                   </Button>\r\n                   <Button\r\n                     variant=\"outline\"\r\n                     size=\"sm\"\r\n                     onClick={() => setCurrentHmPage(p => Math.min(totalHmPages, p + 1))}\r\n                     disabled={currentHmPage === totalHmPages}\r\n                   >\r\n                     Next\r\n                   </Button>\r\n                   <Button\r\n                     variant=\"outline\"\r\n                     size=\"sm\"\r\n                     onClick={() => setCurrentHmPage(totalHmPages)}\r\n                     disabled={currentHmPage === totalHmPages}\r\n                   >\r\n                     Last\r\n                   </Button>\r\n                 </div>\r\n               </div>\r\n             )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\SkDashboardPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'createSkMutation' is assigned a value but never used.","line":62,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":62,"endColumn":25},{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\features\\sk-management\\SkDashboardPage.tsx:221:7\n  219 |   // Reset to page 1 when filters change\n  220 |   useEffect(() => {\n> 221 |       setCurrentPage(1)\n      |       ^^^^^^^^^^^^^^ Avoid calling setState() directly within an effect\n  222 |   }, [searchTerm, filterType])\n  223 |\n  224 |   return (","line":221,"column":7,"nodeType":null,"endLine":221,"endColumn":21}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":140,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5566,5569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5566,5569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":171,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6612,6615],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6612,6615],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":206,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":206,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7705,7708],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7705,7708],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":257,"column":102,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":257,"endColumn":105,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9443,9446],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9443,9446],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/* eslint-disable @typescript-eslint/no-explicit-any */\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { FilePlus, Search, Trash2, FileText, CheckSquare, XSquare } from \"lucide-react\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport { useNavigate } from \"react-router-dom\"\r\nimport StatusBadge from \"@/components/shared/StatusBadge\"\r\nimport type { StatusType } from \"@/components/shared/StatusBadge\"\r\nimport { useState, useEffect, useMemo } from \"react\"\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\"\r\n//  CONVEX REAL-TIME\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\nimport { Tabs, TabsList, TabsTrigger } from \"@/components/ui/tabs\"\r\n\r\n// Type definitions (to be moved to types/sk.ts later)\r\ninterface SkSubmission {\r\n  id: string\r\n  nomorSurat: string\r\n  jenisSk: string\r\n  nama: string\r\n  tanggalPengajuan: string\r\n  status: StatusType\r\n  suratPermohonanUrl?: string\r\n  isTeacher?: boolean\r\n}\r\n\r\nexport default function SkDashboardPage() {\r\n  const navigate = useNavigate()\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [filterType, setFilterType] = useState(\"all\")\r\n  const [statusFilter, setStatusFilter] = useState<StatusType | \"all\">(\"draft\") // Default view: Drafts only\r\n  \r\n  //  REAL-TIME CONVEX QUERY\r\n  // 1. Get SK Documents (Approved/Rejected/Issued)\r\n  const skDocuments = useQuery(convexApi.sk.list, {\r\n    jenisSk: filterType === \"all\" ? undefined : filterType,\r\n    status: statusFilter === \"all\" || statusFilter === \"draft\" ? undefined : statusFilter, \r\n    // If \"Draft\", we don't look at SKs (unless legacy). We look at Teachers Queue.\r\n  })\r\n\r\n  // 2. Get Teachers Queue (Candidates for SK) - Only for \"Draft\" tab\r\n  // DEBUG: Removing filter to see ALL teachers\r\n  const teacherQueue = useQuery(convexApi.sk.getTeachersWithSk, { isVerified: false })\r\n\r\n  // Mutations\r\n  const archiveAllSk = useMutation(convexApi.sk.archiveAll)\r\n  const batchUpdateStatusMutation = useMutation(convexApi.sk.batchUpdateStatus)\r\n  const verifyTeacherMutation = useMutation(convexApi.sk.verifyTeacher)\r\n  const rejectTeacherMutation = useMutation(convexApi.sk.rejectTeacher)\r\n  // We need to use valid mutations. create for SK is `create` not `approve`\r\n  const createSkMutation = useMutation(convexApi.sk.create)\r\n  \r\n  // Selection state for batch operations\r\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())\r\n  \r\n  // Combine Data based on Active Tab\r\n  const skData: SkSubmission[] = useMemo(() => {\r\n    // A. If Tab is \"Draft\" (Perlu Diproses), show Teacher Queue\r\n    if (statusFilter === \"draft\") {\r\n        if (!teacherQueue) return []\r\n        return teacherQueue.map(t => ({\r\n            id: t._id,\r\n            nomorSurat: \"-\", // No SK Number yet\r\n            jenisSk: t.status === \"GTY\" ? \"SK Guru Tetap Yayasan\" : t.status === \"GTT\" ? \"SK Guru Tidak Tetap\" : \"SK Tenaga Kependidikan\",\r\n            nama: t.nama,\r\n            tanggalPengajuan: new Date(t.createdAt).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' }),\r\n            status: \"draft\", // Visual status\r\n            suratPermohonanUrl: undefined, // Or check if we can add this to teacher schema later\r\n            isTeacher: true // Flag to identify this is a Teacher record, not SK\r\n        }))\r\n    }\r\n\r\n    // B. If Tab is \"Approved\", \"Rejected\", \"All\" -> Show SK Documents\r\n    if (!skDocuments) return []\r\n    \r\n    return skDocuments.map((item) => ({\r\n      id: item._id,\r\n      nomorSurat: item.nomorSk || \"-\",\r\n      jenisSk: item.jenisSk,\r\n      nama: item.nama,\r\n      tanggalPengajuan: new Date(item.createdAt).toLocaleDateString('id-ID', {\r\n        day: 'numeric', month: 'short', year: 'numeric'\r\n      }),\r\n      status: item.status as StatusType,\r\n      suratPermohonanUrl: item.fileUrl,\r\n      isTeacher: false\r\n    }))\r\n  }, [skDocuments, teacherQueue, statusFilter])\r\n\r\n  const isLoading = statusFilter === \"draft\" ? teacherQueue === undefined : skDocuments === undefined;\r\n\r\n  // Batch selection handlers\r\n  // Filter Logic (moved up)\r\n  const filteredData = useMemo(() => skData.filter(item => {\r\n    const matchesSearch = item.nama.toLowerCase().includes(searchTerm.toLowerCase()) || \r\n                          item.jenisSk.toLowerCase().includes(searchTerm.toLowerCase())\r\n    return matchesSearch\r\n  }), [skData, searchTerm])\r\n\r\n  const handleSelectAll = (checked: boolean) => {\r\n    if (checked) {\r\n      const allIds = new Set(filteredData.map(sk => sk.id))\r\n      setSelectedIds(allIds)\r\n    } else {\r\n      setSelectedIds(new Set())\r\n    }\r\n  }\r\n  \r\n  const handleSelectRow = (id: string, checked: boolean) => {\r\n    const newSelection = new Set(selectedIds)\r\n    if (checked) {\r\n      newSelection.add(id)\r\n    } else {\r\n      newSelection.delete(id)\r\n    }\r\n    setSelectedIds(newSelection)\r\n  }\r\n\r\n  // Batch actions\r\n  const handleBatchApprove = async () => {\r\n    if (selectedIds.size === 0) {\r\n      alert(\"Pilih minimal satu data untuk di-approve\")\r\n      return\r\n    }\r\n    \r\n    if (!confirm(`Approve ${selectedIds.size} data yang dipilih? Data akan masuk ke Generator SK.`)) return\r\n    \r\n    try {\r\n        const ids = Array.from(selectedIds) as any[]\r\n        \r\n        if (statusFilter === \"draft\") {\r\n            // Approve Teachers -> Verify them\r\n             await Promise.all(ids.map(id => verifyTeacherMutation({ id })))\r\n             // Ideally use bulkVerifyTeachers if available\r\n        } else {\r\n            // Approve SKs -> Update status\r\n             await batchUpdateStatusMutation({ ids, status: \"approved\" })\r\n        }\r\n\r\n      setSelectedIds(new Set()) // Clear selection\r\n      alert(` Berhasil meng-approve ${selectedIds.size} data!`)\r\n    } catch (error) {\r\n      console.error(\"Batch approve failed:\", error)\r\n      alert(\"Gagal approve data. Silakan coba lagi.\")\r\n    }\r\n  }\r\n  \r\n  const handleBatchReject = async () => {\r\n    if (selectedIds.size === 0) {\r\n      alert(\"Pilih minimal satu SK untuk di-reject\")\r\n      return\r\n    }\r\n    \r\n    const reason = prompt(\"Alasan penolakan (Wajib diisi):\")\r\n    if (!reason) return \r\n    \r\n    if (!confirm(`Tolak ${selectedIds.size} pengajuan ini?`)) return\r\n    \r\n    try {\r\n      const ids = Array.from(selectedIds) as any[]\r\n      \r\n      if (statusFilter === \"draft\") {\r\n          // Reject Teachers\r\n          await Promise.all(ids.map(id => rejectTeacherMutation({ id, reason })))\r\n      } else {\r\n          // Reject SK Documents\r\n          await batchUpdateStatusMutation({ \r\n            ids, \r\n            status: \"rejected\",\r\n            rejectionReason: reason\r\n          })\r\n      }\r\n\r\n      setSelectedIds(new Set()) \r\n      alert(` Berhasil menolak ${selectedIds.size} data!`)\r\n    } catch (error) {\r\n      console.error(\"Batch reject failed:\", error)\r\n      alert(\"Gagal reject SK. Silakan coba lagi.\")\r\n    }\r\n  }\r\n\r\n\r\n\r\n  // Pagination State\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const itemsPerPage = 10\r\n\r\n  const handleReset = async () => {\r\n    if (!confirm(\" PERINGATAN! \\n\\nApakah anda yakin ingin MENGHAPUS SEMUA riwayat SK?\\nTindakan ini akan mengarsipkan semua SK.\")) return\r\n    \r\n    try {\r\n        const result = await archiveAllSk()\r\n        alert(`Berhasil mengarsipkan ${result.count} dokumen SK.`)\r\n    } catch (e) {\r\n        alert(\"Gagal reset data: \" + (e as any).message)\r\n    }\r\n  }\r\n\r\n\r\n\r\n  // Pagination Logic\r\n  const totalPages = Math.ceil(filteredData.length / itemsPerPage)\r\n  const paginatedData = filteredData.slice(\r\n      (currentPage - 1) * itemsPerPage,\r\n      currentPage * itemsPerPage\r\n  )\r\n\r\n  // Reset to page 1 when filters change\r\n  useEffect(() => {\r\n      setCurrentPage(1)\r\n  }, [searchTerm, filterType])\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between\">\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold tracking-tight\">Manajemen SK (v1.3)</h1>\r\n          <p className=\"text-muted-foreground\">\r\n            Kelola pengajuan dan penerbitan Surat Keputusan.\r\n          </p>\r\n        </div>\r\n        <div className=\"flex items-center\">\r\n            {[\"admin\", \"super_admin\"].includes(JSON.parse(localStorage.getItem(\"user\") || \"{}\")?.role) && (\r\n                <Button variant=\"destructive\" className=\"mr-2\" onClick={handleReset}>\r\n                    <Trash2 className=\"mr-2 h-4 w-4\" />\r\n                    Reset Data\r\n                </Button>\r\n            )}\r\n            <Button onClick={() => navigate(\"/dashboard/sk/new\")}>\r\n            <FilePlus className=\"mr-2 h-4 w-4\" />\r\n            Ajukan SK Baru\r\n            </Button>\r\n        </div>\r\n      </div>\r\n\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Daftar Pengajuan SK</CardTitle>\r\n          <CardDescription>\r\n            Lihat status pengajuan SK Anda di sini.\r\n          </CardDescription>\r\n        </CardHeader>\r\n        <CardContent>\r\n          \r\n          {/* Status Tabs (Inbox Workflow) */}\r\n          <Tabs defaultValue=\"draft\" value={statusFilter} onValueChange={(v) => setStatusFilter(v as any)} className=\"w-full mb-6\">\r\n            <TabsList className=\"grid w-full grid-cols-4 lg:w-[600px]\">\r\n              <TabsTrigger value=\"draft\">\r\n                  Perlu Diproses {teacherQueue ? `(${teacherQueue.length})` : \"\"}\r\n              </TabsTrigger>\r\n              <TabsTrigger value=\"approved\">Disetujui</TabsTrigger>\r\n              <TabsTrigger value=\"rejected\">Ditolak</TabsTrigger>\r\n              <TabsTrigger value=\"all\">Semua Data</TabsTrigger>\r\n            </TabsList>\r\n          </Tabs>\r\n\r\n          {/* Filters */}\r\n          <div className=\"mb-6 flex flex-col gap-4 sm:flex-row\">\r\n            <div className=\"relative flex-1\">\r\n              <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n              <Input\r\n                placeholder=\"Cari nama atau jenis SK...\"\r\n                className=\"pl-9\"\r\n                value={searchTerm}\r\n                onChange={(e) => setSearchTerm(e.target.value)}\r\n              />\r\n            </div>\r\n            <div className=\"w-full sm:w-[200px]\">\r\n                <Select value={filterType} onValueChange={setFilterType}>\r\n                    <SelectTrigger>\r\n                        <SelectValue placeholder=\"Filter Jenis SK\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                        <SelectItem value=\"all\">Semua Jenis</SelectItem>\r\n                        <SelectItem value=\"SK Kepala Madrasah\">SK Kepala Madrasah</SelectItem>\r\n                        <SelectItem value=\"SK Guru Tetap Yayasan\">SK GTY</SelectItem>\r\n                        <SelectItem value=\"SK Guru Tidak Tetap\">SK GTT</SelectItem>\r\n                        <SelectItem value=\"SK Tenaga Kependidikan\">SK Tendik</SelectItem>\r\n                    </SelectContent>\r\n                </Select>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Table */}\r\n          <div className=\"rounded-md border\">\r\n            <Table>\r\n              <TableHeader>\r\n                <TableRow>\r\n                  <TableHead className=\"w-[50px]\">\r\n                    {[\"admin\", \"super_admin\"].includes(JSON.parse(localStorage.getItem(\"user\") || \"{}\")?.role) && (\r\n                        <Checkbox\r\n                        checked={filteredData.length > 0 && selectedIds.size === filteredData.length}\r\n                        onCheckedChange={handleSelectAll}\r\n                        />\r\n                    )}\r\n                  </TableHead>\r\n                  <TableHead>Tanggal</TableHead>\r\n                  <TableHead>Jenis SK</TableHead>\r\n                  <TableHead>Nama Pemohon</TableHead>\r\n                  <TableHead>Nomor Surat</TableHead>\r\n                  <TableHead>Status</TableHead>\r\n                  <TableHead className=\"text-right\">Aksi</TableHead>\r\n                </TableRow>\r\n              </TableHeader>\r\n              <TableBody>\r\n                {isLoading ? (\r\n                     <TableRow>\r\n                        <TableCell colSpan={7} className=\"h-24 text-center text-muted-foreground\">\r\n                            Memuat data...\r\n                        </TableCell>\r\n                    </TableRow>\r\n                ) : filteredData.length === 0 ? (\r\n                    <TableRow>\r\n                        <TableCell colSpan={7} className=\"h-24 text-center\">\r\n                            Tidak ada data ditemukan.\r\n                        </TableCell>\r\n                    </TableRow>\r\n                ) : (\r\n                    paginatedData.map((item) => (\r\n                      <TableRow \r\n                        key={item.id} \r\n                        className=\"hover:bg-muted/50\"\r\n                        data-state={selectedIds.has(item.id) ? \"selected\" : \"\"}\r\n                      >\r\n                        <TableCell>\r\n                          {[\"admin\", \"super_admin\"].includes(JSON.parse(localStorage.getItem(\"user\") || \"{}\")?.role) && (\r\n                              <Checkbox\r\n                                checked={selectedIds.has(item.id)}\r\n                                onCheckedChange={(checked) => handleSelectRow(item.id, !!checked)}\r\n                              />\r\n                          )}\r\n                        </TableCell>\r\n                        <TableCell>{new Date(item.tanggalPengajuan).toLocaleDateString('id-ID')}</TableCell>\r\n                        <TableCell>{item.jenisSk}</TableCell>\r\n                        <TableCell className=\"font-medium\">{item.nama}</TableCell>\r\n                        <TableCell>{item.nomorSurat}</TableCell>\r\n                        <TableCell>\r\n                            <StatusBadge status={item.status} />\r\n                        </TableCell>\r\n                        <TableCell className=\"text-right\">\r\n                            {item.suratPermohonanUrl && (\r\n                                <Button variant=\"ghost\" size=\"sm\" className=\"mr-1 text-blue-600\" onClick={(e) => {\r\n                                    e.stopPropagation();\r\n                                    window.open(item.suratPermohonanUrl, '_blank');\r\n                                }}>\r\n                                    <FileText className=\"w-4 h-4\" />\r\n                                </Button>\r\n                            )}\r\n                            <Button variant=\"ghost\" size=\"sm\" onClick={() => navigate(`/dashboard/sk/${item.id}`)}>\r\n                                <FileText className=\"h-4 w-4 mr-2\" />\r\n                                Detail\r\n                            </Button>\r\n                        </TableCell>\r\n                      </TableRow>\r\n                    ))\r\n                )}\r\n              </TableBody>\r\n            </Table>\r\n          </div>\r\n\r\n          {/* Pagination Controls */}\r\n          {!isLoading && filteredData.length > itemsPerPage && (\r\n            <div className=\"flex items-center justify-end space-x-2 py-4 px-2\">\r\n              <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                Halaman {currentPage} dari {totalPages} ({filteredData.length} data)\r\n              </div>\r\n              <div className=\"space-x-2\">\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(1)}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  First\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(p => Math.max(1, p - 1))}\r\n                  disabled={currentPage === 1}\r\n                >\r\n                  Prev\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  Next\r\n                </Button>\r\n                <Button\r\n                  variant=\"outline\"\r\n                  size=\"sm\"\r\n                  onClick={() => setCurrentPage(totalPages)}\r\n                  disabled={currentPage === totalPages}\r\n                >\r\n                  Last\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Floating Batch Action Bar - ADMIN ONLY */}\r\n      {selectedIds.size > 0 && [\"admin\", \"super_admin\"].includes(JSON.parse(localStorage.getItem(\"user\") || \"{}\")?.role) && (\r\n        <div className=\"fixed bottom-6 left-1/2 -translate-x-1/2 bg-white border shadow-lg rounded-full px-6 py-3 flex items-center gap-4 z-50 animate-in slide-in-from-bottom-5\">\r\n          <span className=\"font-medium\">{selectedIds.size} SK Dipilih</span>\r\n          <Button onClick={handleBatchApprove} size=\"sm\" className=\"bg-green-600 hover:bg-green-700\">\r\n            <CheckSquare className=\"mr-2 h-4 w-4\" />\r\n            Approve Selected\r\n          </Button>\r\n          <Button onClick={handleBatchReject} variant=\"destructive\" size=\"sm\">\r\n            <XSquare className=\"mr-2 h-4 w-4\" />\r\n            Reject Selected\r\n          </Button>\r\n          <Button \r\n            onClick={() => setSelectedIds(new Set())} \r\n            variant=\"ghost\" \r\n            size=\"sm\"\r\n          >\r\n            Batal\r\n          </Button>\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\SkDetailPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":107,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3941,3944],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3941,3944],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { ArrowLeft, CheckCircle, FileText, AlertTriangle, XCircle, Printer } from \"lucide-react\"\r\nimport { useNavigate, useParams } from \"react-router-dom\"\r\nimport StatusBadge from \"@/components/shared/StatusBadge\"\r\nimport type { StatusType } from \"@/components/shared/StatusBadge\"\r\nimport { useState } from \"react\"\r\nimport { Separator } from \"@/components/ui/separator\"\r\n//  CONVEX REAL-TIME\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\nimport { Id } from \"../../../convex/_generated/dataModel\"\r\nimport { toast } from \"sonner\"\r\n\r\ninterface SkDetail {\r\n  id: string\r\n  nomorSurat: string\r\n  jenis: string\r\n  nama: string\r\n  niy: string\r\n  unitKerja: string\r\n  jenisPengajuan: string\r\n  status: string // Raw backend status\r\n  createdAt: string\r\n  fileUrl?: string\r\n  keterangan?: string\r\n}\r\n\r\nexport default function SkDetailPage() {\r\n  const navigate = useNavigate()\r\n  const { id } = useParams()\r\n  \r\n  //  REAL-TIME CONVEX QUERY - Auto-updates!\r\n  const skDoc = useQuery(convexApi.sk.get, \r\n    id ? { id: id as Id<\"skDocuments\"> } : \"skip\"\r\n  )\r\n  \r\n  // Mutations\r\n  const updateSk = useMutation(convexApi.sk.update)\r\n  \r\n  //  CHECK ACTUAL USER ROLE from localStorage\r\n  const [isAdmin] = useState(() => {\r\n    try {\r\n      const userStr = localStorage.getItem(\"user\")\r\n      if (!userStr) return false\r\n      const user = JSON.parse(userStr)\r\n      // super_admin AND admin_yayasan can approve/reject SK\r\n      return [\"super_admin\", \"admin_yayasan\"].includes(user.role)\r\n    } catch {\r\n      return false\r\n    }\r\n  })\r\n  \r\n  // Helper to map Convex status to frontend badge status\r\n  const getBadgeStatus = (backendStatus: string): StatusType => {\r\n      const lower = backendStatus?.toLowerCase() || \"\";\r\n      if (lower === \"pending\" || lower === \"draft\") return \"submitted\";\r\n      if (lower === \"approved\" || lower === \"active\") return \"issued\";\r\n      if (lower === \"rejected\" || lower === \"archived\") return \"rejected\";\r\n      return \"draft\";\r\n  }\r\n\r\n  // Map Convex document to SkDetail interface\r\n  const sk: SkDetail | null = skDoc ? {\r\n    id: skDoc._id,\r\n    nomorSurat: skDoc.nomorSk,\r\n    jenis: skDoc.jenisSk,\r\n    nama: skDoc.nama,\r\n    niy: \"\", // Not in Convex schema, infer from teacher if needed\r\n    unitKerja: skDoc.unitKerja || \"-\",\r\n    jenisPengajuan: skDoc.jenisSk, // Same as jenis\r\n    status: skDoc.status,\r\n    createdAt: new Date(skDoc.createdAt).toISOString(),\r\n    fileUrl: skDoc.fileUrl,\r\n    keterangan: \"\" // Not in schema yet\r\n  } : null\r\n\r\n  const isLoading = skDoc === undefined\r\n\r\n  const handleAction = async (action: \"approve\" | \"reject\" | \"revise\") => {\r\n      console.log(\"[DEBUG] handleAction called with action:\", action, \"| SK id:\", id);\r\n      \r\n      // Confirmation\r\n      const confirmMsg = action === 'approve' ? 'Menyetujui' : action === 'reject' ? 'Menolak' : 'Merevisi';\r\n      const confirmed = window.confirm(`Apakah Anda yakin ingin ${confirmMsg} SK ini?`);\r\n      \r\n      console.log(\"[DEBUG] User confirmed:\", confirmed);\r\n      if(!confirmed) return;\r\n\r\n      try {\r\n          let status = \"\";\r\n          if (action === \"approve\") status = \"active\";\r\n          else if (action === \"reject\") status = \"archived\";\r\n          else if (action === \"revise\") status = \"draft\";\r\n\r\n          console.log(\"[DEBUG] Calling Convex update with id:\", id, \"status:\", status);\r\n          toast.info(`Memproses ${confirmMsg}...`);\r\n          \r\n          await updateSk({ \r\n            id: id as Id<\"skDocuments\">, \r\n            status: status \r\n          });\r\n          \r\n          console.log(\"[DEBUG] Convex update successful\");\r\n          toast.success(`SK Berhasil di-${status}`);\r\n          // No need to re-fetch, Convex auto-updates!\r\n      } catch (e: any) {\r\n          console.error(\"[ERROR] handleAction failed:\", e);\r\n          const errorMessage = e?.message || \"Error tidak diketahui\";\r\n          toast.error(`Gagal memproses tindakan: ${errorMessage}`);\r\n      }\r\n  }\r\n\r\n  if (isLoading) return <div className=\"p-8 text-center text-muted-foreground\">Memuat data SK...</div>\r\n  if (!sk) return <div className=\"p-8 text-center text-muted-foreground\">Data SK tidak ditemukan.</div>\r\n\r\n  const badgeStatus = getBadgeStatus(sk.status);\r\n  const isIssued = badgeStatus === \"issued\";\r\n\r\n  return (\r\n    <div className=\"max-w-4xl space-y-6\">\r\n       <div className=\"flex items-center justify-between\">\r\n            <Button variant=\"ghost\" onClick={() => navigate(\"/dashboard/sk\")} className=\"pl-0\">\r\n                <ArrowLeft className=\"mr-2 h-4 w-4\" /> Kembali\r\n            </Button>\r\n            <div className=\"flex gap-2\">\r\n                 {isIssued && (\r\n                    <Button variant=\"outline\" onClick={() => handleAction(\"revise\")}>\r\n                        <AlertTriangle className=\"mr-2 h-4 w-4 text-orange-500\" /> Ajukan Revisi\r\n                    </Button>\r\n                 )}\r\n                 {sk.fileUrl ? (\r\n                     <Button variant=\"outline\" onClick={() => window.open(sk.fileUrl, '_blank')}>\r\n                        <Printer className=\"mr-2 h-4 w-4\" /> Cetak / Download\r\n                     </Button>\r\n                 ) : (\r\n                     <Button variant=\"outline\" disabled>\r\n                        <FileText className=\"mr-2 h-4 w-4\" /> PDF Belum Tersedia\r\n                     </Button>\r\n                 )}\r\n                 <Button variant=\"outline\" className=\"text-blue-600 border-blue-200 bg-blue-50 hover:bg-blue-100\" onClick={() => navigate(`/dashboard/sk/${id}/print`)}>\r\n                    <Printer className=\"mr-2 h-4 w-4\" /> Cetak Validasi (Baru)\r\n                 </Button>\r\n            </div>\r\n       </div>\r\n\r\n      <div className=\"grid gap-6 md:grid-cols-3\">\r\n        {/* Main Info */}\r\n        <div className=\"md:col-span-2 space-y-6\">\r\n            <Card>\r\n                <CardHeader>\r\n                    <div className=\"flex justify-between items-start\">\r\n                        <div>\r\n                            <CardTitle className=\"text-xl\">{sk.jenis}</CardTitle>\r\n                            <CardDescription>Nomor: {sk.nomorSurat || \"Belum Terbit\"}</CardDescription>\r\n                        </div>\r\n                        <StatusBadge status={badgeStatus} className=\"text-sm px-3 py-1\" />\r\n                    </div>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-6\">\r\n                    <div className=\"grid grid-cols-2 gap-4 text-sm\">\r\n                        <div>\r\n                            <p className=\"text-muted-foreground\">Nama Lengkap</p>\r\n                            <p className=\"font-medium\">{sk.nama}</p>\r\n                        </div>\r\n                         <div>\r\n                            <p className=\"text-muted-foreground\">NIY / NUPTK</p>\r\n                            <p className=\"font-medium\">{sk.niy || \"-\"}</p>\r\n                        </div>\r\n                        <div>\r\n                            <p className=\"text-muted-foreground\">Tanggal Pengajuan</p>\r\n                            <p className=\"font-medium\">\r\n                                {new Date(sk.createdAt).toLocaleDateString('id-ID', {\r\n                                    day: 'numeric', month: 'long', year: 'numeric'\r\n                                })}\r\n                            </p>\r\n                        </div>\r\n                         <div>\r\n                            <p className=\"text-muted-foreground\">Unit Kerja</p>\r\n                            <p className=\"font-medium\">{sk.unitKerja}</p>\r\n                        </div>\r\n                         <div>\r\n                            <p className=\"text-muted-foreground\">Jenis Pengajuan</p>\r\n                            <p className=\"font-medium\">{sk.jenisPengajuan}</p>\r\n                        </div>\r\n                         <div className=\"col-span-2\">\r\n                            <p className=\"text-muted-foreground\">Keterangan / Pesan</p>\r\n                            <p className=\"font-medium text-slate-700 bg-slate-50 p-2 rounded block mt-1\">\r\n                                {sk.keterangan || \"-\"}\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                    \r\n                    <Separator />\r\n\r\n                    <div>\r\n                        <h4 className=\"mb-2 font-semibold\">Preview SK</h4>\r\n                        {sk.fileUrl && (sk.fileUrl.startsWith('http') || sk.fileUrl.startsWith('/')) ? (\r\n                             <div className=\"rounded-md border p-0 overflow-hidden bg-slate-100 h-[600px]\">\r\n                                <iframe \r\n                                    src={sk.fileUrl} \r\n                                    className=\"w-full h-full\" \r\n                                    title=\"Preview SK\"\r\n                                />\r\n                             </div>\r\n                        ) : sk.fileUrl ? (\r\n                             <div className=\"rounded-md border border-dashed p-8 text-center text-muted-foreground bg-slate-50\">\r\n                                <FileText className=\"mx-auto h-8 w-8 mb-2 opacity-50\" />\r\n                                <p>Preview tidak tersedia.</p>\r\n                                <p className=\"text-sm font-medium mt-1\">{sk.fileUrl}</p> \r\n                                <p className=\"text-xs mt-1 text-slate-500\">File SK ini digenerate secara massal (ZIP). Silakan cek file yang sudah didownload.</p>\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"rounded-md border border-dashed p-8 text-center text-muted-foreground bg-slate-50\">\r\n                                <FileText className=\"mx-auto h-8 w-8 mb-2 opacity-50\" />\r\n                                <p>File SK belum digenerate.</p>\r\n                                <p className=\"text-xs mt-1\">Silakan minta Admin untuk memproses.</p>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Admin Actions Area */}\r\n            {isAdmin && badgeStatus === \"submitted\" && (\r\n                 <Card className=\"border-blue-200 bg-blue-50/50\">\r\n                    <CardHeader>\r\n                        <CardTitle className=\"text-lg text-blue-800\">Tindakan Admin</CardTitle>\r\n                        <CardDescription className=\"text-blue-600\">\r\n                            Silakan periksa data sebelum memberikan persetujuan.\r\n                        </CardDescription>\r\n                    </CardHeader>\r\n                     <CardContent className=\"flex gap-3\">\r\n                        <Button className=\"bg-green-600 hover:bg-green-700 flex-1\" onClick={() => handleAction(\"approve\")}>\r\n                            <CheckCircle className=\"mr-2 h-4 w-4\" /> Setujui\r\n                        </Button>\r\n                        <Button variant=\"destructive\" className=\"flex-1\" onClick={() => handleAction(\"reject\")}>\r\n                            <XCircle className=\"mr-2 h-4 w-4\" /> Tolak\r\n                        </Button>\r\n                     </CardContent>\r\n                 </Card>\r\n            )}\r\n        </div>\r\n\r\n        {/* Sidebar Info */}\r\n        <div className=\"space-y-6\">\r\n             <Card>\r\n                <CardHeader>\r\n                    <CardTitle className=\"text-base\">Metadata</CardTitle>\r\n                </CardHeader>\r\n                <CardContent className=\"space-y-4 text-sm\">\r\n                    <div>\r\n                        <span className=\"text-muted-foreground block text-xs uppercase tracking-wider\">ID Sistem</span>\r\n                        <span className=\"font-mono text-xs text-slate-600 truncate block bg-slate-100 p-1 rounded\">{sk.id}</span>\r\n                    </div>\r\n                    <div>\r\n                        <span className=\"text-muted-foreground block text-xs uppercase tracking-wider\">Status Database</span>\r\n                        <span className=\"font-mono text-xs\">{sk.status}</span>\r\n                    </div>\r\n                    <Separator />\r\n                    <div className=\"pt-2\">\r\n                        <p className=\"text-xs text-muted-foreground text-center\">\r\n                            Jika data salah, silakan hubungi Administrator PUSAT.\r\n                        </p>\r\n                    </div>\r\n                </CardContent>\r\n             </Card>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\SkGeneratorPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'CardDescription' is defined but never used.","line":2,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'e' is defined but never used.","line":77,"column":14,"nodeType":null,"messageId":"unusedVar","endLine":77,"endColumn":15},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":84,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2903,2906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2903,2906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":86,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":86,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2962,2965],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2962,2965],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":101,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":101,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3493,3496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3493,3496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'tagName' is defined but never used.","line":158,"column":55,"nodeType":null,"messageId":"unusedVar","endLine":158,"endColumn":62},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":161,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":161,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6169,6172],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6169,6172],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'part' is defined but never used.","line":174,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":174,"endColumn":34},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":196,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":196,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7484,7487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7484,7487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":235,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":235,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8901,8904],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8901,8904],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'deleteTeacher' is assigned a value but never used.","line":259,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":259,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'startDateStr' is defined but never used.","line":299,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":299,"endColumn":46},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":319,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":319,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12381,12384],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12381,12384],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":335,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":335,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13078,13081],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13078,13081],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\{.","line":428,"column":82,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":428,"endColumn":83,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15995,15996],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15995,15995],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\}.","line":428,"column":84,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":428,"endColumn":85,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15997,15998],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15997,15997],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":490,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":490,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18967,18970],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18967,18970],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":499,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":499,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19160,19163],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19160,19163],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":552,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":552,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[21442,21445],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[21442,21445],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":575,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":575,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[22322,22323],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[22322,22322],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":575,"column":46,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":575,"endColumn":47,"suggestions":[{"messageId":"removeEscape","fix":{"range":[22326,22327],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[22326,22326],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":575,"column":59,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":575,"endColumn":60,"suggestions":[{"messageId":"removeEscape","fix":{"range":[22339,22340],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[22339,22339],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":575,"column":63,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":575,"endColumn":64,"suggestions":[{"messageId":"removeEscape","fix":{"range":[22343,22344],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[22343,22343],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":591,"column":40,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":591,"endColumn":41,"suggestions":[{"messageId":"removeEscape","fix":{"range":[23247,23248],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[23247,23247],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'tanggalHabisBerlaku' is assigned a value but never used.","line":698,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":698,"endColumn":32},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":705,"column":61,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":705,"endColumn":64,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28366,28369],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28366,28369],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":705,"column":107,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":705,"endColumn":110,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[28412,28415],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[28412,28415],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":737,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":737,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29766,29769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29766,29769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":742,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":742,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30015,30018],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30015,30018],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":743,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":743,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[30073,30076],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[30073,30076],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":802,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":802,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32553,32556],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32553,32556],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":816,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":816,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33082,33085],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33082,33085],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":819,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":819,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33176,33179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33176,33179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":820,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":820,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[33251,33254],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[33251,33254],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":862,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":862,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35110,35113],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35110,35113],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":872,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":872,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35441,35444],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35441,35444],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":883,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":883,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[35998,36001],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[35998,36001],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":884,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":884,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36065,36068],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36065,36068],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":891,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":891,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36323,36326],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36323,36326],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'successCount' is assigned a value but never used.","line":893,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":893,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":895,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":895,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[36407,36410],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[36407,36410],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":921,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":921,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[37499,37502],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[37499,37502],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":1170,"column":78,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":1170,"endColumn":81,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[52392,52395],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[52392,52395],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":43,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { FileDown, Loader2, Search, Archive, BadgeCheck, Settings, CheckCircle, RotateCcw, Trash2 } from \"lucide-react\"\r\nimport { useState, useEffect } from \"react\"\r\n// Removed: import { saveAs } from \"file-saver\" - using native browser download instead\r\nimport JSZip from \"jszip\"\r\nimport PizZip from \"pizzip\"\r\nimport Docxtemplater from \"docxtemplater\"\r\nimport { Link } from \"react-router-dom\"\r\nimport ImageModule from \"docxtemplater-image-module-free\"\r\nimport QRCode from \"qrcode\"\r\n\r\n// Helper: Convert Base64 DataURL to ArrayBuffer (Required by ImageModule)\r\nfunction base64DataURLToArrayBuffer(dataURL: string) {\r\n  const base64Regex = /^data:image\\/(png|jpg|svg|svg\\+xml);base64,/;\r\n  if (!base64Regex.test(dataURL)) {\r\n    return false;\r\n  }\r\n  const stringBase64 = dataURL.replace(base64Regex, \"\");\r\n  let binaryString;\r\n  if (typeof window !== \"undefined\") {\r\n    binaryString = window.atob(stringBase64);\r\n  } else {\r\n    binaryString = new Buffer(stringBase64, \"base64\").toString(\"binary\");\r\n  }\r\n  const len = binaryString.length;\r\n  const bytes = new Uint8Array(len);\r\n  for (let i = 0; i < len; i++) {\r\n    const ascii = binaryString.charCodeAt(i);\r\n    bytes[i] = ascii;\r\n  }\r\n  return bytes.buffer;\r\n}\r\n\r\n// Helper to load base64 template to binary string\r\nconst loadTemplate = (key: string): string | null => {\r\n    const base64 = localStorage.getItem(key + \"_blob\")\r\n    if (!base64) return null\r\n    // Remove data:application/vnd.openxmlformats-officedocument.wordprocessingml.document;base64,\r\n    const block = base64.split(\";base64,\");\r\n    const realData = block[1] ? block[1] : Base64String(base64) ? base64 : null; // simplified\r\n    if (!realData) return null\r\n    return atob(realData)\r\n}\r\n\r\n// Simple Base64 check\r\nconst Base64String = (str: string) => {\r\n    try {\r\n        return btoa(atob(str)) === str;\r\n    } catch {\r\n        return false;\r\n    }\r\n}\r\n\r\n// Helper: Add 1 year to Indonesian Date String (e.g., \"16 Juli 2024\" -> \"16 Juli 2025\")\r\nconst addOneYearIndonesian = (dateStr: string) => {\r\n    if (!dateStr || dateStr === \"-\") return \"-\"\r\n    try {\r\n        const parts = dateStr.split(\" \")\r\n        if (parts.length < 3) return dateStr // Safety check\r\n        const year = parseInt(parts[parts.length - 1])\r\n        if (isNaN(year)) return dateStr\r\n        \r\n        // Replace year with year + 1\r\n        parts[parts.length - 1] = (year + 1).toString()\r\n        return parts.join(\" \")\r\n    } catch (e) {\r\n        return dateStr\r\n    }\r\n}\r\n\r\n\r\nconst generateBulkSkZip = async (\r\n  candidates: any[],\r\n  filename = \"SK_Masal_Maarif.zip\",\r\n  debugData?: any // Added for debugging\r\n) => {\r\n    const zip = new JSZip()\r\n    const folder = zip.folder(\"SK_Generated\")\r\n    \r\n    // Add Debug File\r\n    if (debugData) {\r\n        folder?.file(\"DEBUG_DATA_MAPPING.json\", JSON.stringify(debugData, null, 2))\r\n    }\r\n    \r\n    // Cache templates to avoid repeated localStorage reads/decodes\r\n    const templateCache: Record<string, string | null> = {}\r\n    \r\n    // Mapping Jenis SK to Template ID\r\n    // Updated to accept full data object for complex logic\r\n    const getTemplateId = (data: any) => {\r\n        const jenis = (data.jenisSk || data.status || \"\").toLowerCase()\r\n        const jabatan = (data.jabatan || \"\").toLowerCase()\r\n        // const status = (data.statusKepegawaian || \"\").toLowerCase() // not reliable if undefined\r\n        const nip = (data.nip || \"\").replace(/[^0-9]/g, \"\")\r\n\r\n        if (jenis.includes(\"tetap yayasan\") || jenis.includes(\"gty\")) return \"sk_template_gty\"\r\n        if (jenis.includes(\"tidak tetap\") || jenis.includes(\"gtt\")) return \"sk_template_gtt\"\r\n        \r\n        // Complex Kamad Logic\r\n        if (jenis.includes(\"kepala\") || jenis.includes(\"kamad\")) {\r\n             if (jabatan.includes(\"plt\") || jabatan.includes(\"pelaksana\")) {\r\n                 return \"sk_template_kamad_plt\"\r\n             }\r\n             // PNS Check: Valid NIP usually means PNS. \r\n             // Also check statusKepegawaian if available, but NIP > 10 digits is strong signal\r\n             const isPns = nip.length > 10 || (data.statusKepegawaian || \"\").includes(\"PNS\") || (data.statusKepegawaian || \"\").includes(\"ASN\")\r\n             \r\n             if (isPns) return \"sk_template_kamad_pns\"\r\n             return \"sk_template_kamad_nonpns\"\r\n        }\r\n        \r\n        return \"sk_template_tendik\" // Default to Tendik\r\n    }\r\n\r\n    let successCount = 0;\r\n    const errors: string[] = []\r\n\r\n    for (const data of candidates) {\r\n        try {\r\n            const templateId = getTemplateId(data)\r\n            \r\n            if (templateCache[templateId] === undefined) {\r\n                templateCache[templateId] = loadTemplate(templateId)\r\n            }\r\n\r\n            const content = templateCache[templateId]\r\n            if (!content) {\r\n                errors.push(`Template tidak ditemukan untuk ${data.nama} (ID: ${templateId}). Upload di Settings.`)\r\n                continue\r\n            }\r\n\r\n            // QR Code Generation\r\n            let qrDataUrl = \"\";\r\n            try {\r\n                // Use _id for verification URL, fallback to nomorSk if needed\r\n                const docId = data._id || data.nomorSk || \"INVALID\";\r\n                const verificationUrl = `${window.location.origin}/verify/${docId}`;\r\n                qrDataUrl = await QRCode.toDataURL(verificationUrl, { width: 400, margin: 1 });\r\n            } catch (err) {\r\n                console.error(\"QR Generated Failed\", err);\r\n            }\r\n\r\n            const pzip = new PizZip(content);\r\n\r\n            // Configure Image Module\r\n            const imageOpts = {\r\n                getImage: function (tagValue: string, tagName: string) {\r\n                    return base64DataURLToArrayBuffer(tagValue);\r\n                },\r\n                getSize: function (img: any, tagValue: string, tagName: string) {\r\n                    // Force 100x100px for QR Codes\r\n                    if (tagName === \"qrcode\") return [100, 100];\r\n                    return [100, 100];\r\n                },\r\n            };\r\n            const imageModule = new ImageModule(imageOpts);\r\n\r\n            const doc = new Docxtemplater(pzip, {\r\n                paragraphLoop: true,\r\n                linebreaks: true,\r\n                modules: [imageModule],\r\n                // Fix: Return empty string instead of \"undefined\" text\r\n                nullGetter: (part) => {\r\n                     // console.warn(\"Missing tag:\", part.value) \r\n                     return \"\" \r\n                }\r\n            });\r\n\r\n            // Render with QR Code\r\n            doc.render({\r\n                ...data,\r\n                qrcode: qrDataUrl // {%qrcode} tag in Docx\r\n            });\r\n\r\n            const out = doc.getZip().generate({\r\n                type: \"uint8array\",\r\n                mimeType: \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\r\n            });\r\n\r\n            \r\n            const safeName = (data.nama || \"document\").replace(/[^a-z0-9]/gi, '_').substring(0, 50)\r\n            folder?.file(`${safeName}_SK.docx`, out)\r\n            successCount++\r\n\r\n        } catch (error: any) {\r\n            console.error(\"Gen Error\", error)\r\n            errors.push(`Gagal generate untuk ${data.nama}: ${error.message}`)\r\n        }\r\n    }\r\n\r\n    if (errors.length > 0) {\r\n        folder?.file(\"ERRORS_REPORT.txt\", errors.join(\"\\n\"))\r\n    }\r\n    \r\n    \r\n    if (successCount === 0 && errors.length > 0) {\r\n        alert(`Gagal Generate SK!\\n\\n${errors[0]}\\n\\n(Cek file ERRORS_REPORT.txt di dalam ZIP untuk detail lengkap)`)\r\n    }\r\n\r\n    // CRITICAL FIX: Wrap ZIP generation in try-catch\r\n    try {\r\n        const content = await zip.generateAsync({ type: \"blob\" })\r\n        \r\n        // FIXED: Use native browser download with Chrome compatibility\r\n        const url = URL.createObjectURL(content)\r\n        const link = document.createElement('a')\r\n        link.href = url\r\n        link.download = filename\r\n        link.type = 'application/zip' // Chrome needs explicit type\r\n        link.rel = 'noopener' // Security best practice\r\n        link.style.display = 'none'\r\n        document.body.appendChild(link)\r\n        \r\n        // Force click for download\r\n        link.click()\r\n        \r\n        // Cleanup after download triggered (increased delay for Chrome)\r\n        setTimeout(() => {\r\n            document.body.removeChild(link)\r\n            URL.revokeObjectURL(url)\r\n        }, 250)\r\n        \r\n        console.log(` ZIP saved: ${filename}, Size: ${content.size} bytes`)\r\n    } catch (zipError: any) {\r\n        console.error(\" CRITICAL: ZIP Generation Failed!\", zipError)\r\n        alert(`CRITICAL ERROR: Gagal membuat file ZIP!\\n\\nError: ${zipError.message}\\n\\nSilakan cek console untuk detail.`)\r\n        throw zipError // Re-throw to prevent false success\r\n    }\r\n    \r\n    return { successCount, errorCount: errors.length }\r\n}\r\n\r\n//  CONVEX REAL-TIME\r\nimport { useQuery, useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../convex/_generated/api\"\r\n\r\nexport default function SkGeneratorPage() {\r\n  // Use Convex query to get teachers\r\n  \r\n  //  ONLY SHOW TEACHERS WHO HAVE SUBMITTED SK\r\n  // Teachers from master data import won't appear here\r\n  // Only teachers who submitted SK via submission form will show\r\n  const teachersData = useQuery(convexApi.sk.getTeachersWithSk, { isVerified: true }) || []\r\n  \r\n  // MUTATIONS\r\n  // MUTATIONS\r\n  const createSk = useMutation(convexApi.sk.create)\r\n  const deleteTeacher = useMutation(convexApi.sk.deleteTeacher)\r\n  const deleteAllTeachers = useMutation(convexApi.sk.deleteAllTeachers)\r\n  // FIXED: Point to the correct new mutation\r\n  const deleteAllSkHistory = useMutation(convexApi.sk.deleteAllSk) \r\n  const markAsGenerated = useMutation(convexApi.sk.markTeacherAsGenerated) \r\n  \r\n  // STATES\r\n  const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())\r\n  const [hasStoredTemplate, setHasStoredTemplate] = useState(false)\r\n  const [isLoading, setIsLoading] = useState(false)\r\n  const [isGenerating, setIsGenerating] = useState(false)\r\n  const [searchTerm, setSearchTerm] = useState(\"\")\r\n  const [currentPage, setCurrentPage] = useState(1)\r\n  const itemsPerPage = 10\r\n\r\n  const [nomorMulai, setNomorMulai] = useState(\"0001\")\r\n  const [nomorFormat, setNomorFormat] = useState(\"{NOMOR}/PC.L/A.II/H-34.B/24.29/{TANGGAL}/{BULAN}/{TAHUN}\")\r\n  \r\n  // New States for Surat Masuk & Validity\r\n  const [nomorSuratMasuk, setNomorSuratMasuk] = useState(\"\")\r\n  const [tanggalSuratMasuk, setTanggalSuratMasuk] = useState(\"\")\r\n  const [tahunAjaran, setTahunAjaran] = useState(() => {\r\n    const now = new Date()\r\n    const currentYear = now.getFullYear()\r\n    const currentMonth = now.getMonth() // 0 = Jan, 6 = July\r\n    \r\n    // If Month is July (6) or later -> 2025/2026\r\n    // If Month is before July -> 2024/2025\r\n    if (currentMonth >= 6) { \r\n        return `${currentYear}/${currentYear + 1}`\r\n    } else {\r\n        return `${currentYear - 1}/${currentYear}`\r\n    }\r\n  })\r\n  \r\n  const [tanggalPenetapan, setTanggalPenetapan] = useState(\"\")\r\n  // New: Global Kecamatan Fallback\r\n  const [defaultKecamatan, setDefaultKecamatan] = useState(\"\") \r\n\r\n  // Helper function to calculate +1 Year\r\n  const calculateValidityDate = (startDateStr: string): string => {\r\n      // Check if Date is valid?\r\n      // Simple implementation\r\n      return \"-\"\r\n  }\r\n  \r\n  // ... (Lines 249-876 skipped) ...\r\n\r\n  const handleReset = async () => {\r\n    if (!confirm(\" PERINGATAN KERAS!\\n\\nApakah anda yakin ingin MENGHAPUS SEMUA DATA GURU?\\nTindakan ini tidak dapat dibatalkan.\")) return\r\n    \r\n    // Double confirmation\r\n    if(!confirm(\"Yakin? Data akan hilang selamanya.\")) return\r\n\r\n    setIsLoading(true)\r\n    try {\r\n        await deleteAllTeachers()\r\n        await deleteAllSkHistory() // Also wipe SK History to prevent duplicates\r\n        setNomorMulai(\"0001\") // Reset Counter\r\n        alert(\"Semua data guru antrean DAN riwayat SK berhasil dihapus.\\nNomor Surat kembali ke 0001.\")\r\n    } catch (e: any) {\r\n        console.error(e)\r\n        alert(\"Gagal menghapus data: \" + e.message)\r\n    } finally {\r\n        setIsLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleResetSkHistoryOnly = async () => {\r\n    if (!confirm(\" KONFIRMASI PENTING \\n\\nApakah anda yakin ingin menghapus HANYA RIWAYAT SK?\\n\\n- Data guru antrean TETAP ADA.\\n- Nomor SK yang sudah terbentuk akan DIHAPUS.\\n- Anda bisa generate ulang dari awal.\\n\\nLanjutkan?\")) return\r\n    \r\n    setIsLoading(true)\r\n    try {\r\n        const res = await deleteAllSkHistory()\r\n        setNomorMulai(\"0001\") // Reset Counter\r\n        alert(` Berhasil menghapus ${res.count} Riwayat SK.\\nData Guru aman.\\nSilakan generate ulang.`)\r\n    } catch (e: any) {\r\n        console.error(e)\r\n        alert(\"Gagal menghapus riwayat SK: \" + e.message)\r\n    } finally {\r\n        setIsLoading(false)\r\n    }\r\n  }\r\n\r\n\r\n  \r\n  // Teachers loaded via Convex useQuery (real-time, no need for manual fetch)\r\n  useEffect(() => {\r\n    // 2. Check for ANY stored template\r\n\r\n    if (\r\n        localStorage.getItem(\"sk_template_gty_blob\") || \r\n        localStorage.getItem(\"sk_template_gtt_blob\") || \r\n        localStorage.getItem(\"sk_template_kamad_blob\") || \r\n        localStorage.getItem(\"sk_template_tendik_blob\")\r\n    ) {\r\n        setHasStoredTemplate(true)\r\n    }\r\n  }, [])\r\n\r\n  // Filter logic\r\n  const filteredTeachers = teachersData.filter(t => \r\n    // Only show active teachers\r\n    (t.isActive !== false) &&\r\n    ((t.nama?.toLowerCase() || \"\").includes(searchTerm.toLowerCase()) || \r\n    (t.unitKerja?.toLowerCase() || \"\").includes(searchTerm.toLowerCase()))\r\n  )\r\n\r\n  // Pagination Logic\r\n  const totalPages = Math.ceil(filteredTeachers.length / itemsPerPage)\r\n  const startIndex = (currentPage - 1) * itemsPerPage\r\n  const currentData = filteredTeachers.slice(startIndex, startIndex + itemsPerPage)\r\n\r\n  // Selection Logic\r\n  const handleSelectAllForPage = (checked: boolean) => {\r\n    const next = new Set(selectedIds)\r\n    currentData.forEach(t => {\r\n        if (checked) next.add(t._id)\r\n        else next.delete(t._id)\r\n    })\r\n    setSelectedIds(next)\r\n  }\r\n\r\n  \r\n\r\n  const [isSuperAdmin, setIsSuperAdmin] = useState(false)\r\n  useEffect(() => {\r\n        const u = localStorage.getItem(\"user\")\r\n        if (u) {\r\n            const user = JSON.parse(u)\r\n            setIsSuperAdmin(user.role === \"super_admin\")\r\n        }\r\n  }, [])\r\n  \r\n  const handleBulkSign = () => {\r\n      // Stub for future bulk sign action\r\n      alert(`Menandatangani ${selectedIds.size} SK secara digital (Simulasi)...`)\r\n  }\r\n\r\n  const handleSelectOne = (id: string, checked: boolean) => {\r\n    const next = new Set(selectedIds)\r\n    if (checked) {\r\n      next.add(id)\r\n    } else {\r\n      next.delete(id)\r\n    }\r\n    setSelectedIds(next)\r\n  }\r\n\r\n\r\n\r\n  // --- SMART LOGIC: Template Inspector & Validator ---\r\n  const inspectTemplate = () => {\r\n      const templateId = \"sk_template_gty\" \r\n      const content = loadTemplate(templateId) || loadTemplate(\"sk_template_tendik\")\r\n      \r\n      if (!content) {\r\n          alert(\"Tidak ada template yang tersimpan. Upload dulu!\")\r\n          return\r\n      }\r\n\r\n      try {\r\n          const zip = new PizZip(content)\r\n          const doc = new Docxtemplater(zip, { paragraphLoop: true, linebreaks: true })\r\n          const text = doc.getFullText()\r\n          // Robust Regex: Matches {VAR}, {{VAR}}, { VAR }, {Variable Name}\r\n          const matchedTags = text.match(/\\{{1,2}[^{}\\n\\r]+\\}{1,2}/g) || []\r\n          \r\n          // Clean tags: remove braces and trim whitespace\r\n          const uniqueTags = Array.from(new Set(matchedTags.map(t => t.replace(/[\\{\\}]/g, '').trim())))\r\n\r\n          // Create a dummy data object with ALL available keys to check against\r\n          const sampleData = {\r\n              ...teachersData[0], // base props\r\n              jenisSk: \"SK Guru Tetap\",\r\n              // Uppercase\r\n              NAMA: \"Sample\", NAMA_LENGKAP: \"Sample\", NAMA_GURU: \"Sample\",\r\n              NIP: \"123\", NUPTK: \"123\", NOMOR_INDUK: \"123\", \"NOMOR INDUK MAARIF\": \"123\",\r\n              JABATAN: \"Guru\", UNIT_KERJA: \"Madrasah\", \"UNIT KERJA\": \"Madrasah\", STATUS: \"Aktif\",\r\n              TTL: \"City, 01-01-1990\", \"TEMPAT/TANGGAL LAHIR\": \"City, 01-01-1990\",\r\n              PENDIDIKAN: \"S1\", TMT: \"2010-01-01\",\r\n              KECAMATAN: \"Cilacap\", NOMOR_SURAT: \"123/SK/2025\", TANGGAL_PENETAPAN: \"01 Januari 2025\",\r\n              NOMOR: \"123\", TANGGAL: \"01\", BULAN: \"Januari\", TAHUN: \"2025\", \"TANGGAL LENGKAP\": \"01 Januari 2025\",\r\n              // Lowercase\r\n              nama: \"x\", nip: \"x\", nuptk: \"x\", nomor_induk: \"x\",\r\n              jabatan: \"x\", unit_kerja: \"x\", status: \"x\", ttl: \"x\", pendidikan: \"x\", tmt: \"x\",\r\n              kecamatan: \"x\", nomor_surat: \"x\", tanggal_penetapan: \"x\",\r\n              // Title\r\n              Nama: \"x\", Nip: \"x\", Nuptk: \"x\", Nomor_Induk: \"x\", Jabatan: \"x\", Unit_Kerja: \"x\",\r\n              Status: \"x\", Ttl: \"x\", Pendidikan: \"x\", Tmt: \"x\",\r\n              Kecamatan: \"x\", Nomor_Surat: \"x\", Tanggal_Penetapan: \"x\",\r\n              KETUA_NAMA: \"x\", KETUA_NIP: \"x\", SEKRETARIS_NAMA: \"x\", SEKRETARIS_NIP: \"x\"\r\n          }\r\n\r\n          const availableKeys = new Set(Object.keys(sampleData))\r\n          \r\n          const found = []\r\n          const missing = []\r\n\r\n          uniqueTags.forEach(tag => {\r\n              if (availableKeys.has(tag)) found.push(tag)\r\n              else missing.push(tag)\r\n          })\r\n\r\n          let msg = `[HASIL ANALISA TEMPLATE]\\n\\n`\r\n          \r\n          if (uniqueTags.length === 0) {\r\n              msg += ` TIDAK DITEMUKAN VARIABEL APAPUN!\\n\\n`\r\n              msg += `Saya tidak menemukan tanda kurung { } atau {{ }} di dalam file Word anda.\\n`\r\n              msg += `Pastikan anda menulis variabel seperti ini: {NAMA}, {NIP}, dll.\\n`\r\n              msg += `Jangan gunakan [ ] atau < >.`\r\n              alert(msg)\r\n              return\r\n          }\r\n\r\n          msg += `Ditemukan ${uniqueTags.length} variabel: ${uniqueTags.join(\", \")}\\n`\r\n\r\n          if (found.length > 0) {\r\n              msg += `\\n BERHASIL MATCH (${found.length}):\\n${found.join(\", \")}\\n`\r\n          }\r\n\r\n          if (missing.length > 0) {\r\n              msg += `\\n TIDAK DIKENALI (${missing.length}):\\n${missing.join(\", \")}\\n`\r\n              msg += `\\nSOLUSI: Rename variabel di Word anda menjadi salah satu ini:\\n`\r\n              msg += `NAMA, NUPTK, TTL, PENDIDIKAN, TMT, JABATAN, UNIT_KERJA, KECAMATAN, NOMOR_SURAT, TANGGAL_PENETAPAN\\n`\r\n          } else {\r\n              msg += `\\n SEMPURNA! Semua variabel valid.`\r\n          }\r\n\r\n          alert(msg)\r\n\r\n      } catch (e: any) {\r\n          alert(\"Error: \" + e.message)\r\n      }\r\n  }\r\n\r\n  // Duplicate handleGenerate removed\r\n\r\n\r\n  // --- SMART LOGIC: Explain Classification ---\r\n  const explainClassification = (t: any) => {\r\n      const p = (t.pendidikanTerakhir || \"\").toLowerCase()\r\n      const n = (t.nama || \"\").toLowerCase()\r\n      const tmt = t.tmt\r\n\r\n      let log = `[Analisa Logika SK - ${t.nama}]\\n`\r\n\r\n      // 1. Check Education / Title\r\n      const educationKeywords = [\"s1\", \"s.1\", \"sarjana\", \"s2\", \"s.2\", \"magister\", \"s3\", \"s.3\", \"doktor\", \"div\", \"d4\"]\r\n      const titleKeywords = [\"s.pd\", \"s.ag\", \"s.e\", \"s.kom\", \"s.h\", \"s.sos\", \"s.hum\", \"s.ip\", \"m.pd\", \"m.ag\", \"m.e\", \"m.kom\", \"dra.\", \"drs.\", \"lc.\", \"b.a\"]\r\n\r\n      const hasEdu = educationKeywords.some(k => p.includes(k))\r\n      const hasTitle = titleKeywords.some(k => n.includes(k))\r\n\r\n      log += `1. Cek Pendidikan/Gelar:\\n`\r\n      log += `   - Data Pendidikan: \"${t.pendidikanTerakhir}\" -> ${hasEdu ? \"LULUS (S1+)\" : \"TIDAK (Belum S1)\"}\\n`\r\n      log += `   - Cek Gelar di Nama: \"${t.nama}\" -> ${hasTitle ? \"LULUS (Ada Gelar)\" : \"TIDAK\"}\\n`\r\n\r\n      if (!hasEdu && !hasTitle) {\r\n          log += `\\nKESIMPULAN: TENDIK\\n(Karena tidak ditemukan tanda S1 atau gelar akademik)`\r\n          alert(log)\r\n          return\r\n      }\r\n\r\n      // 2. Check Tenure\r\n      log += `\\n2. Cek Masa Kerja (TMT):\\n`\r\n      let tmtDate = new Date()\r\n       if (tmt && typeof tmt === 'string' && tmt.includes(\"/\")) {\r\n          const parts = tmt.split(\"/\")\r\n          if (parts.length === 3) tmtDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`)\r\n      } else if (tmt) {\r\n          tmtDate = new Date(tmt)\r\n      }\r\n\r\n      const now = new Date()\r\n      let yearsDiff = now.getFullYear() - tmtDate.getFullYear()\r\n      const m = now.getMonth() - tmtDate.getMonth()\r\n      if (m < 0 || (m === 0 && now.getDate() < tmtDate.getDate())) yearsDiff--\r\n\r\n      log += `   - TMT Tercatat: ${t.tmt || 'Kosong'} (Dibaca: ${tmtDate.toDateString()})\\n`\r\n      log += `   - Masa Kerja: ${yearsDiff} Tahun\\n`\r\n      log += `   - Syarat GTY: Minimal 2 Tahun\\n`\r\n\r\n      if (yearsDiff >= 2) {\r\n          log += `\\nKESIMPULAN: GTY (Guru Tetap Yayasan)\\n(Berpendidikan S1/Gelar DAN Masa Kerja >= 2 Tahun)`\r\n      } else {\r\n          log += `\\nKESIMPULAN: GTT (Guru Tidak Tetap)\\n(Berpendidikan S1/Gelar tapi Masa Kerja < 2 Tahun)`\r\n      }\r\n      \r\n      alert(log)\r\n  }\r\n\r\n  // --- HELPER: Parse Date Robustly ---\r\n  const parseIndonesianDate = (dateStr: any): Date | null => {\r\n      if (!dateStr) return null\r\n      \r\n      const str = String(dateStr).trim()\r\n\r\n      \r\n      // 0. Excel Serial Date check (Simple 5 digit number)\r\n      if (/^\\d{5}$/.test(str)) {\r\n          try {\r\n             const serial = parseInt(str, 10);\r\n             // Convert Excel serial to JS Date (rough approximation sufficient for dates)\r\n             // (serial - 25569) * 86400 * 1000\r\n             return new Date((serial - 25569) * 86400 * 1000);\r\n          } catch (e) {\r\n              console.error(\"Failed to parse serial date\", e);\r\n          }\r\n      }\r\n\r\n      // 1. Try Standard Date\r\n      const d = new Date(str)\r\n      if (!isNaN(d.getTime()) && !/^\\d+$/.test(str)) return d // Avoid plain numbers being treated as ms timestamp unless filtered above\r\n\r\n      // 2. Try DD/MM/YYYY or DD-MM-YYYY\r\n      const parts = str.match(/(\\d{1,2})[\\/\\-\\.](\\d{1,2})[\\/\\-\\.](\\d{4})/)\r\n      if (parts) {\r\n          // parts[1] is Day, parts[2] is Month, parts[3] is Year\r\n          return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`)\r\n      }\r\n\r\n      // 3. Try Indonesian/English Month Names with varying delimiters (space, dash, slash)\r\n      // e.g. \"15 Juli 2020\", \"18-Jul-2011\", \"01/Des/2023\"\r\n      const months: {[key: string]: string} = {\r\n          'januari': '01', 'februari': '02', 'maret': '03', 'april': '04', 'mei': '05', 'juni': '06',\r\n          'juli': '07', 'agustus': '08', 'september': '09', 'oktober': '10', 'november': '11', 'desember': '12',\r\n          'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06',\r\n          'jul': '07', 'aug': '08', 'agt': '08', 'sep': '09', 'oct': '10', 'okt': '10', 'nov': '11', 'dec': '12', 'des': '12'\r\n      }\r\n\r\n      // Split by space, dash, or slash\r\n      const txtParts = str.split(/[\\s\\-\\/]+/)\r\n      \r\n      if (txtParts.length >= 3) {\r\n          const day = txtParts[0].replace(/[^0-9]/g, '')\r\n          const monthTxt = txtParts[1].toLowerCase()\r\n          const year = txtParts[2].replace(/[^0-9]/g, '')\r\n          \r\n          if (months[monthTxt] && year && day) {\r\n              return new Date(`${year}-${months[monthTxt]}-${day}`)\r\n          }\r\n      }\r\n\r\n      return null\r\n  }\r\n\r\n  // --- LOGIC: Determine Jenis SK ---\r\n  // FIXED: Added fallback logic to respect existing Status for overrides\r\n  const determineJenisSk = (pendidikan: string, tmt: string, nama: string, jabatan: string, explicitStatus?: string) => {\r\n      // 0. Explicit Override (GTY/GTT/Kamad)\r\n      if (explicitStatus) {\r\n         const s = explicitStatus.toLowerCase()\r\n         if (s === \"gty\" || s.includes(\"guru tetap yayasan\") || s.includes(\"tetap yayasan\") || s.includes(\"sertifikasi\")) return \"SK Guru Tetap Yayasan\"\r\n         if (s === \"gtt\" || s.includes(\"guru tidak tetap\") || s.includes(\"tidak tetap\") || s.includes(\"honorer\")) return \"SK Guru Tidak Tetap\"\r\n         if (s === \"kamad\" || s.includes(\"kepala\")) return \"SK Kepala Madrasah\"\r\n      }\r\n      \r\n      const p = (pendidikan || \"\").toLowerCase()\r\n      const n = (nama || \"\").toLowerCase()\r\n      const j = (jabatan || \"\").toLowerCase()\r\n\r\n      console.log(`[determineJenisSk] nama: ${nama}, tmt: ${tmt}, pendidikan: ${pendidikan}`)\r\n\r\n      // 0. Check Kamad\r\n      if (j.includes(\"kepala\") || j.includes(\"kamad\")) return \"SK Kepala Madrasah\"\r\n\r\n      // Keywords for S1 or above (Check Pendidikan AND Name titles)\r\n      const educationKeywords = [\"s1\", \"s.1\", \"sarjana\", \"s2\", \"s.2\", \"magister\", \"s3\", \"s.3\", \"doktor\", \"div\", \"d4\"]\r\n      const titleKeywords = [\"s.pd\", \"s.ag\", \"s.e\", \"s.kom\", \"s.h\", \"s.sos\", \"s.hum\", \"s.ip\", \"m.pd\", \"m.ag\", \"m.e\", \"m.kom\", \"dra.\", \"drs.\", \"lc.\", \"b.a\"]\r\n      \r\n      const isSarjana = educationKeywords.some(k => p.includes(k)) || \r\n                        titleKeywords.some(k => n.includes(k))\r\n\r\n      if (!isSarjana) return \"SK Tenaga Kependidikan\"\r\n\r\n      // Check Tenure - ONLY if TMT exists\r\n      if (!tmt || tmt.trim() === '') {\r\n        console.warn(`[determineJenisSk] TMT kosong untuk ${nama}! Default ke GTT`)\r\n        return \"SK Guru Tidak Tetap\"\r\n      }\r\n\r\n      const tmtDate = parseIndonesianDate(tmt)\r\n      if (!tmtDate) {\r\n        console.warn(`[determineJenisSk] TMT tidak bisa di-parse: ${tmt} untuk ${nama}. Default ke GTT`)\r\n        return \"SK Guru Tidak Tetap\"\r\n      }\r\n\r\n      const now = new Date()\r\n      let yearsDiff = now.getFullYear() - tmtDate.getFullYear()\r\n      const m = now.getMonth() - tmtDate.getMonth()\r\n      if (m < 0 || (m === 0 && now.getDate() < tmtDate.getDate())) yearsDiff--\r\n\r\n      console.log(`[determineJenisSk] ${nama}: TMT Date=${tmtDate.toLocaleDateString()}, Years=${yearsDiff}`)\r\n\r\n      if (yearsDiff >= 2) return \"SK Guru Tetap Yayasan\"\r\n      else return \"SK Guru Tidak Tetap\"\r\n  }\r\n\r\n  // --- HELPER: Roman Numerals ---\r\n  const toRoman = (num: number): string => {\r\n      const roman = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}\r\n      let str = '', i\r\n      for ( i in roman ) {\r\n          while ( num >= roman[i as keyof typeof roman] ) {\r\n              str += i\r\n              num -= roman[i as keyof typeof roman]\r\n          }\r\n      }\r\n      return str\r\n  }\r\n\r\n  // Generate Handler\r\n  const handleGenerate = async () => {\r\n    if (selectedIds.size === 0) return alert(\"Pilih minimal satu data guru.\")\r\n\r\n    setIsGenerating(true)\r\n    try {\r\n      // Get selected teacher objects\r\n      const selectedData = teachersData.filter(t => selectedIds.has(t._id))\r\n      \r\n      // Get Settings for Signers\r\n      const settingsStr = localStorage.getItem(\"app_settings\")\r\n      const settings = settingsStr ? JSON.parse(settingsStr) : {}\r\n\r\n      // PREPARE DATE COMPONENTS\r\n      // Default to today if empty\r\n      const finalTanggalPenetapan = tanggalPenetapan || new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})\r\n      \r\n      // Try to parse day, month, year from string like \"01 Januari 2025\" or ISO\r\n      // Simple parse assume: DD Month YYYY or YYYY-MM-DD\r\n      const dateObj = parseIndonesianDate(tanggalPenetapan) || new Date()\r\n      const dd = String(dateObj.getDate()).padStart(2, '0')\r\n      const mm = String(dateObj.getMonth() + 1).padStart(2, '0') // 07\r\n      const mmAngka = String(dateObj.getMonth() + 1) // 7\r\n      const mmRoma = toRoman(dateObj.getMonth() + 1)\r\n      const yyyy = dateObj.getFullYear()\r\n\r\n      // Calculate +1 Year Validity\r\n      const tanggalHabisBerlaku = calculateValidityDate(finalTanggalPenetapan)\r\n      const tanggalSuratMasukFormatted = parseIndonesianDate(tanggalSuratMasuk) \r\n            ? parseIndonesianDate(tanggalSuratMasuk)!.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})\r\n            : (tanggalSuratMasuk || \"-\")\r\n\r\n      // Map teacher data to template keys clearly\r\n      const mappedData = selectedData.map((t, idx) => {\r\n              const derivedJenisSk = determineJenisSk((t as any).pendidikanTerakhir, t.tmt, t.nama, (t as any).jabatan, t.status)\r\n              \r\n              const tmt = t.tmt || ''\r\n          const tmtParsed = parseIndonesianDate(tmt)\r\n          const tmtFormatted = tmtParsed \r\n                ? tmtParsed.toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'}) \r\n                : (tmt || '-')\r\n\r\n          // Auto-Numbering Logic\r\n          // Parse Start Number\r\n          let currentSeq = parseInt(nomorMulai) || 1\r\n          currentSeq += idx // Increment\r\n          const seqStr = String(currentSeq).padStart(4, '0')\r\n          \r\n          const generatedNomor = nomorFormat\r\n              .replace(/{NO}/g, seqStr)\r\n              .replace(/{NOMOR}/g, seqStr)\r\n              .replace(/{SEQ}/g, seqStr)\r\n              .replace(/{HL}/g, dd)\r\n              .replace(/{DD}/g, dd)\r\n              .replace(/{TANGGAL}/g, dd)\r\n              .replace(/{MM}/g, mm)\r\n              .replace(/{BL}/g, mmAngka) // \"7\"\r\n              .replace(/{BULAN}/g, mmAngka) // \"7\" (User Request)\r\n              .replace(/{BL_ROMA}/g, mmRoma)\r\n              .replace(/{TH}/g, String(yyyy))\r\n              .replace(/{YYYY}/g, String(yyyy))\r\n              .replace(/{TAHUN}/g, String(yyyy))\r\n\r\n\r\n          // Fallback Kecamatan Logic:\r\n          // 1. Teacher Data (highest priority) -> 2. Global Input -> 3. \".....\"\r\n          const rawKecamatan = (t as any).kecamatan\r\n          const kecamatan = (rawKecamatan && rawKecamatan.length > 2) ? rawKecamatan : (defaultKecamatan || \".....\")\r\n\r\n\r\n          // TTL Construction - FIX: Use correct field names from database\r\n          const birthPlace = (t as any).tempatLahir || \"\"\r\n          const birthDate = (t as any).tanggalLahir || \"\"\r\n          let ttl = \"-\"\r\n          if(birthPlace || birthDate) {\r\n              ttl = `${birthPlace}${birthPlace && birthDate ? ', ' : ''}${birthDate}`\r\n          }\r\n\r\n          return {\r\n            ...t,\r\n            jenisSk: derivedJenisSk,\r\n\r\n            // Uppercase\r\n            NAMA: t.nama,\r\n            NOMOR_SURAT: generatedNomor,\r\n            TANGGAL_PENETAPAN: finalTanggalPenetapan,\r\n            KECAMATAN: kecamatan,\r\n            \r\n            // Extensive Aliases (Kitchen Sink)\r\n            NOMOR: seqStr,\r\n            \"NOMOR INDUK MAARIF\": t.nuptk || t.nip || '-',\r\n            \"UNIT KERJA\": t.unitKerja || '-',\r\n            \"TEMPAT/TANGGAL LAHIR\": ttl,\r\n            \"TANGGAL LENGKAP\": finalTanggalPenetapan,\r\n            TANGGAL: dd,\r\n            BULAN: mmAngka,\r\n            NAMA_BULAN: dateObj.toLocaleDateString('id-ID', {month: 'long'}),\r\n            TAHUN: String(yyyy),\r\n            \r\n            // Request Letter & Validity\r\n            NOMOR_SURAT_MASUK: nomorSuratMasuk || \"-\",\r\n            NOMOR_SURAT_PERMOHONAN: nomorSuratMasuk || \"-\",\r\n            NO_SURAT_PERMOHONAN: nomorSuratMasuk || \"-\",\r\n            NOMOR_PERMOHONAN: nomorSuratMasuk || \"-\",\r\n            NO_PERMOHONAN: nomorSuratMasuk || \"-\",\r\n            \r\n            TANGGAL_SURAT_MASUK: tanggalSuratMasukFormatted,\r\n            TANGGAL_SURAT_PERMOHONAN: tanggalSuratMasukFormatted,\r\n            TGL_SURAT_PERMOHONAN: tanggalSuratMasukFormatted,\r\n            TANGGAL_PERMOHONAN: tanggalSuratMasukFormatted,\r\n            TGL_PERMOHONAN: tanggalSuratMasukFormatted,\r\n            \r\n            TAHUN_AJARAN: tahunAjaran,\r\n            TAHUN_PELAJARAN: tahunAjaran,\r\n            TH_AJARAN: tahunAjaran,\r\n            TH_PELAJARAN: tahunAjaran,\r\n            \r\n            TANGGAL_HABIS_BERLAKU: addOneYearIndonesian(finalTanggalPenetapan),\r\n            TANGGAL_BERAKHIR: addOneYearIndonesian(finalTanggalPenetapan),\r\n            \"TANGGAL > 1 TAHUN SEJAK PENETAPAN\": addOneYearIndonesian(finalTanggalPenetapan),\r\n            MASA_BERLAKU: addOneYearIndonesian(finalTanggalPenetapan),\r\n\r\n            NAMA_LENGKAP: t.nama,\r\n            NAMA_GURU: t.nama,\r\n            NIP: t.nip || t.nuptk || '-',\r\n            NUPTK: t.nuptk || '-',\r\n            NOMOR_INDUK: t.nuptk || t.nip || '-',\r\n            JABATAN: t.mapel === '-' ? 'Guru' : t.mapel,\r\n            UNIT_KERJA: t.unitKerja || '-',\r\n            STATUS: t.status,\r\n            TTL: ttl,\r\n            PENDIDIKAN: (t as any).pendidikanTerakhir || '-',\r\n            TMT: tmtFormatted,\r\n            TANGGAL_MULAI_TUGAS: tmtFormatted,\r\n            TGL_MULAI_TUGAS: tmtFormatted,\r\n\r\n            // Lowercase\r\n            nama: t.nama,\r\n            nip: t.nip || t.nuptk || '-',\r\n            nuptk: t.nuptk || '-',\r\n            nomor_induk: t.nuptk || t.nip || '-',\r\n            jabatan: t.mapel === '-' ? 'Guru' : t.mapel,\r\n            unit_kerja: t.unitKerja || '-',\r\n            status: t.status,\r\n            ttl: ttl,\r\n            pendidikan: (t as any).pendidikanTerakhir || '-',\r\n            tmt: tmtFormatted,\r\n\r\n            pangkat: (t as any).pangkat || \"-\", // Fallback common field\r\n            golongan: (t as any).golongan || \"-\",\r\n\r\n            // --- KITCHEN SINK ALIASES (Space, TitleCase, dots) ---\r\n            \"Nomor Surat Permohonan\": nomorSuratMasuk || \"-\",\r\n            \"No. Surat Permohonan\": nomorSuratMasuk || \"-\",\r\n            \"Nomor Permohonan\": nomorSuratMasuk || \"-\",\r\n            \"No Surat Permohonan\": nomorSuratMasuk || \"-\",\r\n\r\n            \"Tanggal Surat Permohonan\": tanggalSuratMasukFormatted,\r\n            \"Tgl. Surat Permohonan\": tanggalSuratMasukFormatted,\r\n            \"Tanggal Permohonan\": tanggalSuratMasukFormatted,\r\n            \"Tgl Surat Permohonan\": tanggalSuratMasukFormatted,\r\n            \r\n            \"Tahun Ajaran\": tahunAjaran,\r\n            \"Th. Ajaran\": tahunAjaran,\r\n            \"Th Ajaran\": tahunAjaran,\r\n            \r\n            // --- ALL CAPS SPACES (User might format like this) ---\r\n            \"NOMOR SURAT PERMOHONAN\": nomorSuratMasuk || \"-\",\r\n            \"NO SURAT PERMOHONAN\": nomorSuratMasuk || \"-\",\r\n            \"TANGGAL SURAT PERMOHONAN\": tanggalSuratMasukFormatted,\r\n            \"TGL SURAT PERMOHONAN\": tanggalSuratMasukFormatted,\r\n            \"TAHUN AJARAN\": tahunAjaran,\r\n            \"TH AJARAN\": tahunAjaran,\r\n            \"TAHUN PELAJARAN\": tahunAjaran,\r\n            \"TH PELAJARAN\": tahunAjaran,\r\n            \r\n            // Title Case Space\r\n            \"Tahun Pelajaran\": tahunAjaran,\r\n            \"Th Pelajaran\": tahunAjaran,\r\n\r\n            // Inject Global Signers\r\n            KETUA_NAMA: settings.signerKetuaName || \"H. Munib\",\r\n            KETUA_NIP: settings.signerKetuaNip || \"-\",\r\n            SEKRETARIS_NAMA: settings.signerSekretarisName || \"-\",\r\n            SEKRETARIS_NIP: settings.signerSekretarisNip || \"-\"\r\n        }\r\n      })\r\n      \r\n      console.log(\"MAPPED DATA SAMPLE:\", mappedData[0]) // Debug Log\r\n\r\n      // --- 1. PRE-ARCHIVE: Create SKs first to get IDs ---\r\n      const finalData: any[] = []\r\n      let successCount = 0\r\n\r\n      for (const item of mappedData) {\r\n          try {\r\n              // Create SK in DB\r\n              const skId = await createSk({\r\n                  jenisSk: item.jenisSk,\r\n                  status: \"active\",\r\n                  nama: item.nama,\r\n                  teacherId: (item as any)._id, // Original Teacher ID\r\n                  jabatan: item.JABATAN,\r\n                  unitKerja: item.UNIT_KERJA || \"LP Maarif NU Cilacap\",\r\n                  nomorSk: item.NOMOR_SURAT,\r\n                  tanggalPenetapan: item.TANGGAL_PENETAPAN,\r\n                  fileUrl: \"Generated via Bulk ZIP\",\r\n                  createdBy: \"System\"\r\n              })\r\n\r\n              // MODIFIED (SAFEGUARD): User requested NOT to delete teacher data after generation\r\n              // Use Soft-Cleanup instead: Mark as Generated\r\n              if ((item as any)._id) {\r\n                 await markAsGenerated({ id: (item as any)._id })\r\n              }\r\n\r\n              // PUSH WITH NEW ID (For QR Code)\r\n              finalData.push({\r\n                  ...item,\r\n                  _id: skId, // <--- CRITICAL: Overwrite with SK ID\r\n                  original_teacher_id: (item as any)._id\r\n              })\r\n              successCount++\r\n\r\n          } catch (err: any) {\r\n              console.error(\"Failed to archive SK:\", item.nama, err)\r\n              // If archive fails, we probably shouldn't generate the file? \r\n              // Or maybe generate but with invalid QR? \r\n              // Better to skip to ensure consistency.\r\n              alert(`Gagal menyimpan data untuk ${item.nama}: ${err.message}`)\r\n          }\r\n      }\r\n\r\n      if (finalData.length === 0) {\r\n          setIsGenerating(false)\r\n          return\r\n      }\r\n      \r\n      // --- 2. GENERATE ZIP (Now using valid SK IDs) ---\r\n      const res = await generateBulkSkZip(finalData, \"SK_Masal_Maarif.zip\", finalData) \r\n      \r\n      if (res.successCount > 0) {\r\n          // Auto-Increment\r\n          const nextStart = (parseInt(nomorMulai) || 0) + res.successCount\r\n          setNomorMulai(String(nextStart).padStart(4, '0'))\r\n          \r\n          alert(`Berhasil membuat ${res.successCount} SK! (Cek Download)\\n\\nData sudah tersimpan di Bank Data SK.\\nNomor Surat berikutnya: ${String(nextStart).padStart(4, '0')}`)\r\n      }\r\n      \r\n      setIsGenerating(false)\r\n    } catch (e: any) {\r\n        console.error(\" Critical Gen Error:\", e)\r\n        alert(`Terjadi kesalahan sistem saat generate!\\n\\nError: ${e.message || e}\\n\\nCek console untuk detail lengkap.`)\r\n        setIsGenerating(false)\r\n    }\r\n  }\r\n\r\n\r\n\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex flex-col sm:flex-row items-center justify-between gap-4\">\r\n        <div>\r\n            <h1 className=\"text-2xl font-bold tracking-tight\">Generator SK Masal</h1>\r\n            <p className=\"text-muted-foreground\">Pilih data guru dan terbitkan SK secara otomatis.</p>\r\n        </div>\r\n        <div className=\"flex gap-2\">\r\n            <Button variant=\"outline\" onClick={handleResetSkHistoryOnly} className=\"text-amber-600 border-amber-200 hover:bg-amber-50\" title=\"Hapus Riwayat SK saja (Guru Aman)\">\r\n                <RotateCcw className=\"mr-2 h-4 w-4\" />\r\n                Reset SK History\r\n            </Button>\r\n            <Button variant=\"destructive\" onClick={handleReset} disabled={isLoading} title=\"Hapus Data Guru + Riwayat SK\">\r\n                <Trash2 className=\"mr-2 h-4 w-4\" /> Hapus Semua Data\r\n            </Button>\r\n             <Button variant=\"outline\" asChild>\r\n                <Link to=\"/dashboard/settings\">\r\n                    <Settings className=\"mr-2 h-4 w-4\" /> Atur Template & Tanda Tangan\r\n                </Link>\r\n            </Button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Removed Tabs wrapper - Archive moved to Arsip SK Unit page */}\r\n      <div className=\"space-y-4\">\r\n        {/* GLOBAL SETTINGS CARD */}\r\n        <Card className=\"mb-4 bg-slate-50/50 border-blue-100\">\r\n            <CardHeader className=\"pb-3 border-b bg-slate-50\">\r\n                <CardTitle className=\"text-sm font-semibold flex items-center gap-2 text-slate-700\">\r\n                    <Settings className=\"h-4 w-4 text-blue-600\"/> Pengaturan Surat Keputusan (Global)\r\n                </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"pt-4 grid sm:grid-cols-2 gap-4\">\r\n                <div className=\"space-y-2 col-span-2 sm:col-span-1\">\r\n                    <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">Format Nomor Surat (Otomatis)</label>\r\n                    <div className=\"flex gap-2\">\r\n                        <Input \r\n                            value={nomorMulai}\r\n                            onChange={e => setNomorMulai(e.target.value)}\r\n                            placeholder=\"Start (0001)\"\r\n                            className=\"w-20 bg-white\"\r\n                            title=\"Nomor Awal\"\r\n                        />\r\n                        <Button \r\n                            variant=\"sketch\" \r\n                            size=\"icon\" \r\n                            className=\"bg-white border-input border text-slate-500 hover:text-black hover:bg-slate-100\"\r\n                            title=\"Reset Nomor ke 0001\"\r\n                            onClick={() => setNomorMulai(\"0001\")}\r\n                        >\r\n                            <RotateCcw className=\"h-4 w-4\" />\r\n                        </Button>\r\n                        <Input \r\n                            value={nomorFormat}\r\n                            onChange={e => setNomorFormat(e.target.value)}\r\n                            placeholder=\"Format: {NO}/SK/{BL_ROMA}/{TH}\"\r\n                            className=\"flex-1 bg-white\"\r\n                        />\r\n                    </div>\r\n                    <p className=\"text-[10px] text-muted-foreground mt-1\">\r\n                        Gunakan kode: <code>{\"{NOMOR}\"}</code> (urut), <code>{\"{BL_ROMA}\"}</code> (III), <code>{\"{TANGGAL}\"}</code> (01), <code>{\"{BULAN}\"}</code> (07), <code>{\"{TAHUN}\"}</code> (2025). \r\n                        <br/> Preview: <span className=\"font-mono bg-slate-100 px-1\">{nomorFormat.replace('{NOMOR}', nomorMulai).replace('{NO}', nomorMulai).replace('{BL_ROMA}', 'VII').replace('{TH}', '2025').replace('{TAHUN}', '2025')}</span>\r\n                    </p>\r\n                </div>\r\n                <div className=\"space-y-2 col-span-2 sm:col-span-1\">\r\n                    <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">Tanggal Penetapan</label>\r\n\r\n                    <Input \r\n                        placeholder=\"Contoh: 1 Juli 2025\" \r\n                        value={tanggalPenetapan}\r\n                        onChange={e => setTanggalPenetapan(e.target.value)}\r\n                        className=\"bg-white\"\r\n                    />\r\n                    <p className=\"text-[10px] text-muted-foreground\">Otomatis mengganti <code>{\"{TANGGAL_PENETAPAN}\"}</code>.</p>\r\n                </div>\r\n                \r\n                {/* SURAT MASUK & TAHUN AJARAN */}\r\n                <div className=\"md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 border-t pt-2 mt-2\">\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">No. Surat Permohonan</label>\r\n                        <Input \r\n                            value={nomorSuratMasuk}\r\n                            onChange={e => setNomorSuratMasuk(e.target.value)}\r\n                            placeholder=\"Contoh: 005/MWC/...\"\r\n                            className=\"bg-white\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">Tgl. Surat Permohonan</label>\r\n                         <Input \r\n                            value={tanggalSuratMasuk}\r\n                            onChange={e => setTanggalSuratMasuk(e.target.value)}\r\n                            placeholder=\"Contoh: 20 Juni 2025\"\r\n                            className=\"bg-white\"\r\n                        />\r\n                    </div>\r\n                    <div className=\"space-y-1\">\r\n                        <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">Tahun Ajaran (Auto)</label>\r\n                         <Input \r\n                            value={tahunAjaran}\r\n                            onChange={e => setTahunAjaran(e.target.value)}\r\n                            placeholder=\"Contoh: 2024/2025\"\r\n                            className=\"bg-white\"\r\n                        />\r\n                    </div>\r\n                     <div className=\"space-y-1\">\r\n                        <label className=\"text-xs font-semibold text-slate-600 uppercase tracking-wider\">Kecamatan (Default)</label>\r\n                         <Input \r\n                            value={defaultKecamatan}\r\n                            onChange={e => setDefaultKecamatan(e.target.value)}\r\n                            placeholder=\"Isi jika kecamatan di data guru kosong\"\r\n                            className=\"bg-white\"\r\n                        />\r\n                    </div>\r\n                </div>\r\n            </CardContent>\r\n        </Card>\r\n\r\n        {/* GUIDANCE BOX */}\r\n        <div className=\"bg-blue-50 border border-blue-200 p-4 rounded-md mb-4\">\r\n            <div className=\"flex justify-between items-start\">\r\n                <div>\r\n                     <h3 className=\"font-bold text-blue-800 mb-1\">Panduan Template Word</h3>\r\n                     <p className=\"text-sm text-blue-700 mb-2\">\r\n                        Agar data terisi otomatis, anda <strong>WAJIB</strong> menggunakan tanda kurung <code>{\"{ }\"}</code> di file Word.\r\n                        <br/><span className=\"text-xs opacity-75\">Klik kode dibawah untuk copy:</span>\r\n                    </p>\r\n                </div>\r\n                <div>\r\n                     {hasStoredTemplate ? (\r\n                         <div className=\"flex items-center gap-2 text-xs font-medium text-green-700 bg-green-100 px-2 py-1 rounded\">\r\n                            <CheckCircle className=\"h-3 w-3\" /> Template Aktif: {localStorage.getItem(\"sk_template_name\")}\r\n                         </div>\r\n                     ) : (\r\n                         <div className=\"flex items-center gap-2 text-xs font-medium text-amber-700 bg-amber-100 px-2 py-1 rounded\">\r\n                            <Archive className=\"h-3 w-3\" /> Template Belum Ada\r\n                         </div>\r\n                     )}\r\n                </div>\r\n            </div>\r\n            \r\n            <div className=\"flex flex-wrap gap-2 mb-3\">\r\n                {[\"{NAMA}\", \"{NIP}\", \"{TTL}\", \"{PENDIDIKAN}\", \"{TMT}\", \"{JABATAN}\", \"{UNIT_KERJA}\", \"{KECAMATAN}\", \"{NOMOR_SURAT}\", \"{NOMOR}\", \"{TANGGAL_PENETAPAN}\", \"{TANGGAL_HABIS_BERLAKU}\", \"{NOMOR_SURAT_MASUK}\", \"{TANGGAL_SURAT_MASUK}\", \"{TAHUN_AJARAN}\"].map(tag => (\r\n                    <span key={tag} \r\n                          onClick={() => {navigator.clipboard.writeText(tag); alert(`Copied: ${tag}`)}}\r\n                          className=\"bg-white px-2 py-1 rounded border text-xs font-mono font-bold select-all cursor-pointer hover:bg-slate-100 shadow-sm transition-colors text-blue-800\" \r\n                          title=\"Klik untuk copy\">\r\n                        {tag}\r\n                    </span>\r\n                ))}\r\n            </div>\r\n            \r\n            <div className=\"flex gap-2\">\r\n                 <Button variant=\"outline\" size=\"sm\" onClick={inspectTemplate} className=\"gap-2 bg-white hover:bg-slate-100 text-blue-700 border-blue-300 h-8 text-xs\">\r\n                    <Search className=\"h-3 w-3\" />\r\n                    Analisa Template & Cek Variabel\r\n                </Button>\r\n                {!hasStoredTemplate && (\r\n                    <Link to=\"/dashboard/settings\">\r\n                        <Button variant=\"default\" size=\"sm\" className=\"h-8 text-xs\">Upload Template dulu</Button>\r\n                    </Link>\r\n                )}\r\n            </div>\r\n        </div>\r\n\r\n            {/* Step 2: Select Data (Now Main Step) */}\r\n            <Card>\r\n                <CardHeader className=\"pb-3 card-header-compact\">\r\n                     <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\r\n                        <div className=\"flex items-center gap-2\">\r\n                            <CardTitle className=\"text-base\">Pilih Data Penerima SK ({selectedIds.size} dipilih)</CardTitle>\r\n                             <Button variant=\"ghost\" size=\"icon\" title=\"Refresh Data\">\r\n                                <Search className=\"h-4 w-4\" /> {/* Reusing search icon as refresh temporarily or import RefreshCw */}\r\n                            </Button>\r\n                        </div>\r\n                         <div className=\"relative\">\r\n                            <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-muted-foreground\" />\r\n                            <Input\r\n                                placeholder=\"Cari nama...\"\r\n                                className=\"pl-9 w-[250px]\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => {\r\n                                    setSearchTerm(e.target.value);\r\n                                    setCurrentPage(1); // Reset to page 1 on search\r\n                                }}\r\n                            />\r\n                        </div>\r\n                    </div>\r\n                </CardHeader>\r\n                <CardContent>\r\n                    <div className=\"rounded-md border max-h-[500px] overflow-auto\">\r\n                        <Table>\r\n                            <TableHeader className=\"bg-slate-50 sticky top-0 z-10\">\r\n                                <TableRow>\r\n                                    <TableHead className=\"w-[50px]\">\r\n                                        <Checkbox \r\n                                            checked={\r\n                                                currentData.length > 0 && \r\n                                                currentData.every(t => selectedIds.has(t._id))\r\n                                            }\r\n                                            onCheckedChange={(c) => handleSelectAllForPage(!!c)}\r\n                                        />\r\n                                    </TableHead>\r\n                                    <TableHead>Nama Lengkap</TableHead>\r\n                                    <TableHead>Pendidikan</TableHead>\r\n                                    <TableHead>NIP/NIY</TableHead>\r\n                                    <TableHead>Jabatan</TableHead>\r\n                                    <TableHead>Unit Kerja</TableHead>\r\n                                    <TableHead>Status</TableHead>\r\n                                    <TableHead className=\"w-[50px]\"></TableHead>\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {isLoading ? (\r\n                                    <TableRow>\r\n                                        <TableCell colSpan={8} className=\"h-24 text-center\">\r\n                                            <Loader2 className=\"h-6 w-6 animate-spin mx-auto\"/>\r\n                                            <span className=\"text-xs text-muted-foreground\">Memuat data guru...</span>\r\n                                        </TableCell>\r\n                                    </TableRow>\r\n                                ) : currentData.length === 0 ? (\r\n                                    <TableRow>\r\n                                        <TableCell colSpan={8} className=\"h-24 text-center\">\r\n                                            {searchTerm ? \"Tidak ada data yang cocok dengan pencarian.\" : \"Data kosong. Lakukan input SK atau upload kolektif dulu.\"}\r\n                                        </TableCell>\r\n                                    </TableRow>\r\n                                ) : (\r\n                                    currentData.map((t) => (\r\n                                        <TableRow key={t._id} data-state={selectedIds.has(t._id) ? \"selected\" : \"\"}  >\r\n                                            <TableCell>\r\n                                                <Checkbox \r\n                                                    checked={selectedIds.has(t._id)}\r\n                                                    onCheckedChange={(c) => handleSelectOne(t._id, !!c)}\r\n                                                />\r\n                                            </TableCell>\r\n                                            <TableCell className=\"font-medium\">{t.nama}</TableCell>\r\n                                            <TableCell>{t.pendidikanTerakhir || '-'}</TableCell>\r\n                                            <TableCell>{t.nuptk || t.nip || '-'}</TableCell>\r\n                                            <TableCell>{t.mapel || '-'}</TableCell>\r\n                                            <TableCell>{t.unitKerja || (t as any).satminkal || '-'}</TableCell>\r\n                                            <TableCell>\r\n                                                <div className=\"flex items-center gap-2\">\r\n                                                    {t.status}\r\n                                                </div>\r\n                                            </TableCell>\r\n                                            <TableCell>\r\n                                                 <Button \r\n                                                    variant=\"ghost\" \r\n                                                    size=\"icon\" \r\n                                                    className=\"h-6 w-6 text-blue-500 hover:text-blue-700\"\r\n                                                    title=\"Analisa Logika (AI)\"\r\n                                                    onClick={(e) => {\r\n                                                        e.stopPropagation()\r\n                                                        explainClassification(t)\r\n                                                    }}\r\n                                                 >\r\n                                                    <span className=\"text-xs font-bold\">(?)</span>\r\n                                                </Button>\r\n                                            </TableCell>\r\n                                        </TableRow>\r\n                                    ))\r\n                                )}\r\n                            </TableBody>\r\n                        </Table>\r\n                    </div>\r\n\r\n                    {/* Pagination Controls */}\r\n                     <div className=\"flex items-center justify-end space-x-2 py-4\">\r\n                        <div className=\"flex-1 text-sm text-muted-foreground\">\r\n                            Halaman {currentPage} dari {totalPages} ({filteredTeachers.length} data)\r\n                        </div>\r\n                        <div className=\"space-x-2\">\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}\r\n                                disabled={currentPage === 1}\r\n                            >\r\n                                Sebelumnya\r\n                            </Button>\r\n                            <Button\r\n                                variant=\"outline\"\r\n                                size=\"sm\"\r\n                                onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}\r\n                                disabled={currentPage === totalPages || totalPages === 0}\r\n                            >\r\n                                Selanjutnya\r\n                            </Button>\r\n                        </div>\r\n                    </div>\r\n\r\n                </CardContent>\r\n            </Card>\r\n\r\n            {/* Floating Action Bar for Generation */}\r\n            {selectedIds.size > 0 && (\r\n                <div className=\"fixed bottom-6 left-1/2 -translate-x-1/2 bg-white border shadow-lg rounded-full px-6 py-3 flex items-center gap-4 z-50 animate-in slide-in-from-bottom-5\">\r\n                    <span className=\"font-medium\">{selectedIds.size} Data Dipilih</span>\r\n                    <Button onClick={handleGenerate} disabled={isGenerating || !hasStoredTemplate}>\r\n                        {isGenerating ? (\r\n                            <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> Generating...</>\r\n                        ) : (\r\n                            <><FileDown className=\"mr-2 h-4 w-4\" /> Generate SK Masal</>\r\n                        )}\r\n                    </Button>\r\n                    \r\n                    {isSuperAdmin && (\r\n                        <Button \r\n                            variant=\"secondary\"\r\n                            className=\"bg-purple-100 text-purple-700 hover:bg-purple-200\"\r\n                            disabled={selectedIds.size === 0 || isGenerating}\r\n                            onClick={handleBulkSign}\r\n                        >\r\n                            <BadgeCheck className=\"mr-2 h-4 w-4\" /> Sign Digital\r\n                        </Button>\r\n                    )}\r\n                </div>\r\n            )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\SkPrintPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useRef' is defined but never used.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'useEffect' is defined but never used.","line":1,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":27}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useRef, useEffect } from \"react\"\r\nimport { useParams, useNavigate } from \"react-router-dom\"\r\nimport { useQuery } from \"convex/react\"\r\nimport { api } from \"../../../convex/_generated/api\"\r\nimport { Id } from \"../../../convex/_generated/dataModel\"\r\nimport QRCode from \"react-qr-code\"\r\nimport { Button } from \"@/components/ui/button\"\r\nimport { ArrowLeft, Printer } from \"lucide-react\"\r\n\r\nexport default function SkPrintPage() {\r\n    const { id } = useParams()\r\n    const navigate = useNavigate()\r\n    \r\n    // Fetch SK Data\r\n    const sk = useQuery(api.sk.get, id ? { id: id as Id<\"skDocuments\"> } : \"skip\")\r\n\r\n    const handlePrint = () => {\r\n        window.print()\r\n    }\r\n\r\n    if (sk === undefined) return <div className=\"p-10 text-center\">Memuat data...</div>\r\n    if (sk === null) return <div className=\"p-10 text-center\">Data tidak ditemukan</div>\r\n\r\n    // Full Verification URL\r\n    const verificationUrl = `${window.location.origin}/verify/${sk._id}`\r\n\r\n    return (\r\n        <div className=\"min-h-screen bg-slate-100 flex flex-col items-center py-8 print:bg-white print:py-0\">\r\n            {/* Action Bar - Hidden when printing */}\r\n            <div className=\"w-full max-w-[210mm] flex justify-between items-center mb-6 print:hidden px-4 sm:px-0\">\r\n                <Button variant=\"outline\" onClick={() => navigate(-1)}>\r\n                    <ArrowLeft className=\"mr-2 h-4 w-4\" /> Kembali\r\n                </Button>\r\n                <Button onClick={handlePrint}>\r\n                    <Printer className=\"mr-2 h-4 w-4\" /> Cetak Sekarang\r\n                </Button>\r\n            </div>\r\n\r\n                {/* Header Kop Surat - Pasuruan Style matched to Template color/layout */}\r\n                {/* A4 Paper Container */}\r\n                <div className=\"bg-white w-full max-w-[210mm] min-h-[297mm] p-[15mm] shadow-lg print:shadow-none print:w-full print:max-w-none print:p-0 text-black\">\r\n                    <div className=\"flex items-start gap-4 border-b-4 border-double border-black pb-2 mb-6 justify-center\">\r\n                   <div className=\"w-24 h-24 flex items-start justify-center pt-2\">\r\n                       <img src=\"/logo_maarif.png\" alt=\"Logo\" className=\"w-full object-contain\" \r\n                            onError={(e) => { e.currentTarget.style.display = 'none' }} />\r\n                   </div>\r\n                   <div className=\"flex-1 text-center font-serif text-green-700\">\r\n                        <h4 className=\"font-bold text-lg uppercase tracking-wide leading-tight\">PENGURUS CABANG NAHDLATUL ULAMA KABUPATEN PASURUAN</h4>\r\n                        <h2 className=\"font-bold text-2xl uppercase tracking-wider leading-tight\">LEMBAGA PENDIDIKAN MA'ARIF NU</h2>\r\n                        <div className=\"text-xs text-black font-sans mt-1 space-y-0.5\">\r\n                            <p>Jalan Raya Warungdowo No. 99, Pohjentrek, Pasuruan Telp. (0343) 421234</p>\r\n                            <p>Email: pcmaarifpasuruan@gmail.com | Website: www.maarifpasuruan.org</p>\r\n                        </div>\r\n                   </div>\r\n                </div>\r\n\r\n                {/* SK Title */}\r\n                <div className=\"text-center mb-6 font-serif\">\r\n                     <h3 className=\"font-bold text-lg underline uppercase decoration-1 underline-offset-4\">SURAT KEPUTUSAN</h3>\r\n                     <p className=\"font-bold text-sm mt-1\">Nomor : {sk.nomorSk || \"..../PC.L/A.II/...../2024\"}</p>\r\n                     \r\n                     <div className=\"mt-4 mb-2\">\r\n                         <p className=\"font-bold text-sm uppercase\">TENTANG</p>\r\n                         <p className=\"font-bold text-sm uppercase\">PENGANGKATAN {sk.jenisSk || \"GURU TETAP YAYASAN\"}</p>\r\n                         <p className=\"font-bold text-sm uppercase\">DI LINGKUNGAN PENGURUS CABANG LEMBAGA PENDIDIKAN MA'ARIF NU KABUPATEN PASURUAN</p>\r\n                     </div>\r\n                </div>\r\n\r\n                <div className=\"text-justify text-[13px] leading-tight font-serif space-y-2 relative\">\r\n                    {/* Floating Layout for 'Menimbang' etc */}\r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Menimbang</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\">\r\n                            <ol className=\"list-[lower-alpha] pl-4 space-y-1\">\r\n                                <li>\r\n                                    <span className=\"absolute left-[145px] -ml-4\">1.</span>\r\n                                    Bahwa Pembangunan nasional dalam bidang pendidikan adalah upaya mencerdaskan kehidupan bangsa dan meningkatkan kualitas manusia Indonesia.\r\n                                </li>\r\n                                <li>\r\n                                    <span className=\"absolute left-[145px] -ml-4\">2.</span>\r\n                                    Bahwa untuk merealisasikan hal tersebut diatas perlu ditetapkan formasi Tenaga Pendidik dan Kependidikan di Lingkungan Pengurus Cabang LP Ma'arif NU.\r\n                                </li>\r\n                                <li>\r\n                                    <span className=\"absolute left-[145px] -ml-4\">3.</span>\r\n                                    Bahwa berdasarkan pertimbangan angka 1 dan 2, perlu diterbitkan Surat Keputusan.\r\n                                </li>\r\n                            </ol>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Mengingat</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\">\r\n                            <ol className=\"list-decimal pl-4 space-y-1 relative\">\r\n                                <li>\r\n                                    <span className=\"absolute left-0 -ml-4\">1.</span>\r\n                                    Undang  Undang Nomor 20 Tahun 2003 tentang Sistem Pendidikan Nasional.\r\n                                </li>\r\n                                <li>\r\n                                    <span className=\"absolute left-0 -ml-4\">2.</span>\r\n                                    Peraturan Menteri Pendidikan Nasional Nomor 13 tahun 2007.\r\n                                </li>\r\n                                <li>\r\n                                    <span className=\"absolute left-0 -ml-4\">3.</span>\r\n                                    AD/ART Lembaga Pendidikan Ma'arif NU.\r\n                                </li>\r\n                            </ol>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Memperhatikan</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\">\r\n                            <ol className=\"list-decimal pl-4 space-y-1 relative\">\r\n                                <li>\r\n                                    <span className=\"absolute left-0 -ml-4\">1.</span>\r\n                                    Hasil Rapat Pengurus Harian LP Ma'arif NU Cabang Pasuruan.\r\n                                </li>\r\n                                <li>\r\n                                    <span className=\"absolute left-0 -ml-4\">2.</span>\r\n                                    Surat Permohonan dari {sk.unitKerja}.\r\n                                </li>\r\n                            </ol>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"text-center py-4 font-bold\">\r\n                        MEMUTUSKAN :\r\n                    </div>\r\n\r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Menetapkan</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\"></div>\r\n                    </div>\r\n                    \r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Pertama</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\">\r\n                            <p className=\"mb-2\">Identitas Personil tersebut di bawah ini :</p>\r\n                            <table className=\"w-full mb-2\">\r\n                                <tbody>\r\n                                    <tr>\r\n                                        <td className=\"w-5 font-bold\">1.</td>\r\n                                        <td className=\"w-32\">Nama</td>\r\n                                        <td className=\"w-4\">:</td>\r\n                                        <td className=\"font-bold uppercase\">{sk.nama}</td>\r\n                                    </tr>\r\n                                    <tr>\r\n                                        <td className=\"font-bold\">2.</td>\r\n                                        <td>Tempat/Tgl Lahir</td>\r\n                                        <td>:</td>\r\n                                        <td>-</td> \r\n                                    </tr>\r\n                                    <tr>\r\n                                        <td className=\"font-bold\">3.</td>\r\n                                        <td>NUPTK</td>\r\n                                        <td>:</td>\r\n                                        <td>{sk.teacher?.nuptk || \"-\"}</td>\r\n                                    </tr>\r\n                                    <tr>\r\n                                        <td className=\"font-bold\">4.</td>\r\n                                        <td>Pendidikan</td>\r\n                                        <td>:</td>\r\n                                        <td>-</td>\r\n                                    </tr>\r\n                                    <tr>\r\n                                        <td className=\"font-bold\">5.</td>\r\n                                        <td>Unit Kerja</td>\r\n                                        <td>:</td>\r\n                                        <td>{sk.unitKerja}</td>\r\n                                    </tr>\r\n                                    <tr>\r\n                                        <td className=\"font-bold\">6.</td>\r\n                                        <td>TMT</td>\r\n                                        <td>:</td>\r\n                                        <td>{new Date(sk.createdAt).toLocaleDateString('id-ID')}</td>\r\n                                    </tr>\r\n                                </tbody>\r\n                            </table>\r\n                            <p className=\"indent-0\">\r\n                                Terhitung mulai tanggal ditetapkan, diangkat kembali sebagai {sk.jenisSk} pada {sk.unitKerja}, diberikan hak-hak sesuai dengan ketentuan yang berlaku.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div className=\"flex\">\r\n                        <div className=\"w-32 font-bold shrink-0\">Kedua</div>\r\n                        <div className=\"w-4 text-center shrink-0\">:</div>\r\n                        <div className=\"flex-1\">\r\n                            <p>\r\n                                Keputusan ini berlaku sejak tanggal ditetapkan sampai dengan 1 Tahun, dan apabila ada kekeliruan dikemudian hari akan diadakan perbaikan sebagaimana mestinya.\r\n                            </p>\r\n                        </div>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Footer Section - Precise Layout Match */}\r\n                <div className=\"mt-8 relative font-serif text-[13px]\">\r\n                     {/* Right Side: Date & Signatures */}\r\n                     <div className=\"ml-auto w-[60%] relative\">\r\n                         {/* Date Block */}\r\n                         <div className=\"flex leading-tight\">\r\n                             <div className=\"w-24\">Ditetapkan di</div>\r\n                             <div className=\"w-4\">:</div>\r\n                             <div>Pasuruan</div>\r\n                         </div>\r\n                         <div className=\"flex leading-tight mb-4\">\r\n                             <div className=\"w-24\">Pada Tanggal</div>\r\n                             <div className=\"w-4\">:</div>\r\n                             <div>{new Date(sk.createdAt).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</div>\r\n                         </div>\r\n\r\n                         {/* QR Code BOX - Absolute Right of the Date Block */}\r\n                         <div className=\"absolute right-0 top-0 w-[80px] h-[80px] border border-black p-1 bg-white\">\r\n                             <QRCode \r\n                                value={verificationUrl}\r\n                                size={70}\r\n                                style={{ height: \"100%\", width: \"100%\" }}\r\n                                viewBox={`0 0 256 256`}\r\n                             />\r\n                         </div>\r\n\r\n                         {/* Signature Header */}\r\n                         <div className=\"text-center mt-2 pr-[80px]\"> {/* pr-80px to account for QR box visual balance if needed, or just standard center */}\r\n                             <p className=\"font-bold uppercase\">PENGURUS CABANG NAHDLATUL ULAMA</p>\r\n                             <p className=\"font-bold uppercase\">LEMBAGA PENDIDIKAN MA'ARIF</p>\r\n                             <p className=\"font-bold uppercase\">KABUPATEN PASURUAN</p>\r\n                         </div>\r\n                         \r\n                         {/* Signatures Columns */}\r\n                         <div className=\"flex justify-between mt-16 pr-[20px]\">\r\n                             <div className=\"text-center relative\">\r\n                                 {/* Optional Sekretaris Slot */}\r\n                             </div>\r\n                             \r\n                             <div className=\"text-center relative min-w-[150px] mr-12\">\r\n                                 <p className=\"font-bold underline decoration-1 underline-offset-2 uppercase mb-1\">H. AHMAD ADIP MUHLISIN, M.Pd.I</p>\r\n                                 <p className=\"font-bold\">Ketua</p>\r\n                             </div>\r\n                         </div>\r\n                     </div>\r\n\r\n                     {/* Tembusan - Bottom Left Absolute */}\r\n                     <div className=\"absolute bottom-0 left-0 text-[11px] w-[35%]\">\r\n                         <p className=\"underline decoration-1 mb-1\">Tembusan dikirim Kepada Yth.:</p>\r\n                         <ol className=\"list-decimal pl-4 space-y-0 leading-tight\">\r\n                            <li>LP Ma'arif PWNU Jawa Timur</li>\r\n                            <li>PCNU Kabupaten Pasuruan</li>\r\n                            <li>Arsip</li>\r\n                         </ol>\r\n                         <p className=\"text-[8px] text-slate-300 mt-2\">rev.2405</p>\r\n                     </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\SkSubmissionPage.tsx","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":98,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":98,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4051,4054],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4051,4054],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\sk-management\\components\\BulkSkSubmission.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'createTeacherMutation' is assigned a value but never used.","line":28,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":28,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'createSkMutation' is assigned a value but never used.","line":29,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":29,"endColumn":25},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'idx' is defined but never used.","line":163,"column":64,"nodeType":null,"messageId":"unusedVar","endLine":163,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'hasData' is assigned a value but never used.","line":266,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":266,"endColumn":28},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'excelDateToJSDate' is assigned a value but never used.","line":290,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":290,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'date_info' is assigned a value but never used.","line":297,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":297,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'date' is assigned a value but never used.","line":301,"column":12,"nodeType":null,"messageId":"unusedVar","endLine":301,"endColumn":16},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":329,"column":16,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":329,"endColumn":17,"suggestions":[{"messageId":"removeEscape","fix":{"range":[14690,14691],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[14690,14690],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":343,"column":42,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":343,"endColumn":43,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15236,15237],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15236,15236],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":343,"column":46,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":343,"endColumn":47,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15240,15241],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15240,15240],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":343,"column":59,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":343,"endColumn":60,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15253,15254],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15253,15253],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\..","line":343,"column":63,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":343,"endColumn":64,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15257,15258],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15257,15257],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":354,"column":40,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":354,"endColumn":41,"suggestions":[{"messageId":"removeEscape","fix":{"range":[15915,15916],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[15915,15915],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1235,1238],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1235,1238],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":211,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8833,8836],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8833,8836],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":216,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":216,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9064,9067],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9064,9067],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":220,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":220,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9219,9222],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9219,9222],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":280,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":280,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12532,12535],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12532,12535],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":317,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":317,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14266,14269],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14266,14269],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":434,"column":21,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":434,"endColumn":24,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19100,19103],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19100,19103],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":515,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":515,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[22924,22927],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[22924,22927],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":535,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":535,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24004,24007],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24004,24007],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":550,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":550,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[24823,24826],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[24823,24826],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""},{"kind":"directive","justification":""}]}],"errorCount":13,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { Button } from \"@/components/ui/button\"\r\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\"\r\nimport { Input } from \"@/components/ui/input\"\r\nimport { Label } from \"@/components/ui/label\"\r\nimport { Loader2, FileSpreadsheet, CheckCircle, Upload } from \"lucide-react\"\r\nimport { useState } from \"react\"\r\nimport { Checkbox } from \"@/components/ui/checkbox\"\r\nimport * as XLSX from \"xlsx\"\r\nimport { saveAs } from \"file-saver\"\r\nimport { api } from \"@/lib/api\"\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\"\r\nimport { useNavigate } from \"react-router-dom\"\r\nimport { useMutation } from \"convex/react\"\r\nimport { api as convexApi } from \"../../../../convex/_generated/api\"\r\n\r\nexport function BulkSkSubmission() {\r\n  const navigate = useNavigate()\r\n  \r\n  // Convex mutations for bulk operations\r\n  const bulkCreateTeacherMutation = useMutation(convexApi.teachers.bulkCreate)\r\n  const createTeacherMutation = useMutation(convexApi.teachers.create)\r\n  const createSkMutation = useMutation(convexApi.sk.create)\r\n  \r\n  /* eslint-disable @typescript-eslint/no-explicit-any */\r\n  const [candidates, setCandidates] = useState<any[]>([])\r\n  const [isProcessing, setIsProcessing] = useState(false)\r\n  const [isFullSync, setIsFullSync] = useState(false)\r\n  const [autoApprove, setAutoApprove] = useState(false)\r\n  const [debugLog, setDebugLog] = useState<string[]>([])\r\n  const [uploadError, setUploadError] = useState<string | null>(null)\r\n  \r\n  // New State for Surat Permohonan\r\n  const [suratPermohonanFile, setSuratPermohonanFile] = useState<File | null>(null)\r\n\r\n  const log = (msg: string) => setDebugLog(prev => [...prev, `${new Date().toLocaleTimeString()} - ${msg}`])\r\n\r\n\r\n  /* \r\n    Flexible Header Validation Logic \r\n    Maps internal ID -> Possible Excel Header strings (lowercase)\r\n  */\r\n\r\n  const HEADER_DEFINITIONS: Record<string, string[]> = {\r\n    \"Nama\": [\"nama\", \"nama lengkap\", \"nama guru\"],\r\n    \"Tempat Lahir\": [\"tempat lahir\", \"tmp lahir\"],\r\n    \"Tanggal Lahir\": [\"tanggal lahir\", \"tgl lahir\", \"tgl. lahir\"],\r\n    \"Tempat/Tanggal Lahir\": [\"tempat/tanggal lahir\", \"ttl\", \"tempat tanggal lahir\"],\r\n    \"Nomor Induk Ma'arif\": [\"nomor induk ma'arif\", \"niy\", \"nip\", \"nomor induk\", \"n.i.y\", \"nuptk\", \"pegid\"],\r\n    \"Pendidikan Terakhir\": [\"pendidikan terakhir\", \"pendidikan\", \"ijazah terakhir\"],\r\n    \"Unit Kerja\": [\"unit kerja\", \"satminkal\", \"tempat tugas\", \"lembaga\", \"nama madrasah\", \"sekolah\"],\r\n    \"Tanggal Mulai Tugas\": [\"tanggal mulai tugas\", \"tmt\", \"mulai tugas\", \"tgl masuk\", \"tmt guru\"],\r\n    \"Sertifikasi\": [\"sertifikasi\", \"sertifikat\", \"status sertifikasi\", \"sudah sertifikasi\", \"ket sertifikasi\"],\r\n    \"Status\": [\"status\", \"status kepegawaian\", \"status guru\"],\r\n    \"PDPKPNU\": [\"pdpkpnu\", \"pkpnu\", \"diklat\", \"status pdpkpnu\", \"ket pdpkpnu\", \"keterangan pdpkpnu\", \"sertifikat pdpkpnu\", \"lulus pdpkpnu\"],\r\n    \"Kecamatan\": [\"kecamatan\", \"kec\", \"distrik\", \"wilayah\"]\r\n  }\r\n\r\n  // We need at least these to form a valid submission\r\n  const MIN_REQUIRED_MATCHES = 3; \r\n\r\n  // EXCLUSION RULES to prevent collisions\r\n  const HEADER_EXCLUSIONS: Record<string, string[]> = {\r\n      \"Status\": [\"sertifikasi\", \"pernikahan\", \"kawin\", \"pdpkpnu\", \"sosial\"], // \"Status Sertifikasi\" != \"Status\" (Kepegawaian)\r\n      \"Sertifikasi\": [],\r\n      \"PDPKPNU\": [],\r\n  }\r\n\r\n  const handleDownloadTemplate = () => {\r\n    // Defines standard headers for the template\r\n    const headers = [\r\n      \"Nama\", \r\n      \"Tempat/Tanggal Lahir\", \r\n      \"Nomor Induk Ma'arif\", \r\n      \"Pendidikan Terakhir\", \r\n      \"Unit Kerja\", \r\n      \"Tanggal Mulai Tugas\", \r\n      \"Sertifikasi\", \r\n      \"Status\", \r\n      \"PDPKPNU\", \r\n      \"Kecamatan\"\r\n    ];\r\n\r\n    // Create a dummy row to help user understand the format\r\n    const sampleRow = [\r\n      \"Ahmad Contoh, S.Pd\",\r\n      \"Cilacap, 12-05-1990\",\r\n      \"123456789\",\r\n      \"S1 Pendidikan Agama Islam\",\r\n      \"MI Ma'arif 01 Cilacap\",\r\n      \"01-07-2015\",\r\n      \"Sudah\",\r\n      \"GTY\",\r\n      \"Lulus Angkatan 1\",\r\n      \"Cilacap Selatan\"\r\n    ];\r\n\r\n    const ws = XLSX.utils.aoa_to_sheet([headers, sampleRow]);\r\n    \r\n    // Auto-width columns roughly\r\n    ws[\"!cols\"] = headers.map(() => ({ wch: 25 }));\r\n    ws[\"!cols\"][0] = { wch: 30 }; // Nama wider\r\n    ws[\"!cols\"][4] = { wch: 30 }; // Unit Kerja wider\r\n\r\n    const wb = XLSX.utils.book_new();\r\n    XLSX.utils.book_append_sheet(wb, ws, \"Template Guru\");\r\n    \r\n    const excelBuffer = XLSX.write(wb, { bookType: \"xlsx\", type: \"array\" });\r\n    const blob = new Blob([excelBuffer], { type: \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\" });\r\n    saveAs(blob, \"Template_Data_Guru_Maarif.xlsx\");\r\n  }\r\n\r\n  /* eslint-disable @typescript-eslint/no-explicit-any */\r\n  const handleExcelUpload = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    setDebugLog([])\r\n    setUploadError(null)\r\n    setCandidates([])\r\n\r\n    if (file) {\r\n      log(`File selected: ${file.name} (${file.size} bytes)`)\r\n      const reader = new FileReader()\r\n      reader.onload = (evt) => {\r\n        try {\r\n            const bstr = evt.target?.result\r\n            const wb = XLSX.read(bstr, { type: \"binary\" })\r\n            const wsname = wb.SheetNames[0]\r\n            const ws = wb.Sheets[wsname]\r\n            log(`Sheet loaded: ${wsname}`)\r\n            \r\n            // 1. Convert sheet to array of arrays to find header row\r\n            const rows = XLSX.utils.sheet_to_json(ws, { header: 1 }) as string[][]\r\n            log(`Total rows found: ${rows.length}`)\r\n\r\n            if (rows.length === 0) {\r\n                setUploadError(\"File kosong or format tidak valid.\")\r\n                return\r\n            }\r\n\r\n            // 2. Simple Heuristic\r\n            let headerRowIndex = -1\r\n            let colMap: Record<string, string> = {} \r\n            const allKeys = Object.keys(HEADER_DEFINITIONS);\r\n\r\n            log(\"Scanning for headers...\")\r\n            for (let i = 0; i < Math.min(rows.length, 15); i++) {\r\n                // Fix: Use Array.from to handle sparse arrays from Excel ensuring no undefined cells\r\n                const rowStr = Array.from(rows[i] || []).map(c => (c || \"\").toString().toLowerCase().trim())\r\n                let matchedCount = 0\r\n                const currentMap: Record<string, string> = {}\r\n\r\n                allKeys.forEach(key => {\r\n                    const possibleHeaders = HEADER_DEFINITIONS[key]\r\n                    const exclusions = HEADER_EXCLUSIONS[key] || []\r\n\r\n                    // Find index where header matches AND passes exclusion rules\r\n                    const foundIndex = rowStr.findIndex((cell, idx) => {\r\n                        const cellLower = cell.toLowerCase()\r\n                        const isMatch = possibleHeaders.some(ph => cellLower.includes(ph))\r\n                        const isExcluded = exclusions.some(ex => cellLower.includes(ex))\r\n                        \r\n                        if (!isMatch) return false;\r\n                        if (isExcluded) return false;\r\n\r\n                        return true\r\n                    })\r\n                    \r\n                    if (foundIndex >= 0) {\r\n                        matchedCount++\r\n                        currentMap[key] = String(foundIndex) \r\n                    }\r\n                })\r\n                \r\n                if (matchedCount > 0) {\r\n                    log(`Row ${i} matches: ${matchedCount} columns`)\r\n                }\r\n\r\n                if (matchedCount >= MIN_REQUIRED_MATCHES) {\r\n                    headerRowIndex = i\r\n                    colMap = currentMap\r\n                    log(`Header found at row ${i}!`)\r\n                if (headerRowIndex !== -1) {\r\n                    // Log detected mapping\r\n                    const detected = Object.keys(colMap).map(k => `${k} -> Index ${colMap[k]} (${rows[i][parseInt(colMap[k])]})`).join(\"\\n\")\r\n                    log(`Detected Columns:\\n${detected}`)\r\n                    // Show visible alert for mapping\r\n                    alert(` Header Terdeteksi di Baris ${i + 1}!\\n\\nMapping Kolom:\\n${detected}`)\r\n                }\r\n                break\r\n                }\r\n            }\r\n\r\n            if (headerRowIndex === -1) {\r\n                const msg = `Gagal menemukan header yang valid dalam 15 baris pertama.`\r\n                log(msg)\r\n                setUploadError(msg + \" Pastikan ada kolom: Nama, NIP, Unit Kerja, dsb.\")\r\n                return\r\n            }\r\n            \r\n            // CAPTURE ALL HEADERS for debugging\r\n            const foundHeaders = (rows[headerRowIndex] || []).map(h => String(h).trim()).filter(h => h)\r\n            log(`Raw Headers Found: ${foundHeaders.join(\", \")}`)\r\n            \r\n            // 3. Extract Data\r\n            const extractedData: any[] = []\r\n            for(let r = headerRowIndex + 1; r < rows.length; r++) {\r\n                const rawRow = rows[r]\r\n                if(!rawRow || rawRow.length === 0) continue;\r\n                \r\n                const newObj: any = {}\r\n                let hasData = false;\r\n\r\n                // Extract Raw Values first using the Map\r\n                const rawVals: Record<string, any> = {}\r\n                allKeys.forEach(k => {\r\n                    const idx = parseInt(colMap[k])\r\n                    if (!isNaN(idx)) rawVals[k] = rawRow[idx]\r\n                })\r\n\r\n                // Parse Fields\r\n                newObj[\"nama\"] = rawVals[\"Nama\"]\r\n                newObj[\"nuptk\"] = rawVals[\"Nomor Induk Ma'arif\"]\r\n                newObj[\"unitKerja\"] = rawVals[\"Unit Kerja\"]\r\n                newObj[\"satminkal\"] = rawVals[\"Unit Kerja\"] // Duplicate for safety\r\n                newObj[\"kecamatan\"] = rawVals[\"Kecamatan\"]\r\n                newObj[\"pendidikanTerakhir\"] = rawVals[\"Pendidikan Terakhir\"]\r\n                \r\n                // Parse Dates using Robust Parser\r\n                const tmtDate = parseIndonesianDate(rawVals[\"Tanggal Mulai Tugas\"])\r\n                newObj[\"tmt\"] = tmtDate ? tmtDate.toISOString().split('T')[0] : \"\"\r\n                \r\n                // Parse TTL (Tempat/Tanggal Lahir logic)\r\n                // If we have separate columns\r\n                const dobDate = parseIndonesianDate(rawVals[\"Tanggal Lahir\"])\r\n                const dobStr = dobDate ? dobDate.toISOString().split('T')[0] : (rawVals[\"Tanggal Lahir\"] || \"\")\r\n                const pob = rawVals[\"Tempat Lahir\"] || \"\"\r\n                \r\n                if (pob || dobStr) {\r\n                    newObj[\"ttl\"] = `${pob}, ${dobStr}`\r\n                } else {\r\n                     newObj[\"ttl\"] = rawVals[\"Tempat/Tanggal Lahir\"] || \"\"\r\n                }\r\n                \r\n                // Parse Certification\r\n                const sertifVal = String(rawVals[\"Sertifikasi\"] || \"\").toLowerCase()\r\n                newObj[\"sertifikasi\"] = (sertifVal.includes(\"ya\") || sertifVal.includes(\"sudah\") || sertifVal === 'v') ? \"Ya\" : \"Tidak\"\r\n                \r\n                // Parse PDPKPNU\r\n                const pdpVal = String(rawVals[\"PDPKPNU\"] || \"\").toLowerCase()\r\n                newObj[\"pdpkpnu\"] = (pdpVal.includes(\"sudah\") || pdpVal.includes(\"lulus\") || pdpVal === 'v') ? \"Sudah\" : \"Belum\"\r\n                \r\n                // Parse Status\r\n                newObj[\"status\"] = rawVals[\"Status\"] || \"\"\r\n                \r\n                // Calculate Jenis SK (using the robust TMT date we just parsed)\r\n                // Ensure tmtDate is passed as Date or string? determineJenisSk expects string but parses it again. \r\n                // Let's pass the already formatted string\r\n                if (newObj[\"nama\"]) {\r\n                    extractedData.push(newObj)\r\n                    hasData = true\r\n                }\r\n                \r\n                // DEBUG: Row 0 Analysis\r\n                if (r === headerRowIndex + 1) {\r\n                    const debugColMap = Object.entries(colMap).map(([k, v]) => `${k}:Index ${v}`).join(', ')\r\n                    alert(` Analysis Baris Data Pertama:\\n\\nNama: ${newObj[\"nama\"]}\\nUnit: ${newObj[\"unitKerja\"]}\\nTMT Raw: ${rawVals[\"Tanggal Mulai Tugas\"]}\\nTMT Parsed: ${newObj[\"tmt\"]}\\nTTL: ${newObj[\"ttl\"]}\\n\\nDetected Cols: ${debugColMap}`)\r\n                }\r\n            }\r\n            \r\n            log(`Extracted ${extractedData.length} valid rows.`)\r\n            setCandidates(extractedData)\r\n            if(extractedData.length === 0) setUploadError(\"Header ditemukan tapi tidak ada data yang bisa diextract.\")\r\n\r\n        } catch (err: any) {\r\n            log(`Error parsing: ${err.message}`)\r\n            setUploadError(\"Error parsing file: \" + err.message)\r\n        }\r\n      }\r\n      reader.readAsBinaryString(file)\r\n    }\r\n  }\r\n\r\n  // --- HELPER: Excel Serial to Date ---\r\n  const excelDateToJSDate = (serial: number) => {\r\n     // Excel base date is approx Dec 30 1899. \r\n     // Fast formula: (serial - 25569) * 86400 * 1000 for Unix ms, but let's use the Date dictionary method for stability\r\n     // Adjust for leap year bug in Excel (1900 is strictly not leap, Excel says yes). \r\n     // For typical dates > 2000, simple offset is fine.\r\n     const utc_days  = Math.floor(serial - 25569);\r\n     const utc_value = utc_days * 86400;                                        \r\n     const date_info = new Date(utc_value * 1000);\r\n     \r\n     // Improve robustness for local timezone offsets if needed, but usually UTC conversion is adequate for just Dates\r\n     // Actually a simpler constructor approach:\r\n     const date = new Date((serial - (25567 + 2)) * 86400 * 1000); \r\n     // 25569 is 1970-01-01. \r\n     \r\n     // Let's use the most reliable \"days add\" method\r\n     const d = new Date(1900, 0, serial - 1) // Excel counts from 1900-01-01 as 1. JS months are 0-indexed.\r\n     \r\n     // FIX: toISOString() uses UTC, which might be \"Yesterday\" if local time is +GMT (Indo is +7)\r\n     // Use local date components instead to preserve \"July 18\"\r\n     const year = d.getFullYear()\r\n     const month = String(d.getMonth() + 1).padStart(2, '0')\r\n     const day = String(d.getDate()).padStart(2, '0')\r\n     \r\n     return `${year}-${month}-${day}`\r\n  }\r\n\r\n  // --- HELPER: Parse Date Robustly (Unified with TeacherListPage) ---\r\n  const parseIndonesianDate = (dateStr: any): Date | null => {\r\n      if (!dateStr) return null\r\n      \r\n      // 1. Direct Number (Excel Serial)\r\n      if (typeof dateStr === 'number') {\r\n          const excelEpoch = new Date(1899, 11, 30);\r\n          return new Date(excelEpoch.getTime() + dateStr * 24 * 60 * 60 * 1000)\r\n      }\r\n\r\n      const str = String(dateStr).trim()\r\n      \r\n      // 2. Stringified Number (Excel Serial) - allow decimals\r\n      if (/^[\\d\\.]+$/.test(str) && !isNaN(parseFloat(str))) { \r\n          const val = parseFloat(str)\r\n          // Heuristic: Excel dates are usually > 10000 (after 1927). \r\n          if (val > 1000) {\r\n              const excelEpoch = new Date(1899, 11, 30);\r\n              return new Date(excelEpoch.getTime() + val * 24 * 60 * 60 * 1000)\r\n          }\r\n      }\r\n\r\n      // 3. Standard Date\r\n      const d = new Date(str)\r\n      if (!isNaN(d.getTime()) && !/^\\d+$/.test(str)) return d\r\n      \r\n      // 4. DD/MM/YYYY\r\n      const parts = str.match(/(\\d{1,2})[\\/\\-\\.](\\d{1,2})[\\/\\-\\.](\\d{4})/)\r\n      if (parts) return new Date(`${parts[3]}-${parts[2]}-${parts[1]}`)\r\n      \r\n      // 5. Indonesian Months\r\n      const months: {[key: string]: string} = {\r\n          'januari': '01', 'februari': '02', 'maret': '03', 'april': '04', 'mei': '05', 'juni': '06',\r\n          'juli': '07', 'agustus': '08', 'september': '09', 'oktober': '10', 'november': '11', 'desember': '12',\r\n          'jan': '01', 'feb': '02', 'mar': '03', 'apr': '04', 'may': '05', 'jun': '06',\r\n          'jul': '07', 'aug': '08', 'agt': '08', 'sep': '09', 'oct': '10', 'okt': '10', 'nov': '11', 'dec': '12', 'des': '12'\r\n      }\r\n\r\n      const txtParts = str.split(/[\\s\\-\\/]+/)\r\n      if (txtParts.length >= 3) {\r\n          const day = txtParts[0].replace(/[^0-9]/g, '')\r\n          const monthTxt = txtParts[1].toLowerCase()\r\n          const year = txtParts[2].replace(/[^0-9]/g, '')\r\n          \r\n          if (months[monthTxt] && year && day) {\r\n              return new Date(`${year}-${months[monthTxt]}-${day}`)\r\n          }\r\n      }\r\n\r\n      return null\r\n  }\r\n\r\n  // --- LOGIC: Determine Jenis SK based on Rules ---\r\n  // MODIFIED: Accepts 'explicitStatus' from Excel to override calculation\r\n  const determineJenisSk = (pendidikan: string, tmt: string, explicitStatus?: string) => {\r\n      // 0. Explicit Override\r\n      if (explicitStatus) {\r\n          const s = explicitStatus.toLowerCase()\r\n          if (s.includes(\"gty\") || s.includes(\"tetap yayasan\") || s.includes(\"sertifikasi\")) return \"SK Guru Tetap Yayasan\"\r\n          if (s.includes(\"gtt\") || s.includes(\"tidak tetap\") || s.includes(\"honorer\")) return \"SK Guru Tidak Tetap\"\r\n          if (s.includes(\"kamad\") || s.includes(\"kepala\")) return \"SK Kepala Madrasah\"\r\n          if (s.includes(\"tendik\") || s.includes(\"kependidikan\")) return \"SK Tenaga Kependidikan\"\r\n      }\r\n\r\n      // 1. Check Pendidikan\r\n      const p = (pendidikan || \"\").toLowerCase()\r\n      // Keywords for S1 or above\r\n      const isSarjana = p.includes(\"s1\") || p.includes(\"s.1\") || p.includes(\"sarjana\") || \r\n                        p.includes(\"s2\") || p.includes(\"s.2\") || p.includes(\"magister\") ||\r\n                        p.includes(\"s3\") || p.includes(\"s.3\") || p.includes(\"doktor\") ||\r\n                        p.includes(\"div\") || p.includes(\"d4\")\r\n\r\n      if (!isSarjana) {\r\n          return \"SK Tenaga Kependidikan\"\r\n      }\r\n\r\n      // 2. Check Tenure (Masa Kerja) via TMT\r\n      // FIXED: Use robust date parser\r\n      const tmtDate = parseIndonesianDate(tmt)\r\n      \r\n      // Fallback if Date is invalid -> GTT\r\n      if (!tmtDate || isNaN(tmtDate.getTime())) {\r\n          console.warn(\"Invalid TMT Date:\", tmt);\r\n          return \"SK Guru Tidak Tetap\"; \r\n      }\r\n\r\n      const now = new Date()\r\n      // Calculate difference in specific years\r\n      let yearsDiff = now.getFullYear() - tmtDate.getFullYear()\r\n      const m = now.getMonth() - tmtDate.getMonth()\r\n      if (m < 0 || (m === 0 && now.getDate() < tmtDate.getDate())) {\r\n          yearsDiff--\r\n      }\r\n\r\n      // Default calculation if explicit status invalid or missing\r\n      if (yearsDiff >= 2) {\r\n          return \"SK Guru Tetap Yayasan\" // Correct Enum Value\r\n      } else {\r\n          return \"SK Guru Tidak Tetap\" // Correct Enum Value\r\n      }\r\n  }\r\n\r\n   \r\n  const handleSubmit = async () => {\r\n    if (candidates.length === 0) {\r\n        alert(\"Tidak ada data calon SK yang valid. Upload file Excel terlebih dahulu.\")\r\n        return\r\n    }\r\n\r\n    let permohonanUrl = \"\";\r\n\r\n    // 0. Upload Surat Permohonan if exists\r\n    if (suratPermohonanFile) {\r\n        log(`Mengupload surat permohonan: ${suratPermohonanFile.name}...`)\r\n        try {\r\n            const uploadRes = await api.uploadFile(suratPermohonanFile);\r\n            permohonanUrl = uploadRes.url;\r\n            log(`Upload berhasil: ${permohonanUrl}`);\r\n        } catch (e: any) {\r\n            log(`Gagal upload file: ${e.message}`);\r\n            alert(\"Gagal mengupload surat permohonan! \" + e.message);\r\n            setIsProcessing(false);\r\n            return;\r\n        }\r\n    }\r\n\r\n    setIsProcessing(true)\r\n\r\n    try {\r\n        // Map candidates to Teacher structure with precise fields\r\n        const teachersToUpsert = candidates.map((c, i) => {\r\n            //  CALCULATE PROPER STATUS (GTY/GTT/Tendik)\r\n            // PASS EXPLICIT STATUS FROM EXCEL TO OVERRIDE CALCULATION\r\n            const jenisSk = determineJenisSk(c[\"pendidikanTerakhir\"], c[\"tmt\"], c[\"status\"])\r\n            \r\n            let calculatedStatus = \"Tendik\"\r\n            if (jenisSk.includes(\"Tetap Yayasan\")) calculatedStatus = \"GTY\"\r\n            else if (jenisSk.includes(\"Tidak Tetap\")) calculatedStatus = \"GTT\"\r\n            else if (jenisSk.includes(\"Kepala\")) calculatedStatus = \"Kamad\"\r\n            \r\n            // Map Sertifikasi (already processed in loop)\r\n            const isCertified = c[\"sertifikasi\"] === \"Ya\"\r\n\r\n            // Map PDPKPNU (already processed in loop)\r\n            const pdpkpnu = c[\"pdpkpnu\"] || \"Belum\"\r\n\r\n            return {\r\n                nuptk: c[\"nuptk\"] ? String(c[\"nuptk\"]) : `TMP-${Date.now()}-${i}`, \r\n                nama: c[\"nama\"] ? String(c[\"nama\"]) : \"Tanpa Nama\",\r\n                status: calculatedStatus, \r\n                satminkal: c[\"unitKerja\"] ? String(c[\"unitKerja\"]) : \"Lainnya\",\r\n                mapel: \"-\", \r\n                isCertified: isCertified,\r\n                pdpkpnu: pdpkpnu,\r\n                kecamatan: c[\"kecamatan\"] || null, // FIX: Ensure this is passed to backend \r\n                \r\n                // Metadata\r\n                birthPlace: String((c[\"ttl\"] || \"\").split(\",\")[0]).trim(),\r\n                birthDate: String((c[\"ttl\"] || \"\").split(\",\")[1] || \"\").trim(),\r\n                pendidikanTerakhir: c[\"pendidikanTerakhir\"] ? String(c[\"pendidikanTerakhir\"]) : \"-\",\r\n                tmt: c[\"tmt\"] ? String(c[\"tmt\"]) : \"-\",\r\n                \r\n                // New: Permohonan Link\r\n                suratPermohonanUrl: permohonanUrl || null\r\n            }\r\n        })\r\n\r\n        // 1. Sync Teachers to Master Data using Convex\r\n        console.log(\"Upserting teachers via Convex:\", teachersToUpsert.length, \"rows\")\r\n        \r\n        // Map to Convex schema format (using undefined for optional fields)\r\n        const convexTeachers = teachersToUpsert.map(t => ({\r\n            nuptk: t.nuptk,\r\n            nama: t.nama,\r\n            status: t.status || undefined,\r\n            unitKerja: t.satminkal || undefined,\r\n            mapel: t.mapel || undefined,\r\n            kecamatan: t.kecamatan || undefined,\r\n            phoneNumber: undefined,\r\n            pdpkpnu: t.pdpkpnu || undefined,\r\n            tempatLahir: t.birthPlace || undefined,\r\n            tanggalLahir: t.birthDate || undefined,\r\n            pendidikanTerakhir: t.pendidikanTerakhir || undefined,\r\n            tmt: t.tmt || undefined, //  CRITICAL: Need TMT for GTY/GTT calculation\r\n            isCertified: t.isCertified || undefined,\r\n        }))\r\n\r\n        // --- DEBUG PAYLOAD INSPECTOR ---\r\n        if (convexTeachers.length > 0) {\r\n            const sample = convexTeachers[0]\r\n            const debugStr = ` PAYLOAD DB CHECK:\\n\\nNama: ${sample.nama}\\nUnit: ${sample.unitKerja}\\nTMT: ${sample.tmt}\\nStatus: ${sample.status}\\nPendidikan: ${sample.pendidikanTerakhir}\\n\\nJika field di atas kosong/undefined, berarti Front End belum membaca data dengan benar.`\r\n            alert(debugStr)\r\n            console.log(\"PAYLOAD FULL:\", convexTeachers)\r\n        }\r\n        // -------------------------------\r\n        \r\n        // -------------------------------\r\n        \r\n        log(`Mengirim ${convexTeachers.length} data guru ke Convex...`)\r\n        let teacherIds: any[] = [];\r\n        try {\r\n            const bulkResult = await bulkCreateTeacherMutation({ teachers: convexTeachers })\r\n            console.log(\" bulkCreate result:\", bulkResult)\r\n            \r\n            // ERROR HANDLING: Check for partial failures\r\n            if (bulkResult.errors && bulkResult.errors.length > 0) {\r\n                 const sampleError = bulkResult.errors[0]\r\n                 const errorMsg = `Gagal menyimpan ${bulkResult.errors.length} data Guru. Contoh error: ${typeof sampleError === 'string' ? sampleError : JSON.stringify(sampleError)}`\r\n                 console.error(errorMsg)\r\n                 alert(errorMsg)\r\n                 // If all failed, stop here\r\n                 if (!bulkResult.ids || bulkResult.ids.length === 0) {\r\n                     throw new Error(\"Semua data guru gagal disimpan. Cek format Excel anda.\")\r\n                 }\r\n            }\r\n            \r\n            teacherIds = bulkResult?.ids || []\r\n            log(` ${teacherIds.filter(id => id).length} teachers created/updated.`)\r\n            \r\n        } catch (err: any) {\r\n            console.error(\"Convex bulkCreate failed\", err)\r\n            throw new Error(`Gagal menyimpan data guru (System Error): ${err.message}`)\r\n        }\r\n\r\n        // 2. SK Submission Creation REMOVED to prevent premature data entry.\r\n        // The SK will be created ONLY when generated in SK Generator page.\r\n        \r\n        const resultMessage = `Berhasil memproses!\\n\\nData Guru: ${convexTeachers.length} data masuk antrean.\\n\\nSilakan 'Approve' data ini di menu 'Daftar Guru' atau abaikan jika auto-approve.`\r\n        alert(resultMessage)\r\n        \r\n        // Navigate to Teacher List to verify/approve? Or Generator?\r\n        // Generator is where they will mint the SK.\r\n        navigate(\"/dashboard/sk\") // Redirect to Dashboard so they can Approve (Verify) the data first.\r\n\r\n    } catch (e: any) {\r\n        console.error(\"Bulk Submission Error:\", e)\r\n        alert(\"Terjadi kesalahan saat memproses data: \" + (e.message || \"Unknown error\"))\r\n    } finally {\r\n        setIsProcessing(false)\r\n    }\r\n  }\r\n\r\n  return (\r\n    <Card className=\"w-full\">\r\n      <CardHeader>\r\n        <CardTitle>Pengajuan Kolektif</CardTitle>\r\n        <CardDescription>\r\n          Upload file Excel berisi daftar nama guru/siswa untuk diajukan SK-nya secara bersamaan.\r\n        </CardDescription>\r\n      </CardHeader>\r\n      <CardContent className=\"space-y-6\">\r\n        \r\n        {/* Template Download Section */}\r\n        <div \r\n          className=\"flex items-center gap-4 p-4 border rounded-lg bg-green-50 hover:bg-green-100 transition-colors cursor-pointer group mb-6\"\r\n          onClick={handleDownloadTemplate}\r\n        >\r\n            <div className=\"p-2 bg-green-200 rounded-md group-hover:bg-green-300 transition-colors\">\r\n              <FileSpreadsheet className=\"h-6 w-6 text-green-800\" />\r\n            </div>\r\n            <div>\r\n               <h4 className=\"font-semibold text-sm text-green-900\">Download Template Guru</h4>\r\n               <p className=\"text-xs text-green-700\">Format .xlsx standar sistem</p>\r\n            </div>\r\n            <div className=\"ml-auto\">\r\n                <Button variant=\"outline\" size=\"sm\" className=\"bg-white hover:bg-green-50 border-green-200 text-green-800\">\r\n                  Download\r\n                </Button>\r\n            </div>\r\n        </div>\r\n\r\n        <div className=\"space-y-2\">\r\n            <Label>1. Upload File Excel (.xlsx)</Label>\r\n            <div className={`flex items-center gap-4 rounded-md border p-4 ${uploadError ? 'border-red-500 bg-red-50' : ''}`}>\r\n                <FileSpreadsheet className={`h-8 w-8 ${uploadError ? 'text-red-500' : 'text-green-500'}`} />\r\n                <div className=\"flex-1\">\r\n                    <Input \r\n                        type=\"file\" \r\n                        accept=\".xlsx, .xls\" \r\n                        onChange={handleExcelUpload} \r\n                    />\r\n                     <p className=\"text-xs text-muted-foreground mt-1 text-red-600 font-medium\">\r\n                        Wajib Header: Nama, Tempat/Tanggal Lahir, Nomor Induk Ma'arif, Pendidikan terakhir, Unit Kerja, Tanggal Mulai Tugas, Status, PDPKPNU\r\n                    </p>\r\n                </div>\r\n            </div>\r\n            \r\n            <div className=\"space-y-2 pt-2 border-t\">\r\n                 <Label>2. Upload Surat Permohonan (PDF)</Label>\r\n                 <div className=\"flex items-center gap-4 rounded-md border p-4 bg-slate-50\">\r\n                    <Upload className=\"h-6 w-6 text-blue-600\" />\r\n                    <div className=\"flex-1\">\r\n                        <Input \r\n                            type=\"file\" \r\n                            accept=\".pdf\" \r\n                            onChange={(e) => setSuratPermohonanFile(e.target.files?.[0] || null)} \r\n                        />\r\n                        <p className=\"text-xs text-muted-foreground mt-1\">Opsional: Lampirkan surat permohonan resmi dr lembaga.</p>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {uploadError && (\r\n                <div className=\"p-3 bg-red-100 text-red-700 text-sm rounded-md font-medium\">\r\n                    {uploadError}\r\n                </div>\r\n            )}\r\n            \r\n            {(debugLog.length > 0) && (\r\n                 <div className=\"text-[10px] space-y-1 p-2 bg-slate-100 rounded border max-h-32 overflow-y-auto font-mono text-slate-600\">\r\n                    <div className=\"font-bold text-slate-800\">Debug Log:</div>\r\n                    {debugLog.map((l, i) => <div key={i}>{l}</div>)}\r\n                 </div>\r\n            )}\r\n            \r\n            {candidates.length > 0 && (\r\n                <div className=\"space-y-2\">\r\n                    <div className=\"flex items-center gap-2 text-sm text-green-600 bg-green-50 p-2 rounded\">\r\n                        <CheckCircle className=\"h-4 w-4\" />\r\n                        <span>Terdeteksi {candidates.length} data.</span>\r\n                    </div>\r\n\r\n                    <div className=\"rounded-md border\">\r\n                        <Table>\r\n                            <TableHeader>\r\n                                <TableRow>\r\n                                    <TableHead className=\"w-[50px]\">No</TableHead>\r\n                                    <TableHead>Nama</TableHead>\r\n                                    <TableHead>Pendidikan</TableHead>\r\n                                    <TableHead>TMT</TableHead>\r\n                                    <TableHead>Jenis SK (Auto)</TableHead>\r\n                                </TableRow>\r\n                            </TableHeader>\r\n                            <TableBody>\r\n                                {candidates.slice(0, 5).map((row, i) => (\r\n                                    <TableRow key={i}>\r\n                                        <TableCell>{i + 1}</TableCell>\r\n                                        <TableCell>{row[\"nama\"]}</TableCell>\r\n                                        <TableCell>{row[\"pendidikanTerakhir\"]}</TableCell>\r\n                                        <TableCell>{row[\"tmt\"]}</TableCell>\r\n                                        <TableCell className=\"font-semibold text-blue-600\">\r\n                                            {determineJenisSk(row[\"pendidikanTerakhir\"], row[\"tmt\"])}\r\n                                        </TableCell>\r\n                                    </TableRow>\r\n                                ))}\r\n                            </TableBody>\r\n                        </Table>\r\n                        {candidates.length > 5 && (\r\n                            <p className=\"p-2 text-center text-xs text-muted-foreground bg-slate-50\">\r\n                                ... dan {candidates.length - 5} data lainnya.\r\n                            </p>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            )}\r\n        </div>\r\n\r\n        {/* PREVIEW SECTION */}\r\n      {candidates.length > 0 && (\r\n          <div className=\"mt-6 border rounded-md p-4 bg-slate-50\">\r\n              <h3 className=\"font-semibold mb-2 flex items-center gap-2\">\r\n                  <FileSpreadsheet className=\"h-4 w-4\" />\r\n                  Preview Data ({candidates.length} baris)\r\n              </h3>\r\n              <div className=\"max-h-[250px] overflow-auto border bg-white rounded-md\">\r\n                   <Table>\r\n                        <TableHeader className=\"bg-slate-100\">\r\n                             <TableRow>\r\n                                 <TableHead>Nama</TableHead>\r\n                                 <TableHead>NIP/NUPTK</TableHead>\r\n                                 <TableHead>Pendidikan</TableHead>\r\n                                 <TableHead>TMT (Tanggal Mulai)</TableHead>\r\n                                 <TableHead>Status (Map/Raw)</TableHead>\r\n                                 <TableHead>Sertifikasi (Raw)</TableHead>\r\n                                 <TableHead>PDPKPNU (Map/Raw)</TableHead>\r\n                             </TableRow>\r\n                        </TableHeader>\r\n                        <TableBody>\r\n                             {candidates.slice(0, 10).map((c, i) => (\r\n                                 <TableRow key={i}>\r\n                                     <TableCell>{c[\"nama\"]}</TableCell>\r\n                                     <TableCell>{c[\"nuptk\"] || \"-\"}</TableCell>\r\n                                     <TableCell className={!c[\"pendidikanTerakhir\"] ? \"text-red-500 font-bold\" : \"\"}>\r\n                                         {c[\"pendidikanTerakhir\"] || \"MISSING\"}\r\n                                     </TableCell>\r\n                                     <TableCell className={!c[\"tmt\"] ? \"text-red-500 font-bold\" : \"\"}>\r\n                                         {c[\"tmt\"] || \"MISSING\"}\r\n                                     </TableCell>\r\n                                     <TableCell>{c[\"status\"]}</TableCell>\r\n                                     <TableCell>{c[\"sertifikasi\"]}</TableCell>\r\n                                 </TableRow>\r\n                             ))}\r\n                        </TableBody>\r\n                   </Table>\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground mt-2\">\r\n                  * Menampilkan 10 baris pertama. Jika kolom Pendidikan atau TMT merah (MISSING), cek header file Excel anda. Header harus mengandung kata kunci seperti \"Pendidikan\" dan \"TMT\" atau \"Tanggal Mulai Tugas\".\r\n              </p>\r\n          </div>\r\n      )}\r\n\r\n        <div className=\"flex flex-col gap-3 pt-4\">\r\n             <div className=\"flex items-center space-x-2 border p-3 rounded-md bg-amber-50 border-amber-200\">\r\n                <Checkbox \r\n                    id=\"fullSync\" \r\n                    checked={isFullSync} \r\n                    onCheckedChange={(c) => setIsFullSync(!!c)} \r\n                />\r\n                <div className=\"grid gap-1.5 leading-none\">\r\n                    <Label htmlFor=\"fullSync\" className=\"text-sm font-medium leading-none cursor-pointer\">\r\n                        Mode Sinkronisasi Penuh\r\n                    </Label>\r\n                    <p className=\"text-xs text-muted-foreground\">\r\n                        Jika dicentang, guru di Unit Kerja yang sama tetapi TIDAK ADA di file Excel ini akan otomatis dinonaktifkan (dianggap keluar/resign).\r\n                    </p>\r\n                </div>\r\n             </div>\r\n\r\n             {/* ADMIN ONLY: Auto Approve */}\r\n             {[\"admin\", \"super_admin\"].includes(JSON.parse(localStorage.getItem(\"user\") || \"{}\")?.role) && (\r\n                 <div className=\"flex items-center space-x-2 border p-3 rounded-md bg-green-50 border-green-200\">\r\n                    <Checkbox \r\n                        id=\"autoApprove\" \r\n                        checked={autoApprove} \r\n                        onCheckedChange={(c) => setAutoApprove(!!c)} \r\n                    />\r\n                    <div className=\"grid gap-1.5 leading-none\">\r\n                        <Label htmlFor=\"autoApprove\" className=\"text-sm font-medium leading-none cursor-pointer\">\r\n                            Langsung Approve (Skip Review)\r\n                        </Label>\r\n                        <p className=\"text-xs text-muted-foreground\">\r\n                            SK yang diupload akan langsung berstatus \"Approved\" tanpa review di Dashboard SK. Gunakan hanya jika data sudah diverifikasi.\r\n                        </p>\r\n                    </div>\r\n                 </div>\r\n             )}\r\n\r\n             <Button \r\n                onClick={handleSubmit} \r\n                disabled={isProcessing}\r\n                className=\"w-full sm:w-auto\"\r\n            >\r\n                {isProcessing ? (\r\n                    <><Loader2 className=\"mr-2 h-4 w-4 animate-spin\" /> Mengirim...</>\r\n                ) : (\r\n                    <><Upload className=\"mr-2 h-4 w-4\" /> Kirim Pengajuan {candidates.length > 0 ? `(${candidates.length})` : \"\"}</>\r\n                )}\r\n            </Button>\r\n        </div>\r\n\r\n      </CardContent>\r\n    </Card>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\users\\UserListPage.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'UserPlus' is defined but never used.","line":7,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'DialogTrigger' is defined but never used.","line":24,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":24,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":68,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":68,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2238,2241],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2238,2241],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":79,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":79,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2592,2595],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2592,2595],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState } from \"react\";\r\nimport SoftPageHeader from \"@/components/ui/SoftPageHeader\";\r\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Search, Edit, UserPlus, CheckCircle2, XCircle } from \"lucide-react\";\r\nimport {\r\n  Table,\r\n  TableBody,\r\n  TableCell,\r\n  TableHead,\r\n  TableHeader,\r\n  TableRow,\r\n} from \"@/components/ui/table\";\r\nimport { useQuery, useMutation } from \"convex/react\";\r\nimport { api } from \"../../../convex/_generated/api\";\r\nimport { Id } from \"../../../convex/_generated/dataModel\";\r\nimport {\r\n  Dialog,\r\n  DialogContent,\r\n  DialogHeader,\r\n  DialogTitle,\r\n  DialogTrigger,\r\n  DialogFooter,\r\n} from \"@/components/ui/dialog\";\r\nimport { Label } from \"@/components/ui/label\";\r\nimport {\r\n  Select,\r\n  SelectContent,\r\n  SelectItem,\r\n  SelectTrigger,\r\n  SelectValue,\r\n} from \"@/components/ui/select\";\r\nimport { toast } from \"sonner\";\r\n\r\nexport default function UserListPage() {\r\n  const [search, setSearch] = useState(\"\");\r\n  // Pagination State\r\n  const [currentCursor, setCurrentCursor] = useState<string | null>(null);\r\n  const [cursorStack, setCursorStack] = useState<(string | null)[]>([]); // History of start cursors\r\n\r\n  const results = useQuery(api.auth.listUsersPage, { \r\n    paginationOpts: { cursor: currentCursor, numItems: 20 } \r\n  });\r\n  \r\n  const users = results?.page;\r\n  const filteredUsers = users?.filter((user) => // Note: Filter only applies to current page\r\n    user.name.toLowerCase().includes(search.toLowerCase()) ||\r\n    user.email.toLowerCase().includes(search.toLowerCase())\r\n  );\r\n\r\n  const handleNext = () => {\r\n    if (results?.continueCursor) {\r\n      setCursorStack([...cursorStack, currentCursor]);\r\n      setCurrentCursor(results.continueCursor);\r\n    }\r\n  };\r\n\r\n  const handlePrev = () => {\r\n    if (cursorStack.length > 0) {\r\n      const prevCursor = cursorStack[cursorStack.length - 1];\r\n      setCursorStack(cursorStack.slice(0, -1));\r\n      setCurrentCursor(prevCursor);\r\n    }\r\n  };\r\n  const updateUser = useMutation(api.auth.updateUser);\r\n  const [editingUser, setEditingUser] = useState<any>(null);\r\n  const [isEditOpen, setIsEditOpen] = useState(false);\r\n\r\n  // Form states for editing\r\n  const [editRole, setEditRole] = useState(\"\");\r\n  const [editUnit, setEditUnit] = useState(\"\");\r\n  const [editIsActive, setEditIsActive] = useState(true);\r\n  const [editPassword, setEditPassword] = useState(\"\");\r\n\r\n\r\n\r\n  const handleEditClick = (user: any) => {\r\n    setEditingUser(user);\r\n    setEditRole(user.role);\r\n    setEditUnit(user.unitKerja || \"\");\r\n    setEditIsActive(user.isActive);\r\n    setEditPassword(\"\"); // Blank default\r\n    setIsEditOpen(true);\r\n  };\r\n\r\n  const handleSaveUser = async () => {\r\n    if (!editingUser) return;\r\n    \r\n    try {\r\n      await updateUser({\r\n        userId: editingUser.id as Id<\"users\">,\r\n        role: editRole,\r\n        unit: editUnit || undefined, // Send undefined if empty string\r\n        isActive: editIsActive,\r\n        password: editPassword || undefined, // Only update if typed\r\n      });\r\n      toast.success(\"User updated successfully\");\r\n      setIsEditOpen(false);\r\n    } catch (error) {\r\n      toast.error(\"Failed to update user\");\r\n      console.error(error);\r\n    }\r\n  };\r\n\r\n  const getRoleBadgeColor = (role: string) => {\r\n    switch (role) {\r\n      case \"super_admin\": return \"bg-purple-100 text-purple-700 hover:bg-purple-100\";\r\n      case \"admin\": return \"bg-blue-100 text-blue-700 hover:bg-blue-100\";\r\n      case \"operator\": return \"bg-green-100 text-green-700 hover:bg-green-100\";\r\n      default: return \"bg-gray-100 text-gray-700 hover:bg-gray-100\";\r\n    }\r\n  };\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <SoftPageHeader\r\n        title=\"Manajemen User\"\r\n        description=\"Kelola akses Operator Sekolah dan Admin\"\r\n      >\r\n        {/* <Button><UserPlus className=\"mr-2 h-4 w-4\" /> Tambah User</Button> */}\r\n      </SoftPageHeader>\r\n\r\n      <Card>\r\n        <CardHeader className=\"pb-3\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <CardTitle>Daftar Pengguna</CardTitle>\r\n            <div className=\"relative w-64\">\r\n              <Search className=\"absolute left-2.5 top-2.5 h-4 w-4 text-gray-500\" />\r\n              <Input\r\n                placeholder=\"Cari nama atau email...\"\r\n                className=\"pl-9\"\r\n                value={search}\r\n                onChange={(e) => setSearch(e.target.value)}\r\n              />\r\n            </div>\r\n          </div>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <Table>\r\n            <TableHeader>\r\n              <TableRow>\r\n                <TableHead>Nama</TableHead>\r\n                <TableHead>Email</TableHead>\r\n                <TableHead>Role</TableHead>\r\n                <TableHead>Unit Kerja / Sekolah</TableHead>\r\n                <TableHead>Status</TableHead>\r\n                <TableHead className=\"text-right\">Aksi</TableHead>\r\n              </TableRow>\r\n            </TableHeader>\r\n            <TableBody>\r\n              {filteredUsers?.map((user) => (\r\n                <TableRow key={user.id}>\r\n                  <TableCell className=\"font-medium\">{user.name}</TableCell>\r\n                  <TableCell>{user.email}</TableCell>\r\n                  <TableCell>\r\n                    <Badge className={getRoleBadgeColor(user.role)}>\r\n                      {user.role}\r\n                    </Badge>\r\n                  </TableCell>\r\n                  <TableCell>{user.unitKerja || \"-\"}</TableCell>\r\n                  <TableCell>\r\n                    {user.isActive ? (\r\n                        <div className=\"flex items-center text-green-600 text-sm\">\r\n                            <CheckCircle2 className=\"w-4 h-4 mr-1\" /> Aktif\r\n                        </div>\r\n                    ) : (\r\n                        <div className=\"flex items-center text-red-500 text-sm\">\r\n                            <XCircle className=\"w-4 h-4 mr-1\" /> Non-Aktif\r\n                        </div>\r\n                    )}\r\n                  </TableCell>\r\n                  <TableCell className=\"text-right\">\r\n                    <Button variant=\"ghost\" size=\"sm\" onClick={() => handleEditClick(user)}>\r\n                      <Edit className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </TableCell>\r\n                </TableRow>\r\n              ))}\r\n              {filteredUsers?.length === 0 && (\r\n                <TableRow>\r\n                  <TableCell colSpan={6} className=\"text-center py-8 text-gray-500\">\r\n                    Tidak ada user ditemukan\r\n                  </TableCell>\r\n                </TableRow>\r\n              )}\r\n            </TableBody>\r\n          </Table>\r\n\r\n          {/* Pagination Controls (Standard Previous/Next) */}\r\n          <div className=\"flex justify-center items-center gap-4 py-4 border-t\">\r\n            <Button \r\n              variant=\"outline\" \r\n              onClick={handlePrev}\r\n              disabled={cursorStack.length === 0}\r\n            >\r\n              Sebelumnya\r\n            </Button>\r\n            <span className=\"text-sm text-gray-500\">\r\n               Halaman {cursorStack.length + 1}\r\n            </span>\r\n            <Button \r\n              variant=\"outline\" \r\n              onClick={handleNext}\r\n              disabled={!results?.isDone ? false : true} // isDone=true means no more items? Wait.\r\n              // Convex paginate: isDone means \"no more items AFTER this page\".\r\n              // But if page is full, continueCursor is present.\r\n              // usually check !results.isDone\r\n            >\r\n              Selanjutnya\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Edit User Dialog */}\r\n      <Dialog open={isEditOpen} onOpenChange={setIsEditOpen}>\r\n        <DialogContent>\r\n            <DialogHeader>\r\n                <DialogTitle>Edit User</DialogTitle>\r\n            </DialogHeader>\r\n            <div className=\"space-y-4 py-4\">\r\n                <div className=\"space-y-2\">\r\n                    <Label>Nama</Label>\r\n                    <Input value={editingUser?.name || \"\"} disabled className=\"bg-gray-100\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label>Email</Label>\r\n                    <Input value={editingUser?.email || \"\"} disabled className=\"bg-gray-100\" />\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label>Role</Label>\r\n                    <Select value={editRole} onValueChange={setEditRole}>\r\n                        <SelectTrigger>\r\n                            <SelectValue placeholder=\"Pilih Role\" />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"operator\">Operator Sekolah</SelectItem>\r\n                            <SelectItem value=\"admin\">Admin Wilayah</SelectItem>\r\n                            <SelectItem value=\"super_admin\">Super Admin</SelectItem>\r\n                            <SelectItem value=\"viewer\">Viewer (Read Only)</SelectItem>\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label>Unit Kerja (Nama Sekolah)</Label>\r\n                    <Input \r\n                        placeholder=\"Misal: MI Maarif NU 1...\" \r\n                        value={editUnit} \r\n                        onChange={(e) => setEditUnit(e.target.value)} \r\n                    />\r\n                    <p className=\"text-xs text-gray-500\">Kosongkan jika Admin Wilayah</p>\r\n                </div>\r\n                <div className=\"space-y-2\">\r\n                    <Label>Status Akun</Label>\r\n                    <Select value={editIsActive ? \"active\" : \"inactive\"} onValueChange={(val) => setEditIsActive(val === \"active\")}>\r\n                        <SelectTrigger>\r\n                            <SelectValue />\r\n                        </SelectTrigger>\r\n                        <SelectContent>\r\n                            <SelectItem value=\"active\">Aktif</SelectItem>\r\n                            <SelectItem value=\"inactive\">Non-Aktif (Blokir)</SelectItem>\r\n                        </SelectContent>\r\n                    </Select>\r\n                </div>\r\n                <div className=\"space-y-2 pt-2 border-t\">\r\n                    <Label>Reset Password (Opsional)</Label>\r\n                    <Input \r\n                        type=\"password\"\r\n                        placeholder=\"Isi untuk ganti password...\" \r\n                        value={editPassword} \r\n                        onChange={(e) => setEditPassword(e.target.value)} \r\n                    />\r\n                </div>\r\n            </div>\r\n            <DialogFooter>\r\n                <Button variant=\"outline\" onClick={() => setIsEditOpen(false)}>Batal</Button>\r\n                <Button onClick={handleSaveUser}>Simpan Perubahan</Button>\r\n            </DialogFooter>\r\n        </DialogContent>\r\n      </Dialog>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\features\\verification\\PublicVerificationPage.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\hooks\\usePermissions.ts","messages":[{"ruleId":"react-hooks/set-state-in-effect","severity":2,"message":"Error: Calling setState synchronously within an effect can trigger cascading renders\n\nEffects are intended to synchronize state between React and external systems such as manually updating the DOM, state management libraries, or other platform APIs. In general, the body of an effect should do one or both of the following:\n* Update external systems with the latest state from React.\n* Subscribe for updates from some external system, calling setState in a callback function when external state changes.\n\nCalling setState synchronously within an effect body causes cascading renders that can hurt performance, and is not recommended. (https://react.dev/learn/you-might-not-need-an-effect).\n\nD:\\SIMMACI\\src\\hooks\\usePermissions.ts:23:9\n  21 |     if (userStr) {\n  22 |       try {\n> 23 |         setUser(JSON.parse(userStr));\n     |         ^^^^^^^ Avoid calling setState() directly within an effect\n  24 |       } catch (e) {\n  25 |         console.error('Failed to parse user from localStorage', e);\n  26 |       }","line":23,"column":9,"nodeType":null,"endLine":23,"endColumn":16}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect } from 'react';\r\n\r\nexport interface User {\r\n  id: string;\r\n  username: string;\r\n  name: string;\r\n  role: 'super_admin' | 'admin_pusat' | 'operator_madrasah' | 'kepala_madrasah';\r\n  unitKerja?: string;\r\n  kecamatan?: string;\r\n  permissions: string[];\r\n}\r\n\r\n/**\r\n * Get current user from localStorage\r\n */\r\nexport const useUser = (): User | null => {\r\n  const [user, setUser] = useState<User | null>(null);\r\n\r\n  useEffect(() => {\r\n    const userStr = localStorage.getItem('user');\r\n    if (userStr) {\r\n      try {\r\n        setUser(JSON.parse(userStr));\r\n      } catch (e) {\r\n        console.error('Failed to parse user from localStorage', e);\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  return user;\r\n};\r\n\r\n/**\r\n * Check if user has a specific permission\r\n */\r\nexport const usePermission = (permission: string): boolean => {\r\n  const user = useUser();\r\n  \r\n  if (!user) return false;\r\n  \r\n  // Super admin always has all permissions\r\n  if (user.role === 'super_admin') return true;\r\n  \r\n  // Check permissions array\r\n  return user.permissions?.includes(permission) || false;\r\n};\r\n\r\n/**\r\n * Check if user has ANY of the specified permissions\r\n */\r\nexport const useAnyPermission = (permissions: string[]): boolean => {\r\n  const user = useUser();\r\n  \r\n  if (!user) return false;\r\n  \r\n  // Super admin always has all permissions\r\n  if (user.role === 'super_admin') return true;\r\n  \r\n  // Check if user has any of the required permissions\r\n  return permissions.some(perm => user.permissions?.includes(perm));\r\n};\r\n\r\n/**\r\n * Check if user has ALL of the specified permissions\r\n */\r\nexport const useAllPermissions = (permissions: string[]): boolean => {\r\n  const user = useUser();\r\n  \r\n  if (!user) return false;\r\n  \r\n  // Super admin always has all permissions\r\n  if (user.role === 'super_admin') return true;\r\n  \r\n  // Check if user has all required permissions\r\n  return permissions.every(perm => user.permissions?.includes(perm));\r\n};\r\n\r\n/**\r\n * Check if user has a specific role\r\n */\r\nexport const useRole = (roles: string | string[]): boolean => {\r\n  const user = useUser();\r\n  \r\n  if (!user) return false;\r\n  \r\n  const roleArray = Array.isArray(roles) ? roles : [roles];\r\n  return roleArray.includes(user.role);\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\lib\\api.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":6,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":6,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[238,241],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[238,241],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":14,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":14,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[503,506],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[503,506],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"// Universal Mock API to fix build errors due to missing src/lib/api.ts\r\n// This uses a recursive proxy to handle any property access or function call.\r\n\r\nexport const API_URL = \"https://mock-api.com\";\r\n\r\nconst createRecursiveProxy = (): any => new Proxy(() => Promise.resolve([]), {\r\n  get: (target, prop) => {\r\n    if (prop === 'then') return undefined; // Avoid treating as Promise unless called\r\n    return createRecursiveProxy();\r\n  },\r\n  apply: () => Promise.resolve([])\r\n});\r\n\r\nexport const api: any = createRecursiveProxy();\r\n","usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\lib\\authHelpers.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\lib\\sk-generator.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\types\\mammoth.d.ts","messages":[],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":3,"column":108,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":3,"endColumn":111,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[157,160],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[157,160],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":4,"column":109,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":4,"endColumn":112,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[276,279],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[276,279],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\src\\vite-env.d.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\tailwind.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\test-import.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\test-template-generation.mjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\test-upload.cjs","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"D:\\SIMMACI\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
